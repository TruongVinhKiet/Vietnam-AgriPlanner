<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AgriPlanner - Quản lý Nâng cao</title>
    <meta name="description" content="Quản lý bản đồ quy hoạch đất đai" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../images/logo.png">

    <!-- TailwindCSS -->
    <script>window.TAILWIND_SUPPRESS_CDN_WARNING = true;</script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#10B981",
                        "primary-dark": "#059669",
                        "primary-light": "#34D399",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                        "card-light": "#FFFFFF",
                        "card-dark": "#1F2937",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                        body: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>

    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Draw for polygon editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="../css/pages/admin-advanced.css" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
</head>

<body class="bg-background-light font-body antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-primary text-white flex flex-col h-full shadow-xl z-20">
            <div class="p-6 flex items-center gap-3">
                <div class="w-10 h-10 flex items-center justify-center">
                    <img src="../images/logo.png" alt="AgriPlanner" class="w-full h-full object-cover rounded-full">
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight">AgriPlanner</h1>
                    <p class="text-xs text-white/70 uppercase tracking-wider font-medium">System Admin</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto custom-scrollbar" id="sidebar-nav">
                <a href="#"
                    class="sidebar-item active flex items-center gap-3 px-4 py-3 rounded-lg text-white transition-colors"
                    data-tab="map">
                    <span class="material-icons-round">map</span>
                    <span class="font-medium">Bản đồ Quy hoạch</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="uploads">
                    <span class="material-icons-round">cloud_upload</span>
                    <span class="font-medium">Quản lý KMZ</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="zones">
                    <span class="material-icons-round">layers</span>
                    <span class="font-medium">Vùng Quy hoạch</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="legend">
                    <span class="material-icons-round">palette</span>
                    <span class="font-medium">Chú giải Màu</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="snapshots">
                    <span class="material-icons-round">history</span>
                    <span class="font-medium">Lịch sử Phiên bản</span>
                </a>

                <div class="border-t border-white/10 my-3"></div>

                <a href="admin.html" onclick="window.location.href='admin.html'; return false;"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors">
                    <span class="material-icons-round">arrow_back</span>
                    <span class="font-medium">Quay lại Admin</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button id="logout-btn"
                    class="flex items-center gap-3 px-4 py-3 w-full rounded-lg text-white/80 hover:bg-white/10 transition-colors">
                    <span class="material-icons-round">logout</span>
                    <span class="font-medium">Đăng xuất</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <!-- Header -->
            <header
                class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 sticky top-0 z-10">
                <h2 id="page-title" class="text-xl font-bold text-gray-800">Bản đồ Quy hoạch Đất đai</h2>
                <div class="flex items-center gap-4">
                    <!-- Upload Button -->
                    <button id="upload-btn"
                        class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                        <span class="material-icons-round text-xl">upload_file</span>
                        <span class="font-medium">Upload KMZ</span>
                    </button>

                    <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
                        <div id="admin-avatar"
                            class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                            A</div>
                        <div>
                            <p id="admin-name" class="text-sm font-semibold text-gray-700">Admin</p>
                            <p class="text-xs text-gray-500">Quản trị viên</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 overflow-hidden relative">
                <!-- Map Container -->
                <div id="map-container" class="absolute inset-0">
                    <div id="leaflet-map" class="w-full h-full"></div>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoom-in-btn" title="Phóng to">
                            <span class="material-icons-round">add</span>
                        </button>
                        <button class="map-control-btn" id="zoom-out-btn" title="Thu nhỏ">
                            <span class="material-icons-round">remove</span>
                        </button>
                        <button class="map-control-btn" id="locate-btn" title="Vị trí của tôi">
                            <span class="material-icons-round">my_location</span>
                        </button>
                        <button class="map-control-btn" id="refresh-btn" title="Làm mới dữ liệu">
                            <span class="material-icons-round">refresh</span>
                        </button>
                    </div>

                    <!-- Layer Selector -->
                    <div class="layer-selector">
                        <button class="layer-btn active" data-layer="street">Đường phố</button>
                        <button class="layer-btn" data-layer="satellite">Vệ tinh</button>
                        <button class="layer-btn" data-layer="terrain">Địa hình</button>
                    </div>

                    <!-- Legend Panel -->
                    <div id="legend-panel" class="legend-panel">
                        <div class="legend-header">
                            <span class="material-icons-round">palette</span>
                            <span>Chú giải Màu sắc</span>
                            <button class="legend-close" id="legend-close">
                                <span class="material-icons-round">close</span>
                            </button>
                        </div>
                        <div class="legend-content" id="legend-content">
                            <!-- Legend items will be inserted here -->
                        </div>
                    </div>

                    <!-- Zone Info Panel -->
                    <div id="zone-info-panel" class="zone-info-panel hidden">
                        <div class="zone-info-header">
                            <h3 id="zone-info-title">Thông tin Vùng</h3>
                            <button class="zone-info-close" id="zone-info-close">
                                <span class="material-icons-round">close</span>
                            </button>
                        </div>
                        <div class="zone-info-content" id="zone-info-content">
                            <!-- Zone info will be inserted here -->
                        </div>
                        <div class="zone-info-actions">
                            <button class="btn btn-outline" id="zone-edit-btn">
                                <span class="material-icons-round">edit</span>
                                Sửa chú thích
                            </button>
                            <button class="btn btn-danger" id="zone-delete-btn">
                                <span class="material-icons-round">delete</span>
                                Xóa
                            </button>
                        </div>
                    </div>

                    <!-- Stats Badge -->
                    <div class="stats-badge" id="stats-badge">
                        <span class="material-icons-round">layers</span>
                        <span id="zones-count">0</span> vùng
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="uploads-container" class="tab-content hidden p-6 overflow-y-auto h-full">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Quản lý File KMZ</h2>

                        <!-- Upload Area -->
                        <div class="upload-dropzone" id="upload-dropzone">
                            <div class="upload-icon">
                                <span class="material-icons-round">cloud_upload</span>
                            </div>
                            <p class="upload-text">Kéo thả file KMZ vào đây hoặc click để chọn</p>
                            <p class="upload-hint">Hỗ trợ file .kmz, .kml (tối đa 100MB)</p>
                            <input type="file" id="file-input" accept=".kmz,.kml" class="hidden">
                        </div>

                        <!-- Upload Form -->
                        <div class="upload-form mt-4 hidden" id="upload-form-container">
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <div class="flex items-center gap-4 mb-4">
                                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                                        <span class="material-icons-round text-primary">description</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium" id="selected-filename">filename.kmz</p>
                                        <p class="text-sm text-gray-500" id="selected-filesize">0 MB</p>
                                    </div>
                                    <button class="text-gray-400 hover:text-red-500" id="clear-file">
                                        <span class="material-icons-round">close</span>
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tỉnh/Thành
                                            phố</label>
                                        <select id="upload-province" class="w-full px-3 py-2 border rounded-lg">
                                            <option value="Cần Thơ">Cần Thơ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Quận/Huyện</label>
                                        <select id="upload-district" class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">-- Chọn quận/huyện --</option>
                                            <option value="Ninh Kiều">Quận Ninh Kiều</option>
                                            <option value="Bình Thủy">Quận Bình Thủy</option>
                                            <option value="Cái Răng">Quận Cái Răng</option>
                                            <option value="Ô Môn">Quận Ô Môn</option>
                                            <option value="Thốt Nốt">Quận Thốt Nốt</option>
                                            <option value="Phong Điền">Huyện Phong Điền</option>
                                            <option value="Cờ Đỏ">Huyện Cờ Đỏ</option>
                                            <option value="Vĩnh Thạnh">Huyện Vĩnh Thạnh</option>
                                            <option value="Thới Lai">Huyện Thới Lai</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                                    <textarea id="upload-notes" class="w-full px-3 py-2 border rounded-lg" rows="2"
                                        placeholder="Ghi chú về file quy hoạch..."></textarea>
                                </div>

                                <button id="submit-upload"
                                    class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                                    <span class="material-icons-round">upload</span>
                                    Tải lên và Xử lý
                                </button>
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div class="upload-progress mt-4 hidden" id="upload-progress">
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <span class="material-icons-round text-blue-600 animate-spin">sync</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium">Đang xử lý...</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                            <div class="bg-primary h-2 rounded-full transition-all" id="progress-bar"
                                                style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Uploads List -->
                        <div class="mt-8">
                            <h3 class="text-lg font-semibold mb-4">Lịch sử Upload</h3>
                            <div id="uploads-list" class="space-y-3">
                                <!-- Upload items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zones List Tab -->
                <div id="zones-container" class="tab-content hidden p-6 overflow-y-auto h-full">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Danh sách Vùng Quy hoạch</h2>
                        <div id="zones-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Zone cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Legend Tab -->
                <div id="legend-container" class="tab-content hidden p-6 overflow-y-auto h-full">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Chú giải Màu sắc Quy hoạch</h2>
                        <div id="zone-types-list" class="space-y-2">
                            <!-- Zone types will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Snapshots Tab -->
                <div id="snapshots-container" class="tab-content hidden p-6 overflow-y-auto h-full">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Lịch sử Phiên bản</h2>
                            <button id="create-snapshot-btn"
                                class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105 active:scale-95">
                                <span class="material-icons-round">add_circle</span>
                                <span class="font-medium">Tạo Snapshot</span>
                            </button>
                        </div>

                        <!-- Info Card -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <span class="material-icons-round text-blue-600">info</span>
                                <div>
                                    <p class="font-medium text-blue-900">Snapshot là gì?</p>
                                    <p class="text-sm text-blue-700 mt-1">
                                        Snapshot lưu lại trạng thái hiện tại của tất cả vùng quy hoạch.
                                        Bạn có thể rollback (quay lại) bất kỳ snapshot nào để khôi phục dữ liệu trước
                                        đó.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Snapshots List -->
                        <div id="snapshots-list" class="space-y-3">
                            <!-- Snapshot items will be inserted here -->
                            <div class="text-center py-8 text-gray-500">
                                <span class="material-icons-round text-4xl">photo_camera</span>
                                <p class="mt-2">Chưa có snapshot nào</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload File KMZ</h3>
                <button class="modal-close" id="modal-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Modal content same as upload tab -->
            </div>
        </div>
    </div>

    <!-- Edit Zone Modal -->
    <div id="edit-zone-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h3>Sửa Chú thích Vùng</h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-zone-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên vùng</label>
                    <input type="text" id="edit-zone-name" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mã quy hoạch</label>
                    <input type="text" id="edit-zone-code" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mục đích sử dụng</label>
                    <input type="text" id="edit-zone-purpose" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                    <textarea id="edit-zone-notes" class="w-full px-3 py-2 border rounded-lg" rows="3"></textarea>
                </div>
                <button onclick="saveZoneEdit()"
                    class="w-full py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark">
                    Lưu thay đổi
                </button>
            </div>
        </div>
    </div>

    <!-- Rollback Confirmation Modal -->
    <div id="rollback-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <div class="modal-header bg-amber-50">
                <h3 class="text-amber-800">⚠️ Xác nhận Rollback</h3>
                <button class="modal-close" onclick="closeRollbackModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-gray-700 mb-4">
                    Bạn có chắc muốn quay lại snapshot <strong id="rollback-snapshot-name"></strong>?
                </p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p class="text-red-800 text-sm">
                        <span class="material-icons-round text-sm align-middle">warning</span>
                        <strong>Cảnh báo:</strong> Tất cả zones hiện tại sẽ bị xóa và thay bằng dữ liệu từ snapshot.
                    </p>
                </div>
                <input type="hidden" id="rollback-snapshot-id">
                <div class="flex gap-3">
                    <button onclick="closeRollbackModal()"
                        class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Hủy
                    </button>
                    <button onclick="confirmRollback()"
                        class="flex-1 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">
                        Xác nhận Rollback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Snapshot Modal -->
    <div id="create-snapshot-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h3>Tạo Snapshot mới</h3>
                <button class="modal-close" onclick="closeCreateSnapshotModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên Snapshot</label>
                    <input type="text" id="snapshot-name" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="VD: Backup trước khi cập nhật...">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả (tùy chọn)</label>
                    <textarea id="snapshot-description" class="w-full px-3 py-2 border rounded-lg" rows="2"
                        placeholder="Ghi chú về snapshot này..."></textarea>
                </div>
                <button onclick="submitCreateSnapshot()"
                    class="w-full py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                    <span class="material-icons-round">photo_camera</span>
                    Tạo Snapshot
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/admin-advanced.js"></script>
</body>

</html>