<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>AgriPlanner - Cài đặt</title>
    <meta name="description" content="Cài đặt tài khoản và hệ thống">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/settings.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <link rel="stylesheet" href="../css/smart-advisor.css">

    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* Address Card Styles */
        .address-card {
            margin-top: 20px;
        }

        .address-map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin: 16px 0;
            border: 2px solid var(--color-border);
        }

        .address-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .address-input-group input {
            flex: 1;
        }

        .address-coords {
            font-size: 13px;
            color: var(--color-text-muted);
            margin-top: 8px;
        }

        .address-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn--location {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        .btn--location:hover {
            background: var(--color-primary);
            color: white;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
</head>

<body data-page="settings">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo-icon" style="background: none; padding: 0;">
                    <img src="../images/logo.png" alt="AgriPlanner Logo"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <h1 class="sidebar__logo-text">AgriPlanner</h1>
            </div>
            <nav class="sidebar__nav">
                <a href="../index.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">home</span><span>Trang chủ</span></a>
                <a href="cultivation.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">potted_plant</span><span>Trồng trọt</span></a>
                <a href="livestock.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">egg</span><span>Chăn nuôi</span></a>
                <a href="labor.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">engineering</span><span>Nhân công</span></a>
                <a href="shop.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">store</span><span>Cửa hàng</span></a>
                <a href="cooperative.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">groups</span><span>Hợp tác xã</span></a>
                <a href="community.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">forum</span><span>Cộng đồng</span></a>
                <a href="analytics.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">account_balance_wallet</span><span>Tài sản</span></a>
                <a href="settings.html" class="sidebar__nav-link active"><span
                        class="material-symbols-outlined">settings</span><span>Cài đặt</span></a>
                <div class="sidebar__spacer"></div>
                <a href="help.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">help</span><span>Trợ giúp</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__user-avatar"
                        style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDCMN1BzSnHgFxeyKEvWsG_QZ7RRtaDeDC8da2PFWOdIOql1NQCIo7EyyLhovyGTv1IssyE0ElFcEa4Vw-V8109xsNhBf99T3NkTDvtYBU47tW1lefo65wDbOMoAbD7PjTIEurzbP6iG_cbmo4nHkWq5Ui67icWuS_TELGtKpV-77MezNda4FST6uqiwz7I-b6lE7ansa-imri7RnOY44Du1B8I1k4Rv_dGiOsudGGjdZD0rsUyhKsP7Eo6RCFsaG5tXK4lTjqA9wxs');">
                    </div>
                    <div class="sidebar__user-info">
                        <p class="sidebar__user-name">John Farmer</p>
                        <p class="sidebar__user-email">john@agriplanner.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="header">
                <div class="header__search"><span
                        class="material-symbols-outlined header__search-icon">search</span><input type="text"
                        class="header__search-input" placeholder="Tìm kiếm cài đặt..."></div>
                <div class="header__actions">
                    <button class="header__notification"><span
                            class="material-symbols-outlined">notifications</span><span
                            class="header__notification-badge"></span></button>
                    <div class="header__user">
                        <div class="header__user-info">
                            <p class="header__user-name">John Farmer</p>
                            <p class="header__user-role">Farm Manager</p>
                        </div>
                        <div class="header__user-avatar"
                            style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCHFCTqN0OM4sPkXOIJq6yxGJaRp5CFHphT4D3h5kTOVuH5XYva-_dBSZW4xFkV4oYoFHd-mgQi2uwLpx8Y2d0nY-kTjVoTY-fsw_cVVCZMuHwe1uAiUGLxaflzoYqbhM8v8nkGBQyp3yT7yk_pAadyFgKQ0ZfaPxHWGc8-v3chAxzKzK48oNsygXDarEGdKrgTsJ54TT58oJ-WPS65S_kwcNajqy3wIMFodmRWYftN04hShgSUMQ8hrtuIVt2uMPn6xk_ckF1LZRfp');">
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="main-content__container">
                    <div class="page-header">
                        <h2 class="page-header__title">Cài đặt</h2>
                    </div>

                    <div class="settings-layout">
                        <!-- Settings Navigation -->
                        <nav class="settings-nav">
                            <button class="settings-nav__link active" data-target="profile-settings"><span
                                    class="material-symbols-outlined">person</span>Hồ sơ</button>
                            <button class="settings-nav__link" data-target="security-settings"><span
                                    class="material-symbols-outlined">security</span>Bảo mật</button>
                            <button class="settings-nav__link" data-target="preferences-settings"><span
                                    class="material-symbols-outlined">tune</span>Tùy chọn</button>
                            <div class="settings-nav__divider"></div>
                            <a href="#" id="logout-btn" class="settings-nav__link settings-nav__link--danger"><span
                                    class="material-symbols-outlined">logout</span>Đăng xuất</a>
                        </nav>

                        <!-- Settings Content -->
                        <div class="settings-content">
                            <!-- Profile Section -->
                            <div class="card settings-section active fade-in" id="profile-settings">
                                <div class="settings-section__header">
                                    <div>
                                        <h3 class="settings-section__title">Hồ sơ công khai</h3>
                                        <p class="settings-section__subtitle">Thông tin này sẽ hiển thị công khai</p>
                                    </div>
                                </div>
                                <div class="settings-section__body">
                                    <div class="profile-form">
                                        <div class="profile-avatar">
                                            <div class="profile-avatar__image"
                                                style="background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center;">
                                                <span class="material-symbols-outlined"
                                                    style="font-size: 48px; color: white;">person</span>
                                            </div>
                                            <button class="profile-avatar__change">Thay đổi ảnh</button>
                                        </div>
                                        <div class="profile-fields">
                                            <div class="form-group"><label class="form-group__label">Họ và
                                                    tên</label><input type="text" id="profile-fullname"
                                                    placeholder="Nhập họ và tên"></div>
                                            <div class="form-group"><label class="form-group__label">Email</label><input
                                                    type="email" id="profile-email" placeholder="Email" readonly
                                                    style="background: #f3f4f6; cursor: not-allowed;"></div>
                                            <div class="form-group"><label class="form-group__label">Vai
                                                    trò</label>
                                                <div id="profile-role"
                                                    style="padding: 12px 16px; background: #f3f4f6; border-radius: 8px; color: #1f2937; font-weight: 500;">
                                                    Đang tải...
                                                </div>
                                            </div>
                                            <div class="form-group"><label class="form-group__label">Số điện
                                                    thoại</label><input type="tel" id="profile-phone"
                                                    placeholder="Số điện thoại"></div>
                                        </div>
                                    </div>
                                    <div class="settings-actions"><button id="cancel-btn"
                                            class="btn btn--secondary">Hủy</button><button id="save-profile-btn"
                                            class="btn btn--primary">Lưu thay đổi</button></div>
                                </div>
                            </div>

                            <!-- Address Section - New Card -->
                            <div class="card settings-section address-card active fade-in" id="address-settings">
                                <div class="settings-section__header">
                                    <div>
                                        <h3 class="settings-section__title">
                                            <span class="material-symbols-outlined"
                                                style="vertical-align: middle; margin-right: 8px; color: var(--color-primary);">location_on</span>
                                            Địa chỉ của bạn
                                        </h3>
                                        <p class="settings-section__subtitle">Chọn vị trí trên bản đồ hoặc nhập địa chỉ
                                        </p>
                                    </div>
                                </div>
                                <div class="settings-section__body">
                                    <!-- Address Input -->
                                    <div class="address-input-group">
                                        <input type="text" id="user-address-input" placeholder="Nhập địa chỉ của bạn..."
                                            class="modal-input">
                                        <button class="btn btn--secondary" onclick="searchAddressOnMap()"
                                            title="Tìm trên bản đồ">
                                            <span class="material-symbols-outlined">search</span>
                                        </button>
                                    </div>

                                    <!-- Map Container -->
                                    <div id="settings-address-map" class="address-map-container"></div>

                                    <!-- Coordinates Display -->
                                    <p class="address-coords">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 16px; vertical-align: middle;">pin_drop</span>
                                        Tọa độ: <span id="address-lat">--</span>, <span id="address-lng">--</span>
                                    </p>

                                    <!-- Actions -->
                                    <div class="address-actions">
                                        <button class="btn btn--location" onclick="getCurrentLocation()">
                                            <span class="material-symbols-outlined"
                                                style="font-size: 18px; margin-right: 6px;">my_location</span>
                                            Vị trí hiện tại
                                        </button>
                                        <button class="btn btn--primary" onclick="saveUserAddress()"
                                            id="save-address-btn">
                                            <span class="material-symbols-outlined"
                                                style="font-size: 18px; margin-right: 6px;">save</span>
                                            Lưu địa chỉ
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Preferences Section -->
                            <div class="card settings-section fade-in" id="preferences-settings">
                                <div class="settings-section__header">
                                    <h3 class="settings-section__title">Tùy chọn hệ thống</h3>
                                </div>
                                <div class="settings-section__body">
                                    <div class="preference-item">
                                        <div class="preference-item__content">
                                            <p class="preference-item__title">Chế độ tối</p>
                                            <p class="preference-item__description">Sử dụng giao diện tối cho ứng dụng
                                            </p>
                                        </div>
                                        <label class="toggle"><input type="checkbox" class="toggle__input"
                                                id="dark-mode-toggle"><span class="toggle__slider"></span></label>
                                    </div>
                                    <div class="preference-item">
                                        <div class="preference-item__content">
                                            <p class="preference-item__title">Thông báo email</p>
                                            <p class="preference-item__description">Nhận email thông báo về các cập nhật
                                                quan trọng</p>
                                        </div>
                                        <label class="toggle"><input type="checkbox" class="toggle__input" checked><span
                                                class="toggle__slider"></span></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Section -->
                            <div class="card settings-section fade-in" id="security-settings">
                                <div class="settings-section__header">
                                    <h3 class="settings-section__title">Bảo mật tài khoản</h3>
                                    <p class="settings-section__subtitle">Quản lý mật khẩu và bảo mật 2 lớp</p>
                                </div>
                                <div class="settings-section__body">
                                    <!-- Change Password -->
                                    <div class="preference-item">
                                        <div class="preference-item__content">
                                            <p class="preference-item__title">Đổi mật khẩu</p>
                                            <p class="preference-item__description">Thay đổi mật khẩu đăng nhập (Yêu cầu
                                                OTP)</p>
                                        </div>
                                        <button class="btn btn--secondary" onclick="initChangePassword()">Đổi mật
                                            khẩu</button>
                                    </div>

                                    <!-- Change Email -->
                                    <div class="preference-item">
                                        <div class="preference-item__content">
                                            <p class="preference-item__title">Đổi Email</p>
                                            <p class="preference-item__description">Thay đổi địa chỉ email (Yêu cầu OTP)
                                            </p>
                                        </div>
                                        <button class="btn btn--secondary" onclick="initChangeEmail()">Đổi
                                            Email</button>
                                    </div>

                                    <!-- 2FA -->
                                    <div class="preference-item">
                                        <div class="preference-item__content">
                                            <p class="preference-item__title">Xác thực 2 bước (2FA)</p>
                                            <p class="preference-item__description">Tăng cường bảo mật với Google
                                                Authenticator</p>
                                        </div>
                                        <label class="toggle"><input type="checkbox" class="toggle__input"
                                                id="two-factor-toggle"><span class="toggle__slider"></span></label>
                                    </div>

                                    <!-- Face Login Section -->
                                    <div class="preference-item" style="flex-direction: column; align-items: stretch;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                            <div class="preference-item__content">
                                                <p class="preference-item__title" style="display: flex; align-items: center; gap: 8px;">
                                                    <span class="material-symbols-outlined" style="color: #8b5cf6; font-size: 20px;">face</span>
                                                    Đăng nhập bằng khuôn mặt
                                                </p>
                                                <p class="preference-item__description" id="face-status-text">Đang kiểm tra...</p>
                                            </div>
                                            <label class="toggle"><input type="checkbox" class="toggle__input"
                                                    id="face-login-toggle"><span class="toggle__slider"></span></label>
                                        </div>

                                        <!-- Face Setup Panel (shown when enabling) -->
                                        <div id="face-setup-panel" style="display:none; margin-top: 16px; padding: 20px; background: linear-gradient(135deg, #f5f3ff, #ede9fe); border-radius: 12px; border: 1px solid #ddd6fe;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                                    <span class="material-symbols-outlined" style="color: white; font-size: 24px;">face</span>
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #5b21b6;">Đăng ký khuôn mặt</h4>
                                                    <p style="margin: 2px 0 0; font-size: 13px; color: #7c3aed;">Chụp ảnh khuôn mặt để đăng nhập nhanh</p>
                                                </div>
                                            </div>

                                            <div id="face-setup-options" style="display: flex; gap: 12px;">
                                                <button onclick="startFaceSetupCamera()" class="btn btn--primary" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; background: #8b5cf6;">
                                                    <span class="material-symbols-outlined">videocam</span> Camera
                                                </button>
                                                <button onclick="uploadFaceSetupPhoto()" class="btn btn--secondary" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px;">
                                                    <span class="material-symbols-outlined">photo_camera</span> Tải ảnh
                                                </button>
                                                <input type="file" id="face-setup-file" accept="image/*" style="display:none;">
                                            </div>

                                            <div id="face-setup-camera" style="display:none; margin-top: 12px;">
                                                <video id="face-setup-video" autoplay playsinline style="width:100%; border-radius:8px; background:#000;"></video>
                                                <canvas id="face-setup-canvas" style="display:none;"></canvas>
                                                <p id="face-setup-status" style="text-align:center; font-size:13px; color:#6b7280; margin-top:8px;">Đang tải...</p>
                                                <div style="display:flex; gap:8px; margin-top:8px;">
                                                    <button onclick="captureFaceSetup()" id="btn-capture-setup" class="btn btn--primary" style="flex:1; background:#8b5cf6;" disabled>
                                                        <span class="material-symbols-outlined">photo_camera</span> Chụp
                                                    </button>
                                                    <button onclick="stopFaceSetupCamera()" class="btn btn--secondary"><span class="material-symbols-outlined">close</span></button>
                                                </div>
                                            </div>

                                            <div id="face-setup-processing" style="display:none; text-align:center; padding:20px;">
                                                <span class="material-symbols-outlined spinning" style="font-size:40px; color:#8b5cf6;">face</span>
                                                <p style="margin-top:8px; color:#6b7280;">Đang xử lý khuôn mặt...</p>
                                            </div>

                                            <div id="face-setup-success" style="display:none; text-align:center; padding:20px;">
                                                <span class="material-symbols-outlined" style="font-size:48px; color:#10b981;">check_circle</span>
                                                <p style="margin-top:8px; color:#059669; font-weight:600;">Đăng ký khuôn mặt thành công!</p>
                                            </div>

                                            <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px;">
                                                <p style="font-size: 12px; color: #7c3aed; margin: 0; display: flex; align-items: center; gap: 6px;">
                                                    <span class="material-symbols-outlined" style="font-size: 16px;">info</span>
                                                    Mỗi tài khoản chỉ đăng ký được một khuôn mặt duy nhất.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-footer">
                        <p class="settings-footer__copyright">© 2023 AgriPlanner. Phiên bản 1.0.0</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/animations.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/smart-advisor.js"></script>
    <script src="../js/main.js"></script>

    <!-- face-api.js for face detection -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        // Use consistent modal styling
        const modalStyles = `
            .modal-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
                animation: fadeIn 0.2s;
            }
            .modal-content {
                background: white; padding: 32px; border-radius: 16px; width: 440px; max-width: 90%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                display: flex; flex-direction: column; gap: 16px;
            }
            .modal-header h3 { font-size: 20px; font-weight: 600; color: #111827; margin: 0; }
            .modal-header p { font-size: 14px; color: #6b7280; margin: 4px 0 0 0; }
            .modal-body { display: flex; flex-direction: column; gap: 12px; }
            .modal-input {
                width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px;
                font-size: 14px; transition: border-color 0.2s; outline: none;
            }
            .modal-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
            .modal-otp-input {
                text-align: center; letter-spacing: 8px; font-size: 24px; font-weight: 600;
                color: var(--color-primary);
            }
            .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
            .btn-full { width: 100%; }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = modalStyles;
        document.head.appendChild(styleSheet);

        // Security Functions
        const securityApi = 'http://localhost:8080/api/security';
        let currentSecurityAction = null;
        let currentNewEmail = null;

        function showCustomModal(html) {
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeModal(id) {
            document.getElementById(id)?.remove();
        }

        async function initChangePassword() {
            const html = `
                <div id="confirm-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Xác nhận thay đổi mật khẩu</h3>
                            <p>Hệ thống sẽ gửi mã OTP đến email của bạn để xác nhận. Bạn có muốn tiếp tục?</p>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('confirm-modal')" class="btn btn--secondary">Hủy</button>
                            <button onclick="closeModal('confirm-modal'); requestOtp('PASSWORD_CHANGE')" class="btn btn--primary">Tiếp tục</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);
        }

        async function initChangeEmail() {
            const html = `
                <div id="email-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Thay đổi Email</h3>
                            <p>Nhập địa chỉ email mới của bạn</p>
                        </div>
                        <div class="modal-body">
                            <input type="email" id="new-email-input" class="modal-input" placeholder="nhancuamoi@example.com">
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('email-modal')" class="btn btn--secondary">Hủy</button>
                            <button onclick="processNewEmail()" class="btn btn--primary">Tiếp tục</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);
        }

        function processNewEmail() {
            const newEmail = document.getElementById('new-email-input').value;
            if (newEmail && validateEmail(newEmail)) {
                currentNewEmail = newEmail;
                closeModal('email-modal');
                requestOtp('EMAIL_CHANGE');
            } else {
                showNotification('error', 'Lỗi', 'Email không hợp lệ');
            }
        }

        async function requestOtp(type) {
            currentSecurityAction = type;
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`${securityApi}/otp/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type })
                });
                if (response.ok) {
                    showInputOtpModal(type);
                    showNotification('success', 'Đã gửi OTP', 'Vui lòng kiểm tra email của bạn');
                } else {
                    showNotification('error', 'Lỗi', 'Không thể gửi OTP');
                }
            } catch (e) { console.error(e); }
        }

        function showInputOtpModal(type) {
            let extraFields = '';
            if (type === 'PASSWORD_CHANGE') {
                extraFields = `
                    <input type="password" id="new-password" class="modal-input" placeholder="Mật khẩu mới">
                    <input type="password" id="confirm-password" class="modal-input" placeholder="Xác nhận mật khẩu mới">
                `;
            }

            const html = `
                <div id="otp-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Xác thực OTP</h3>
                            <p>Nhập mã số gồm 6 chữ số đã được gửi đến email</p>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="otp-input" class="modal-input modal-otp-input" placeholder="------" maxlength="6">
                            ${extraFields}
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('otp-modal')" class="btn btn--secondary">Hủy</button>
                            <button onclick="submitOtpAction('${type}')" class="btn btn--primary">Xác nhận</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);
        }

        async function submitOtpAction(type) {
            const otp = document.getElementById('otp-input').value;
            const token = localStorage.getItem('authToken');

            let body = { otp };
            let endpoint = '';

            if (type === 'PASSWORD_CHANGE') {
                const newPass = document.getElementById('new-password').value;
                const confirmPass = document.getElementById('confirm-password').value;
                if (newPass !== confirmPass) { return showNotification('error', 'Lỗi', 'Mật khẩu không khớp'); }
                body.newPassword = newPass;
                endpoint = '/password/change';
            } else if (type === 'EMAIL_CHANGE') {
                body.newEmail = currentNewEmail;
                endpoint = '/email/change';
            }

            try {
                const response = await fetch(securityApi + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification('success', 'Thành công', data.message || 'Cập nhật thành công');
                    closeModal('otp-modal');
                    if (type === 'EMAIL_CHANGE') location.reload();
                } else {
                    showNotification('error', 'Lỗi', data.message || 'Cập nhật thất bại');
                }
            } catch (e) {
                console.error(e);
                showNotification('error', 'Lỗi', 'Có lỗi xảy ra');
            }
        }

        // 2FA Logic
        document.getElementById('two-factor-toggle').addEventListener('change', async function () {
            const isChecked = this.checked;
            const token = localStorage.getItem('authToken');

            if (isChecked) {
                this.checked = false; // Wait for verification
                try {
                    const response = await fetch(`${securityApi}/2fa/init`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    showQrModal(data.otpAuthUri);
                } catch (e) { console.error(e); }
            } else {
                showDisable2FaModal(this);
            }
        });

        function showDisable2FaModal(toggleElement) {
            const html = `
                <div id="disable-2fa-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Tắt xác thực 2 bước?</h3>
                            <p>Tài khoản của bạn sẽ kém an toàn hơn nếu tắt tính năng này.</p>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('disable-2fa-modal'); document.getElementById('two-factor-toggle').checked = true;" class="btn btn--secondary">Hủy</button>
                            <button onclick="processDisable2Fa()" class="btn btn--danger">Vẫn tắt</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);
        }

        async function processDisable2Fa() {
            const token = localStorage.getItem('authToken');
            try {
                await fetch(`${securityApi}/2fa/disable`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showNotification('success', 'Thành công', 'Đã tắt 2FA');
                document.getElementById('two-factor-toggle').checked = false;
            } catch (e) {
                document.getElementById('two-factor-toggle').checked = true;
            }
            closeModal('disable-2fa-modal');
        }

        function showQrModal(uri) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(uri)}`;
            let html = `
                <div id="qr-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header" style="text-align: center;">
                            <h3>Thiết lập Google Authenticator</h3>
                            <p>Quét mã QR bên dưới bằng ứng dụng xác thực của bạn</p>
                        </div>
                        <div class="modal-body" style="align-items: center;">
                            <div style="padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                                <img src="${qrUrl}" style="display: block; width: 160px; height: 160px;">
                            </div>
                            <input type="text" id="verify-2fa-code" class="modal-input modal-otp-input" placeholder="------" maxlength="6">
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('qr-modal')" class="btn btn--secondary btn-full">Hủy</button>
                            <button onclick="verifyAndEnable2fa()" class="btn btn--primary btn-full">Xác nhận & Bật</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);
        }

        async function verifyAndEnable2fa() {
            const code = document.getElementById('verify-2fa-code').value;
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`${securityApi}/2fa/enable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ code })
                });
                if (response.ok) {
                    showNotification('success', 'Thành công', 'Đã bật xác thực 2 lớp');
                    document.getElementById('two-factor-toggle').checked = true;
                    closeModal('qr-modal');
                } else {
                    showNotification('error', 'Lỗi', 'Mã xác thực không đúng');
                }
            } catch (e) { console.error(e); }
        }

        function validateEmail(email) {
            return String(email)
                .toLowerCase()
                .match(
                    /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                );
        }

        // Toggle password visibility - (Keep existing if any)

        // Avatar Logic
        document.querySelector('.profile-avatar__change').addEventListener('click', function () {
            initChangeAvatar();
        });

        function initChangeAvatar() {
            const html = `
                <div id="avatar-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Thay đổi ảnh đại diện</h3>
                            <p>Chọn ảnh từ máy tính của bạn</p>
                        </div>
                        <div class="modal-body">
                            <div id="avatar-preview-container" style="width: 120px; height: 120px; margin: 0 auto 16px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af;">person</span>
                            </div>
                            <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
                            <button type="button" onclick="document.getElementById('avatar-file-input').click()" class="btn btn--secondary" style="width: 100%;">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px;">upload</span>
                                Chọn ảnh
                            </button>
                            <p style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">Hỗ trợ: JPG, PNG, GIF (tối đa 2MB)</p>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal('avatar-modal')" class="btn btn--secondary">Hủy</button>
                            <button id="save-avatar-btn" onclick="saveAvatar()" class="btn btn--primary" disabled>Lưu ảnh</button>
                        </div>
                    </div>
                </div>`;
            showCustomModal(html);

            // Setup file input listener
            setTimeout(() => {
                const fileInput = document.getElementById('avatar-file-input');
                if (fileInput) {
                    fileInput.addEventListener('change', handleAvatarFileSelect);
                }
            }, 100);
        }

        let selectedAvatarBase64 = null;

        function handleAvatarFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('error', 'Lỗi', 'Ảnh quá lớn. Tối đa 2MB.');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'Lỗi', 'Vui lòng chọn file ảnh.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                selectedAvatarBase64 = e.target.result;

                // Update preview
                const previewContainer = document.getElementById('avatar-preview-container');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                    previewContainer.style.backgroundImage = `url('${selectedAvatarBase64}')`;
                    previewContainer.style.backgroundSize = 'cover';
                    previewContainer.style.backgroundPosition = 'center';
                }

                // Enable save button
                const saveBtn = document.getElementById('save-avatar-btn');
                if (saveBtn) saveBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function saveAvatar() {
            if (!selectedAvatarBase64) {
                showNotification('error', 'Lỗi', 'Vui lòng chọn ảnh trước');
                return;
            }

            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('authToken');

            try {
                const response = await fetch('http://localhost:8080/api/user/avatar', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email: userEmail, avatarUrl: selectedAvatarBase64 })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('userAvatar', selectedAvatarBase64);
                    updateAvatarDisplay(selectedAvatarBase64);
                    closeModal('avatar-modal');
                    selectedAvatarBase64 = null; // Reset
                    showNotification('success', 'Thành công', 'Đã cập nhật ảnh đại diện');
                } else {
                    showNotification('error', 'Lỗi', data.message || 'Không thể cập nhật ảnh');
                }
            } catch (e) {
                console.error(e);
                showNotification('error', 'Lỗi', 'Lỗi kết nối');
            }
        }

        function updateAvatarDisplay(url) {
            if (!url) return;
            // Update all avatar instances
            document.querySelectorAll('.profile-avatar__image, .sidebar__user-avatar, .header__user-avatar').forEach(el => {
                // If it's the profile page large avatar, it might be an div with background or img
                // The structure in HTML is div.profile-avatar__image with style background-image?
                // Actually the current HTML uses: 
                // .sidebar__user-avatar { background-image: ... }
                // .header__user-avatar { background-image: ... }
                // .profile-avatar__image > span.material-symbols-outlined (placeholder)

                // Let's standardized to simple background-image
                el.style.backgroundImage = `url('${url}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';

                // If it was the placeholder one in profile settings, hide the icon
                if (el.classList.contains('profile-avatar__image')) {
                    el.innerHTML = ''; // Remove the icon
                    el.style.background = `url('${url}') center/cover no-repeat`;
                }
            });
        }

        // Initialize Profile
        document.addEventListener('DOMContentLoaded', async function () {
            // ... (Keep existing loading logic)
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) { window.location.href = 'login.html'; return; }

            // Initial Display Update including Avatar
            updateUserDisplayFromStorage();

            try {
                const response = await fetch(`http://localhost:8080/api/user/profile?email=${encodeURIComponent(userEmail)}`);
                if (response.ok) {
                    const profile = await response.json();

                    // Store latest avatar
                    if (profile.avatarUrl) {
                        localStorage.setItem('userAvatar', profile.avatarUrl);
                        updateAvatarDisplay(profile.avatarUrl);
                    }

                    const fullNameInput = document.getElementById('profile-fullname');
                    const emailInput = document.getElementById('profile-email');
                    const phoneInput = document.getElementById('profile-phone');
                    const roleDisplay = document.getElementById('profile-role');
                    const darkModeToggle = document.getElementById('dark-mode-toggle');
                    if (fullNameInput) fullNameInput.value = profile.fullName || '';
                    if (emailInput) emailInput.value = profile.email || '';
                    if (phoneInput) phoneInput.value = profile.phone || '';
                    if (roleDisplay) {
                        const roleLabels = { 'OWNER': 'Chủ trang trại', 'WORKER': 'Nhân công', 'SYSTEM_ADMIN': 'Quản trị viên' };
                        roleDisplay.textContent = roleLabels[profile.role] || profile.role;
                    }
                    if (darkModeToggle) {
                        darkModeToggle.checked = profile.darkMode || false;
                        document.documentElement.setAttribute('data-theme', profile.darkMode ? 'dark' : 'light');
                    }
                    const twoFactorToggle = document.getElementById('two-factor-toggle');
                    if (twoFactorToggle) {
                        twoFactorToggle.checked = profile.twoFactorEnabled || false;
                    }
                }
            } catch (error) { console.error('Error loading profile:', error); }
        });

        function updateUserDisplayFromStorage() {
            const userName = localStorage.getItem('userName') || 'User';
            const userEmail = localStorage.getItem('userEmail') || '';
            const userRole = localStorage.getItem('userRole') || '';
            const userAvatar = localStorage.getItem('userAvatar');

            const roleLabels = { 'OWNER': 'Chủ trang trại', 'WORKER': 'Nhân công', 'SYSTEM_ADMIN': 'Quản trị viên' };

            document.querySelectorAll('.sidebar__user-name').forEach(el => el.textContent = userName);
            document.querySelectorAll('.sidebar__user-email').forEach(el => el.textContent = userEmail);
            document.querySelectorAll('.header__user-name').forEach(el => el.textContent = userName);
            document.querySelectorAll('.header__user-role').forEach(el => el.textContent = roleLabels[userRole] || userRole);

            if (userAvatar) {
                updateAvatarDisplay(userAvatar);
            }
        }

        document.getElementById('logout-btn').addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'login.html';
        });

        document.getElementById('save-profile-btn').addEventListener('click', async function () {
            // ... (Keep existing save logic)
            const userEmail = localStorage.getItem('userEmail');
            const fullName = document.getElementById('profile-fullname').value;
            const phone = document.getElementById('profile-phone').value;
            this.disabled = true; this.innerHTML = '<span class="material-symbols-outlined spinning">sync</span> Đang lưu...';
            try {
                const response = await fetch('http://localhost:8080/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, fullName, phone })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('userName', fullName);
                    updateUserDisplayFromStorage();
                    showNotification('success', 'Cập nhật thành công!', 'Thông tin hồ sơ đã được lưu.');
                } else { showNotification('error', 'Lỗi!', data.error || 'Không thể cập nhật thông tin.'); }
            } catch (error) { console.error('Error', error); showNotification('error', 'Lỗi kết nối!', 'Không thể kết nối đến máy chủ.'); }
            this.disabled = false; this.textContent = 'Lưu thay đổi';
        });

        document.getElementById('dark-mode-toggle').addEventListener('change', async function () {
            const darkMode = this.checked;
            const userEmail = localStorage.getItem('userEmail');
            document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            localStorage.setItem('darkMode', darkMode);
            try {
                await fetch('http://localhost:8080/api/user/dark-mode', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, darkMode })
                });
            } catch (error) { console.error('Error saving dark mode:', error); }
        });

        document.getElementById('cancel-btn').addEventListener('click', function () { window.location.reload(); });
        document.querySelectorAll('.settings-nav__link[data-target]').forEach(link => {
            link.addEventListener('click', function () {
                document.querySelectorAll('.settings-nav__link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });

        function showNotification(type, title, message) {
            // Re-implement or reuse existing notification logic
            const isSuccess = type === 'success';
            const iconName = isSuccess ? 'check_circle' : 'error';
            const gradientColor = isSuccess ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)';
            const modalHtml = `
                <div id="notification-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.2s ease;">
                    <div style="background: white; padding: 32px 40px; border-radius: 16px; text-align: center; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                        <div style="width: 64px; height: 64px; background: ${gradientColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <span class="material-symbols-outlined" style="font-size: 36px; color: white;">${iconName}</span>
                        </div>
                        <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 20px; font-weight: 600;">${title}</h3>
                        <p style="color: #6b7280; margin-bottom: 24px; font-size: 14px;">${message}</p>
                        <button onclick="document.getElementById('notification-modal').remove()" style="background: ${gradientColor}; color: white; border: none; padding: 12px 32px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Đóng</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            if (isSuccess) setTimeout(() => document.getElementById('notification-modal')?.remove(), 3000);
        }

        // ========== ASSET MANAGEMENT ==========
        const assetApi = 'http://localhost:8080/api/assets';

        async function loadAssetData() {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) return;

            // Only run if asset elements exist on this page
            const balanceEl = document.getElementById('asset-balance');
            if (!balanceEl) return;

            try {
                // Load balance
                const balanceRes = await fetch(`${assetApi}/balance?email=${encodeURIComponent(userEmail)}`);
                if (balanceRes.ok) {
                    const data = await balanceRes.json();
                    const balance = data.balance || 0;
                    balanceEl.textContent = balance.toLocaleString('vi-VN') + ' VNĐ';
                }

                // Load transactions
                const transRes = await fetch(`${assetApi}/transactions?email=${encodeURIComponent(userEmail)}`);
                if (transRes.ok) {
                    const transactions = await transRes.json();
                    renderTransactions(transactions);
                }
            } catch (e) {
                console.error('Error loading asset data:', e);
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactions-list');
            if (!tbody) return;
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #9ca3af; padding: 32px;">
                            <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 8px;">receipt_long</span>
                            Chưa có giao dịch nào
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = transactions.map(t => {
                const isIncome = t.transactionType === 'INCOME';
                const sign = isIncome ? '+' : '-';
                const color = isIncome ? '#10b981' : '#ef4444';
                const icon = isIncome ? 'arrow_downward' : 'arrow_upward';
                const date = new Date(t.createdAt).toLocaleString('vi-VN');
                const categoryLabels = {
                    'TOPUP': 'Nạp tiền',
                    'HARVEST': 'Thu hoạch',
                    'SEED': 'Hạt giống',
                    'FERTILIZER': 'Phân bón',
                    'PESTICIDE': 'Thuốc trừ sâu',
                    'MACHINERY': 'Máy móc'
                };
                return `
                    <tr>
                        <td style="font-size: 13px; color: #6b7280;">${date}</td>
                        <td>
                            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; background: ${isIncome ? '#dcfce7' : '#fee2e2'}; color: ${color}; font-size: 12px; font-weight: 500;">
                                <span class="material-symbols-outlined" style="font-size: 14px;">${icon}</span>
                                ${categoryLabels[t.category] || t.category}
                            </span>
                        </td>
                        <td style="font-weight: 600; color: ${color};">${sign}${t.amount.toLocaleString('vi-VN')} VNĐ</td>
                        <td style="font-size: 13px; color: #4b5563; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.description || '-'}</td>
                    </tr>`;
            }).join('');
        }

        function openTopUpModal() {
            const html = `
                <div id="topup-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Nạp tiền vào tài khoản</h3>
                            <p>Tải lên hình ảnh với tên là số tiền (VNĐ)</p>
                        </div>
                        <div class="modal-body">
                            <div style="background: #f0fdf4; border: 2px dashed #10b981; border-radius: 12px; padding: 32px; text-align: center; cursor: pointer;" onclick="document.getElementById('topup-file-input').click()">
                                <span class="material-symbols-outlined" style="font-size: 48px; color: #10b981; margin-bottom: 8px;">cloud_upload</span>
                                <p style="color: #065f46; font-weight: 500;">Click để chọn hình ảnh</p>
                            </div>
                            <input type="file" id="topup-file-input" accept="image/*" style="display: none;" onchange="handleTopUpFileSelect(event)">
                            <div id="topup-preview" style="margin-top: 16px; display: none;">
                                <div style="text-align: center;">
                                    <img id="topup-image-preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-bottom: 12px; object-fit: cover;">
                                    <div id="topup-amount-preview" style="font-size: 24px; font-weight: 700; color: #059669;"></div>
                                </div>
                            </div>
                            <div id="topup-error" style="margin-top: 12px; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; display: none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn--secondary" onclick="closeModal('topup-modal')">Hủy</button>
                            <button id="confirm-topup-btn" class="btn btn--primary" onclick="confirmTopUp()" disabled>Xác nhận nạp tiền</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        let pendingTopUpFileName = null;

        function handleTopUpFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;

            // Validate: must be numeric only
            const isNumeric = /^\d+$/.test(nameWithoutExt);

            const previewEl = document.getElementById('topup-preview');
            const imageEl = document.getElementById('topup-image-preview');
            const amountEl = document.getElementById('topup-amount-preview');
            const errorEl = document.getElementById('topup-error');
            const confirmBtn = document.getElementById('confirm-topup-btn');

            // Show image preview
            const reader = new FileReader();
            reader.onload = function (e) {
                imageEl.src = e.target.result;
            };
            reader.readAsDataURL(file);

            previewEl.style.display = 'block';

            if (!isNumeric) {
                errorEl.style.display = 'block';
                errorEl.innerHTML = '<strong>Lỗi:</strong> Tên file phải là số thuần túy';
                amountEl.textContent = '';
                confirmBtn.disabled = true;
                pendingTopUpFileName = null;
            } else {
                errorEl.style.display = 'none';
                const amount = parseInt(nameWithoutExt);
                amountEl.textContent = '+' + amount.toLocaleString('vi-VN') + ' VNĐ';
                confirmBtn.disabled = false;
                pendingTopUpFileName = fileName;
            }
        }

        async function confirmTopUp() {
            if (!pendingTopUpFileName) return;

            const userEmail = localStorage.getItem('userEmail');
            const confirmBtn = document.getElementById('confirm-topup-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="material-symbols-outlined spinning">sync</span> Đang xử lý...';

            try {
                const response = await fetch(`${assetApi}/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        imageName: pendingTopUpFileName
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    closeModal('topup-modal');
                    showNotification('success', 'Nạp tiền thành công!', 'Đã cộng ' + data.amount.toLocaleString('vi-VN') + ' VNĐ vào tài khoản');
                    loadAssetData(); // Refresh data
                    pendingTopUpFileName = null;
                } else {
                    showNotification('error', 'Lỗi', data.error || 'Không thể nạp tiền');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Xác nhận nạp tiền';
                }
            } catch (e) {
                console.error(e);
                showNotification('error', 'Lỗi kết nối', 'Không thể kết nối đến máy chủ');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Xác nhận nạp tiền';
            }
        }

        // Load asset data when switching to Asset tab
        const dataSettingsTab = document.querySelector('[data-target="data-settings"]');
        if (dataSettingsTab) {
            dataSettingsTab.addEventListener('click', function () {
                loadAssetData();
            });
        }

        // Also load on page load if already on that tab
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(loadAssetData, 500);
        });

        // ========== ADDRESS MAP FUNCTIONALITY ==========
        let addressMap = null;
        let addressMarker = null;
        let userAddressLat = null;
        let userAddressLng = null;

        // Initialize address map
        function initAddressMap() {
            const mapContainer = document.getElementById('settings-address-map');
            if (!mapContainer || addressMap) return;

            // Check if Leaflet is available
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                mapContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Đang tải bản đồ...</p>';
                setTimeout(initAddressMap, 500); // Retry
                return;
            }

            // Default center (Ho Chi Minh City)
            const defaultLat = userAddressLat || 10.8231;
            const defaultLng = userAddressLng || 106.6297;

            addressMap = L.map('settings-address-map').setView([defaultLat, defaultLng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(addressMap);

            // Create custom marker icon
            const customIcon = L.divIcon({
                html: '<span class="material-symbols-outlined" style="color: #ef4444; font-size: 36px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">location_on</span>',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                className: 'custom-location-marker'
            });

            // Add marker if user has address
            if (userAddressLat && userAddressLng) {
                addressMarker = L.marker([userAddressLat, userAddressLng], { icon: customIcon, draggable: true }).addTo(addressMap);
                addressMarker.on('dragend', function (e) {
                    const pos = e.target.getLatLng();
                    updateAddressFromCoords(pos.lat, pos.lng);
                });
            }

            // Click event to place/move marker
            addressMap.on('click', function (e) {
                const { lat, lng } = e.latlng;
                placeMarkerOnMap(lat, lng);
                updateAddressFromCoords(lat, lng);
            });

            // Fix map sizing issue
            setTimeout(() => addressMap.invalidateSize(), 100);
        }

        function placeMarkerOnMap(lat, lng) {
            const customIcon = L.divIcon({
                html: '<span class="material-symbols-outlined" style="color: #ef4444; font-size: 36px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">location_on</span>',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                className: 'custom-location-marker'
            });

            if (addressMarker) {
                addressMarker.setLatLng([lat, lng]);
            } else {
                addressMarker = L.marker([lat, lng], { icon: customIcon, draggable: true }).addTo(addressMap);
                addressMarker.on('dragend', function (e) {
                    const pos = e.target.getLatLng();
                    updateAddressFromCoords(pos.lat, pos.lng);
                });
            }

            userAddressLat = lat;
            userAddressLng = lng;

            // Update display
            document.getElementById('address-lat').textContent = lat.toFixed(6);
            document.getElementById('address-lng').textContent = lng.toFixed(6);
        }

        async function updateAddressFromCoords(lat, lng) {
            userAddressLat = lat;
            userAddressLng = lng;

            document.getElementById('address-lat').textContent = lat.toFixed(6);
            document.getElementById('address-lng').textContent = lng.toFixed(6);

            // Reverse geocode to get address
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=vi`);
                const data = await response.json();
                if (data.display_name) {
                    document.getElementById('user-address-input').value = data.display_name;
                }
            } catch (e) {
                console.log('Geocoding failed:', e);
            }
        }

        async function searchAddressOnMap() {
            const address = document.getElementById('user-address-input').value.trim();
            if (!address) {
                showNotification('error', 'Lỗi', 'Vui lòng nhập địa chỉ để tìm kiếm');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&accept-language=vi&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    const latNum = parseFloat(lat);
                    const lngNum = parseFloat(lon);

                    placeMarkerOnMap(latNum, lngNum);
                    addressMap.setView([latNum, lngNum], 16);
                    document.getElementById('user-address-input').value = display_name;

                    showNotification('success', 'Đã tìm thấy', 'Vị trí đã được đánh dấu trên bản đồ');
                } else {
                    showNotification('error', 'Không tìm thấy', 'Không tìm thấy địa chỉ này. Hãy thử lại hoặc chọn trực tiếp trên bản đồ.');
                }
            } catch (e) {
                console.error('Search error:', e);
                showNotification('error', 'Lỗi', 'Không thể tìm kiếm địa chỉ');
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('error', 'Lỗi', 'Trình duyệt không hỗ trợ định vị');
                return;
            }

            showNotification('success', 'Đang định vị...', 'Vui lòng chờ trong giây lát');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    placeMarkerOnMap(latitude, longitude);
                    addressMap.setView([latitude, longitude], 16);
                    await updateAddressFromCoords(latitude, longitude);
                    showNotification('success', 'Thành công', 'Đã xác định vị trí của bạn');
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    showNotification('error', 'Lỗi định vị', 'Không thể xác định vị trí. Vui lòng cho phép quyền truy cập vị trí.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        async function saveUserAddress() {
            const address = document.getElementById('user-address-input').value.trim();

            if (!userAddressLat || !userAddressLng) {
                showNotification('error', 'Lỗi', 'Vui lòng chọn vị trí trên bản đồ');
                return;
            }

            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('authToken');
            const btn = document.getElementById('save-address-btn');

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined spinning">sync</span> Đang lưu...';

            try {
                const response = await fetch('http://localhost:8080/api/user/address', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        defaultAddress: address,
                        addressLat: userAddressLat,
                        addressLng: userAddressLng
                    })
                });

                const data = await response.json();

                if (response.ok || data.success) {
                    showNotification('success', 'Thành công', 'Đã lưu địa chỉ của bạn');
                } else {
                    showNotification('error', 'Lỗi', data.message || 'Không thể lưu địa chỉ');
                }
            } catch (e) {
                console.error('Save address error:', e);
                showNotification('error', 'Lỗi kết nối', 'Không thể kết nối đến máy chủ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px; margin-right: 6px;">save</span> Lưu địa chỉ';
            }
        }

        // Load user address on page load
        async function loadUserAddress() {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) return;

            try {
                const response = await fetch(`http://localhost:8080/api/user/profile?email=${encodeURIComponent(userEmail)}`);
                if (response.ok) {
                    const profile = await response.json();

                    if (profile.defaultAddress) {
                        document.getElementById('user-address-input').value = profile.defaultAddress;
                    }
                    if (profile.addressLat && profile.addressLng) {
                        userAddressLat = profile.addressLat;
                        userAddressLng = profile.addressLng;
                        document.getElementById('address-lat').textContent = profile.addressLat.toFixed(6);
                        document.getElementById('address-lng').textContent = profile.addressLng.toFixed(6);
                    }
                }
            } catch (e) {
                console.error('Error loading address:', e);
            }
        }

        // Initialize address map after page loads
        document.addEventListener('DOMContentLoaded', async function () {
            await loadUserAddress();
            setTimeout(initAddressMap, 300);
            initFaceLoginSetup();
        });

        // ============================================
        // FACE LOGIN SETUP
        // ============================================
        const FACE_SERVICE_URL = 'http://localhost:5001';
        const FACE_API_URL = 'http://localhost:8080/api/auth/face';
        let faceSetupStream = null;
        let faceSetupModelsLoaded = false;

        async function initFaceLoginSetup() {
            const toggle = document.getElementById('face-login-toggle');
            const statusText = document.getElementById('face-status-text');
            const setupPanel = document.getElementById('face-setup-panel');

            // Check current face status
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8080/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const user = await response.json();
                    if (user.faceEnabled) {
                        toggle.checked = true;
                        statusText.textContent = 'Đã đăng ký khuôn mặt ✓';
                        statusText.style.color = '#10b981';
                        setupPanel.style.display = 'none';
                    } else {
                        toggle.checked = false;
                        statusText.textContent = 'Chưa kích hoạt';
                        setupPanel.style.display = 'none';
                    }
                }
            } catch (e) {
                statusText.textContent = 'Không thể kiểm tra trạng thái';
            }

            // Toggle handler
            toggle.addEventListener('change', async function() {
                if (this.checked) {
                    setupPanel.style.display = 'block';
                    // Reset setup UI
                    document.getElementById('face-setup-options').style.display = 'flex';
                    document.getElementById('face-setup-camera').style.display = 'none';
                    document.getElementById('face-setup-processing').style.display = 'none';
                    document.getElementById('face-setup-success').style.display = 'none';

                    if (typeof gsap !== 'undefined') {
                        gsap.fromTo(setupPanel, { opacity: 0, height: 0 }, { opacity: 1, height: 'auto', duration: 0.3 });
                    }
                } else {
                    // Disable face login
                    if (confirm('Bạn có chắc chắn muốn tắt đăng nhập bằng khuôn mặt?')) {
                        await disableFaceLogin();
                    } else {
                        this.checked = true;
                    }
                }
            });

            // File upload handler
            document.getElementById('face-setup-file').addEventListener('change', handleFaceSetupUpload);
        }

        async function loadFaceSetupModels() {
            if (faceSetupModelsLoaded) return true;
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                faceSetupModelsLoaded = true;
                return true;
            } catch (error) {
                console.error('Failed to load face models:', error);
                return false;
            }
        }

        async function startFaceSetupCamera() {
            const optionsDiv = document.getElementById('face-setup-options');
            const cameraDiv = document.getElementById('face-setup-camera');
            const statusDiv = document.getElementById('face-setup-status');

            optionsDiv.style.display = 'none';
            cameraDiv.style.display = 'block';

            statusDiv.textContent = 'Đang tải mô hình nhận diện...';
            const loaded = await loadFaceSetupModels();
            if (!loaded) {
                statusDiv.textContent = 'Không thể tải mô hình nhận diện. Vui lòng thử tải ảnh lên.';
                // Allow user to go back to options after a delay
                setTimeout(() => {
                    cameraDiv.style.display = 'none';
                    optionsDiv.style.display = 'flex';
                }, 3000);
                return;
            }

            try {
                faceSetupStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                const video = document.getElementById('face-setup-video');
                video.srcObject = faceSetupStream;
                statusDiv.textContent = 'Đưa khuôn mặt vào giữa camera...';
                video.onloadeddata = () => detectFaceSetupLoop();
            } catch (error) {
                console.error('Camera error:', error);
                statusDiv.textContent = 'Không thể truy cập camera.';
            }
        }

        async function detectFaceSetupLoop() {
            const video = document.getElementById('face-setup-video');
            const statusDiv = document.getElementById('face-setup-status');
            const captureBtn = document.getElementById('btn-capture-setup');

            if (!video || !faceSetupStream) return;

            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());

            if (detection) {
                statusDiv.innerHTML = '<span style="color:#10b981;">✓ Phát hiện khuôn mặt - Nhấn "Chụp"</span>';
                captureBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Đưa khuôn mặt vào giữa camera...';
                captureBtn.disabled = true;
            }

            if (faceSetupStream) {
                requestAnimationFrame(detectFaceSetupLoop);
            }
        }

        async function captureFaceSetup() {
            const video = document.getElementById('face-setup-video');
            const canvas = document.getElementById('face-setup-canvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            stopFaceSetupCamera();

            document.getElementById('face-setup-camera').style.display = 'none';
            document.getElementById('face-setup-processing').style.display = 'block';

            canvas.toBlob(async (blob) => {
                await registerFaceFromImage(blob);
            }, 'image/jpeg', 0.92);
        }

        function uploadFaceSetupPhoto() {
            document.getElementById('face-setup-file').click();
        }

        async function handleFaceSetupUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('face-setup-options').style.display = 'none';
            document.getElementById('face-setup-processing').style.display = 'block';

            await registerFaceFromImage(file);
        }

        async function registerFaceFromImage(imageBlob) {
            try {
                const token = localStorage.getItem('authToken');
                const userEmail = localStorage.getItem('userEmail');

                // Step 1: Encode face via Python service
                const formData = new FormData();
                formData.append('file', imageBlob, 'face.jpg');

                const encodeRes = await fetch(`${FACE_SERVICE_URL}/encode`, {
                    method: 'POST',
                    body: formData
                });
                const encodeData = await encodeRes.json();

                if (!encodeData.success) {
                    showFaceSetupError(encodeData.error || 'Không thể nhận diện khuôn mặt');
                    return;
                }

                // Step 2: Check uniqueness
                const uniqueRes = await fetch(`${FACE_SERVICE_URL}/check-unique`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        encoding: encodeData.encoding,
                        excludeEmail: userEmail
                    })
                });
                const uniqueData = await uniqueRes.json();

                if (uniqueData.success && !uniqueData.unique) {
                    showFaceSetupError(uniqueData.message || 'Khuôn mặt đã được đăng ký cho tài khoản khác');
                    return;
                }

                // Step 3: Upload image to backend
                const uploadFormData = new FormData();
                uploadFormData.append('file', imageBlob, 'face.jpg');

                const uploadRes = await fetch(`${FACE_API_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: uploadFormData
                });
                const uploadData = await uploadRes.json();

                if (!uploadRes.ok || !uploadData.success) {
                    showFaceSetupError(uploadData.message || 'Không thể tải ảnh lên. Vui lòng thử lại.');
                    return;
                }

                // Step 4: Register face encoding in DB
                const registerRes = await fetch(`${FACE_API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        faceEncoding: JSON.stringify(encodeData.encoding),
                        faceImagePath: uploadData.filePath || ''
                    })
                });
                const registerData = await registerRes.json();

                if (registerData.success) {
                    document.getElementById('face-setup-processing').style.display = 'none';
                    document.getElementById('face-setup-success').style.display = 'block';
                    document.getElementById('face-status-text').textContent = 'Đã đăng ký khuôn mặt ✓';
                    document.getElementById('face-status-text').style.color = '#10b981';

                    if (typeof showNotification === 'function') {
                        showNotification('success', 'Thành công', 'Đã đăng ký khuôn mặt thành công!');
                    }
                } else {
                    showFaceSetupError(registerData.message || 'Đăng ký thất bại');
                }
            } catch (error) {
                console.error('Face registration error:', error);
                showFaceSetupError('Không thể kết nối đến dịch vụ nhận diện khuôn mặt. Đảm bảo dịch vụ đang chạy (port 5001).');
            }
        }

        function showFaceSetupError(message) {
            document.getElementById('face-setup-processing').style.display = 'none';
            document.getElementById('face-setup-options').style.display = 'flex';

            if (typeof showNotification === 'function') {
                showNotification('error', 'Lỗi', message);
            } else {
                alert(message);
            }
        }

        async function disableFaceLogin() {
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${FACE_API_URL}/disable`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('face-status-text').textContent = 'Chưa kích hoạt';
                    document.getElementById('face-status-text').style.color = '';
                    document.getElementById('face-setup-panel').style.display = 'none';

                    if (typeof showNotification === 'function') {
                        showNotification('success', 'Đã tắt', 'Đăng nhập bằng khuôn mặt đã được tắt');
                    }
                }
            } catch (e) {
                console.error('Disable face error:', e);
            }
        }

        function stopFaceSetupCamera() {
            if (faceSetupStream) {
                faceSetupStream.getTracks().forEach(track => track.stop());
                faceSetupStream = null;
            }
        }
    </script>
</body>

</html>