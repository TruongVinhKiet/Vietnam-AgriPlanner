<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AgriPlanner - Trang Công Nhân</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">
    <script>window.TAILWIND_SUPPRESS_CDN_WARNING = true;</script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#10B981",
                        "primary-dark": "#059669",
                        "primary-light": "#34D399",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                    },
                    fontFamily: {
                        display: ["Inter", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans", "Liberation Sans", "sans-serif"],
                        body: ["Inter", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans", "Liberation Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
        }

        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .task-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .view-section {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        /* Stats cards hover effect */
        .stats-card {
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.3);
        }

        /* Button hover effects */
        button {
            transition: all 0.2s ease;
        }

        /* Task tab styling */
        .task-tab {
            transition: all 0.2s ease;
            position: relative;
        }

        .task-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: #10B981;
            transition: width 0.3s ease;
        }

        .task-tab:hover::after,
        .task-tab.active::after {
            width: 100%;
        }

        /* Smooth scrollbar */
        main::-webkit-scrollbar {
            width: 6px;
        }

        main::-webkit-scrollbar-track {
            background: transparent;
        }

        main::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        main::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Header shadow on scroll */
        header {
            transition: box-shadow 0.3s ease;
        }

        header.scrolled {
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-background-light font-body antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-primary text-white flex flex-col h-full shadow-xl z-20">
            <div class="p-6 flex items-center gap-3">
                <div class="w-10 h-10 flex items-center justify-center">
                    <img src="../images/logo.png" alt="AgriPlanner" class="w-full h-full object-cover rounded-full">
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight">AgriPlanner</h1>
                    <p class="text-xs text-white/70 uppercase tracking-wider font-medium">Worker Portal</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-4" id="sidebar-nav">
                <a href="#"
                    class="sidebar-item active flex items-center gap-3 px-4 py-3 rounded-lg text-white transition-colors"
                    data-tab="home">
                    <span class="material-icons-round">home</span>
                    <span class="font-medium">Trang chủ</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="tasks">
                    <span class="material-icons-round">assignment</span>
                    <span class="font-medium">Công việc</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="assets">
                    <span class="material-icons-round">account_balance_wallet</span>
                    <span class="font-medium">Tài sản</span>
                </a>
                <div class="my-4 border-t border-white/10"></div>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="settings">
                    <span class="material-icons-round">settings</span>
                    <span class="font-medium">Cài đặt</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-white/80 hover:bg-white/10 transition-colors"
                    data-tab="help">
                    <span class="material-icons-round">help</span>
                    <span class="font-medium">Trợ giúp</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button id="logout-btn"
                    class="flex items-center gap-3 px-4 py-3 w-full rounded-lg text-white/80 hover:bg-white/10 transition-colors">
                    <span class="material-icons-round">logout</span>
                    <span class="font-medium">Đăng xuất</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <header
                class="bg-white border-b border-gray-200 h-20 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Tổng quan</h2>
                <div class="flex items-center gap-6">
                    <div id="weather-widget"
                        class="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 text-sm font-medium text-blue-800">
                        <span class="material-symbols-outlined text-base">cloud</span>
                        <span>Đang tải...</span>
                    </div>

                    <div class="flex items-center gap-2 bg-green-50 px-3 py-1.5 rounded-full border border-green-200">
                        <span class="material-symbols-outlined text-green-600">account_balance_wallet</span>
                        <span id="worker-balance" class="font-bold text-green-700">0 VNĐ</span>
                    </div>

                    <div class="flex items-center gap-3 pl-6 border-l border-gray-200">
                        <div id="worker-avatar"
                            class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                            W</div>
                        <div>
                            <p id="worker-name" class="text-sm font-semibold text-gray-700">Công nhân</p>
                            <p class="text-xs text-gray-500">Worker</p>
                        </div>
                    </div>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-y-auto p-8 bg-gray-50">
                <!-- Views -->
                <div id="view-home" class="view-section">
                    <!-- Home Content: Overview, Today's Tasks Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Công việc hôm nay</div>
                            <div class="text-3xl font-bold text-gray-800" id="home-today-count">0</div>
                            <div class="text-green-600 text-sm mt-2 flex items-center gap-1">
                                <span class="material-icons-round text-sm">schedule</span> Cần hoàn thành
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Thu nhập tháng này</div>
                            <div class="text-3xl font-bold text-gray-800" id="home-income">0 ₫</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Thời tiết hôm nay</div>
                            <div class="text-3xl font-bold text-gray-800" id="home-weather-temp">--°C</div>
                            <div class="text-blue-600 text-sm mt-2" id="home-weather-desc">--</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Công việc ưu tiên</h3>
                        <div id="home-tasks-list" class="space-y-3">
                            <!-- Tasks injected here -->
                        </div>
                    </div>
                </div>

                <div id="view-tasks" class="view-section hidden">
                    <!-- Task Tabs -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button
                            class="task-tab active px-6 py-3 text-sm font-medium text-primary border-b-2 border-primary"
                            data-type="CULTIVATION">Trồng trọt</button>
                        <button class="task-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                            data-type="LIVESTOCK">Chăn nuôi</button>
                        <button class="task-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                            data-type="OTHER">Khác</button>
                    </div>
                    <div id="tasks-list-container" class="space-y-4">
                        <!-- Tasks List -->
                    </div>
                </div>

                <div id="view-assets" class="view-section hidden">
                    <div class="flex flex-col gap-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Tài sản</h3>
                                <p class="text-sm text-gray-500">Theo dõi dòng tiền và lịch sử giao dịch</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openTopUpModal()"
                                    class="px-4 py-2 rounded-lg bg-primary text-white font-medium hover:bg-primary-dark">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 18px; vertical-align: middle; margin-right: 6px;">add</span>
                                    Nạp tiền
                                </button>
                                <button onclick="exportReport()"
                                    class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 18px; vertical-align: middle; margin-right: 6px;">download</span>
                                    Xuất báo cáo
                                </button>
                            </div>
                        </div>

                        <div class="rounded-2xl p-6 text-white overflow-hidden"
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); box-shadow: 0 10px 40px rgba(16, 185, 129, 0.25);">
                            <div class="text-sm opacity-90 flex items-center gap-2">
                                <span class="material-symbols-outlined">account_balance_wallet</span>
                                Tổng số dư hiện tại
                            </div>
                            <div class="text-4xl font-bold mt-2" id="total-balance">0 VNĐ</div>
                            <div class="flex flex-wrap gap-10 mt-5">
                                <div>
                                    <div class="text-xs opacity-80">Thu nhập tháng này</div>
                                    <div class="font-semibold" id="month-income">+0 VNĐ</div>
                                </div>
                                <div>
                                    <div class="text-xs opacity-80">Chi tiêu tháng này</div>
                                    <div class="font-semibold" id="month-expense">-0 VNĐ</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 20px; color: #10b981;">payments</span>
                                        Thông tin lương
                                    </h4>
                                    <button id="payroll-refresh-btn"
                                        class="text-primary font-medium text-sm hover:text-primary-dark">Tải
                                        lại</button>
                                </div>
                                <div id="salary-settings-summary" class="text-sm text-gray-500">Đang tải...</div>
                            </div>

                            <div class="bg-white rounded-xl border border-gray-100 overflow-hidden lg:col-span-2">
                                <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                                    <h4 class="font-bold text-gray-800">Lịch sử nhận lương</h4>
                                    <span id="salary-payments-count"
                                        class="text-xs font-semibold text-gray-600 bg-gray-100 px-2.5 py-1 rounded-full">0</span>
                                </div>
                                <div id="salary-payments-list" class="divide-y divide-gray-100">
                                    <div class="p-10 text-center text-gray-500">Đang tải...</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xs text-gray-500 font-medium">Tổng thu nhập</div>
                                        <div class="text-xl font-bold text-gray-800" id="stat-total-income">0 VNĐ</div>
                                    </div>
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                                        style="background:#d1fae5; color:#059669;">
                                        <span class="material-symbols-outlined">arrow_downward</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xs text-gray-500 font-medium">Tổng chi tiêu</div>
                                        <div class="text-xl font-bold text-gray-800" id="stat-total-expense">0 VNĐ</div>
                                    </div>
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                                        style="background:#fee2e2; color:#dc2626;">
                                        <span class="material-symbols-outlined">arrow_upward</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xs text-gray-500 font-medium">Lợi nhuận ròng</div>
                                        <div class="text-xl font-bold text-gray-800" id="stat-net-profit">0 VNĐ</div>
                                    </div>
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                                        style="background:#dbeafe; color:#2563eb;">
                                        <span class="material-symbols-outlined">trending_up</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xs text-gray-500 font-medium">Số giao dịch</div>
                                        <div class="text-xl font-bold text-gray-800" id="stat-tx-count">0</div>
                                    </div>
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                                        style="background:#fef3c7; color:#d97706;">
                                        <span class="material-symbols-outlined">receipt_long</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl border border-gray-100 p-5 lg:col-span-2">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-gray-800">Thu nhập & Chi tiêu (30 ngày)</h4>
                                </div>
                                <div class="h-72">
                                    <canvas id="incomeExpenseChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-100 p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-gray-800">Phân bổ chi tiêu</h4>
                                </div>
                                <div class="h-72">
                                    <canvas id="expenseBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                            <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                                <h4 class="font-bold text-gray-800">Giao dịch gần đây</h4>
                                <button onclick="loadMoreTransactions()"
                                    class="text-primary font-medium text-sm hover:text-primary-dark">Xem tất cả</button>
                            </div>
                            <div id="transactions-list" class="divide-y divide-gray-100"></div>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="view-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl border border-gray-100 p-3">
                                <button
                                    class="worker-settings-nav w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-primary bg-green-50"
                                    data-target="worker-profile-settings">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">person</span>
                                    Hồ sơ
                                </button>
                                <button
                                    class="worker-settings-nav w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700 hover:bg-gray-50"
                                    data-target="worker-security-settings">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">security</span>
                                    Bảo mật
                                </button>
                                <button
                                    class="worker-settings-nav w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700 hover:bg-gray-50"
                                    data-target="worker-preferences-settings">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">tune</span>
                                    Tùy chọn
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-3 space-y-6">
                            <div id="worker-profile-settings" class="worker-settings-section">
                                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                                    <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-800">Hồ sơ</h3>
                                            <p class="text-sm text-gray-500">Cập nhật thông tin tài khoản</p>
                                        </div>
                                        <button id="save-profile-btn"
                                            class="px-4 py-2 rounded-lg bg-primary text-white font-medium hover:bg-primary-dark">
                                            <span class="material-symbols-outlined"
                                                style="font-size: 18px; vertical-align: middle; margin-right: 6px;">save</span>
                                            Lưu
                                        </button>
                                    </div>
                                    <div class="p-6 space-y-6">
                                        <div class="flex items-center gap-4">
                                            <div id="profile-avatar"
                                                class="w-16 h-16 rounded-full bg-primary flex items-center justify-center text-white font-bold text-xl">
                                                W</div>
                                            <div>
                                                <div class="font-semibold text-gray-800" id="profile-name-display">Công
                                                    nhân</div>
                                                <button id="change-avatar-btn"
                                                    class="mt-1 text-sm font-medium text-primary hover:text-primary-dark">Đổi
                                                    ảnh đại diện</button>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Họ và
                                                    tên</label>
                                                <input type="text" id="profile-fullname"
                                                    class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Số điện
                                                    thoại</label>
                                                <input type="text" id="profile-phone"
                                                    class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary"
                                                    placeholder="VD: 0901234567">
                                            </div>
                                            <div class="md:col-span-2">
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                                <input type="email" id="profile-email"
                                                    class="w-full rounded-lg border-gray-300 bg-gray-50" disabled>
                                            </div>
                                        </div>

                                        <div class="border-t border-gray-100 pt-6">
                                            <h4 class="font-bold text-gray-800 mb-3">Địa chỉ</h4>
                                            <div class="flex flex-col md:flex-row gap-3">
                                                <input type="text" id="user-address-input"
                                                    class="flex-1 rounded-lg border-gray-300 focus:border-primary focus:ring-primary"
                                                    placeholder="Nhập địa chỉ của bạn">
                                                <button id="search-address-btn"
                                                    class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Tìm</button>
                                                <button id="current-location-btn"
                                                    class="px-4 py-2 rounded-lg bg-green-50 text-primary font-medium hover:bg-green-100">Vị
                                                    trí hiện tại</button>
                                            </div>
                                            <div class="mt-4 rounded-xl overflow-hidden border border-gray-200"
                                                style="height: 300px;" id="settings-address-map"></div>
                                            <div class="mt-3 text-sm text-gray-500">Tọa độ: <span
                                                    id="address-lat">--</span>, <span id="address-lng">--</span></div>
                                            <div class="mt-4">
                                                <button id="save-address-btn"
                                                    class="px-4 py-2 rounded-lg bg-primary text-white font-medium hover:bg-primary-dark">
                                                    <span class="material-symbols-outlined"
                                                        style="font-size: 18px; vertical-align: middle; margin-right: 6px;">save</span>
                                                    Lưu địa chỉ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="worker-security-settings" class="worker-settings-section hidden">
                                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                                    <div class="p-6 border-b border-gray-100">
                                        <h3 class="text-lg font-bold text-gray-800">Bảo mật</h3>
                                        <p class="text-sm text-gray-500">Đổi mật khẩu, email và xác thực 2 lớp</p>
                                    </div>
                                    <div class="p-6 space-y-6">
                                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                            <div>
                                                <div class="font-semibold text-gray-800">Đổi mật khẩu</div>
                                                <div class="text-sm text-gray-500">Yêu cầu OTP qua email</div>
                                            </div>
                                            <button id="change-password-btn"
                                                class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Đổi
                                                mật khẩu</button>
                                        </div>
                                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                            <div>
                                                <div class="font-semibold text-gray-800">Đổi email</div>
                                                <div class="text-sm text-gray-500">Yêu cầu OTP qua email</div>
                                            </div>
                                            <button id="change-email-btn"
                                                class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Đổi
                                                email</button>
                                        </div>
                                        <div
                                            class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                            <div>
                                                <div class="font-semibold text-gray-800">Xác thực 2 bước (2FA)</div>
                                                <div class="text-sm text-gray-500">Tăng cường bảo mật cho tài khoản
                                                </div>
                                            </div>
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="two-factor-toggle" class="sr-only peer">
                                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-primary peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                            </label>
                                        </div>

                                        <!-- Face Login Section -->
                                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-100" style="display:flex; flex-direction:column; gap:12px;">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-semibold text-gray-800 flex items-center gap-2">
                                                        <span class="material-icons-round" style="color:#8b5cf6; font-size:20px;">face</span>
                                                        Đăng nhập bằng khuôn mặt
                                                    </div>
                                                    <div class="text-sm text-gray-500" id="worker-face-status-text">Đang kiểm tra...</div>
                                                </div>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="worker-face-login-toggle" class="sr-only peer">
                                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-purple-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                                </label>
                                            </div>

                                            <!-- Face Setup Panel -->
                                            <div id="worker-face-setup-panel" style="display:none; padding:16px; background:linear-gradient(135deg, #f5f3ff, #ede9fe); border-radius:12px; border:1px solid #ddd6fe;">
                                                <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                                                    <div style="width:40px; height:40px; background:linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                                                        <span class="material-icons-round" style="color:white; font-size:22px;">face</span>
                                                    </div>
                                                    <div>
                                                        <h4 style="margin:0; font-size:15px; font-weight:700; color:#5b21b6;">Đăng ký khuôn mặt</h4>
                                                        <p style="margin:2px 0 0; font-size:12px; color:#7c3aed;">Chụp ảnh khuôn mặt để đăng nhập nhanh</p>
                                                    </div>
                                                </div>

                                                <div id="worker-face-setup-options" style="display:flex; gap:10px;">
                                                    <button onclick="workerStartFaceCamera()" class="px-4 py-2 rounded-lg text-white font-medium" style="flex:1; display:flex; align-items:center; justify-content:center; gap:6px; background:#8b5cf6;">
                                                        <span class="material-icons-round" style="font-size:18px;">videocam</span> Camera
                                                    </button>
                                                    <button onclick="workerUploadFacePhoto()" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium" style="flex:1; display:flex; align-items:center; justify-content:center; gap:6px;">
                                                        <span class="material-icons-round" style="font-size:18px;">photo_camera</span> Tải ảnh
                                                    </button>
                                                    <input type="file" id="worker-face-setup-file" accept="image/*" style="display:none;">
                                                </div>

                                                <div id="worker-face-setup-camera" style="display:none; margin-top:12px;">
                                                    <video id="worker-face-setup-video" autoplay playsinline style="width:100%; border-radius:8px; background:#000;"></video>
                                                    <canvas id="worker-face-setup-canvas" style="display:none;"></canvas>
                                                    <p id="worker-face-setup-status" style="text-align:center; font-size:13px; color:#6b7280; margin-top:8px;">Đang tải...</p>
                                                    <div style="display:flex; gap:8px; margin-top:8px;">
                                                        <button onclick="workerCaptureFaceSetup()" id="worker-btn-capture-setup" class="px-4 py-2 rounded-lg text-white font-medium" style="flex:1; background:#8b5cf6;" disabled>
                                                            <span class="material-icons-round" style="font-size:18px; vertical-align:middle;">photo_camera</span> Chụp
                                                        </button>
                                                        <button onclick="workerStopFaceCamera()" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium">
                                                            <span class="material-icons-round" style="font-size:18px; vertical-align:middle;">close</span>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div id="worker-face-setup-processing" style="display:none; text-align:center; padding:16px;">
                                                    <span class="material-icons-round" style="font-size:36px; color:#8b5cf6; animation:spin 1s linear infinite;">face</span>
                                                    <p style="margin-top:8px; color:#6b7280; font-size:13px;">Đang xử lý khuôn mặt...</p>
                                                </div>

                                                <div id="worker-face-setup-success" style="display:none; text-align:center; padding:16px;">
                                                    <span class="material-icons-round" style="font-size:40px; color:#10b981;">check_circle</span>
                                                    <p style="margin-top:8px; color:#059669; font-weight:600; font-size:14px;">Đăng ký khuôn mặt thành công!</p>
                                                </div>

                                                <div style="margin-top:12px; padding:10px; background:white; border-radius:8px;">
                                                    <p style="font-size:11px; color:#7c3aed; margin:0; display:flex; align-items:center; gap:6px;">
                                                        <span class="material-icons-round" style="font-size:14px;">info</span>
                                                        Mỗi tài khoản chỉ đăng ký được một khuôn mặt duy nhất.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="worker-preferences-settings" class="worker-settings-section hidden">
                                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                                    <div class="p-6 border-b border-gray-100">
                                        <h3 class="text-lg font-bold text-gray-800">Tùy chọn</h3>
                                        <p class="text-sm text-gray-500">Cài đặt hiển thị và trải nghiệm</p>
                                    </div>
                                    <div class="p-6 space-y-6">
                                        <div
                                            class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                            <div>
                                                <div class="font-semibold text-gray-800">Chế độ tối</div>
                                                <div class="text-sm text-gray-500">Bật/tắt giao diện tối</div>
                                            </div>
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-primary peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-help" class="view-section hidden">
                    <div class="max-w-4xl mx-auto space-y-6">

                        <!-- Help Hero -->
                        <div class="text-center py-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Trung tâm trợ giúp</h2>
                            <p class="text-gray-500">Gửi yêu cầu hỗ trợ hoặc tìm câu trả lời nhanh</p>
                        </div>

                        <!-- Support Tabs -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="flex border-b border-gray-200">
                                <button id="help-tab-owner"
                                    class="help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-green-500 text-green-600 bg-green-50/50"
                                    onclick="switchHelpTab('owner')">
                                    <span class="material-icons-round text-lg">agriculture</span>
                                    Gửi tới Chủ trang trại
                                </button>
                                <button id="help-tab-admin"
                                    class="help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                    onclick="switchHelpTab('admin')">
                                    <span class="material-icons-round text-lg">admin_panel_settings</span>
                                    Gửi tới Quản trị viên
                                </button>
                            </div>

                            <!-- Owner Support Form -->
                            <div id="help-panel-owner" class="p-6">
                                <div class="flex items-center gap-3 mb-5">
                                    <div class="w-10 h-10 rounded-xl bg-green-50 text-green-600 flex items-center justify-center">
                                        <span class="material-icons-round">support_agent</span>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-bold text-gray-800">Yêu cầu hỗ trợ từ Chủ trang trại</h3>
                                        <p class="text-sm text-gray-500">Gửi phản hồi trực tiếp cho chủ nông trại của bạn</p>
                                    </div>
                                </div>

                                <form id="help-request-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu đề (tuỳ chọn)</label>
                                        <input id="help-title" type="text"
                                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary"
                                            placeholder="VD: Báo lỗi / Xin vật tư / Hỏi quy trình">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nội dung</label>
                                        <textarea id="help-message" rows="4"
                                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary"
                                            placeholder="Mô tả chi tiết vấn đề bạn đang gặp..."></textarea>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
                                        <button id="help-refresh-btn" type="button"
                                            class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Tải lại</button>
                                        <button type="submit"
                                            class="px-4 py-2 rounded-lg bg-primary text-white font-medium hover:bg-primary-dark">Gửi yêu cầu</button>
                                    </div>
                                    <div id="help-form-status" class="text-sm text-gray-500 hidden"></div>
                                </form>
                            </div>

                            <!-- Admin Support Form -->
                            <div id="help-panel-admin" class="p-6" style="display: none;">
                                <div class="flex items-center gap-3 mb-5">
                                    <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center">
                                        <span class="material-icons-round">admin_panel_settings</span>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-bold text-gray-800">Yêu cầu hỗ trợ từ Quản trị viên</h3>
                                        <p class="text-sm text-gray-500">Gửi yêu cầu tới quản trị viên hệ thống (lỗi kỹ thuật, tài khoản...)</p>
                                    </div>
                                </div>

                                <form id="help-admin-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại vấn đề</label>
                                        <select id="admin-help-type"
                                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                                            <option value="technical">Lỗi kỹ thuật</option>
                                            <option value="account">Vấn đề tài khoản</option>
                                            <option value="payment">Thanh toán / Lương</option>
                                            <option value="suggestion">Góp ý / Đề xuất</option>
                                            <option value="other">Khác</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu đề</label>
                                        <input id="admin-help-title" type="text"
                                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="Mô tả ngắn gọn vấn đề">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Chi tiết</label>
                                        <textarea id="admin-help-message" rows="4"
                                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="Mô tả chi tiết vấn đề bạn đang gặp phải..."></textarea>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
                                        <button type="button" onclick="loadAdminHelpRequests()"
                                            class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Tải lại</button>
                                        <button type="submit"
                                            class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700">Gửi tới Admin</button>
                                    </div>
                                    <div id="admin-help-status" class="text-sm text-gray-500 hidden"></div>
                                </form>
                            </div>
                        </div>

                        <!-- Request History Tabs -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                                <h4 class="font-bold text-gray-800">Lịch sử yêu cầu</h4>
                                <div class="flex items-center gap-2">
                                    <button id="history-tab-owner"
                                        class="history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700"
                                        onclick="switchHistoryTab('owner')">
                                        Chủ trang trại <span id="help-requests-count" class="ml-1">0</span>
                                    </button>
                                    <button id="history-tab-admin"
                                        class="history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600"
                                        onclick="switchHistoryTab('admin')">
                                        Quản trị viên <span id="admin-requests-count" class="ml-1">0</span>
                                    </button>
                                </div>
                            </div>
                            <div id="help-requests-list" class="divide-y divide-gray-100">
                                <div class="p-10 text-center text-gray-500">Chưa có yêu cầu nào.</div>
                            </div>
                            <div id="admin-requests-list" class="divide-y divide-gray-100" style="display: none;">
                                <div class="p-10 text-center text-gray-500">Chưa có yêu cầu nào gửi tới quản trị viên.</div>
                            </div>
                        </div>

                        <!-- Quick FAQ for Workers -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="material-icons-round text-amber-500">quiz</span>
                                Câu hỏi thường gặp
                            </h4>
                            <div class="space-y-3">
                                <details class="group border border-gray-100 rounded-lg">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                                        Làm sao để xem công việc được giao?
                                        <span class="material-icons-round text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
                                    </summary>
                                    <div class="px-4 pb-4 text-sm text-gray-600">Vào tab <strong>Công việc</strong> trên thanh bên. Bạn sẽ thấy danh sách tất cả công việc được chủ trang trại giao, bao gồm mô tả, thời hạn và trạng thái.</div>
                                </details>
                                <details class="group border border-gray-100 rounded-lg">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                                        Tôi có thể xem lương và thu nhập ở đâu?
                                        <span class="material-icons-round text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
                                    </summary>
                                    <div class="px-4 pb-4 text-sm text-gray-600">Vào tab <strong>Tài sản</strong> để xem số dư hiện tại, lịch sử nhận lương và các khoản thưởng.</div>
                                </details>
                                <details class="group border border-gray-100 rounded-lg">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                                        Làm sao để đổi mật khẩu hoặc email?
                                        <span class="material-icons-round text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
                                    </summary>
                                    <div class="px-4 pb-4 text-sm text-gray-600">Vào tab <strong>Cài đặt</strong>, sau đó nhấp <strong>Đổi mật khẩu</strong> hoặc <strong>Đổi email</strong>. Hệ thống sẽ gửi mã OTP tới email hiện tại để xác nhận thay đổi.</div>
                                </details>
                                <details class="group border border-gray-100 rounded-lg">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                                        Tôi gặp lỗi kỹ thuật, nên liên hệ ai?
                                        <span class="material-icons-round text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
                                    </summary>
                                    <div class="px-4 pb-4 text-sm text-gray-600">Nếu lỗi liên quan đến công việc hoặc nông trại, hãy gửi yêu cầu tới <strong>Chủ trang trại</strong>. Nếu lỗi hệ thống, tài khoản hoặc thanh toán, hãy chuyển sang tab <strong>Gửi tới Quản trị viên</strong> để được hỗ trợ.</div>
                                </details>
                                <details class="group border border-gray-100 rounded-lg">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                                        Làm thế nào để bật đăng nhập bằng khuôn mặt?
                                        <span class="material-icons-round text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
                                    </summary>
                                    <div class="px-4 pb-4 text-sm text-gray-600">Vào <strong>Cài đặt</strong>, tìm phần <strong>Đăng nhập khuôn mặt</strong>. Bật toggle và chụp ảnh khuôn mặt bằng camera hoặc tải ảnh lên. Sau khi đăng ký thành công, bạn có thể đăng nhập bằng khuôn mặt trên trang đăng nhập.</div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <script src="../js/config.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="../js/worker_dashboard.js"></script>
    <script>
        // Add scroll shadow effect to header
        const mainContent = document.querySelector('main');
        const header = document.querySelector('header');
        if (mainContent && header) {
            mainContent.addEventListener('scroll', () => {
                if (mainContent.scrollTop > 10) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        }
    </script>

    <!-- Face Login Setup for Worker -->
    <script>
    (function() {
        const WORKER_FACE_SERVICE_URL = 'http://localhost:5001';
        const WORKER_FACE_API_URL = 'http://localhost:8080/api/auth/face';
        let workerFaceStream = null;
        let workerFaceModelsLoaded = false;

        function getWorkerToken() {
            return localStorage.getItem('token') || localStorage.getItem('authToken') || '';
        }

        window.addEventListener('DOMContentLoaded', function() {
            initWorkerFaceSetup();
        });

        function initWorkerFaceSetup() {
            const toggle = document.getElementById('worker-face-login-toggle');
            const panel = document.getElementById('worker-face-setup-panel');
            const statusText = document.getElementById('worker-face-status-text');
            const fileInput = document.getElementById('worker-face-setup-file');
            if (!toggle || !panel) return;

            // Check current face status via /api/auth/me
            const token = getWorkerToken();
            if (token) {
                fetch('http://localhost:8080/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.faceEnabled) {
                        toggle.checked = true;
                        statusText.textContent = 'Đã đăng ký khuôn mặt ✓';
                        statusText.style.color = '#10b981';
                    } else {
                        toggle.checked = false;
                        statusText.textContent = 'Chưa đăng nhập';
                        statusText.style.color = '#6b7280';
                    }
                })
                .catch(() => {
                    statusText.textContent = 'Không thể kiểm tra trạng thái';
                    statusText.style.color = '#ef4444';
                });
            } else {
                statusText.textContent = 'Chưa đăng nhập';
            }

            toggle.addEventListener('change', function() {
                if (this.checked) {
                    panel.style.display = 'block';
                    document.getElementById('worker-face-setup-options').style.display = 'flex';
                    document.getElementById('worker-face-setup-camera').style.display = 'none';
                    document.getElementById('worker-face-setup-processing').style.display = 'none';
                    document.getElementById('worker-face-setup-success').style.display = 'none';
                } else {
                    if (confirm('Bạn có chắc chắn muốn tắt đăng nhập bằng khuôn mặt?')) {
                        panel.style.display = 'none';
                        workerStopFaceCamera();
                        workerDisableFaceLogin();
                    } else {
                        this.checked = true;
                    }
                }
            });

            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        workerHandleFaceUpload(e.target.files[0]);
                    }
                });
            }
        }

        async function workerLoadFaceModels() {
            if (workerFaceModelsLoaded) return true;
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                workerFaceModelsLoaded = true;
                return true;
            } catch (error) {
                console.error('Failed to load face models:', error);
                return false;
            }
        }

        window.workerStartFaceCamera = async function() {
            const camDiv = document.getElementById('worker-face-setup-camera');
            const video = document.getElementById('worker-face-setup-video');
            const statusEl = document.getElementById('worker-face-setup-status');
            const btnCapture = document.getElementById('worker-btn-capture-setup');
            const optionsDiv = document.getElementById('worker-face-setup-options');

            if (optionsDiv) optionsDiv.style.display = 'none';
            camDiv.style.display = 'block';
            statusEl.textContent = 'Đang tải mô hình nhận diện...';
            btnCapture.disabled = true;

            const loaded = await workerLoadFaceModels();
            if (!loaded) {
                statusEl.textContent = 'Không thể tải mô hình nhận diện. Vui lòng thử tải ảnh lên.';
                statusEl.style.color = '#ef4444';
                setTimeout(() => {
                    camDiv.style.display = 'none';
                    if (optionsDiv) optionsDiv.style.display = 'flex';
                }, 3000);
                return;
            }

            try {
                workerFaceStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = workerFaceStream;
                statusEl.textContent = 'Đưa khuôn mặt vào giữa camera...';
                statusEl.style.color = '#6b7280';
                video.onloadeddata = () => workerDetectFaceLoop();
            } catch (err) {
                statusEl.textContent = 'Không thể truy cập camera: ' + err.message;
                statusEl.style.color = '#ef4444';
            }
        };

        function workerDetectFaceLoop() {
            const video = document.getElementById('worker-face-setup-video');
            const statusEl = document.getElementById('worker-face-setup-status');
            const btnCapture = document.getElementById('worker-btn-capture-setup');

            if (!video || !workerFaceStream) return;

            faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).then(detection => {
                if (detection) {
                    statusEl.innerHTML = '<span style="color:#10b981;">✓ Phát hiện khuôn mặt — Nhấn "Chụp"</span>';
                    btnCapture.disabled = false;
                } else {
                    statusEl.textContent = 'Đưa khuôn mặt vào giữa camera...';
                    statusEl.style.color = '#6b7280';
                    btnCapture.disabled = true;
                }
                if (workerFaceStream) {
                    requestAnimationFrame(workerDetectFaceLoop);
                }
            }).catch(() => {
                if (workerFaceStream) {
                    requestAnimationFrame(workerDetectFaceLoop);
                }
            });
        }

        window.workerCaptureFaceSetup = function() {
            const video = document.getElementById('worker-face-setup-video');
            const canvas = document.getElementById('worker-face-setup-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            workerStopFaceCamera();

            document.getElementById('worker-face-setup-camera').style.display = 'none';
            document.getElementById('worker-face-setup-processing').style.display = 'block';

            canvas.toBlob(blob => {
                workerRegisterFace(blob);
            }, 'image/jpeg', 0.92);
        };

        window.workerUploadFacePhoto = function() {
            document.getElementById('worker-face-setup-file').click();
        };

        function workerHandleFaceUpload(file) {
            document.getElementById('worker-face-setup-options').style.display = 'none';
            document.getElementById('worker-face-setup-processing').style.display = 'block';
            workerRegisterFace(file);
        }

        async function workerRegisterFace(imageBlob) {
            const optionsDiv = document.getElementById('worker-face-setup-options');
            const processingDiv = document.getElementById('worker-face-setup-processing');
            const successDiv = document.getElementById('worker-face-setup-success');
            const statusText = document.getElementById('worker-face-status-text');

            const token = getWorkerToken();
            const userEmail = localStorage.getItem('userEmail') || '';

            try {
                // Step 1: Encode face via Python service
                const formData = new FormData();
                formData.append('file', imageBlob, 'face.jpg');

                const encodeRes = await fetch(WORKER_FACE_SERVICE_URL + '/encode', {
                    method: 'POST',
                    body: formData
                });
                const encodeData = await encodeRes.json();

                if (!encodeData.success) {
                    throw new Error(encodeData.error || 'Không thể nhận diện khuôn mặt');
                }

                // Step 2: Check uniqueness
                const uniqueRes = await fetch(WORKER_FACE_SERVICE_URL + '/check-unique', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        encoding: encodeData.encoding,
                        excludeEmail: userEmail
                    })
                });
                const uniqueData = await uniqueRes.json();

                if (uniqueData.success && !uniqueData.unique) {
                    throw new Error(uniqueData.message || 'Khuôn mặt đã được đăng ký cho tài khoản khác');
                }

                // Step 3: Upload image to backend
                const uploadFormData = new FormData();
                uploadFormData.append('file', imageBlob, 'face.jpg');

                const uploadRes = await fetch(WORKER_FACE_API_URL + '/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: uploadFormData
                });
                const uploadData = await uploadRes.json();

                if (!uploadRes.ok || !uploadData.success) {
                    throw new Error(uploadData.message || 'Không thể tải ảnh lên. Vui lòng thử lại.');
                }

                // Step 4: Register face encoding in DB
                const registerRes = await fetch(WORKER_FACE_API_URL + '/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        faceEncoding: JSON.stringify(encodeData.encoding),
                        faceImagePath: uploadData.filePath || ''
                    })
                });
                const registerData = await registerRes.json();

                if (registerData.success) {
                    // Success
                    processingDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    statusText.textContent = 'Đã đăng ký khuôn mặt ✓';
                    statusText.style.color = '#10b981';

                    setTimeout(() => {
                        document.getElementById('worker-face-setup-panel').style.display = 'none';
                        successDiv.style.display = 'none';
                    }, 2500);
                } else {
                    throw new Error(registerData.message || 'Đăng ký thất bại');
                }
            } catch (err) {
                console.error('Face registration error:', err);
                processingDiv.style.display = 'none';
                optionsDiv.style.display = 'flex';
                workerShowFaceError(err.message || 'Không thể kết nối đến dịch vụ nhận diện khuôn mặt. Đảm bảo dịch vụ đang chạy (port 5001).');
            }
        }

        async function workerDisableFaceLogin() {
            const token = getWorkerToken();
            const statusText = document.getElementById('worker-face-status-text');
            try {
                const res = await fetch(WORKER_FACE_API_URL + '/disable', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if (data.success) {
                    statusText.textContent = 'Chưa kích hoạt';
                    statusText.style.color = '#6b7280';
                }
            } catch (e) {
                console.error('Disable face error:', e);
            }
        }

        window.workerStopFaceCamera = function() {
            if (workerFaceStream) { workerFaceStream.getTracks().forEach(t => t.stop()); workerFaceStream = null; }
        };

        function workerShowFaceError(msg) {
            const panel = document.getElementById('worker-face-setup-panel');
            let errDiv = document.getElementById('worker-face-setup-error');
            if (!errDiv) {
                errDiv = document.createElement('div');
                errDiv.id = 'worker-face-setup-error';
                errDiv.style.cssText = 'margin-top:10px; padding:10px; background:#fef2f2; border:1px solid #fecaca; border-radius:8px; color:#dc2626; font-size:13px; display:flex; align-items:center; gap:6px;';
                panel.appendChild(errDiv);
            }
            errDiv.innerHTML = '<span class="material-icons-round" style="font-size:16px;">error</span>' + msg;
            errDiv.style.display = 'flex';
            setTimeout(() => { errDiv.style.display = 'none'; }, 5000);
        }
    })();
    </script>

    <!-- Help Tab Switching & Admin Support -->
    <script>
    function switchHelpTab(tab) {
        const ownerTab = document.getElementById('help-tab-owner');
        const adminTab = document.getElementById('help-tab-admin');
        const ownerPanel = document.getElementById('help-panel-owner');
        const adminPanel = document.getElementById('help-panel-admin');

        if (tab === 'owner') {
            ownerTab.className = 'help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-green-500 text-green-600 bg-green-50/50';
            adminTab.className = 'help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50';
            ownerPanel.style.display = '';
            adminPanel.style.display = 'none';
        } else {
            adminTab.className = 'help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-blue-500 text-blue-600 bg-blue-50/50';
            ownerTab.className = 'help-tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-3.5 text-sm font-semibold transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50';
            ownerPanel.style.display = 'none';
            adminPanel.style.display = '';
        }
    }

    function switchHistoryTab(tab) {
        const ownerBtn = document.getElementById('history-tab-owner');
        const adminBtn = document.getElementById('history-tab-admin');
        const ownerList = document.getElementById('help-requests-list');
        const adminList = document.getElementById('admin-requests-list');

        if (tab === 'owner') {
            ownerBtn.className = 'history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700';
            adminBtn.className = 'history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';
            ownerList.style.display = '';
            adminList.style.display = 'none';
        } else {
            adminBtn.className = 'history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700';
            ownerBtn.className = 'history-tab-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';
            ownerList.style.display = 'none';
            adminList.style.display = '';
            loadAdminHelpRequests();
        }
    }

    // Admin help form submission
    document.getElementById('help-admin-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const type = document.getElementById('admin-help-type')?.value || 'other';
        const title = document.getElementById('admin-help-title')?.value?.trim();
        const message = document.getElementById('admin-help-message')?.value?.trim();
        const statusEl = document.getElementById('admin-help-status');
        const userId = localStorage.getItem('userId');

        if (!message) {
            if (statusEl) {
                statusEl.textContent = 'Vui lòng nhập nội dung chi tiết.';
                statusEl.style.color = '#ef4444';
                statusEl.classList.remove('hidden');
            }
            return;
        }

        const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) || 'http://localhost:8080/api';
        const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';

        try {
            const res = await fetch(`${apiBase}/help/admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    senderId: userId,
                    senderRole: 'WORKER',
                    requestType: type,
                    title: title || `[${type}] Yêu cầu hỗ trợ`,
                    message: message
                })
            });

            if (res.ok) {
                if (statusEl) {
                    statusEl.textContent = '✓ Đã gửi yêu cầu tới quản trị viên!';
                    statusEl.style.color = '#10b981';
                    statusEl.classList.remove('hidden');
                }
                document.getElementById('admin-help-title').value = '';
                document.getElementById('admin-help-message').value = '';
                setTimeout(() => statusEl?.classList.add('hidden'), 3000);
                loadAdminHelpRequests();
            } else {
                const data = await res.json().catch(() => ({}));
                if (statusEl) {
                    statusEl.textContent = data.message || 'Gửi yêu cầu thất bại. Vui lòng thử lại.';
                    statusEl.style.color = '#ef4444';
                    statusEl.classList.remove('hidden');
                }
            }
        } catch (err) {
            console.error('Admin help request error:', err);
            if (statusEl) {
                statusEl.textContent = 'Không thể kết nối đến máy chủ.';
                statusEl.style.color = '#ef4444';
                statusEl.classList.remove('hidden');
            }
        }
    });

    async function loadAdminHelpRequests() {
        const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) || 'http://localhost:8080/api';
        const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';
        const userId = localStorage.getItem('userId');
        const listEl = document.getElementById('admin-requests-list');
        const countEl = document.getElementById('admin-requests-count');

        try {
            // Use /my-requests endpoint (JWT-based) as primary, fallback to worker/{id}
            const url = userId ? `${apiBase}/help/admin/worker/${userId}` : `${apiBase}/help/admin/my-requests`;
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const requests = await res.json();
                const items = Array.isArray(requests) ? requests : (requests.content || []);
                if (countEl) countEl.textContent = items.length;

                if (items.length === 0) {
                    listEl.innerHTML = '<div class="p-10 text-center text-gray-500">Chưa có yêu cầu nào gửi tới quản trị viên.</div>';
                    return;
                }

                listEl.innerHTML = items.map(req => {
                    const statusColor = req.status === 'CLOSED' ? 'text-green-600 bg-green-50' :
                                       req.status === 'RESPONDED' ? 'text-blue-600 bg-blue-50' :
                                       'text-amber-600 bg-amber-50';
                    const statusLabel = req.status === 'CLOSED' ? 'Đã đóng' :
                                       req.status === 'RESPONDED' ? 'Đã phản hồi' : 'Chờ xử lý';
                    const date = req.createdAt ? new Date(req.createdAt).toLocaleDateString('vi-VN') : '';

                    return `<div class="p-4 flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="material-icons-round" style="font-size: 16px;">admin_panel_settings</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-sm text-gray-800 truncate">${req.title || 'Yêu cầu hỗ trợ'}</span>
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${statusColor}">${statusLabel}</span>
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-2">${req.message || ''}</p>
                            ${req.adminResponse ? `<div class="mt-2 p-2 bg-blue-50 rounded-lg text-xs text-blue-800"><strong>Phản hồi:</strong> ${req.adminResponse}</div>` : ''}
                            <span class="text-xs text-gray-400 mt-1 block">${date}</span>
                        </div>
                    </div>`;
                }).join('');
            }
        } catch (err) {
            console.error('Load admin help requests error:', err);
        }
    }
    </script>
</body>

</html>