<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPlanner - ChƒÉn nu√¥i</title>
    <meta name="description" content="Qu·∫£n l√Ω m√¥ ph·ªèng c∆° s·ªü chƒÉn nu√¥i">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/livestock.css">
    <link rel="stylesheet" href="../css/pages/inventory.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <link rel="stylesheet" href="../css/smart-advisor.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
</head>

<body data-page="livestock" style="overflow: hidden;">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo-icon" style="background: none; padding: 0;">
                    <img src="../images/logo.png" alt="AgriPlanner Logo"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <h1 class="sidebar__logo-text">AgriPlanner</h1>
            </div>
            <nav class="sidebar__nav">
                <a href="../index.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">home</span><span>Trang ch·ªß</span></a>
                <a href="cultivation.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">potted_plant</span><span>Tr·ªìng tr·ªçt</span></a>
                <a href="livestock.html" class="sidebar__nav-link active">
                    <span class="material-symbols-outlined">egg</span>
                    <span>ChƒÉn nu√¥i</span>
                </a>
                <a href="labor.html" class="sidebar__nav-link">
                    <span class="material-symbols-outlined">engineering</span>
                    <span>Nh√¢n c√¥ng</span>
                </a>
                <a href="shop.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">store</span><span>C·ª≠a h√†ng</span></a>
                <a href="cooperative.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">groups</span><span>H·ª£p t√°c x√£</span></a>
                <a href="community.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">forum</span><span>C·ªông ƒë·ªìng</span></a>
                <a href="analytics.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">account_balance_wallet</span><span>T√†i s·∫£n</span></a>
                <a href="settings.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">settings</span><span>C√†i ƒë·∫∑t</span></a>
                <div class="sidebar__spacer"></div>
                <a href="help.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">help</span><span>Tr·ª£ gi√∫p</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__user-avatar"
                        style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDCMN1BzSnHgFxeyKEvWsG_QZ7RRtaDeDC8da2PFWOdIOql1NQCIo7EyyLhovyGTv1IssyE0ElFcEa4Vw-V8109xsNhBf99T3NkTDvtYBU47tW1lefo65wDbOMoAbD7PjTIEurzbP6iG_cbmo4nHkWq5Ui67icWuS_TELGtKpV-77MezNda4FST6uqiwz7I-b6lE7ansa-imri7RnOY44Du1B8I1k4Rv_dGiOsudGGjdZD0rsUyhKsP7Eo6RCFsaG5tXK4lTjqA9wxs');">
                    </div>
                    <div class="sidebar__user-info">
                        <p class="sidebar__user-name">John Farmer</p>
                        <p class="sidebar__user-email">john@agriplanner.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="header">
                <div class="header__search"><span
                        class="material-symbols-outlined header__search-icon">search</span><input type="text"
                        class="header__search-input" placeholder="T√¨m ki·∫øm chu·ªìng tr·∫°i..."></div>
                <div class="header__actions">
                    <button class="header__notification" onclick="toggleNotificationPanel()"><span
                            class="material-symbols-outlined">notifications</span><span id="notification-badge"
                            class="header__notification-badge"></span></button>
                    <div class="header__user">
                        <div class="header__user-info">
                            <p class="header__user-name">John Farmer</p>
                            <p class="header__user-role">Farm Manager</p>
                        </div>
                        <div class="header__user-avatar"
                            style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCHFCTqN0OM4sPkXOIJq6yxGJaRp5CFHphT4D3h5kTOVuH5XYva-_dBSZW4xFkV4oYoFHd-mgQi2uwLpx8Y2d0nY-kTjVoTY-fsw_cVVCZMuHwe1uAiUGLxaflzoYqbhM8v8nkGBQyp3yT7yk_pAadyFgKQ0ZfaPxHWGc8-v3chAxzKzK48oNsygXDarEGdKrgTsJ54TT58oJ-WPS65S_kwcNajqy3wIMFodmRWYftN04hShgSUMQ8hrtuIVt2uMPn6xk_ckF1LZRfp');">
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content" style="padding: 0; overflow: hidden;">
                <div class="livestock-layout">
                    <!-- ==================== LEFT PANEL: Pen Visualization ==================== -->
                    <div class="pen-visualization" id="pen-viz">
                        <!-- Pen Selector Bar -->
                        <div class="pen-selector-bar" id="pen-selector-bar">
                            <!-- Pen cards rendered by livestock.js -->
                            <div class="pen-selector-card pen-selector-card--empty" style="opacity:0.5;">
                                <span class="material-symbols-outlined pen-selector-card__icon">hourglass_empty</span>
                                <span class="pen-selector-card__info">
                                    <span class="pen-selector-card__code">ƒêang t·∫£i...</span>
                                </span>
                            </div>
                        </div>

                        <!-- Canvas Container -->
                        <div class="pen-canvas-container" id="pen-canvas-container">
                            <canvas id="pen-canvas"></canvas>
                        </div>

                        <!-- Canvas Overlays -->
                        <div class="pen-viz-info" id="pen-viz-info">
                            <span class="material-symbols-outlined pen-viz-info__icon">visibility</span>
                            <span id="pen-viz-info-text"></span>
                        </div>

                        <button class="pen-viz-sound-toggle" id="pen-viz-sound-toggle" title="B·∫≠t/T·∫Øt √¢m thanh">
                            <span class="material-symbols-outlined" id="pen-viz-sound-icon">volume_off</span>
                        </button>

                        <div class="pen-viz-legend" id="pen-viz-legend" style="display: none;">
                            <div class="pen-viz-legend__item">
                                <span class="pen-viz-legend__dot pen-viz-legend__dot--healthy"></span>
                                <span>Kh·ªèe m·∫°nh</span>
                            </div>
                            <div class="pen-viz-legend__item">
                                <span class="pen-viz-legend__dot pen-viz-legend__dot--sick"></span>
                                <span>·ªêm</span>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== RIGHT PANEL: Sidebar ==================== -->
                    <aside class="livestock-sidebar">
                        <div class="livestock-sidebar__header">
                            <div class="livestock-sidebar__title">
                                <span class="material-symbols-outlined livestock-sidebar__title-icon">monitoring</span>
                                Chi ti·∫øt chu·ªìng
                            </div>
                            <div id="pen-status-control" style="display:none;" class="status-control">
                                <select id="pen-status-select" onchange="handlePenStatusChange(this.value)">
                                    <option value="CLEAN">S·∫°ch</option>
                                    <option value="DIRTY">C·∫ßn d·ªçn</option>
                                    <option value="SICK">·ªêm</option>
                                    <option value="EMPTY">Tr·ªëng</option>
                                </select>
                            </div>
                        </div>

                        <div class="livestock-sidebar__content">
                            <!-- Empty State -->
                            <div id="empty-pen-state" class="sidebar-empty-state">
                                <span class="material-symbols-outlined sidebar-empty-state__icon">pets</span>
                                <p class="sidebar-empty-state__text">Ch·ªçn m·ªôt chu·ªìng ƒë·ªÉ xem<br>chi ti·∫øt v√† qu·∫£n l√Ω</p>
                            </div>

                            <!-- Detail Content (hidden until pen selected) -->
                            <div id="pen-detail-content" style="display: none;">
                                <!-- Pen Info Card -->
                                <div class="pen-info-card" id="pen-info-card">
                                    <div class="pen-info-card__icon-wrap">
                                        <span class="material-symbols-outlined pen-info-card__icon"
                                            id="pen-info-icon">pets</span>
                                    </div>
                                    <div class="pen-info-card__details">
                                        <div class="pen-info-card__name" id="pen-info-name">--</div>
                                        <div class="pen-info-card__sub">
                                            <span id="pen-info-sub">--</span>
                                            <span class="pen-info-card__badge" id="pen-info-badge">--</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Stat Cards -->
                                <div class="stat-cards-grid" id="stat-cards-grid">
                                    <div class="stat-card stat-card--green">
                                        <span class="material-symbols-outlined stat-card__bg-icon">restaurant</span>
                                        <div class="stat-card__label">Cho ƒÉn</div>
                                        <div class="stat-card__value stat-card__value--green" id="stat-feeding">--</div>
                                    </div>
                                    <div class="stat-card stat-card--amber">
                                        <span class="material-symbols-outlined stat-card__bg-icon">monitor_heart</span>
                                        <div class="stat-card__label">S·ª©c kh·ªèe</div>
                                        <div class="stat-card__value stat-card__value--amber" id="stat-health">--</div>
                                    </div>
                                    <div class="stat-card stat-card--blue">
                                        <span class="material-symbols-outlined stat-card__bg-icon">calendar_today</span>
                                        <div class="stat-card__label">Tu·ªïi nu√¥i</div>
                                        <div class="stat-card__value stat-card__value--blue" id="stat-age">--</div>
                                    </div>
                                    <div class="stat-card stat-card--purple">
                                        <span class="material-symbols-outlined stat-card__bg-icon">trending_up</span>
                                        <div class="stat-card__label">Ti·∫øn ƒë·ªô</div>
                                        <div class="stat-card__value stat-card__value--purple" id="stat-progress">--
                                        </div>
                                    </div>
                                </div>

                                <!-- Management Actions -->
                                <div class="sidebar-section">
                                    <div class="sidebar-section__header">
                                        <div class="sidebar-section__title">
                                            <span class="material-symbols-outlined">tune</span>
                                            Qu·∫£n l√Ω chu·ªìng tr·∫°i
                                        </div>
                                    </div>
                                    <div class="action-buttons-grid">
                                        <button class="action-btn" id="btn-select-animal" onclick="openAddCageModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--amber">
                                                <span class="material-symbols-outlined action-btn__icon">pets</span>
                                            </div>
                                            <span class="action-btn__label">Ch·ªçn v·∫≠t nu√¥i</span>
                                        </button>
                                        <button class="action-btn" id="btn-feed" disabled onclick="openFeedingModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--green">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">restaurant</span>
                                            </div>
                                            <span class="action-btn__label">Cho ƒÉn</span>
                                        </button>
                                        <button class="action-btn" id="btn-clean" disabled onclick="cleanPen()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--blue">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">cleaning_services</span>
                                            </div>
                                            <span class="action-btn__label">V·ªá sinh</span>
                                        </button>
                                        <button class="action-btn" id="btn-vaccine" disabled
                                            onclick="openVaccineModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--purple">
                                                <span class="material-symbols-outlined action-btn__icon">vaccines</span>
                                            </div>
                                            <span class="action-btn__label">Ti√™m ph√≤ng</span>
                                        </button>
                                        <button class="action-btn" id="btn-harvest" disabled
                                            onclick="openHarvestModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--teal">
                                                <span class="material-symbols-outlined action-btn__icon">payments</span>
                                            </div>
                                            <span class="action-btn__label">Thu ho·∫°ch</span>
                                        </button>
                                        <button class="action-btn" id="btn-delete-pen" disabled
                                            onclick="confirmDeletePen()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--red">
                                                <span class="material-symbols-outlined action-btn__icon">delete</span>
                                            </div>
                                            <span class="action-btn__label">X√≥a chu·ªìng</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Advanced Features -->
                                <div class="sidebar-section">
                                    <div class="sidebar-section__header">
                                        <div class="sidebar-section__title">
                                            <span class="material-symbols-outlined">auto_awesome</span>
                                            T√≠nh nƒÉng n√¢ng cao
                                        </div>
                                    </div>
                                    <div class="action-buttons-grid">
                                        <button class="action-btn" onclick="toggleNotificationPanel()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--amber">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">notifications</span>
                                            </div>
                                            <span class="action-btn__label">Th√¥ng b√°o</span>
                                        </button>
                                        <button class="action-btn" onclick="toggleMarketplacePanel()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--green">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">storefront</span>
                                            </div>
                                            <span class="action-btn__label">Th·ªã tr∆∞·ªùng</span>
                                        </button>
                                        <button class="action-btn" id="btn-livestock-analysis" disabled
                                            onclick="openAnalysisModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--blue">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">analytics</span>
                                            </div>
                                            <span class="action-btn__label">Ph√¢n t√≠ch</span>
                                        </button>
                                        <button class="action-btn" onclick="openInventoryModal()">
                                            <div class="action-btn__icon-wrap action-btn__icon-wrap--amber">
                                                <span
                                                    class="material-symbols-outlined action-btn__icon">inventory_2</span>
                                            </div>
                                            <span class="action-btn__label">Kho v·∫≠t t∆∞</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Health Records Timeline -->
                                <div class="sidebar-section">
                                    <div class="sidebar-section__header">
                                        <div class="sidebar-section__title">
                                            <span class="material-symbols-outlined">vaccines</span>
                                            L·ªãch s·ª≠ s·ª©c kh·ªèe
                                        </div>
                                    </div>
                                    <div class="health-timeline" id="health-timeline">
                                        <p class="health-timeline__empty">Ch∆∞a c√≥ d·ªØ li·ªáu s·ª©c kh·ªèe</p>
                                    </div>
                                </div>

                                <!-- Weight Chart -->
                                <div class="sidebar-section">
                                    <div class="sidebar-section__header">
                                        <div class="sidebar-section__title">
                                            <span class="material-symbols-outlined">monitoring</span>
                                            Xu h∆∞·ªõng c√¢n n·∫∑ng
                                        </div>
                                    </div>
                                    <div class="growth-chart-container">
                                        <div id="weight-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>
        </div>
    </div>

    <!-- Feeding Modal - Enhanced Version -->
    <div id="feeding-modal" class="modal">
        <div class="modal__content" style="max-width: 600px;">
            <div class="modal__header">
                <h3 class="modal__title">
                    <span class="material-symbols-outlined" style="color: var(--color-primary);">restaurant</span>
                    Cho ƒÉn
                </h3>
                <button class="modal__close" onclick="closeFeedingModal()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <!-- Pen Info -->
                <div class="feed-pen-info">
                    <div class="feed-pen-info__item">
                        <span class="material-symbols-outlined">home</span>
                        <span id="feed-pen-code">--</span>
                    </div>
                    <div class="feed-pen-info__item">
                        <span class="material-symbols-outlined">pets</span>
                        <span id="feed-animal-name">--</span>
                    </div>
                    <div class="feed-pen-info__item">
                        <span class="material-symbols-outlined">tag</span>
                        <span id="feed-animal-count">-- con</span>
                    </div>
                </div>

                <!-- Feed Selection -->
                <div class="form-group">
                    <label class="form-label">Lo·∫°i th·ª©c ƒÉn</label>
                    <div class="feed-selection-grid" id="feed-selection-grid">
                        <div class="feed-loading">
                            <span class="material-symbols-outlined rotating">sync</span>
                            ƒêang t·∫£i...
                        </div>
                    </div>
                </div>

                <!-- Amount Input -->
                <div class="form-group">
                    <label class="form-label">Kh·ªëi l∆∞·ª£ng cho ƒÉn</label>
                    <div class="feed-amount-row">
                        <input type="number" id="feed-amount" class="form-input" placeholder="0.0" step="0.1">
                        <span class="feed-unit">kg</span>
                        <button type="button" class="btn btn--outline btn--sm" onclick="fillRecommendedAmount()">
                            <span class="material-symbols-outlined">auto_fix_high</span>
                            ƒê·ªÅ xu·∫•t
                        </button>
                    </div>
                    <div class="form-hint" id="feed-amount-hint">
                        <span class="material-symbols-outlined">lightbulb</span>
                        <span id="feed-recommended-text">Ch·ªçn th·ª©c ƒÉn ƒë·ªÉ xem ƒë·ªÅ xu·∫•t</span>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">Ghi ch√∫</label>
                    <textarea id="feed-notes" class="form-input" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                </div>

                <!-- Cost Preview -->
                <div class="feed-cost-preview">
                    <div class="feed-cost-preview__row">
                        <span>ƒê∆°n gi√°:</span>
                        <span id="feed-unit-price">0 ‚Ç´/kg</span>
                    </div>
                    <div class="feed-cost-preview__row feed-cost-preview__row--total">
                        <span>T·ªïng chi ph√≠:</span>
                        <span id="feed-total-cost">0 ‚Ç´</span>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeFeedingModal()">H·ªßy</button>
                <button class="btn btn--primary" onclick="submitFeeding()">
                    <span class="material-symbols-outlined">check</span>
                    X√°c nh·∫≠n cho ƒÉn
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal__content" style="max-width: 400px;">
            <div class="modal__header">
                <h3 class="modal__title">X√°c nh·∫≠n x√≥a</h3>
                <button class="modal__close" onclick="closeConfirmModal()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <p id="confirm-modal-text">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chu·ªìng n√†y kh√¥ng? D·ªØ li·ªáu s·∫Ω kh√¥ng th·ªÉ ph·ª•c h·ªìi.
                </p>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeConfirmModal()">H·ªßy</button>
                <button class="btn btn--danger" id="confirm-modal-btn">X√≥a chu·ªìng</button>
            </div>
        </div>
    </div>

    <!-- Harvest/Sell Modal -->
    <div id="harvest-modal" class="modal">
        <div class="modal__content" style="max-width: 550px;">
            <div class="modal__header">
                <h3 class="modal__title">
                    <span class="material-symbols-outlined" style="color: var(--color-success);">payments</span>
                    Thu ho·∫°ch / B√°n v·∫≠t nu√¥i
                </h3>
                <button class="modal__close" onclick="closeHarvestModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal__body">
                <!-- Pen Summary -->
                <div class="harvest-summary">
                    <div class="harvest-summary__header">
                        <span class="material-symbols-outlined">info</span>
                        <span>Th√¥ng tin chu·ªìng</span>
                    </div>
                    <div class="harvest-summary__grid">
                        <div class="harvest-summary__item">
                            <span class="harvest-summary__label">Lo·∫°i v·∫≠t nu√¥i</span>
                            <span class="harvest-summary__value" id="harvest-animal-name">--</span>
                        </div>
                        <div class="harvest-summary__item">
                            <span class="harvest-summary__label">S·ªë l∆∞·ª£ng hi·ªán c√≥</span>
                            <span class="harvest-summary__value" id="harvest-current-count">-- con</span>
                        </div>
                        <div class="harvest-summary__item">
                            <span class="harvest-summary__label">Ng√†y b·∫Øt ƒë·∫ßu</span>
                            <span class="harvest-summary__value" id="harvest-start-date">--</span>
                        </div>
                        <div class="harvest-summary__item">
                            <span class="harvest-summary__label">Gi√° b√°n tham kh·∫£o</span>
                            <span class="harvest-summary__value harvest-summary__value--highlight"
                                id="harvest-ref-price">-- ‚Ç´/con</span>
                        </div>
                    </div>
                </div>

                <!-- Harvest Form -->
                <div class="harvest-form">
                    <div class="form-group">
                        <label class="form-label">S·ªë l∆∞·ª£ng b√°n <span class="text-error">*</span></label>
                        <div class="input-with-suffix">
                            <input type="number" id="harvest-quantity" class="form-input" min="1" placeholder="0">
                            <span class="input-suffix">con</span>
                        </div>
                        <div class="form-hint" id="harvest-quantity-hint">T·ªëi ƒëa: -- con</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gi√° b√°n th·ª±c t·∫ø <span class="text-error">*</span></label>
                        <div class="input-with-suffix">
                            <input type="number" id="harvest-price" class="form-input" min="0" step="1000"
                                placeholder="0">
                            <span class="input-suffix">‚Ç´/con</span>
                        </div>
                        <div class="form-hint">Nh·∫≠p gi√° b√°n th·ª±c t·∫ø t·∫°i th·ªùi ƒëi·ªÉm giao d·ªãch</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ng∆∞·ªùi mua / ƒê·ªëi t√°c</label>
                        <input type="text" id="harvest-buyer" class="form-input"
                            placeholder="VD: C√¥ng ty ABC, Ch·ª£ ƒë·∫ßu m·ªëi...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea id="harvest-notes" class="form-input" rows="2"
                            placeholder="Ghi ch√∫ th√™m v·ªÅ giao d·ªãch..."></textarea>
                    </div>
                </div>

                <!-- Revenue Preview -->
                <div class="harvest-preview">
                    <div class="harvest-preview__row">
                        <span>S·ªë l∆∞·ª£ng b√°n:</span>
                        <span id="preview-quantity">0 con</span>
                    </div>
                    <div class="harvest-preview__row">
                        <span>ƒê∆°n gi√°:</span>
                        <span id="preview-price">0 ‚Ç´</span>
                    </div>
                    <div class="harvest-preview__row harvest-preview__row--total">
                        <span>T·ªïng thu:</span>
                        <span id="preview-total" class="text-success">0 ‚Ç´</span>
                    </div>
                    <div class="harvest-preview__note">
                        <span class="material-symbols-outlined">account_balance_wallet</span>
                        S·ªë ti·ªÅn s·∫Ω ƒë∆∞·ª£c c·ªông v√†o s·ªë d∆∞ t√†i kho·∫£n
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeHarvestModal()">H·ªßy</button>
                <button class="btn btn--success" id="harvest-submit-btn" onclick="submitHarvest()" disabled>
                    <span class="material-symbols-outlined icon-sm">check_circle</span>
                    X√°c nh·∫≠n b√°n
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal (Light Theme - Connected to Shop Warehouse) -->
    <div class="modal" id="inventory-modal">
        <div class="modal-content inventory-modal-content">
            <div class="modal-header">
                <h3><span class="material-symbols-outlined" style="font-size:20px;">warehouse</span> Kho v·∫≠t t∆∞</h3>
                <span class="close-modal" onclick="closeInventoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Summary Cards -->
                <div class="inventory-summary" id="inventory-summary"></div>

                <!-- Search & View Toggle -->
                <div class="inventory-actions" style="margin-bottom: 16px;">
                    <div style="flex: 1; position: relative;">
                        <span class="material-symbols-outlined" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:20px;">search</span>
                        <input type="text" id="inventory-search" placeholder="T√¨m ki·∫øm v·∫≠t t∆∞..." class="form-input" style="padding-left: 38px;">
                    </div>
                    <div style="display:flex; gap:4px; margin-left:8px;">
                        <button class="inv-view-btn active" data-view="grid" onclick="toggleInventoryView('grid')" title="D·∫°ng l∆∞·ªõi" style="background:#ecfdf5; border:1px solid #a7f3d0; border-radius:8px; padding:8px; cursor:pointer; color:#059669;">
                            <span class="material-symbols-outlined" style="font-size:20px;">grid_view</span>
                        </button>
                        <button class="inv-view-btn" data-view="table" onclick="toggleInventoryView('table')" title="D·∫°ng b·∫£ng" style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:8px; cursor:pointer; color:#6b7280;">
                            <span class="material-symbols-outlined" style="font-size:20px;">table_rows</span>
                        </button>
                    </div>
                    <button class="btn btn--primary" onclick="showAddInventoryForm()" style="margin-left:8px;">
                        <span class="material-symbols-outlined">add</span> Nh·∫≠p kho
                    </button>
                </div>

                <!-- Category Tabs -->
                <div class="inv-category-tabs" id="inventory-category-tabs"></div>

                <!-- Grid View -->
                <div class="inventory-grid-container">
                    <div class="inventory-grid" id="inventory-grid-view"></div>
                </div>

                <!-- Table View (hidden by default) -->
                <div class="inventory-list-container" style="display:none;">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>T√™n v·∫≠t t∆∞</th>
                                <th>Lo·∫°i</th>
                                <th>T·ªìn kho</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Gi√° tr·ªã</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>

                <!-- Add/Edit Form Overlay -->
                <div id="inventory-form-overlay" class="inventory-overlay" style="display: none;">
                    <div class="inventory-form-card">
                        <h4 id="inv-form-title"><span class="material-symbols-outlined">add_shopping_cart</span> Nh·∫≠p kho v·∫≠t t∆∞ m·ªõi</h4>
                        <div class="inv-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button type="button" id="tab-catalog" class="inv-tab active" onclick="switchInventoryTab('catalog')">
                                <span class="material-symbols-outlined">storefront</span> Ch·ªçn t·ª´ Catalog
                            </button>
                            <button type="button" id="tab-custom" class="inv-tab" onclick="switchInventoryTab('custom')">
                                <span class="material-symbols-outlined">edit_note</span> T·ª± nh·∫≠p
                            </button>
                        </div>
                        <form id="inventory-form" onsubmit="handleInventorySubmit(event)">
                            <input type="hidden" id="inv-id">
                            <div id="catalog-mode">
                                <div class="form-group">
                                    <label>Lo·∫°i v·∫≠t t∆∞</label>
                                    <select id="inv-catalog-type" class="form-select" onchange="loadCatalogItems()">
                                        <option value="FERTILIZER">üå± Ph√¢n b√≥n</option>
                                        <option value="PESTICIDE">ü¶ü Thu·ªëc BVTV</option>
                                        <option value="SEED">üåæ H·∫°t gi·ªëng</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ch·ªçn s·∫£n ph·∫©m</label>
                                    <select id="inv-catalog-product" class="form-select" onchange="fillProductInfo()">
                                        <option value="">-- ƒêang t·∫£i --</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>S·ªë l∆∞·ª£ng nh·∫≠p</label>
                                        <input type="number" id="inv-catalog-quantity" required class="form-input" min="1" step="0.1" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label>ƒê∆°n gi√° (VNƒê)</label>
                                        <input type="number" id="inv-catalog-cost" required class="form-input" min="0" readonly>
                                    </div>
                                </div>
                                <div class="inv-product-preview" id="inv-product-preview" style="display: none;">
                                    <div class="preview-name" id="preview-name"></div>
                                    <div class="preview-desc" id="preview-desc"></div>
                                </div>
                            </div>
                            <div id="custom-mode" style="display: none;">
                                <div class="form-group">
                                    <label>T√™n v·∫≠t t∆∞</label>
                                    <input type="text" id="inv-name" class="form-input" placeholder="VD: Th·ª©c ƒÉn h·ªón h·ª£p">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Lo·∫°i</label>
                                        <select id="inv-type" class="form-select">
                                            <option value="FERTILIZER">Ph√¢n b√≥n</option>
                                            <option value="PESTICIDE">Thu·ªëc BVTV</option>
                                            <option value="SEED">H·∫°t gi·ªëng</option>
                                            <option value="OTHER">Kh√°c</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>ƒê∆°n v·ªã t√≠nh</label>
                                        <input type="text" id="inv-unit" class="form-input" placeholder="kg, chai, bao">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>S·ªë l∆∞·ª£ng</label>
                                        <input type="number" id="inv-quantity" class="form-input" min="0" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>ƒê∆°n gi√°/ƒë∆°n v·ªã</label>
                                        <input type="number" id="inv-cost" class="form-input" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ng∆∞·ª°ng c·∫£nh b√°o (Min)</label>
                                <input type="number" id="inv-threshold" class="form-input" value="10">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn--secondary" onclick="hideAddInventoryForm()">H·ªßy</button>
                                <button type="submit" class="btn btn--primary">
                                    <span class="material-symbols-outlined">add_shopping_cart</span> Nh·∫≠p kho
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Panel Overlay Backdrop -->
    <div class="feature-panel-overlay" id="feature-overlay" onclick="closeAllFeaturePanels()"></div>

    <!-- Notification Panel (Upgraded) -->
    <div class="feature-panel" id="notification-panel">
        <div class="notif-panel-header">
            <div class="notif-panel-header__left">
                <span class="material-symbols-outlined notif-panel-header__icon">notifications_active</span>
                <h4>Th√¥ng b√°o</h4>
                <span class="notif-panel-header__count" id="notif-header-count"></span>
            </div>
            <div class="notif-panel-header__actions">
                <button class="notif-panel-header__btn" onclick="markAllNotificationsRead()" title="ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc">
                    <span class="material-symbols-outlined">done_all</span>
                </button>
                <button class="notif-panel-header__btn" onclick="toggleNotificationPanel()" title="ƒê√≥ng">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>
        <div class="notif-panel-tabs">
            <button class="notif-tab active" data-tab="all" onclick="filterNotifications('all')">
                T·∫•t c·∫£
            </button>
            <button class="notif-tab" data-tab="unread" onclick="filterNotifications('unread')">
                Ch∆∞a ƒë·ªçc
            </button>
        </div>
        <div class="notif-panel-body" id="notification-list">
            <!-- Notifications rendered by JS -->
        </div>
    </div>

    <!-- Marketplace Panel (Redesigned) -->
    <div class="feature-panel" id="marketplace-panel">
        <div class="feature-panel__header">
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="material-symbols-outlined text-green">candlestick_chart</span>
                <h4>Th·ªã tr∆∞·ªùng V·∫≠t nu√¥i</h4>
            </div>
            <button onclick="toggleMarketplacePanel()" class="close-btn" style="color:white; opacity:0.7;">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="feature-panel__content">
            <div class="market-layout">
                <!-- Sidebar: Tickers -->
                <div class="market-sidebar">
                    <div style="padding:12px; border-bottom:1px solid #334155;">
                        <input type="text" placeholder="T√¨m v·∫≠t nu√¥i..."
                            oninput="filterAnimalTickers(this.value)"
                            style="width:100%; background:#0f172a; border:1px solid #334155; padding:8px; border-radius:4px; color:white;">
                    </div>
                    <div class="market-ticker-list" id="market-ticker-list">
                        <div style="padding:20px; text-align:center; color:#64748b;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>

                <!-- Main: Chart -->
                <div class="market-main">
                    <div id="market-detail-container" style="display:none; height:100%; flex-direction:column;">
                        <div class="chart-header">
                            <div class="coin-info">
                                <div class="coin-icon" id="detail-icon">üêî</div>
                                <div class="coin-details">
                                    <h2 id="detail-name">G√†</h2>
                                    <span id="detail-category" style="color:#94a3b8; font-size:13px;">Gia s√∫c/gia c·∫ßm</span>
                                </div>
                            </div>
                            <div class="coin-stats">
                                <div class="stat-box">
                                    <div class="stat-label">Gi√° b√°n/con</div>
                                    <div class="stat-value" id="detail-price">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Bi·∫øn ƒë·ªông (7 ng√†y)</div>
                                    <div class="stat-value" id="detail-change">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Cao nh·∫•t (30 ng√†y)</div>
                                    <div class="stat-value" id="detail-high">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Th·∫•p nh·∫•t (30 ng√†y)</div>
                                    <div class="stat-value" id="detail-low">---</div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Div -->
                        <div id="price-chart" style="flex:1; width:100%; min-height:400px;"></div>
                    </div>

                    <div id="market-empty-state"
                        style="display:flex; flex:1; align-items:center; justify-content:center; flex-direction:column; color:#64748b;">
                        <span class="material-symbols-outlined"
                            style="font-size:64px; margin-bottom:16px; opacity:0.5;">monitoring</span>
                        <p>Ch·ªçn m·ªôt lo·∫°i v·∫≠t nu√¥i ƒë·ªÉ xem bi·ªÉu ƒë·ªì gi√°</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/animations.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/charts.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/smart-advisor.js"></script>
    <script src="../js/ai_analysis.js"></script>
    <script src="../js/pen-simulation.js"></script>
    <script src="../js/features.js"></script>
    <script src="../js/inventory.js"></script>
    <script src="../js/livestock.js"></script>
    <script src="../js/main.js"></script>
</body>

</html>