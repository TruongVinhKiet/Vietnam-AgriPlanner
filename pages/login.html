<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPlanner - Đăng nhập</title>
    <meta name="description" content="Đăng nhập vào hệ thống quản lý nông trại AgriPlanner">
    <link rel="icon" type="image/x-icon" href="../images/logo.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">

    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/auth.css">
    <link rel="stylesheet" href="../css/chatbot.css">

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body data-page="login">
    <div class="auth-container">
        <!-- Left Panel - Hero -->
        <div class="auth-hero">
            <div class="auth-hero__bg">
                <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=1600" alt="Nông trại"
                    class="auth-hero__bg-image">
                <div class="auth-hero__overlay"></div>
            </div>

            <div class="auth-hero__logo">
                <div class="auth-hero__logo-icon" style="background: none; border: none;">
                    <img src="../images/logo.png" alt="AgriPlanner Logo"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <span class="auth-hero__logo-text">AgriPlanner</span>
            </div>

            <div class="auth-hero__content">
                <div class="auth-testimonials" id="login-testimonials">
                    <!-- Slide 1 -->
                    <div class="auth-testimonial-slide active">
                        <div class="auth-hero__stars">
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                        </div>
                        <blockquote class="auth-hero__quote">
                            "AgriPlanner đã giúp tôi tăng năng suất 40% trong năm đầu tiên. Giao diện trực quan và dữ liệu phân tích đáng kinh ngạc."
                        </blockquote>
                        <p class="auth-hero__author">Nguyễn Văn Minh</p>
                        <p class="auth-hero__author-role">Chủ trang trại, Đồng bằng sông Cửu Long</p>
                    </div>

                    <!-- Slide 2 -->
                    <div class="auth-testimonial-slide">
                        <div class="auth-hero__stars">
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                        </div>
                        <blockquote class="auth-hero__quote">
                            "Từ khi dùng AgriPlanner, việc theo dõi vụ mùa và quản lý nhân công trở nên dễ dàng hơn bao giờ hết. Tiết kiệm rất nhiều thời gian."
                        </blockquote>
                        <p class="auth-hero__author">Lê Thị Thanh Hương</p>
                        <p class="auth-hero__author-role">Chủ trang trại hữu cơ, Lâm Đồng</p>
                    </div>

                    <!-- Slide 3 -->
                    <div class="auth-testimonial-slide">
                        <div class="auth-hero__stars">
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                        </div>
                        <blockquote class="auth-hero__quote">
                            "Hệ thống dự báo thời tiết và cảnh báo sâu bệnh của AgriPlanner đã giúp chúng tôi giảm thiểu thiệt hại đáng kể trong mùa mưa năm ngoái."
                        </blockquote>
                        <p class="auth-hero__author">Phạm Hữu Đức</p>
                        <p class="auth-hero__author-role">Giám đốc Hợp tác xã, An Giang</p>
                    </div>

                    <!-- Slide 4 -->
                    <div class="auth-testimonial-slide">
                        <div class="auth-hero__stars">
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                        </div>
                        <blockquote class="auth-hero__quote">
                            "Tính năng phân tích tài chính giúp tôi nắm rõ lãi lỗ từng vụ. Đầu tư vào AgriPlanner là quyết định đúng đắn nhất của tôi."
                        </blockquote>
                        <p class="auth-hero__author">Võ Thị Mai Lan</p>
                        <p class="auth-hero__author-role">Nông dân sản xuất giỏi, Bến Tre</p>
                    </div>

                    <!-- Slide 5 -->
                    <div class="auth-testimonial-slide">
                        <div class="auth-hero__stars">
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                            <span class="material-symbols-outlined auth-hero__star">star</span>
                        </div>
                        <blockquote class="auth-hero__quote">
                            "Quản lý 50 hecta vườn cà phê chưa bao giờ hiệu quả đến vậy. AgriPlanner giúp tôi lập kế hoạch canh tác khoa học và chính xác."
                        </blockquote>
                        <p class="auth-hero__author">Trần Quốc Bảo</p>
                        <p class="auth-hero__author-role">Chủ trang trại cà phê, Đắk Lắk</p>
                    </div>
                </div>

                <div class="auth-carousel-dots" id="login-carousel-dots">
                    <button class="auth-carousel-dot active" data-index="0"></button>
                    <button class="auth-carousel-dot" data-index="1"></button>
                    <button class="auth-carousel-dot" data-index="2"></button>
                    <button class="auth-carousel-dot" data-index="3"></button>
                    <button class="auth-carousel-dot" data-index="4"></button>
                </div>

                <div class="auth-hero__stats">
                    <div class="auth-stat">
                        <p class="auth-stat__value">10K+</p>
                        <p class="auth-stat__label">Nông trại tin dùng</p>
                    </div>
                    <div class="auth-stat">
                        <p class="auth-stat__value">99%</p>
                        <p class="auth-stat__label">Đánh giá tích cực</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Login Form -->
        <div class="auth-form-panel">
            <!-- Mobile Logo -->
            <div class="auth-mobile-logo">
                <div class="auth-mobile-logo__icon">
                    <span class="material-symbols-outlined">eco</span>
                </div>
                <span class="auth-mobile-logo__text">AgriPlanner</span>
            </div>

            <form class="auth-form" id="login-form">
                <div class="auth-form__header">
                    <h1 class="auth-form__title">Chào mừng trở lại</h1>
                    <p class="auth-form__subtitle">
                        Chưa có tài khoản? <a href="register.html">Đăng ký miễn phí</a>
                    </p>
                </div>

                <div class="auth-form__fields">
                    <div class="auth-form__field">
                        <label class="auth-form__label" for="email">Email</label>
                        <div class="auth-form__input-wrapper">
                            <input type="email" id="email" class="auth-form__input" placeholder="Nhập email" required>
                            <span class="material-symbols-outlined auth-form__input-icon">mail</span>
                        </div>
                    </div>

                    <div class="auth-form__field">
                        <label class="auth-form__label" for="password">Mật khẩu</label>
                        <div class="auth-form__input-wrapper">
                            <input type="password" id="password" class="auth-form__input" placeholder="Nhập mật khẩu"
                                required>
                            <span class="material-symbols-outlined auth-form__input-icon" id="toggle-password"
                                style="cursor: pointer;">visibility_off</span>
                        </div>
                    </div>

                    <div class="auth-form__options">
                        <label class="auth-form__remember">
                            <input type="checkbox" class="auth-form__remember-checkbox">
                            <span class="auth-form__remember-label">Ghi nhớ đăng nhập</span>
                        </label>
                        <a href="#" class="auth-form__forgot">Quên mật khẩu?</a>
                    </div>
                </div>

                <button type="submit" class="btn btn--primary auth-form__submit">
                    Đăng nhập
                </button>

                <div class="auth-form__divider">
                    <div class="auth-form__divider-line"></div>
                    <span class="auth-form__divider-text">hoặc</span>
                </div>

                <div class="auth-form__social-buttons">
                    <button type="button" class="auth-form__social auth-form__social--google" id="btn-google-login">
                        <svg class="auth-form__social-icon" viewBox="0 0 24 24">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                        </svg>
                        <span class="auth-form__social-text">Đăng nhập với Google</span>
                    </button>

                    <button type="button" class="auth-form__social auth-form__social--facebook" id="btn-facebook-login">
                        <svg class="auth-form__social-icon" viewBox="0 0 24 24">
                            <path fill="#1877F2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        <span class="auth-form__social-text">Đăng nhập với Facebook</span>
                    </button>

                    <button type="button" class="auth-form__social auth-form__social--github" id="btn-github-login">
                        <svg class="auth-form__social-icon" viewBox="0 0 24 24">
                            <path fill="#333" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        <span class="auth-form__social-text">Đăng nhập với GitHub</span>
                    </button>

                    <button type="button" class="auth-form__social auth-form__social--face" id="btn-face-login">
                        <span class="material-symbols-outlined auth-form__social-icon" style="width:auto;height:auto;font-size:20px;color:#8b5cf6;">face</span>
                        <span class="auth-form__social-text">Đăng nhập bằng khuôn mặt</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/animations.js"></script>

    <!-- face-api.js for face detection -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        // ============================================
        // CONSTANTS
        // ============================================
        const API_URL = 'http://localhost:8080/api/auth';
        const FACE_SERVICE_URL = 'http://localhost:5001';
        const GOOGLE_CLIENT_ID = '546685859099-lkr6apepqtt1le90p7dqnsnouh9p2e0g.apps.googleusercontent.com';
        const FACEBOOK_APP_ID = '732046953176825';
        const GITHUB_CLIENT_ID = 'Ov23li1eRKn4dyaATfHh';

        // ============================================
        // TOGGLE PASSWORD
        // ============================================
        document.getElementById('toggle-password').addEventListener('click', function () {
            const passwordInput = document.getElementById('password');
            const icon = this;
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility_off';
            }
        });

        // ============================================
        // GOOGLE LOGIN (Server-side redirect flow)
        // ============================================
        document.getElementById('btn-google-login').addEventListener('click', function() {
            const redirectUri = window.location.origin + '/pages/login.html';
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=openid%20email%20profile&state=google_login&access_type=offline&prompt=consent`;
            window.location.href = googleAuthUrl;
        });

        async function loginWithGoogle(code) {
            const redirectUri = window.location.origin + '/pages/login.html';
            try {
                const response = await fetch(`${API_URL}/google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, redirectUri })
                });
                const data = await response.json();

                if (data.success) {
                    storeAuthAndRedirect(data);
                } else {
                    if (data.message === 'NEEDS_REGISTRATION') {
                        showErrorModal('Chưa có tài khoản', 'Tài khoản Google này chưa được đăng ký. Vui lòng <a href="register.html">đăng ký</a> trước.');
                    } else if (data.adminLocked) {
                        showAdminLockedModal(data.message, data.lockReason, data.email || '');
                    } else if (data.accountLocked) {
                        showErrorModal('Tài khoản đã bị khóa!', data.message, true, data.email || '');
                    } else {
                        showErrorModal('Đăng nhập Google thất bại', data.message);
                    }
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến máy chủ.');
            }
        }

        // ============================================
        // FACEBOOK LOGIN (Server-side redirect flow)
        // ============================================
        document.getElementById('btn-facebook-login').addEventListener('click', function() {
            const redirectUri = window.location.origin + '/pages/login.html';
            const facebookAuthUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${FACEBOOK_APP_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=public_profile,email&state=facebook_login`;
            window.location.href = facebookAuthUrl;
        });

        async function loginWithFacebook(code) {
            const redirectUri = window.location.origin + '/pages/login.html';
            try {
                const response = await fetch(`${API_URL}/facebook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, redirectUri })
                });
                const data = await response.json();

                if (data.success) {
                    storeAuthAndRedirect(data);
                } else {
                    if (data.message === 'NEEDS_REGISTRATION') {
                        showErrorModal('Chưa có tài khoản', 'Tài khoản Facebook này chưa được đăng ký. Vui lòng <a href="register.html">đăng ký</a> trước.');
                    } else if (data.adminLocked) {
                        showAdminLockedModal(data.message, data.lockReason, data.email || '');
                    } else if (data.accountLocked) {
                        showErrorModal('Tài khoản đã bị khóa!', data.message, true, data.email || '');
                    } else {
                        showErrorModal('Đăng nhập Facebook thất bại', data.message);
                    }
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến máy chủ.');
            }
        }

        // ============================================
        // GITHUB LOGIN
        // ============================================
        document.getElementById('btn-github-login').addEventListener('click', function() {
            const redirectUri = window.location.origin + '/pages/login.html';
            const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=read:user%20user:email&state=login`;
            window.location.href = githubAuthUrl;
        });

        // Handle OAuth callbacks (GitHub, Google, Facebook)
        (function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (!code || !state) return;

            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);

            if (state === 'login') {
                // Legacy GitHub login
                loginWithGithub(code);
            } else if (state === 'google_login') {
                loginWithGoogle(code);
            } else if (state === 'facebook_login') {
                loginWithFacebook(code);
            } else if (state === 'register' || state === 'google_register' || state === 'facebook_register') {
                // Forward to register.html
                window.location.href = `register.html?code=${encodeURIComponent(code)}&state=${state}`;
                return;
            }
        })();

        async function loginWithGithub(code) {
            try {
                const response = await fetch(`${API_URL}/github`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();

                if (data.success) {
                    storeAuthAndRedirect(data);
                } else {
                    if (data.message === 'NEEDS_REGISTRATION') {
                        showErrorModal('Chưa có tài khoản', 'Tài khoản GitHub này chưa được đăng ký. Vui lòng <a href="register.html">đăng ký</a> trước.');
                    } else if (data.adminLocked) {
                        showAdminLockedModal(data.message, data.lockReason, data.email || '');
                    } else if (data.accountLocked) {
                        showErrorModal('Tài khoản đã bị khóa!', data.message, true, data.email || '');
                    } else {
                        showErrorModal('Đăng nhập GitHub thất bại', data.message);
                    }
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến máy chủ.');
            }
        }

        // ============================================
        // FACE LOGIN
        // ============================================
        document.getElementById('btn-face-login').addEventListener('click', function() {
            showFaceLoginModal();
        });

        function showFaceLoginModal() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.remove());

            const html = `
                <div id="face-login-modal" class="modal-overlay">
                    <div class="modal-content" style="max-width: 520px;">
                        <div class="modal-header">
                            <h3 style="display: flex; align-items: center; gap: 8px;">
                                <span class="material-symbols-outlined" style="color: #8b5cf6;">face</span>
                                Đăng nhập bằng khuôn mặt
                            </h3>
                            <p>Chọn phương thức nhận diện khuôn mặt</p>
                        </div>
                        <div class="modal-body">
                            <div id="face-login-options" style="display: flex; flex-direction: column; gap: 12px;">
                                <button onclick="startFaceCamera()" class="btn btn--primary" style="display: flex; align-items: center; justify-content: center; gap: 8px; height: 48px;">
                                    <span class="material-symbols-outlined">videocam</span> Sử dụng camera
                                </button>
                                <button onclick="uploadFacePhoto()" class="btn btn--secondary" style="display: flex; align-items: center; justify-content: center; gap: 8px; height: 48px;">
                                    <span class="material-symbols-outlined">photo_camera</span> Tải ảnh lên
                                </button>
                                <input type="file" id="face-upload-input" accept="image/*" style="display:none;">
                            </div>

                            <div id="face-camera-container" style="display:none;">
                                <video id="face-video" autoplay playsinline style="width:100%; border-radius:12px; background:#000;"></video>
                                <canvas id="face-canvas" style="display:none;"></canvas>
                                <div id="face-detection-status" style="text-align:center; margin-top:8px; font-size:13px; color:#6b7280;">
                                    Đang tải mô hình nhận diện...
                                </div>
                                <div style="display:flex; gap:12px; margin-top:12px;">
                                    <button onclick="captureFaceForLogin()" id="btn-capture-face" class="btn btn--primary" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px;" disabled>
                                        <span class="material-symbols-outlined">photo_camera</span> Chụp & Đăng nhập
                                    </button>
                                    <button onclick="stopFaceCamera()" class="btn btn--secondary" style="flex:0 0 auto;">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </div>

                            <div id="face-processing" style="display:none; text-align:center; padding:24px;">
                                <div id="face-scan-animation" style="position:relative; width:200px; height:200px; margin:0 auto;">
                                    <!-- Outer ring -->
                                    <div style="position:absolute; inset:0; border:3px solid #e5e7eb; border-radius:50%;"></div>
                                    <!-- Scanning ring -->
                                    <div class="face-scan-ring" style="position:absolute; inset:0; border:3px solid transparent; border-top-color:#8b5cf6; border-right-color:#8b5cf6; border-radius:50%;"></div>
                                    <!-- Inner ring -->
                                    <div class="face-scan-ring-inner" style="position:absolute; inset:16px; border:2px solid transparent; border-bottom-color:#a78bfa; border-left-color:#a78bfa; border-radius:50%;"></div>
                                    <!-- Scan line -->
                                    <div class="face-scan-line" style="position:absolute; left:20px; right:20px; height:2px; background:linear-gradient(90deg, transparent, #8b5cf6, transparent); top:50%;"></div>
                                    <!-- Center face icon -->
                                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                                        <span class="material-symbols-outlined face-scan-pulse" style="font-size:56px; color:#8b5cf6;">face</span>
                                    </div>
                                    <!-- Corner markers -->
                                    <div style="position:absolute; top:30px; left:30px; width:20px; height:20px; border-left:3px solid #8b5cf6; border-top:3px solid #8b5cf6; border-radius:4px 0 0 0;"></div>
                                    <div style="position:absolute; top:30px; right:30px; width:20px; height:20px; border-right:3px solid #8b5cf6; border-top:3px solid #8b5cf6; border-radius:0 4px 0 0;"></div>
                                    <div style="position:absolute; bottom:30px; left:30px; width:20px; height:20px; border-left:3px solid #8b5cf6; border-bottom:3px solid #8b5cf6; border-radius:0 0 0 4px;"></div>
                                    <div style="position:absolute; bottom:30px; right:30px; width:20px; height:20px; border-right:3px solid #8b5cf6; border-bottom:3px solid #8b5cf6; border-radius:0 0 4px 0;"></div>
                                </div>
                                <p id="face-scan-status" style="margin-top:16px; color:#6b7280; font-size:14px;">Đang nhận diện khuôn mặt...</p>
                                <div id="face-scan-progress" style="margin-top:12px; height:4px; background:#e5e7eb; border-radius:2px; overflow:hidden;">
                                    <div class="face-scan-progress-bar" style="height:100%; width:0%; background:linear-gradient(90deg, #8b5cf6, #a78bfa); border-radius:2px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeFaceLoginModal()" class="btn btn--secondary">Đóng</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);

            // Setup file upload handler
            document.getElementById('face-upload-input').addEventListener('change', handleFaceUpload);

            if (typeof gsap !== 'undefined') {
                gsap.fromTo('#face-login-modal .modal-content', { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3, ease: 'back.out(1.5)' });
            }
        }

        let faceStream = null;
        let faceModelsLoaded = false;

        async function loadFaceModels() {
            if (faceModelsLoaded) return true;
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                faceModelsLoaded = true;
                return true;
            } catch (error) {
                console.error('Failed to load face models:', error);
                return false;
            }
        }

        async function startFaceCamera() {
            const optionsDiv = document.getElementById('face-login-options');
            const cameraDiv = document.getElementById('face-camera-container');
            const statusDiv = document.getElementById('face-detection-status');

            if (optionsDiv) optionsDiv.style.display = 'none';
            if (cameraDiv) cameraDiv.style.display = 'block';

            // Load face models
            statusDiv.textContent = 'Đang tải mô hình nhận diện...';
            const loaded = await loadFaceModels();
            if (!loaded) {
                statusDiv.textContent = 'Không thể tải mô hình. Vui lòng thử tải ảnh lên.';
                return;
            }

            try {
                faceStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                const video = document.getElementById('face-video');
                video.srcObject = faceStream;
                statusDiv.textContent = 'Đưa khuôn mặt vào giữa camera...';

                // Start face detection loop
                video.onloadeddata = () => detectFaceInVideo();
            } catch (error) {
                console.error('Camera error:', error);
                statusDiv.textContent = 'Không thể truy cập camera. Vui lòng thử tải ảnh lên.';
            }
        }

        async function detectFaceInVideo() {
            const video = document.getElementById('face-video');
            const statusDiv = document.getElementById('face-detection-status');
            const captureBtn = document.getElementById('btn-capture-face');

            if (!video || !faceStream) return;

            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());

            if (detection) {
                statusDiv.innerHTML = '<span style="color:#10b981;">✓ Phát hiện khuôn mặt - Nhấn "Chụp & Đăng nhập"</span>';
                if (captureBtn) captureBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Đưa khuôn mặt vào giữa camera...';
                if (captureBtn) captureBtn.disabled = true;
            }

            if (faceStream) {
                requestAnimationFrame(detectFaceInVideo);
            }
        }

        async function captureFaceForLogin() {
            const video = document.getElementById('face-video');
            const canvas = document.getElementById('face-canvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            stopFaceCamera();

            // Show processing
            const cameraDiv = document.getElementById('face-camera-container');
            const processingDiv = document.getElementById('face-processing');
            if (cameraDiv) cameraDiv.style.display = 'none';
            if (processingDiv) processingDiv.style.display = 'block';

            // Convert to blob and send to face service
            canvas.toBlob(async (blob) => {
                await matchFaceForLogin(blob);
            }, 'image/jpeg', 0.92);
        }

        function uploadFacePhoto() {
            document.getElementById('face-upload-input').click();
        }

        async function handleFaceUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const optionsDiv = document.getElementById('face-login-options');
            const processingDiv = document.getElementById('face-processing');
            if (optionsDiv) optionsDiv.style.display = 'none';
            if (processingDiv) processingDiv.style.display = 'block';

            await matchFaceForLogin(file);
        }

        async function matchFaceForLogin(imageBlob) {
            try {
                const statusEl = document.getElementById('face-scan-status');

                // Step 1: Send image to Python face service for encoding
                if (statusEl) statusEl.textContent = 'Đang phân tích khuôn mặt...';
                const formData = new FormData();
                formData.append('file', imageBlob, 'face.jpg');

                const encodeRes = await fetch(`${FACE_SERVICE_URL}/encode`, {
                    method: 'POST',
                    body: formData
                });
                const encodeData = await encodeRes.json();

                if (!encodeData.success) {
                    closeFaceLoginModal();
                    showErrorModal('Nhận diện thất bại', encodeData.error || 'Không thể nhận diện khuôn mặt');
                    return;
                }

                // Step 2: Match encoding against registered users
                if (statusEl) statusEl.textContent = 'Đang so khớp với cơ sở dữ liệu...';
                const matchRes = await fetch(`${FACE_SERVICE_URL}/match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ encoding: encodeData.encoding })
                });
                const matchData = await matchRes.json();

                if (matchData.matched) {
                    if (statusEl) statusEl.innerHTML = `<span style="color:#10b981;">✓ Nhận diện thành công: <strong>${matchData.fullName || matchData.email}</strong></span>`;

                    // Brief pause to show matched user
                    await new Promise(r => setTimeout(r, 1000));

                    // Step 3: Login with matched email
                    if (statusEl) statusEl.textContent = 'Đang đăng nhập...';
                    const loginRes = await fetch(`${API_URL}/face/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: matchData.email })
                    });
                    const loginData = await loginRes.json();

                    closeFaceLoginModal();

                    if (loginData.success) {
                        storeAuthAndRedirect(loginData);
                    } else {
                        showErrorModal('Đăng nhập thất bại', loginData.message);
                    }
                } else {
                    closeFaceLoginModal();
                    showErrorModal('Không tìm thấy', matchData.message || 'Khuôn mặt không khớp với tài khoản nào. Vui lòng đăng ký khuôn mặt trong Cài đặt.');
                }
            } catch (error) {
                console.error('Face login error:', error);
                closeFaceLoginModal();
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến dịch vụ nhận diện khuôn mặt. Hãy đảm bảo dịch vụ đang chạy.');
            }
        }

        function stopFaceCamera() {
            if (faceStream) {
                faceStream.getTracks().forEach(track => track.stop());
                faceStream = null;
            }
        }

        function closeFaceLoginModal() {
            stopFaceCamera();
            const modal = document.getElementById('face-login-modal');
            if (modal) modal.remove();
        }

        // ============================================
        // FORGOT PASSWORD
        // ============================================
        document.querySelector('.auth-form__forgot').addEventListener('click', function (e) {
            e.preventDefault();
            showForgotPasswordModal();
        });

        function showForgotPasswordModal() {
            const html = `
                <div id="forgot-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Quên mật khẩu?</h3>
                            <p>Nhập email để nhận mã xác thực đặt lại mật khẩu</p>
                        </div>
                        <div class="modal-body">
                            <input type="email" id="forgot-email" class="modal-input" placeholder="Nhập email của bạn">
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('forgot-modal').remove()" class="btn btn--secondary">Hủy</button>
                            <button onclick="requestForgotOtp()" class="btn btn--primary">Gửi mã</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function requestForgotOtp() {
            const email = document.getElementById('forgot-email').value;
            if (!email) return alert("Vui lòng nhập email");

            try {
                const response = await fetch(`${API_URL}/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();

                document.getElementById('forgot-modal').remove();
                if (response.ok) {
                    showResetPasswordModal(email);
                } else {
                    showErrorModal('Lỗi', data.message);
                }
            } catch (e) {
                console.error(e);
                showErrorModal('Lỗi', 'Không thể gửi yêu cầu');
            }
        }

        function showResetPasswordModal(email) {
            const html = `
                <div id="reset-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Đặt lại mật khẩu</h3>
                            <p>Nhập mã OTP và mật khẩu mới cho ${email}</p>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="reset-otp" class="modal-input modal-otp-input" placeholder="OTP" maxlength="6">
                            <input type="password" id="reset-new-pass" class="modal-input" placeholder="Mật khẩu mới">
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('reset-modal').remove()" class="btn btn--secondary">Hủy</button>
                            <button onclick="submitResetPassword('${email}')" class="btn btn--primary">Đổi mật khẩu</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function submitResetPassword(email) {
            const otp = document.getElementById('reset-otp').value;
            const newPassword = document.getElementById('reset-new-pass').value;

            try {
                const response = await fetch(`${API_URL}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, newPassword })
                });
                const data = await response.json();

                document.getElementById('reset-modal').remove();
                if (response.ok) {
                    showErrorModal('Thành công', 'Mật khẩu đã được đặt lại. Vui lòng đăng nhập.');
                } else {
                    showErrorModal('Thất bại', data.message);
                }
            } catch (e) {
                console.error(e);
                showErrorModal('Lỗi', 'Không thể đặt lại mật khẩu');
            }
        }

        // ... (existing socket/animation code can stay, ensuring no duplicate listeners) ...

        // Form animation on load
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof gsap !== 'undefined') {
                gsap.fromTo('.auth-form',
                    { opacity: 0, y: 30 },
                    { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }
                );

                gsap.fromTo('.auth-hero__content',
                    { opacity: 0, x: -30 },
                    { opacity: 1, x: 0, duration: 0.6, delay: 0.2, ease: 'power2.out' }
                );
            }
        });

        // ... (login form submit handler) ...
        document.getElementById('login-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.querySelector('.auth-form__submit');

            // Loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-symbols-outlined spinning">sync</span> Đang xử lý...';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    storeAuthAndRedirect(data);
                } else {
                    if (data.adminLocked) {
                        showAdminLockedModal(data.message, data.lockReason, email);
                    } else if (data.accountLocked) {
                        showErrorModal('Tài khoản đã bị khóa!', data.message, true, email);
                    } else if (data.requiresTwoFactor) {
                        show2faModal(email, password);
                    } else {
                        showErrorModal('Đăng nhập thất bại', data.message || 'Email hoặc mật khẩu không chính xác');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Đăng nhập';
            }
        });

        // ... (rest of helper functions) ...
        function storeAuthAndRedirect(data) {
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('userId', data.userId ? String(data.userId) : '');
            localStorage.setItem('userEmail', data.email);
            localStorage.setItem('userName', data.fullName);
            localStorage.setItem('userRole', data.role);
            localStorage.setItem('userAvatar', data.avatarUrl || ''); // Store avatar
            redirectUser(data.role);
        }

        function redirectUser(role) {
            if (role === 'SYSTEM_ADMIN') {
                window.location.href = 'admin.html';
            } else if (role === 'WORKER') {
                window.location.href = 'worker_dashboard.html';
            } else {
                // OWNER and any other role → main dashboard
                window.location.href = '../index.html';
            }
        }

        // ... (rest of existing functions: show2faModal, verify2faLogin, showErrorModal, requestUnlock, etc) ...

        let pending2FA = { email: null, password: null };

        function show2faModal(email, password) {
            pending2FA = { email, password };
            const html = `
                <div id="2fa-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Xác thực 2 bước</h3>
                            <p>Nhập mã xác thực từ ứng dụng Google Authenticator</p>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="2fa-code-input" class="modal-input modal-otp-input" placeholder="------" maxlength="6">
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('2fa-modal').remove()" class="btn btn--secondary">Hủy</button>
                            <button onclick="verify2faLogin()" class="btn btn--primary">Xác nhận</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('2fa-code-input').focus();
        }

        async function verify2faLogin() {
            const { email, password } = pending2FA;
            const code = document.getElementById('2fa-code-input').value;
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, twoFactorCode: code })
                });

                const data = await response.json();

                if (data.success) {
                    storeAuthAndRedirect(data);
                } else {
                    showErrorModal('Lỗi xác thực', data.message || 'Mã xác thực không đúng');
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể kết nối đến máy chủ.');
            }
        }

        function showErrorModal(title, message, isLockout = false, email = null) {
            // Remove existing modals if any
            document.querySelectorAll('.modal-overlay').forEach(el => el.remove());

            const unlockButton = isLockout ?
                `<button onclick="requestUnlock('${email}')" class="btn btn--primary">Gửi mail mở khóa</button>` : '';

            const html = `
                <div id="error-modal" class="modal-overlay">
                    <div class="modal-content" style="border-top: 4px solid #ef4444;">
                        <div class="modal-header">
                            <h3 style="color: #ef4444; display: flex; align-items: center; gap: 8px;">
                                <span class="material-symbols-outlined">error</span> ${title}
                            </h3>
                            <p style="margin-top: 8px; line-height: 1.5;">${message}</p>
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('error-modal').remove()" class="btn btn--secondary">Đóng</button>
                            ${unlockButton}
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function requestUnlock(email) {
            if (!email) return;
            document.getElementById('error-modal').remove();

            try {
                const response = await fetch('http://localhost:8080/api/security/unlock/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();

                if (response.ok) {
                    showUnlockOtpModal(email);
                    // Optional: show success toast "Email sent"
                } else {
                    showErrorModal('Lỗi', data.message || 'Không thể gửi yêu cầu mở khóa');
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể gửi yêu cầu.');
            }
        }

        function showUnlockOtpModal(email) {
            const html = `
                <div id="unlock-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Mở khóa tài khoản</h3>
                            <p>Nhập mã OTP đã được gửi đến email ${email}</p>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="unlock-otp-input" class="modal-input modal-otp-input" placeholder="------" maxlength="6">
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('unlock-modal').remove()" class="btn btn--secondary">Hủy</button>
                            <button onclick="submitUnlockOtp('${email}')" class="btn btn--primary">Mở khóa</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('unlock-otp-input').focus();
        }

        async function submitUnlockOtp(email) {
            const otp = document.getElementById('unlock-otp-input').value;
            try {
                const response = await fetch('http://localhost:8080/api/security/unlock/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });
                const data = await response.json();

                document.getElementById('unlock-modal').remove();

                if (response.ok) {
                    showErrorModal('Thành công', data.message, false); // Re-use modal for success message or define showSuccessModal
                    // Or simple alert for success is acceptable, but let's stick to modal styling
                    // Actually let's just use the error modal style but with green header if we wanted, 
                    // but "Thành công" title is enough for now. 
                    // To make it look nice, let's just make a generic showMessageModal later or just use this one.
                } else {
                    showErrorModal('Mở khóa thất bại', data.message);
                }
            } catch (error) {
                console.error(error);
                showErrorModal('Lỗi kết nối', 'Không thể mở khóa tài khoản.');
            }
        }

        function showAdminLockedModal(message, lockReason, email) {
            document.querySelectorAll('.modal-overlay').forEach(el => el.remove());

            const html = `
                <div id="admin-locked-modal" class="modal-overlay">
                    <div class="modal-content" style="border-top: 4px solid #ef4444; max-width: 440px;">
                        <div class="modal-header">
                            <h3 style="color: #ef4444; display: flex; align-items: center; gap: 8px;">
                                <span class="material-symbols-outlined">gpp_bad</span> Tài khoản bị khóa bởi Quản trị viên
                            </h3>
                            <p style="margin-top: 8px; line-height: 1.5;">${message}</p>
                            ${lockReason ? `
                            <div style="margin-top: 12px; padding: 12px 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                                <p style="font-size: 12px; color: #991b1b; font-weight: 600; margin-bottom: 4px;">Lý do:</p>
                                <p style="font-size: 14px; color: #b91c1c; line-height: 1.5;">${lockReason}</p>
                            </div>
                            ` : ''}
                        </div>
                        <div id="unlock-request-form-area">
                            <button onclick="showUnlockRequestForm('${email}')" class="btn btn--primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span class="material-symbols-outlined" style="font-size: 18px;">edit_note</span> Gửi đơn yêu cầu mở khóa
                            </button>
                        </div>
                        <div class="modal-footer">
                            <button onclick="document.getElementById('admin-locked-modal').remove()" class="btn btn--secondary">Đóng</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);

            if (typeof gsap !== 'undefined') {
                gsap.fromTo('#admin-locked-modal .modal-content', { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3, ease: 'back.out(1.5)' });
            }
        }

        function showUnlockRequestForm(email) {
            const area = document.getElementById('unlock-request-form-area');
            if (!area) return;

            area.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Lý do yêu cầu mở khóa</label>
                        <textarea id="unlock-request-reason" class="modal-input" rows="3" placeholder="Nhập lý do bạn muốn mở khóa tài khoản..." style="resize: none;"></textarea>
                    </div>
                    <button onclick="submitUnlockRequestFromLogin('${email}')" class="btn btn--primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">send</span> Gửi đơn
                    </button>
                </div>
            `;

            if (typeof gsap !== 'undefined') {
                gsap.fromTo(area, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3, ease: 'power2.out' });
            }
            document.getElementById('unlock-request-reason')?.focus();
        }

        async function submitUnlockRequestFromLogin(email) {
            const reason = document.getElementById('unlock-request-reason')?.value?.trim();
            if (!reason) {
                const textarea = document.getElementById('unlock-request-reason');
                if (textarea) {
                    textarea.style.borderColor = '#ef4444';
                    textarea.placeholder = 'Vui lòng nhập lý do!';
                }
                return;
            }

            const area = document.getElementById('unlock-request-form-area');
            if (area) {
                area.innerHTML = '<div style="text-align: center; padding: 12px;"><span class="material-symbols-outlined spinning" style="font-size: 28px; color: var(--color-primary);">sync</span></div>';
            }

            try {
                const response = await fetch('http://localhost:8080/api/security/unlock/submit-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, reason })
                });
                const data = await response.json();

                document.getElementById('admin-locked-modal')?.remove();

                if (response.ok) {
                    showErrorModal('Đã gửi thành công!', data.message || 'Đơn yêu cầu mở khóa đã được gửi. Vui lòng chờ quản trị viên xử lý.');
                    // Change the header color to green for success
                    const header = document.querySelector('#error-modal .modal-content');
                    if (header) header.style.borderTopColor = '#10b981';
                    const title = document.querySelector('#error-modal .modal-header h3');
                    if (title) title.style.color = '#10b981';
                } else {
                    showErrorModal('Lỗi', data.message || 'Không thể gửi đơn yêu cầu mở khóa');
                }
            } catch (error) {
                console.error('Unlock request error:', error);
                document.getElementById('admin-locked-modal')?.remove();
                showErrorModal('Lỗi kết nối', 'Không thể gửi đơn yêu cầu. Vui lòng thử lại sau.');
            }
        }

        // Add Shared Modal Styles
        const style = document.createElement('style');
        style.textContent = `
            .modal-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
                animation: fadeIn 0.2s;
            }
            .modal-content {
                background: white; padding: 32px; border-radius: 16px; width: 400px; max-width: 90%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.1); animation: slideUp 0.3s;
                display: flex; flex-direction: column; gap: 16px;
            }
            .modal-header h3 { font-size: 20px; font-weight: 600; color: #111827; margin: 0; }
            .modal-header p { font-size: 14px; color: #6b7280; margin: 4px 0 0 0; }
            .modal-body { display: flex; flex-direction: column; gap: 12px; }
            .modal-input {
                width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px;
                font-size: 14px; outline: none; transition: border-color 0.2s;
            }
            .modal-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
            .modal-otp-input {
                text-align: center; letter-spacing: 8px; font-size: 24px; font-weight: 600; color: var(--color-primary);
            }
            .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

            /* Face Scan Animation */
            .face-scan-ring {
                animation: faceScanSpin 1.5s linear infinite;
            }
            .face-scan-ring-inner {
                animation: faceScanSpin 2s linear infinite reverse;
            }
            .face-scan-line {
                animation: faceScanLine 2s ease-in-out infinite;
            }
            .face-scan-pulse {
                animation: faceScanPulse 1.5s ease-in-out infinite;
            }
            .face-scan-progress-bar {
                animation: faceScanProgress 3s ease-in-out infinite;
            }
            @keyframes faceScanSpin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            @keyframes faceScanLine {
                0%, 100% { top: 30px; opacity: 0; }
                10% { opacity: 1; }
                50% { top: 160px; opacity: 1; }
                60% { opacity: 0; }
            }
            @keyframes faceScanPulse {
                0%, 100% { transform: scale(1); opacity: 0.7; }
                50% { transform: scale(1.1); opacity: 1; }
            }
            @keyframes faceScanProgress {
                0% { width: 0%; }
                50% { width: 70%; }
                80% { width: 90%; }
                100% { width: 100%; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Testimonials Carousel -->
    <script>
    (function() {
        const container = document.getElementById('login-testimonials');
        const dotsContainer = document.getElementById('login-carousel-dots');
        if (!container || !dotsContainer) return;

        const slides = container.querySelectorAll('.auth-testimonial-slide');
        const dots = dotsContainer.querySelectorAll('.auth-carousel-dot');
        let currentIndex = 0;
        let interval;

        function goToSlide(index) {
            slides[currentIndex].classList.remove('active');
            dots[currentIndex].classList.remove('active');
            currentIndex = index;
            slides[currentIndex].classList.add('active');
            dots[currentIndex].classList.add('active');
        }

        function nextSlide() {
            goToSlide((currentIndex + 1) % slides.length);
        }

        function startAutoRotate() {
            interval = setInterval(nextSlide, 10000);
        }

        dots.forEach(dot => {
            dot.addEventListener('click', function() {
                clearInterval(interval);
                goToSlide(parseInt(this.dataset.index));
                startAutoRotate();
            });
        });

        startAutoRotate();
    })();
    </script>
</body>

</html>