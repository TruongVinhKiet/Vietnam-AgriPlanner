<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPlanner - Trồng trọt</title>
    <meta name="description" content="Quản lý mô phỏng đất canh tác với bản đồ Leaflet">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <!-- Styles -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/cultivation.css">
    <link rel="stylesheet" href="../css/pages/pest-analysis.css">
    <link rel="stylesheet" href="../css/pages/financial-analysis.css">
    <link rel="stylesheet" href="../css/pages/ai-agronomist.css">
    <link rel="stylesheet" href="../css/pages/inventory.css">
    <link rel="stylesheet" href="../css/pages/weather-logs.css">
    <link rel="stylesheet" href="../css/pages/traceability.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <link rel="stylesheet" href="../css/smart-advisor.css">

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Chart.js and Adapter for Financial Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chart.js and Adapter for Financial Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        #leaflet-map {
            width: 100%;
            height: 100%;
            min-height: 500px;
            z-index: 1;
        }

        /* Prevent double scrollbars */
        body {
            overflow: hidden;
        }

        .cultivation-layout {
            height: calc(100vh - 64px);
            /* Adjust based on header height */
            overflow: hidden;
        }

        /* Location Search */
        .location-search {
            position: absolute;
            top: var(--spacing-4);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: var(--spacing-2);
            background: white;
            padding: var(--spacing-2);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }

        /* Field Timers & Revenue */
        .sensor-sidebar {
            width: 320px;
            background: white;
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow-y: auto;
            /* Enable scrolling */
            height: 100%;
            /* Ensure full height */
        }

        .feature-panel {
            position: fixed !important;
            /* Ensure it floats above */
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 9999 !important;
            /* Extremely high z-index */
            max-height: 85vh;
            overflow-y: auto;
        }

        .field-timer,
        .field-revenue {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #4b5563;
        }

        .timer-icon {
            font-size: 18px;
        }

        .timer-icon--blue {
            color: #3b82f6;
        }

        .timer-icon--green {
            color: #10b981;
        }

        .timer-icon--red {
            color: #ef4444;
        }

        .timer-icon--amber {
            color: #f59e0b;
        }

        .timer-icon--emerald {
            color: #059669;
        }

        /* Workflow Steps */
        .workflow-step {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            font-weight: bold;
        }

        .field-action-btn:disabled .workflow-step {
            background: #9ca3af;
        }

        /* Danger Button */
        .field-action-btn--danger {
            background-color: #fee2e2 !important;
            color: #ef4444 !important;
            border: 1px solid #fecaca !important;
        }

        .field-action-btn--danger:hover:not(:disabled) {
            background-color: #fecaca !important;
        }

        /* List Items in Modals */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: var(--color-primary);
            background: #f0fdf4;
        }

        .list-item.selected {
            border-color: var(--color-primary);
            background: #dcfce7;
        }

        .list-item__info h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .list-item__info p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }

        .list-item__price {
            font-weight: bold;
            color: var(--color-primary);
            font-size: 13px;
        }

        .location-search__input {
            flex: 1;
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
        }

        .location-search__btn {
            padding: var(--spacing-2) var(--spacing-3);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-size-sm);
            transition: background var(--transition-fast);
        }

        .location-search__btn:hover {
            background: var(--color-primary-dark);
        }

        .location-search__btn .material-symbols-outlined {
            font-size: 18px;
        }

        /* Compact Weather Widget */
        .weather-widget {
            position: absolute;
            top: 70px;
            right: var(--spacing-4);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 200px;
            max-width: 240px;
            overflow: hidden;
        }

        .weather-widget__header {
            padding: var(--spacing-2) var(--spacing-3);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            font-size: var(--font-size-sm);
        }

        .weather-widget__location {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: var(--font-weight-semibold);
        }

        .weather-widget__location .material-symbols-outlined {
            font-size: 16px;
        }

        .weather-widget__body {
            padding: var(--spacing-3);
        }

        .weather-widget__current {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .weather-widget__icon {
            width: 48px;
            height: 48px;
        }

        .weather-widget__temp {
            font-size: 28px;
            font-weight: var(--font-weight-bold);
        }

        .weather-widget__desc {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .weather-widget__details {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-2);
            padding-top: var(--spacing-2);
            border-top: 1px solid var(--color-border-light);
        }

        .weather-detail {
            flex: 1;
            text-align: center;
        }

        .weather-detail__label {
            font-size: 9px;
            color: var(--color-text-muted);
        }

        .weather-detail__value {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .weather-loading {
            text-align: center;
            padding: var(--spacing-4);
        }

        /* Forecast Modal */
        .forecast-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .forecast-modal.open {
            display: flex;
        }

        .forecast-modal__content {
            background: white;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .forecast-modal__header {
            padding: var(--spacing-4) var(--spacing-5);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forecast-modal__title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
        }

        .forecast-modal__close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: var(--radius-full);
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forecast-modal__close .material-symbols-outlined {
            color: white;
            font-size: 20px;
        }

        .forecast-modal__body {
            padding: var(--spacing-4);
        }

        .forecast-tabs {
            display: flex;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }

        .forecast-tab {
            flex: 1;
            padding: var(--spacing-2);
            background: #f1f5f9;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .forecast-tab:hover {
            background: #e2e8f0;
        }

        .forecast-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            max-height: 350px;
            overflow-y: auto;
        }

        .forecast-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            background: #f8fafc;
            border-radius: var(--radius-lg);
        }

        .forecast-item__date {
            flex: 1;
            font-weight: var(--font-weight-medium);
        }

        .forecast-item__icon {
            width: 40px;
            height: 40px;
        }

        .forecast-item__temp {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
        }

        .forecast-item__desc {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            width: 100px;
            text-align: right;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 70px;
            left: var(--spacing-4);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            z-index: 1000;
        }

        .map-control-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .map-control-btn:hover {
            background: #f8fafc;
            box-shadow: var(--shadow-md);
        }

        .map-control-btn .material-symbols-outlined {
            font-size: 20px;
            color: var(--color-text-secondary);
        }

        /* Layer buttons */
        .map-layers {
            position: absolute;
            bottom: 40px;
            /* Increased to avoid Leaflet attribution overlap */
            left: var(--spacing-4);
            right: auto;
            display: flex;
            gap: var(--spacing-1);
            z-index: 1000;
        }

        .map-layer-btn {
            padding: var(--spacing-2) var(--spacing-3);
            background: white;
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .map-layer-btn:hover {
            background: #f8fafc;
        }

        .map-layer-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .map-layer-btn--planning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-color: #d97706;
        }

        .map-layer-btn--planning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .map-layer-btn--planning.active {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #047857;
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.3);
        }

        /* Soil Map Button */
        .map-layer-btn--soil {
            background: linear-gradient(135deg, #92400e, #b45309);
            color: white;
            border-color: #92400e;
        }

        .map-layer-btn--soil:hover {
            background: linear-gradient(135deg, #78350f, #92400e);
        }

        .map-layer-btn--soil.active {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            border-color: #d97706;
            box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.3);
        }

        /* Soil Legend specific styles */
        .soil-legend .planning-legend__header {
            background: linear-gradient(135deg, #92400e 0%, #d97706 100%) !important;
        }

        /* Planning Source Card Featured */
        .planning-source-card--featured {
            border: 2px solid #059669 !important;
            background: linear-gradient(to right, #ecfdf5, #f0fdf4) !important;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2) !important;
        }

        .planning-source-card--featured:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3) !important;
        }

        .planning-source-card--featured .planning-source-info h5 {
            color: #047857 !important;
            font-size: 15px !important;
        }

        /* Planning Sync Bar */
        .planning-sync-bar {
            position: absolute;
            top: var(--spacing-4);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            background: linear-gradient(135deg, #059669, #047857);
            padding: 10px 16px;
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.4);
            color: white;
            min-width: 500px;
            max-width: 700px;
        }

        .planning-sync-bar__info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .planning-sync-bar__info .material-symbols-outlined {
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .planning-sync-bar__actions {
            display: flex;
            gap: 8px;
        }

        .planning-sync-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .planning-sync-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .planning-sync-btn .material-symbols-outlined {
            font-size: 16px;
        }

        .planning-sync-btn--secondary {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.4);
        }

        .planning-sync-btn--primary {
            background: rgba(255, 255, 255, 0.95);
            color: #059669;
            border-color: white;
            font-weight: 600;
        }

        .planning-sync-btn--primary:hover {
            background: white;
            transform: scale(1.02);
        }

        .planning-sync-btn--close {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            padding: 6px 8px;
        }

        .planning-sync-btn--close:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        /* Planning Legend */
        .planning-legend {
            position: absolute;
            bottom: var(--spacing-6);
            right: var(--spacing-4);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 2px solid #f59e0b;
            padding: var(--spacing-3);
            min-width: 200px;
            z-index: 1000;
        }

        .planning-legend__header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #d97706;
            margin-bottom: var(--spacing-2);
            padding-bottom: var(--spacing-2);
            border-bottom: 1px solid #fcd34d;
        }

        .planning-legend__header .material-symbols-outlined {
            font-size: 18px;
        }

        .planning-legend__items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: var(--spacing-3);
        }

        .planning-legend__item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4b5563;
        }

        .planning-legend__dot {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .planning-legend__actions {
            display: flex;
            gap: 8px;
            padding-top: var(--spacing-2);
            border-top: 1px solid #e5e7eb;
        }

        .planning-legend__actions .btn {
            flex: 1;
            font-size: 11px;
            padding: 6px 8px;
        }

        /* Planning Zone Tooltip */
        .planning-zone-tooltip {
            background: rgba(245, 158, 11, 0.95) !important;
            border: none !important;
            color: white !important;
            font-weight: 500;
            padding: 4px 10px !important;
            border-radius: 6px !important;
        }

        .planning-zone-tooltip::before {
            border-top-color: rgba(245, 158, 11, 0.95) !important;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* Disabled button styles */
        .field-action-btn--disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .field-action-btn--disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .field-action-btn__icon--green {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .field-action-btn__icon--amber {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .field-action-btn__icon--red {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .field-action-btn__icon--yellow {
            background: rgba(234, 179, 8, 0.1);
            color: #eab308;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .modal.open {
            display: flex;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0 0 4px;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-header p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Crop grid */
        .crop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .crop-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .crop-card:hover {
            border-color: var(--color-primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .crop-card.selected {
            border-color: var(--color-primary);
            background: rgba(16, 185, 129, 0.1);
        }

        .crop-card--avoid {
            opacity: 0.5;
            border-color: #fca5a5;
            background: rgba(254, 202, 202, 0.3);
        }

        .crop-card__image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin: 0 auto 8px;
        }

        .crop-card__name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .crop-card__info {
            font-size: 11px;
            color: #6b7280;
        }

        .crop-card__badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-top: 4px;
        }

        .crop-card__badge--recommend {
            background: #d1fae5;
            color: #065f46;
        }

        .crop-card__badge--avoid {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Drawing indicator */
        .drawing-indicator {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .drawing-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ==================== FEATURE STYLES ==================== */
        .feature-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .feature-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
        }

        .feature-btn:hover {
            background: #f0fdf4;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .feature-btn .material-symbols-outlined {
            font-size: 20px;
        }

        .feature-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .feature-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
        }

        .feature-panel.open {
            display: block;
        }

        .feature-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1999;
        }

        .feature-panel-overlay.open {
            display: block;
        }

        .feature-panel__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .feature-panel__header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .feature-panel__content {
            padding: 16px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f3f4f6;
        }

        /* Feature Modal */
        .feature-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .feature-modal.open {
            display: flex;
        }

        .feature-modal__content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }

        .feature-modal__content--large {
            max-width: 700px;
        }

        .feature-modal__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .feature-modal__header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .feature-modal__body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }

        /* Notification Items */
        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f3f4f6;
        }

        .notification-item.unread {
            background: #eff6ff;
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .icon--blue {
            background: #dbeafe;
            color: #2563eb;
        }

        .icon--green {
            background: #dcfce7;
            color: #16a34a;
        }

        .icon--amber {
            background: #fef3c7;
            color: #d97706;
        }

        .icon--red {
            background: #fee2e2;
            color: #dc2626;
        }

        .icon--purple {
            background: #ede9fe;
            color: #7c3aed;
        }

        .notification-content h4 {
            margin: 0 0 4px;
            font-size: 13px;
        }

        .notification-content p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }

        .notification-time {
            font-size: 11px;
            color: #9ca3af;
        }

        /* Market Items */
        .market-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .market-item .crop-name {
            font-weight: 500;
            font-size: 13px;
        }

        .market-item .category {
            display: block;
            font-size: 11px;
            color: #6b7280;
        }

        .market-item__price .price {
            font-weight: 600;
            font-size: 14px;
        }

        .market-item .change {
            display: flex;
            align-items: center;
            font-size: 11px;
            margin-top: 2px;
        }

        .market-item .change.up {
            color: #16a34a;
        }

        .market-item .change.down {
            color: #dc2626;
        }

        /* Harvest Records */
        .harvest-record {
            background: #f9fafb;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .harvest-record__header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .harvest-record__crop {
            font-weight: 600;
            font-size: 14px;
        }

        .harvest-record__date {
            font-size: 12px;
            color: #6b7280;
        }

        .harvest-record__stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .harvest-record .stat {
            display: flex;
            flex-direction: column;
        }

        .harvest-record .stat .label {
            font-size: 11px;
            color: #6b7280;
        }

        .harvest-record .stat .value {
            font-size: 13px;
            font-weight: 500;
        }

        .harvest-record .stat .revenue {
            color: #2563eb;
        }

        .harvest-record .stat .cost {
            color: #dc2626;
        }

        .harvest-record .stat .profit {
            color: #16a34a;
        }

        .harvest-record .stat .loss {
            color: #dc2626;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .analytics-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .analytics-card--large {
            grid-column: span 2;
        }

        .analytics-card .material-symbols-outlined {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .analytics-card__value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .analytics-card__label {
            font-size: 12px;
            color: #6b7280;
        }

        .analytics-card.profit {
            background: #dcfce7;
        }

        .analytics-card.loss {
            background: #fee2e2;
        }

        /* Pest Items */
        .pest-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #e5e7eb;
        }

        .pest-item.severity--low {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .pest-item.severity--medium {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .pest-item.severity--high {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .pest-item.severity--critical {
            border-color: #7c3aed;
            background: #faf5ff;
        }

        .pest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pest-name {
            font-weight: 600;
            font-size: 13px;
        }

        .severity-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e5e7eb;
        }

        .pest-description {
            font-size: 12px;
            color: #6b7280;
            margin: 6px 0;
        }

        .pest-treatment {
            font-size: 11px;
            color: #4b5563;
        }

        .detection-success,
        .detection-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .detection-success {
            background: #dcfce7;
            color: #166534;
        }

        .detection-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .empty-state,
        .error-state,
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 13px;
        }

        .irrigation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .irrigation-item.inactive {
            opacity: 0.6;
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
        }

        .toggle-btn.on {
            color: #16a34a;
        }

        .toggle-btn.off {
            color: #9ca3af;
        }

        /* Notification Dropdown */
        .header__notification {
            position: relative;
        }

        /* Ensure parent is relative */
        .header__notification-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .header__notification-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        .notification-header {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 0 !important;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            gap: 12px;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            text-align: left;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .notification-desc {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .notification-action {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
            transition: all 0.2s;
        }

        .notification-action--primary {
            background: #dbeafe;
            color: #2563eb;
        }

        .notification-action--primary:hover {
            background: #bfdbfe;
        }

        .notification-empty {
            padding: 32px;
            text-align: center;
            color: #9ca3af;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast-message {
            background: white;
            border-left: 4px solid #10b981;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 4px;
            padding: 12px 16px;
            min-width: 300px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInLeft 0.3s ease-out;
            transition: opacity 0.3s ease-out, transform 0.2s;
            opacity: 1;
        }

        .toast-message.closing {
            opacity: 0;
            transform: translateX(-100%);
        }

        .toast-icon {
            color: #10b981;
            display: flex;
            align-items: center;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .toast-desc {
            font-size: 13px;
            color: #4b5563;
        }

        .toast-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
</head>

<body data-page="cultivation">
    <!-- Map Container -->
    <div id="map"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo-icon" style="background: none; padding: 0;">
                    <img src="../images/logo.png" alt="AgriPlanner Logo"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <h1 class="sidebar__logo-text">AgriPlanner</h1>
            </div>
            <nav class="sidebar__nav">
                <a href="../index.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">home</span><span>Trang chủ</span></a>
                <a href="cultivation.html" class="sidebar__nav-link active"><span
                        class="material-symbols-outlined">potted_plant</span><span>Trồng trọt</span></a>
                <a href="livestock.html" class="sidebar__nav-link">
                    <span class="material-symbols-outlined">egg</span>
                    <span>Chăn nuôi</span>
                </a>
                <a href="labor.html" class="sidebar__nav-link">
                    <span class="material-symbols-outlined">engineering</span>
                    <span>Nhân công</span>
                </a>
                <a href="shop.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">store</span><span>Cửa hàng</span></a>
                <a href="cooperative.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">groups</span><span>Hợp tác xã</span></a>
                <a href="community.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">forum</span><span>Cộng đồng</span></a>
                <a href="analytics.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">account_balance_wallet</span><span>Tài sản</span></a>
                <a href="settings.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">settings</span><span>Cài đặt</span></a>
                <div class="sidebar__spacer"></div>
                <a href="help.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">help</span><span>Trợ giúp</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__user-avatar"
                        style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDCMN1BzSnHgFxeyKEvWsG_QZ7RRtaDeDC8da2PFWOdIOql1NQCIo7EyyLhovyGTv1IssyE0ElFcEa4Vw-V8109xsNhBf99T3NkTDvtYBU47tW1lefo65wDbOMoAbD7PjTIEurzbP6iG_cbmo4nHkWq5Ui67icWuS_TELGtKpV-77MezNda4FST6uqiwz7I-b6lE7ansa-imri7RnOY44Du1B8I1k4Rv_dGiOsudGGjdZD0rsUyhKsP7Eo6RCFsaG5tXK4lTjqA9wxs');">
                    </div>
                    <div class="sidebar__user-info">
                        <p class="sidebar__user-name">John Farmer</p>
                        <p class="sidebar__user-email">john@agriplanner.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div id="toast-container"></div>
            <header class="header">
                <div class="header__search">
                    <span class="material-symbols-outlined header__search-icon">search</span>
                    <input type="text" class="header__search-input" placeholder="Tìm kiếm khu vực...">
                </div>
                <div class="header__actions">
                    <button class="header__notification" onclick="toggleNotificationDropdown()"><span
                            class="material-symbols-outlined">notifications</span><span
                            class="header__notification-badge" style="display:none"></span>
                        <div class="header__notification-dropdown" id="notification-dropdown"
                            onclick="event.stopPropagation()">
                            <div class="notification-header">
                                <h4>Công việc hôm nay</h4>
                                <span class="material-symbols-outlined"
                                    style="font-size: 18px; color: #9ca3af; cursor: pointer;"
                                    onclick="toggleNotificationDropdown()">close</span>
                            </div>
                            <div class="notification-list" id="notification-list-items">
                                <!-- Using JS to populate -->
                            </div>
                        </div>
                    </button>
                    <div class="header__user">
                        <div class="header__user-info">
                            <p class="header__user-name">John Farmer</p>
                            <p class="header__user-role">Farm Manager</p>
                        </div>
                        <div class="header__user-avatar"
                            style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCHFCTqN0OM4sPkXOIJq6yxGJaRp5CFHphT4D3h5kTOVuH5XYva-_dBSZW4xFkV4oYoFHd-mgQi2uwLpx8Y2d0nY-kTjVoTY-fsw_cVVCZMuHwe1uAiUGLxaflzoYqbhM8v8nkGBQyp3yT7yk_pAadyFgKQ0ZfaPxHWGc8-v3chAxzKzK48oNsygXDarEGdKrgTsJ54TT58oJ-WPS65S_kwcNajqy3wIMFodmRWYftN04hShgSUMQ8hrtuIVt2uMPn6xk_ckF1LZRfp');">
                        </div>
                    </div>
                </div>
            </header>

            <div class="cultivation-layout">
                <div class="field-map" id="map-container">
                    <div id="leaflet-map"></div>

                    <div class="drawing-indicator" id="drawing-indicator">
                        <span class="material-symbols-outlined">draw</span>
                        <span>Click để vẽ mảnh ruộng. Nhấn Enter để hoàn thành.</span>
                    </div>

                    <div class="location-search">
                        <input type="text" class="location-search__input" id="location-input"
                            placeholder="Nhập địa chỉ (VD: Cần Thơ, Việt Nam)...">
                        <button class="location-search__btn" id="search-location">
                            <span class="material-symbols-outlined">search</span> Tìm
                        </button>
                    </div>

                    <div class="map-controls">
                        <button class="map-control-btn" id="btn-financial-mode" title="Bản đồ tài chính"
                            onclick="toggleFinancialMode()">
                            <span class="material-symbols-outlined">monetization_on</span>
                        </button>
                        <button class="map-control-btn" id="zoom-in" title="Phóng to"><span
                                class="material-symbols-outlined">add</span></button>
                        <button class="map-control-btn" id="zoom-out" title="Thu nhỏ"><span
                                class="material-symbols-outlined">remove</span></button>
                        <button class="map-control-btn" id="my-location" title="Vị trí của tôi"><span
                                class="material-symbols-outlined">my_location</span></button>
                    </div>

                    <div class="map-layers">
                        <button class="map-layer-btn" data-layer="streets">Đường phố</button>
                        <button class="map-layer-btn active" data-layer="satellite">Vệ tinh</button>
                        <button class="map-layer-btn" data-layer="terrain">Địa hình</button>
                        <button class="map-layer-btn map-layer-btn--planning" data-layer="planning"
                            title="Bản đồ quy hoạch sử dụng đất">
                            <span class="material-symbols-outlined"
                                style="font-size: 14px; vertical-align: middle;">map</span> Quy hoạch
                        </button>
                        <button class="map-layer-btn map-layer-btn--soil" data-layer="soil"
                            title="Bản đồ thổ nhưỡng - loại đất">
                            <span class="material-symbols-outlined"
                                style="font-size: 14px; vertical-align: middle;">landscape</span> Thổ nhưỡng
                        </button>
                    </div>

                    <!-- Planning Sync Bar -->
                    <div class="planning-sync-bar" id="planning-sync-bar" style="display: none;">
                        <div class="planning-sync-bar__info">
                            <span class="material-symbols-outlined">sync_alt</span>
                            <span>Đang xem quy hoạch tại Guland.vn</span>
                        </div>
                        <div class="planning-sync-bar__actions">
                            <button class="planning-sync-btn planning-sync-btn--primary"
                                onclick="closePlanningMode(); startDrawingField();">
                                <span class="material-symbols-outlined">draw</span> Vẽ ruộng mới
                            </button>
                            <button class="planning-sync-btn" onclick="syncPlanningMapPosition()">
                                <span class="material-symbols-outlined">sync</span> Đồng bộ vị trí
                            </button>
                            <button class="planning-sync-btn planning-sync-btn--secondary"
                                onclick="openPlanningMapModal()">
                                <span class="material-symbols-outlined">language</span> Nguồn khác
                            </button>
                            <button class="planning-sync-btn planning-sync-btn--close" onclick="closePlanningMode()"
                                title="Đóng chế độ quy hoạch">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>

                    <!-- Compact Weather Widget -->
                    <div class="weather-widget" id="weather-widget">
                        <div class="weather-loading">
                            <span class="material-symbols-outlined spinning">sync</span>
                            <p style="font-size: 12px; margin-top: 8px;">Đang tải...</p>
                        </div>
                    </div>

                    <div class="ndvi-legend fade-in">
                        <p class="ndvi-legend__title">Chỉ số NDVI</p>
                        <div class="ndvi-legend__gradient"></div>
                        <div class="ndvi-legend__labels"><span>Kém</span><span>Trung bình</span><span>Tốt</span></div>
                        <div class="ndvi-legend__items">
                            <div class="ndvi-legend__item"><span
                                    class="ndvi-legend__dot ndvi-legend__dot--good"></span><span
                                    class="ndvi-legend__text">Sinh trưởng tốt</span></div>
                            <div class="ndvi-legend__item"><span
                                    class="ndvi-legend__dot ndvi-legend__dot--attention"></span><span
                                    class="ndvi-legend__text">Cần chú ý</span></div>
                            <div class="ndvi-legend__item"><span
                                    class="ndvi-legend__dot ndvi-legend__dot--unplanted"></span><span
                                    class="ndvi-legend__text">Chưa gieo trồng</span></div>
                        </div>
                    </div>

                    <!-- Planning Layer Legend -->
                    <div class="planning-legend" id="planning-legend" style="display: none;">
                        <div class="planning-legend__header">
                            <span class="material-symbols-outlined">map</span>
                            <span>Bản đồ Quy hoạch</span>
                            <button class="planning-legend__close" onclick="togglePlanningLayer()" title="Đóng">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <!-- Phase 3: Filter by District -->
                        <div class="planning-filter">
                            <select id="planning-district-filter" onchange="filterPlanningByDistrict(this.value)">
                                <option value="">🏛️ Tất cả Quận/Huyện</option>
                            </select>
                        </div>

                        <!-- Phase 3: Search by Coordinate -->
                        <div class="planning-search">
                            <input type="text" id="planning-coord-search" placeholder="Tọa độ: 10.0306, 105.7701">
                            <button onclick="searchPlanningByCoordinate()" title="Tìm vùng tại tọa độ">
                                <span class="material-symbols-outlined">search</span>
                            </button>
                        </div>

                        <div class="planning-legend__items">
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #22c55e;"></span>
                                <span>Đất nông nghiệp</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #fbbf24;"></span>
                                <span>Đất ở</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #a855f7;"></span>
                                <span>Đất công nghiệp</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #06b6d4;"></span>
                                <span>Đất thủy sản</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #94a3b8;"></span>
                                <span>Đất giao thông</span>
                            </div>
                        </div>
                        <div class="planning-legend__actions">
                            <button class="btn btn--sm btn--secondary" onclick="exportPlanningGeoJson()"
                                title="Xuất GeoJSON">
                                <span class="material-symbols-outlined">download</span> Export
                            </button>
                            <button class="btn btn--sm btn--secondary" onclick="openPlanningMapSynced()">
                                <span class="material-symbols-outlined">sync_alt</span> Guland
                            </button>
                            <button class="btn btn--sm btn--primary" onclick="startDrawingPlanningZone()"
                                style="background: #f59e0b;">
                                <span class="material-symbols-outlined">add_location</span> Thêm
                            </button>
                        </div>
                    </div>

                    <!-- Soil Layer Legend -->
                    <div class="planning-legend soil-legend" id="soil-legend" style="display: none;">
                        <div class="planning-legend__header" style="background: linear-gradient(135deg, #92400e 0%, #d97706 100%);">
                            <span class="material-symbols-outlined">landscape</span>
                            <span>Bản đồ Thổ nhưỡng</span>
                            <button class="planning-legend__close" onclick="toggleSoilLayer()" title="Đóng">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <!-- Filter by District -->
                        <div class="planning-filter">
                            <select id="soil-district-filter" onchange="filterSoilByDistrict(this.value)">
                                <option value="">🏛️ Tất cả Quận/Huyện</option>
                            </select>
                        </div>

                        <!-- Search by Coordinate -->
                        <div class="planning-search">
                            <input type="text" id="soil-coord-search" placeholder="Tọa độ: 10.0306, 105.7701">
                            <button onclick="searchSoilByCoordinate()" title="Tìm vùng tại tọa độ">
                                <span class="material-symbols-outlined">search</span>
                            </button>
                        </div>

                        <div class="planning-legend__items" id="soil-legend-items">
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #8B4513;"></span>
                                <span>Đất phù sa</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #FF6347;"></span>
                                <span>Đất phèn</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #00CED1;"></span>
                                <span>Đất mặn</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #F5DEB3;"></span>
                                <span>Đất cát</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #2F4F4F;"></span>
                                <span>Đất than bùn</span>
                            </div>
                            <div class="planning-legend__item">
                                <span class="planning-legend__dot" style="background: #808080;"></span>
                                <span>Đất xám</span>
                            </div>
                        </div>
                        <div class="planning-legend__info" style="padding: 8px 12px; font-size: 11px; color: #666; background: #f8f9fa; border-radius: 0 0 8px 8px;">
                            <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">info</span>
                            Click vào vùng để xem thông tin chi tiết về loại đất, độ pH, cây trồng phù hợp
                        </div>
                    </div>
                </div>

                <aside class="sensor-sidebar">
                    <div class="sensor-sidebar__content">
                        <div class="sensor-sidebar__header">
                            <h2 class="sensor-sidebar__title">Dữ liệu cảm biến</h2>
                            <button class="btn btn--icon btn--secondary" id="refresh-sensors"><span
                                    class="material-symbols-outlined">refresh</span></button>
                        </div>

                        <div class="field-info-card" id="selected-field-info">
                            <div class="field-info-card__content">
                                <div class="field-info-card__icon"><span class="material-symbols-outlined">grass</span>
                                </div>
                                <div>
                                    <p class="field-info-card__name" id="field-name-display">Chọn khu vực trên bản đồ
                                    </p>
                                    <p class="field-info-card__meta" id="field-meta-display">Click vào một khu vực để
                                        xem chi tiết</p>
                                </div>
                            </div>

                            <!-- Countdown timers - hidden by default -->
                            <div class="field-timers" id="field-timers" style="display: none;">
                                <div class="field-timer">
                                    <span
                                        class="material-symbols-outlined timer-icon timer-icon--blue">water_drop</span>
                                    <span class="timer-text" id="timer-water">Tưới nước: --</span>
                                </div>
                                <div class="field-timer">
                                    <span class="material-symbols-outlined timer-icon timer-icon--green">eco</span>
                                    <span class="timer-text" id="timer-fertilize">Bón phân: --</span>
                                </div>
                                <div class="field-timer">
                                    <span class="material-symbols-outlined timer-icon timer-icon--red">bug_report</span>
                                    <span class="timer-text" id="timer-pesticide">Phun thuốc: --</span>
                                </div>
                                <div class="field-timer field-timer--harvest" id="harvest-timer">
                                    <span
                                        class="material-symbols-outlined timer-icon timer-icon--amber">agriculture</span>
                                    <span class="timer-text" id="timer-harvest">Thu hoạch: --</span>
                                </div>
                                <div class="field-revenue" id="field-revenue" style="display: none;">
                                    <span
                                        class="material-symbols-outlined timer-icon timer-icon--emerald">payments</span>
                                    <span class="timer-text">Dự kiến: <strong id="estimated-revenue">--</strong></span>
                                </div>
                            </div>
                        </div>

                        <div class="sensor-card sensor-card--blue fade-in">
                            <span class="material-symbols-outlined sensor-card__bg-icon">water_drop</span>
                            <div class="sensor-card__header">
                                <div class="sensor-card__icon sensor-card__icon--blue"><span
                                        class="material-symbols-outlined">water_drop</span></div><span
                                    class="sensor-card__title">Độ ẩm đất</span>
                            </div>
                            <div class="sensor-card__value-row"><span class="sensor-card__value"
                                    id="soil-moisture">42%</span><span
                                    class="sensor-card__trend sensor-card__trend--down"><span
                                        class="material-symbols-outlined icon-sm">trending_down</span>-5%</span></div>
                            <span class="sensor-card__target">Mục tiêu: 60-70%</span>
                        </div>

                        <div class="sensor-card sensor-card--orange fade-in">
                            <span class="material-symbols-outlined sensor-card__bg-icon">thermostat</span>
                            <div class="sensor-card__header">
                                <div class="sensor-card__icon sensor-card__icon--orange"><span
                                        class="material-symbols-outlined">thermostat</span></div><span
                                    class="sensor-card__title">Nhiệt độ</span>
                            </div>
                            <div class="sensor-card__value-row"><span class="sensor-card__value"
                                    id="temperature">--°C</span><span
                                    class="sensor-card__trend sensor-card__trend--neutral" id="temp-source">Đang
                                    tải...</span></div>
                            <span class="sensor-card__target">Tối ưu: 25-30°C</span>
                        </div>

                        <div class="sensor-card sensor-card--purple fade-in">
                            <span class="material-symbols-outlined sensor-card__bg-icon">science</span>
                            <div class="sensor-card__header">
                                <div class="sensor-card__icon sensor-card__icon--purple"><span
                                        class="material-symbols-outlined">science</span></div><span
                                    class="sensor-card__title">Độ pH đất</span>
                            </div>
                            <div class="sensor-card__value-row"><span class="sensor-card__value">6.5</span><span
                                    class="sensor-card__trend sensor-card__trend--up"><span
                                        class="material-symbols-outlined icon-sm">trending_up</span>+0.2</span></div>
                            <span class="sensor-card__target">Tối ưu: 6.0-7.0</span>
                        </div>

                        <div class="sensor-card sensor-card--emerald fade-in">
                            <span class="material-symbols-outlined sensor-card__bg-icon">humidity_percentage</span>
                            <div class="sensor-card__header">
                                <div class="sensor-card__icon sensor-card__icon--emerald"><span
                                        class="material-symbols-outlined">humidity_percentage</span></div><span
                                    class="sensor-card__title">Độ ẩm không khí</span>
                            </div>
                            <div class="sensor-card__value-row"><span class="sensor-card__value"
                                    id="humidity">--%</span><span class="sensor-card__trend sensor-card__trend--neutral"
                                    id="humidity-source">Đang tải...</span></div>
                            <span class="sensor-card__target">Tối ưu: 60-80%</span>
                        </div>

                        <div class="field-actions">
                            <h4 class="field-actions__title">Hoạt động</h4>
                            <div class="field-actions__grid">
                                <button class="field-action-btn" id="add-field-btn"
                                    onclick="showAddFieldOptions()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--green">add_location_alt</span><span
                                        class="field-action-btn__label">Thêm ruộng</span></button>
                                <button class="field-action-btn" id="open-forecast" onclick="openForecastModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--purple">cloud</span><span
                                        class="field-action-btn__label">Dự báo</span></button>
                                <!-- Removed duplicate Watering Schedule button -->
                            </div>
                        </div>

                        <div class="field-actions farm-management-section" id="farm-management">
                            <h4 class="field-actions__title">Quản lý nông trại</h4>
                            <p class="workflow-stage-text" id="workflow-stage-text"
                                style="font-size: 11px; color: #9ca3af; margin-bottom: 12px;">Chọn một mảnh ruộng để
                                quản lý</p>

                            <!-- Workflow Step 1: Select Crop -->
                            <div class="field-actions__grid">
                                <button class="field-action-btn field-action-btn--disabled" id="btn-select-crop"
                                    disabled onclick="openCropSelectionModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--amber">grass</span><span
                                        class="field-action-btn__label">Chọn cây</span>
                                    <span class="workflow-step" id="step-crop">1</span>
                                </button>

                                <!-- Workflow Step 2: Fertilize -->
                                <button class="field-action-btn field-action-btn--disabled" id="btn-fertilize" disabled
                                    onclick="openFertilizerModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--emerald">eco</span><span
                                        class="field-action-btn__label">Bón phân</span>
                                    <span class="workflow-step" id="step-fertilize">2</span>
                                </button>

                                <!-- Workflow Step 3: Seed -->
                                <button class="field-action-btn field-action-btn--disabled" id="btn-seed" disabled
                                    onclick="openSeedModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--yellow">spa</span><span
                                        class="field-action-btn__label">Gieo hạt</span>
                                    <span class="workflow-step" id="step-seed">3</span>
                                </button>

                                <!-- Active after seeding -->
                                <button class="field-action-btn field-action-btn--disabled" id="btn-watering" disabled
                                    onclick="waterField()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--blue">water_drop</span><span
                                        class="field-action-btn__label">Tưới nước</span>
                                </button>

                                <button class="field-action-btn field-action-btn--disabled" id="btn-pesticide" disabled
                                    onclick="openPesticideModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--red">bug_report</span><span
                                        class="field-action-btn__label">Phun thuốc</span>
                                </button>

                                <!-- Harvest (combines machinery) -->
                                <button class="field-action-btn field-action-btn--disabled" id="btn-harvest" disabled
                                    onclick="openHarvestModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--orange">agriculture</span><span
                                        class="field-action-btn__label">Thu hoạch</span>
                                </button>

                                <!-- Delete field button -->
                                <button class="field-action-btn field-action-btn--disabled field-action-btn--danger"
                                    id="btn-delete-field" disabled onclick="openDeleteFieldModal()"><span
                                        class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--red">delete</span><span
                                        class="field-action-btn__label">Xóa ruộng</span>
                                </button>
                            </div>

                            <!-- Tính năng nâng cao -->
                            <div class="field-actions__section">
                                <h4 class="field-actions__title"
                                    style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">TÍNH
                                    NĂNG NÂNG CAO</h4>
                                <div class="field-actions__grid">
                                    <button class="field-action-btn" onclick="toggleNotificationPanel()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--amber">notifications</span>
                                        <span class="field-action-btn__label">Thông báo</span>
                                        <span class="feature-badge" id="notification-badge"
                                            style="position:absolute;top:4px;right:4px;"></span>
                                    </button>
                                    <button class="field-action-btn" onclick="openWateringScheduleModal()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--blue">water</span>
                                        <span class="field-action-btn__label">Lịch tưới</span>
                                    </button>
                                    <button class="field-action-btn" onclick="toggleMarketplacePanel()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--emerald">storefront</span>
                                        <span class="field-action-btn__label">Thị trường</span>
                                    </button>
                                    <button class="field-action-btn field-action-btn--disabled" id="btn-pest-analysis"
                                        disabled onclick="openPestAnalysisModal()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--teal">document_scanner</span>
                                        <span class="field-action-btn__label">Phân tích</span>
                                    </button>
                                    <button class="field-action-btn" onclick="openFinancialAnalysisModels()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--emerald">query_stats</span>
                                        <span class="field-action-btn__label">Tài chính</span>
                                    </button>
                                    <button class="field-action-btn" onclick="openTraceabilityModal()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--blue">qr_code_2</span>
                                        <span class="field-action-btn__label">Truy xuất</span>
                                    </button>
                                    <button class="field-action-btn" onclick="openInventoryModal()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--amber">inventory_2</span>
                                        <span class="field-action-btn__label">Kho vật tư</span>
                                    </button>
                                    <button class="field-action-btn" onclick="openWeatherModal()">
                                        <span
                                            class="material-symbols-outlined field-action-btn__icon field-action-btn__icon--sky">cloudy</span>
                                        <span class="field-action-btn__label">Thời tiết</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Feature Panel Overlay Backdrop -->
    <div class="feature-panel-overlay" id="feature-overlay" onclick="closeAllFeaturePanels()"></div>

    <!-- Notification Panel -->
    <div class="feature-panel" id="notification-panel">
        <div class="feature-panel__header">
            <h4>Thông báo</h4>
            <button onclick="toggleNotificationPanel()" class="close-btn">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="feature-panel__content" id="notification-list"></div>
    </div>

    <!-- Irrigation Panel Removed (Replaced by Watering Schedule Modal) -->

    <!-- Marketplace Panel (Redesigned) -->
    <div class="feature-panel" id="marketplace-panel">
        <div class="feature-panel__header">
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="material-symbols-outlined text-green">candlestick_chart</span>
                <h4>Sàn Giao Dịch Nông Sản</h4>
            </div>
            <button onclick="toggleMarketplacePanel()" class="close-btn" style="color:white; opacity:0.7;">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="feature-panel__content">
            <div class="market-layout">
                <!-- Sidebar: Tickers -->
                <div class="market-sidebar">
                    <div style="padding:12px; border-bottom:1px solid #334155;">
                        <input type="text" placeholder="Tìm kiếm..."
                            style="width:100%; background:#0f172a; border:1px solid #334155; padding:8px; border-radius:4px; color:white;">
                    </div>
                    <div class="market-ticker-list" id="market-ticker-list">
                        <!-- Items injected by JS -->
                        <div style="padding:20px; text-align:center; color:#64748b;">Đang tải dữ liệu...</div>
                    </div>
                </div>

                <!-- Main: Chart -->
                <div class="market-main">
                    <div id="market-detail-container" style="display:none; height:100%; flex-direction:column;">
                        <div class="chart-header">
                            <div class="coin-info">
                                <div class="coin-icon" id="detail-icon">🌾</div>
                                <div class="coin-details">
                                    <h2 id="detail-name">Lúa nước</h2>
                                    <span id="detail-category" style="color:#94a3b8; font-size:13px;">GRAIN</span>
                                </div>
                            </div>
                            <div class="coin-stats">
                                <div class="stat-box">
                                    <div class="stat-label">Giá hiện tại</div>
                                    <div class="stat-value" id="detail-price">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Biến động (24h)</div>
                                    <div class="stat-value" id="detail-change">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Cao nhất (24h)</div>
                                    <div class="stat-value" id="detail-high">---</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">Thấp nhất (24h)</div>
                                    <div class="stat-value" id="detail-low">---</div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Div -->
                        <div id="price-chart" style="flex:1; width:100%; min-height:400px;"></div>
                    </div>

                    <div id="market-empty-state"
                        style="display:flex; flex:1; align-items:center; justify-content:center; flex-direction:column; color:#64748b;">
                        <span class="material-symbols-outlined"
                            style="font-size:64px; margin-bottom:16px; opacity:0.5;">monitoring</span>
                        <p>Chọn một loại nông sản để xem biểu đồ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pest Detection Panel -->
    <!-- Pest Analysis Modal (New) -->
    <div class="modal" id="pest-analysis-modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Phân tích Sâu bệnh</h3>
                <p>Upload hình ảnh để hệ thống AI phân tích</p>
                <span class="close-modal" onclick="closeModal('pest-analysis-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="scan-container" id="scan-container">
                    <div class="scan-overlay" id="scan-overlay"></div>
                    <img id="scan-preview" class="scan-preview" style="display: none;">

                    <div class="scan-placeholder" id="scan-placeholder"
                        onclick="document.getElementById('pest-file-input').click()">
                        <span class="material-symbols-outlined" style="font-size: 48px;">add_a_photo</span>
                        <div style="text-align: center;">
                            <span style="font-weight: 600; font-size: 14px;">Kéo thả hoặc chọn ảnh</span>
                            <br>
                            <span style="font-size: 12px; opacity: 0.7;">Hỗ trợ: JPG, PNG</span>
                        </div>
                    </div>
                    <input type="file" id="pest-file-input" accept="image/*" onchange="handlePestImageUpload(this)">
                </div>

                <div class="analyzing-status" id="analyzing-status">
                    <span class="material-symbols-outlined analyzing-text" style="font-size: 32px;">memory</span>
                    <p class="analyzing-text">Đang phân tích hình ảnh...</p>
                    <p style="font-size: 12px; color: #64748b; margin-top: 4px;">Vui lòng đợi vài giây</p>
                </div>

                <div class="analysis-error" id="analysis-error"
                    style="display: none; text-align: center; margin-top: 20px;">
                    <span class="material-symbols-outlined"
                        style="font-size: 48px; color: #ef4444; margin-bottom: 8px;">sentiment_dissatisfied</span>
                    <h4 style="color: #ef4444; margin: 0 0 8px;">Không nhận diện được</h4>
                    <p style="font-size: 14px; color: #64748b; margin: 0 0 16px;">Hệ thống không thể xác định loại sâu
                        bệnh từ hình ảnh này. Vui lòng thử lại với hình ảnh rõ nét hơn.</p>
                    <button class="btn btn--secondary" onclick="resetPestAnalysis()">Thử lại</button>
                </div>

                <!-- Result View (Hidden by default) -->
                <div id="pest-result-view" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
                    <div class="pest-details-grid-modal">
                        <div class="pest-image-card-modal">
                            <img id="modal-pest-img" class="pest-image-modal" src="" alt="Pest Image">
                            <span id="modal-pest-severity" class="pest-severity-badge">
                                <span class="material-symbols-outlined icon-filled">warning</span>
                                <span id="modal-severity-text">HIGH</span>
                            </span>
                        </div>

                        <div class="info-column-modal">
                            <h2 id="modal-pest-name" style="margin: 0 0 4px; font-size: 24px; color: #1e293b;">Sâu...
                            </h2>
                            <p id="modal-pest-scientific" style="font-style: italic; color: #64748b; margin: 0 0 16px;">
                                Scientific Name</p>

                            <div class="info-section-modal">
                                <h3 class="section-title-modal">
                                    <span class="material-symbols-outlined"
                                        style="color: #3b82f6; font-size: 20px;">info</span>
                                    Mô tả triệu chứng
                                </h3>
                                <p id="modal-pest-description"
                                    style="line-height: 1.5; color: #334155; font-size: 14px;">...</p>
                            </div>

                            <div class="info-section-modal">
                                <h3 class="section-title-modal">
                                    <span class="material-symbols-outlined"
                                        style="color: #ef4444; font-size: 20px;">medical_services</span>
                                    Đề xuất xử lý (Thuốc)
                                </h3>
                                <div class="treatment-card-modal">
                                    <h4 style="margin: 0 0 4px; color: #065f46; font-size: 14px;">Thuốc đặc trị</h4>
                                    <p id="modal-pest-treatment"
                                        style="margin: 0; color: #047857; font-weight: 500; font-size: 14px;">...</p>
                                </div>
                            </div>

                            <div class="info-section-modal">
                                <h3 class="section-title-modal">
                                    <span class="material-symbols-outlined"
                                        style="color: #f59e0b; font-size: 20px;">shield</span>
                                    Biện pháp phòng ngừa
                                </h3>
                                <p id="modal-pest-prevention"
                                    style="line-height: 1.5; color: #334155; font-size: 14px;">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modal-footer-action">
                <button class="btn btn--secondary" onclick="closeModal('pest-analysis-modal')">Đóng</button>
                <button class="btn btn--primary" id="start-scan-btn" onclick="startPestAnalysis()" disabled>Bắt đầu phân
                    tích</button>
                <button class="btn btn--primary" id="reset-scan-btn" onclick="resetPestAnalysis()"
                    style="display: none;">Quét lại</button>
            </div>
        </div>
    </div>

    <!-- Forecast Modal -->
    <div class="forecast-modal" id="forecast-modal">
        <div class="forecast-modal__content">
            <div class="forecast-modal__header">
                <h3 class="forecast-modal__title" id="forecast-title">Dự báo thời tiết</h3>
                <button class="forecast-modal__close" id="close-forecast"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="forecast-modal__body">
                <div class="forecast-tabs">
                    <button class="forecast-tab" data-days="1">1 ngày</button>
                    <button class="forecast-tab active" data-days="5">5 ngày</button>
                    <button class="forecast-tab" data-days="7">7 ngày</button>
                </div>
                <div class="forecast-list" id="forecast-list"></div>
            </div>
        </div>
    </div>

    <!-- Fertilizer Modal -->
    <div class="modal" id="fertilizer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chọn phân bón</h3>
                <p>Chọn loại phân bón phù hợp cho cây trồng</p>
                <span class="close-modal" onclick="closeModal('fertilizer-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="fertilizer-list" class="list-container">Loading...</div>
                <div class="cost-summary"
                    style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Chi phí ước tính:</span>
                        <span id="fertilizer-cost" style="font-weight: bold; color: var(--color-primary);">0 VNĐ</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeModal('fertilizer-modal')">Hủy</button>
                <button class="btn btn--primary" onclick="confirmFertilizer()">Xác nhận bón phân</button>
            </div>
        </div>
    </div>

    <!-- Fertilizer Detail Modal -->
    <div class="modal" id="fertilizer-detail-modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Chi tiết phân bón</h3>
                <span class="close-modal" onclick="closeModal('fertilizer-detail-modal')">&times;</span>
            </div>
            <div class="modal-body" id="fertilizer-detail-content">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeModal('fertilizer-detail-modal')">Đóng</button>
                <button class="btn btn--primary" id="btn-select-from-detail">Chọn loại này</button>
            </div>
        </div>
    </div>



    <!-- Pesticide Modal -->
    <div class="modal" id="pesticide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Phun thuốc bảo vệ thực vật</h3>
                <p>Nhập thông tin thuốc và chi phí</p>
                <span class="close-modal" onclick="closeModal('pesticide-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pesticide-name">Tên thuốc</label>
                    <input type="text" id="pesticide-name" class="form-input" placeholder="VD: Thuốc trừ sâu sinh học">
                </div>
                <div class="form-group">
                    <label for="pesticide-cost">Chi phí (VNĐ)</label>
                    <input type="number" id="pesticide-cost" class="form-input" min="0" step="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeModal('pesticide-modal')">Hủy</button>
                <button class="btn btn--primary" onclick="confirmPesticide()">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- Seed Modal -->
    <div class="modal" id="seed-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gieo hạt giống</h3>
                <p>Nhập số lượng hạt giống cần gieo</p>
                <span class="close-modal" onclick="closeModalById('seed-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Giá hạt giống</label>
                    <p id="seed-price" style="font-weight:bold;color:var(--color-primary);margin:0;">50,000 VNĐ/kg</p>
                </div>
                <div class="form-group">
                    <label for="seed-quantity">Số lượng (kg)</label>
                    <input type="number" id="seed-quantity" class="form-input" min="0" step="0.5" value="10"
                        onchange="calculateSeedCost()">
                </div>
                <div class="cost-summary"
                    style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Tổng chi phí:</span>
                        <span id="seed-total-cost" style="font-weight: bold; color: #10b981;">500,000 VNĐ</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeModalById('seed-modal')">Hủy</button>
                <button class="btn btn--primary" onclick="confirmSeed()">Xác nhận gieo hạt</button>
            </div>
        </div>
    </div>

    <!-- Harvest Modal - Upgraded UI -->
    <div class="modal" id="harvest-modal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px 16px 0 0; padding: 20px 24px;">
                <div>
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-outlined">agriculture</span>
                        Thu hoạch
                    </h3>
                    <p style="margin: 4px 0 0; opacity: 0.9; font-size: 14px;">Chọn phương thức thu hoạch phù hợp</p>
                </div>
                <span class="close-modal" onclick="closeModal('harvest-modal')"
                    style="position: absolute; right: 16px; top: 16px; cursor: pointer; font-size: 24px; opacity: 0.8;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="margin: 0 0 16px; font-size: 13px; color: #6b7280;">Chọn một trong các phương thức dưới đây:
                </p>
                <div id="machinery-list" style="display: grid; gap: 12px;">Loading...</div>

                <!-- Cost Summary -->
                <div
                    style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border: 1px solid #fcd34d;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 8px; color: #92400e; font-weight: 500;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">payments</span>
                            Chi phí thu hoạch
                        </span>
                        <span id="harvest-cost" style="font-size: 20px; font-weight: 700; color: #b45309;">0 VNĐ</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn--secondary" onclick="closeModal('harvest-modal')" style="min-width: 100px;">
                    <span class="material-symbols-outlined icon-sm">close</span>
                    Hủy
                </button>
                <button class="btn btn--primary" onclick="confirmHarvest()"
                    style="min-width: 160px; background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <span class="material-symbols-outlined icon-sm">check</span>
                    Tiến hành thu hoạch
                </button>
            </div>
        </div>
    </div>

    <!-- Harvest Result Modal -->
    <div class="modal" id="harvest-result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kết quả thu hoạch</h3>
                <span class="close-modal" onclick="closeModal('harvest-result-modal')">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">🎉</div>
                <h4 id="result-crop-name" style="margin: 0; font-size: 18px;">Lúa nước</h4>
                <p style="color: #6b7280; margin: 4px 0 24px;">Đã thu hoạch thành công</p>

                <div
                    style="background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #166534;">Doanh thu</p>
                    <p id="result-revenue" style="margin: 4px 0 0; font-size: 24px; font-weight: bold; color: #15803d;">
                        15,000,000 VNĐ</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: left;">
                    <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">Sản lượng</p>
                        <p id="result-yield" style="margin: 4px 0 0; font-weight: bold;">2,000 kg</p>
                    </div>
                    <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">Lợi nhuận</p>
                        <p id="result-profit" style="margin: 4px 0 0; font-weight: bold;">12,500,000 VNĐ</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--primary" style="width: 100%;" onclick="closeModal('harvest-result-modal')">Hoàn
                    tất</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #ef4444;">Xóa mảnh ruộng?</h3>
                <span class="close-modal" onclick="closeModal('delete-confirm-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-message">Bạn có chắc chắn muốn xóa mảnh ruộng này không?</p>
                <div id="delete-warning"
                    style="display: none; background: #fef2f2; border: 1px solid #fecaca; padding: 12px; border-radius: 8px; margin-top: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <span class="material-symbols-outlined" style="color: #ef4444;">warning</span>
                        <p style="margin: 0; font-size: 13px; color: #b91c1c;">Cảnh báo: Mảnh ruộng này đang có cây
                            trồng. Việc xóa sẽ làm mất toàn bộ dữ liệu canh tác và đầu tư hiện tại.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeModal('delete-confirm-modal')">Hủy bỏ</button>
                <button class="btn btn--primary" style="background-color: #ef4444; border-color: #ef4444;"
                    onclick="confirmDeleteField()">Vẫn tiếp tục xóa</button>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <!-- cultivation.js disabled - using inline script instead to avoid duplicate map initialization -->
    <!-- <script src="../js/cultivation.js?v=2"></script>
<!-- Financial Analysis Logic -->
    <script src="../js/financial-analysis.js"></script>

    <!-- Pest Analysis Modal -->
    <div class="modal" id="pest-analysis-modal" style="z-index: 10002;">
        ...
    </div>

    <!-- AI Agronomist Logic -->
    <script src="../js/ai-agronomist.js?v=2"></script>
    <script src="../js/pest-analysis.js?v=2"></script>

    <script src="../js/features.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/smart-advisor.js"></script>
    <script src="../js/main.js"></script>

    <script src="../js/sidebar.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        let currentLocation = { ...CONFIG.DEFAULT_LOCATION };
        let map;
        let forecastData = [];
        let fieldsData = []; // Will be loaded from API
        let selectedField = null;
        let currentTemp = null;
        let allCrops = [];
        let drawnItems;
        let drawControl;
        let isDrawing = false;
        let drawnLayer = null;

        // API_BASE is defined in features.js/config.js
        // const API_BASE = 'http://localhost:8080/api';
        let currentFarmId = null; // Will be loaded from /api/farms/my-farms

        // User inventory cache for checking before activities
        let userInventoryCache = [];

        // ==================== INVENTORY HELPERS ====================

        // Load user inventory from shop API
        async function loadUserInventory() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                if (!userEmail) return [];

                const response = await fetch(`${API_BASE}/shop/inventory?userEmail=${encodeURIComponent(userEmail)}`);
                if (response.ok) {
                    const data = await response.json();
                    userInventoryCache = data.items || [];
                    return userInventoryCache;
                }
            } catch (e) {
                console.error('Error loading inventory:', e);
            }
            return [];
        }

        // Check if user has enough items in inventory
        function checkInventory(category, productName, requiredQuantity) {
            const items = userInventoryCache.filter(item => {
                const matchCategory = !category || item.category === category;
                const matchName = !productName || item.name.toLowerCase().includes(productName.toLowerCase());
                return matchCategory && matchName;
            });

            const totalQuantity = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
            return {
                hasEnough: totalQuantity >= requiredQuantity,
                available: totalQuantity,
                needed: requiredQuantity,
                shortage: Math.max(0, requiredQuantity - totalQuantity),
                items: items
            };
        }

        // Redirect to shop with pre-selected product
        function redirectToShop(category, productKeyword, quantity, message) {
            // Save purchase intent
            const intent = {
                category: category,
                keyword: productKeyword,
                quantity: quantity,
                fromCultivation: true,
                returnUrl: window.location.href,
                timestamp: Date.now()
            };
            localStorage.setItem('agriplanner_purchase_intent', JSON.stringify(intent));

            // Show notification before redirect
            showToast('Thiếu vật tư', message || `Cần mua thêm ${productKeyword}`, 'warning');

            setTimeout(() => {
                window.location.href = `shop.html?category=${category}&search=${encodeURIComponent(productKeyword)}&quantity=${quantity}`;
            }, 1500);
        }

        // Show confirmation dialog for insufficient inventory
        function showInsufficientInventoryDialog(itemName, available, needed, category, keyword) {
            const shortage = needed - available;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'inventory-shortage-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3><span class="material-symbols-outlined" style="color:#f59e0b;vertical-align:middle;">inventory_2</span> Thiếu vật tư</h3>
                        <span class="close-modal" onclick="closeModalById('inventory-shortage-modal')">&times;</span>
                    </div>
                    <div class="modal-body" style="text-align:center;padding:24px;">
                        <div style="font-size:48px;margin-bottom:16px;">📦</div>
                        <h4 style="margin-bottom:8px;">${itemName}</h4>
                        <p style="color:#64748b;margin-bottom:16px;">
                            Cần: <strong>${needed}</strong> • Trong kho: <strong>${available}</strong> • Thiếu: <strong style="color:#ef4444;">${shortage}</strong>
                        </p>
                        <p style="font-size:14px;color:#475569;">Bạn có muốn chuyển đến cửa hàng để mua thêm?</p>
                    </div>
                    <div class="modal-footer" style="justify-content:center;gap:12px;">
                        <button class="btn btn--secondary" onclick="closeModalById('inventory-shortage-modal')">Để sau</button>
                        <button class="btn btn--primary" onclick="closeModalById('inventory-shortage-modal'); redirectToShop('${category}', '${keyword}', ${shortage}, 'Đang chuyển tới cửa hàng...');">
                            <span class="material-symbols-outlined">shopping_cart</span> Mua ngay
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        const tileLayers = {
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM', maxZoom: 19 }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri', maxZoom: 19 }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '© OpenTopoMap', maxZoom: 17 })
        };

        // ==================== PLANNING MAP INTEGRATION ====================
        let planningMapWindow = null;
        let isPlanningMode = false;

        // Build URL with coordinates for different planning sources
        function buildPlanningURL(source, lat, lng, zoom) {
            // Guland.vn uses hash format: #zoom/lat/lng
            const gulandZoom = Math.min(Math.max(zoom, 10), 18);

            // Check if location is in Can Tho bounds (use official GIS)
            const isInCanTho = lat >= 9.8 && lat <= 10.3 && lng >= 105.4 && lng <= 105.9;

            switch (source) {
                case 'giscantho':
                case 'cantho':
                    // GIS Cần Thơ chính thức - Quy hoạch 2021-2030
                    return 'https://gisportal.cantho.gov.vn/maps/web/kg/e574cba1-8f4b-4b4a-b654-5593045ba85b/0/home';
                case 'giscantho-nn':
                    // GIS Cần Thơ - Sở Nông nghiệp
                    return 'https://gisportal.cantho.gov.vn/maps/web/kg/75b3f8ba-e8d2-4a3b-aa5b-9a4bc8d84dd2/0/csdl';
                case 'guland':
                    // Guland supports URL with location in path or hash
                    return `https://guland.vn/soi-quy-hoach#${gulandZoom}/${lat.toFixed(6)}/${lng.toFixed(6)}`;
                case 'thuvien':
                    return `https://thuvienquyhoach.vn/?lat=${lat}&lng=${lng}&z=${zoom}`;
                case 'monre':
                    return `https://gis.monre.gov.vn/`;
                default:
                    // Default: If in Can Tho, use official GIS; otherwise use Guland
                    if (isInCanTho) {
                        return 'https://gisportal.cantho.gov.vn/maps/web/kg/e574cba1-8f4b-4b4a-b654-5593045ba85b/0/home';
                    }
                    return `https://guland.vn/soi-quy-hoach#${gulandZoom}/${lat.toFixed(6)}/${lng.toFixed(6)}`;
            }
        }

        // Open planning map in synced popup window
        function openPlanningMapSynced() {
            const center = map.getCenter();
            const zoom = map.getZoom();

            // Check if in Can Tho - use official GIS
            const isInCanTho = center.lat >= 9.8 && center.lat <= 10.3 && center.lng >= 105.4 && center.lng <= 105.9;
            const source = isInCanTho ? 'giscantho' : 'guland';
            const url = buildPlanningURL(source, center.lat, center.lng, zoom);

            // Calculate window position (right side of screen)
            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;
            const popupWidth = Math.floor(screenWidth * 0.5);
            const popupHeight = screenHeight;
            const popupLeft = screenWidth - popupWidth;

            // Close existing window if open
            if (planningMapWindow && !planningMapWindow.closed) {
                planningMapWindow.location.href = url;
                planningMapWindow.focus();
            } else {
                planningMapWindow = window.open(
                    url,
                    'PlanningMap',
                    `width=${popupWidth},height=${popupHeight},left=${popupLeft},top=0,menubar=no,toolbar=no,location=yes,status=no,scrollbars=yes,resizable=yes`
                );
            }

            isPlanningMode = true;
            updatePlanningModeUI(true);

            // Show sync notification
            const sourceName = isInCanTho ? 'GIS Cần Thơ chính thức' : 'Guland.vn';
            showToast('Bản đồ Quy hoạch', `Đã mở ${sourceName} tại vị trí hiện tại.`, 'success');
        }

        // Sync current position to planning map
        function syncPlanningMapPosition() {
            if (planningMapWindow && !planningMapWindow.closed) {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const url = buildPlanningURL('guland', center.lat, center.lng, zoom);
                planningMapWindow.location.href = url;
                planningMapWindow.focus();
                showToast('Đã đồng bộ', `Vị trí: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
            } else {
                // Window was closed, reopen
                openPlanningMapSynced();
            }
        }

        // Close planning mode
        function closePlanningMode() {
            if (planningMapWindow && !planningMapWindow.closed) {
                planningMapWindow.close();
            }
            planningMapWindow = null;
            isPlanningMode = false;
            updatePlanningModeUI(false);
        }

        // Update UI for planning mode
        function updatePlanningModeUI(isActive) {
            const planningBtn = document.querySelector('.map-layer-btn[data-layer="planning"]');
            const syncBar = document.getElementById('planning-sync-bar');

            if (isActive) {
                planningBtn?.classList.add('active');
                if (syncBar) syncBar.style.display = 'flex';
            } else {
                planningBtn?.classList.remove('active');
                if (syncBar) syncBar.style.display = 'none';
            }
        }

        // Check if planning window is still open
        function checkPlanningWindow() {
            if (isPlanningMode && planningMapWindow && planningMapWindow.closed) {
                isPlanningMode = false;
                updatePlanningModeUI(false);
            }
        }

        // Periodically check planning window status
        setInterval(checkPlanningWindow, 2000);

        // ==================== PLANNING LAYER (OVERLAY) ====================
        let planningLayerGroup = null;
        let planningZonesData = [];
        let isPlanningLayerVisible = false;

        // Load planning zones from database and display on map
        async function loadPlanningZones() {
            try {
                const bounds = map.getBounds();
                const response = await fetch(`${API_BASE}/planning-zones/bounds?minLat=${bounds.getSouth()}&maxLat=${bounds.getNorth()}&minLng=${bounds.getWest()}&maxLng=${bounds.getEast()}`);

                if (response.ok) {
                    planningZonesData = await response.json();
                    if (isPlanningLayerVisible) {
                        renderPlanningZones();
                    }
                }
            } catch (error) {
                console.log('Planning zones not available:', error);
                // Fallback: load all zones
                try {
                    const response = await fetch(`${API_BASE}/planning-zones`);
                    if (response.ok) {
                        planningZonesData = await response.json();
                        if (isPlanningLayerVisible) {
                            renderPlanningZones();
                        }
                    }
                } catch (e) {
                    console.log('Could not load planning zones');
                }
            }
        }

        // Render planning zones on map
        function renderPlanningZones() {
            if (!planningLayerGroup) {
                planningLayerGroup = L.layerGroup().addTo(map);
            }

            // Clear existing
            planningLayerGroup.clearLayers();

            planningZonesData.forEach(zone => {
                try {
                    let layer;

                    // Try GeoJSON first (from KMZ uploads)
                    if (zone.geojson) {
                        try {
                            const geojson = typeof zone.geojson === 'string' ? JSON.parse(zone.geojson) : zone.geojson;
                            layer = L.geoJSON(geojson, {
                                style: {
                                    color: zone.strokeColor || '#333333',
                                    weight: 2,
                                    opacity: 0.8,
                                    fillColor: zone.fillColor || '#f59e0b',
                                    fillOpacity: parseFloat(zone.fillOpacity) || 0.4
                                }
                            });
                        } catch (geoErr) {
                            console.warn('GeoJSON parse error, falling back to coordinates', geoErr);
                        }
                    }

                    // Fallback to boundaryCoordinates 
                    if (!layer && zone.boundaryCoordinates) {
                        const coords = typeof zone.boundaryCoordinates === 'string'
                            ? JSON.parse(zone.boundaryCoordinates)
                            : zone.boundaryCoordinates;
                        layer = L.polygon(coords, {
                            color: zone.strokeColor || '#c92a2a',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: zone.fillColor || '#ff6b6b',
                            fillOpacity: parseFloat(zone.fillOpacity) || 0.4,
                            className: 'planning-zone-polygon'
                        });
                    }

                    if (!layer) return;

                    // Create popup content
                    const popupContent = `
                        <div class="planning-zone-popup">
                            <h4 style="margin: 0 0 8px 0; color: ${zone.fillColor || '#f59e0b'};">
                                <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">map</span>
                                ${zone.name || 'Vùng quy hoạch'}
                            </h4>
                            <div style="font-size: 12px; color: #4b5563; line-height: 1.6;">
                                <p><strong>Loại đất:</strong> ${zone.zoneType || 'Chưa phân loại'}</p>
                                ${zone.zoneCode ? `<p><strong>Mã:</strong> ${zone.zoneCode}</p>` : ''}
                                ${zone.landUsePurpose ? `<p><strong>Mục đích:</strong> ${zone.landUsePurpose}</p>` : ''}
                                ${zone.planningPeriod ? `<p><strong>Kỳ QH:</strong> ${zone.planningPeriod}</p>` : ''}
                                ${zone.district || zone.commune ? `<p><strong>Địa điểm:</strong> ${zone.commune || ''} ${zone.district || ''} ${zone.province || ''}</p>` : ''}
                                ${zone.source ? `<p style="font-size: 11px; color: #9ca3af;"><em>Nguồn: ${zone.source}</em></p>` : ''}
                                ${zone.notes ? `<p style="font-size: 11px; color: #64748b; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e7eb;">${zone.notes}</p>` : ''}
                                ${zone.verified ? '<span style="color: #10b981; font-size: 11px;">✓ Đã xác minh</span>' : '<span style="color: #f59e0b; font-size: 11px;">⚠ Chưa xác minh</span>'}
                            </div>
                        </div>
                    `;

                    layer.bindPopup(popupContent);
                    layer.bindTooltip(zone.name || 'Vùng quy hoạch', {
                        permanent: false,
                        direction: 'center',
                        className: 'planning-zone-tooltip'
                    });

                    planningLayerGroup.addLayer(layer);
                } catch (e) {
                    console.error('Error rendering zone:', zone.name, e);
                }
            });
        }

        // Toggle planning layer visibility
        function togglePlanningLayer() {
            isPlanningLayerVisible = !isPlanningLayerVisible;

            const planningBtn = document.querySelector('.map-layer-btn[data-layer="planning"]');
            const planningLegend = document.getElementById('planning-legend');

            if (isPlanningLayerVisible) {
                planningBtn?.classList.add('active');
                if (planningLegend) planningLegend.style.display = 'block';

                // Load and render zones
                loadPlanningZones();

                // Load legend dynamically
                loadPlanningLegend();

                // Show admin bar if user can add zones
                document.getElementById('planning-admin-bar')?.style.setProperty('display', 'flex');

                showToast('Bản đồ Quy hoạch', 'Đang hiển thị các vùng quy hoạch đã lưu', 'success');
            } else {
                planningBtn?.classList.remove('active');
                if (planningLegend) planningLegend.style.display = 'none';
                document.getElementById('planning-admin-bar')?.style.setProperty('display', 'none');

                // Clear layer
                if (planningLayerGroup) {
                    planningLayerGroup.clearLayers();
                }
            }
        }

        // Load planning legend dynamically from API
        async function loadPlanningLegend() {
            try {
                const response = await fetch(`${API_BASE}/planning-zones/types`);
                if (!response.ok) return;

                const zoneTypes = await response.json();
                const legendItems = document.querySelector('.planning-legend__items');
                if (!legendItems || !zoneTypes.length) return;

                // Group by category
                const categories = {};
                zoneTypes.forEach(t => {
                    const cat = t.category || 'Khác';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(t);
                });

                // Generate legend HTML
                let html = '';
                for (const [category, types] of Object.entries(categories)) {
                    html += `<div class="planning-legend__category" style="padding: 8px 12px; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; background: #f9fafb;">${category}</div>`;
                    types.forEach(t => {
                        html += `
                            <div class="planning-legend__item" style="display: flex; align-items: center; gap: 10px; padding: 6px 12px;">
                                <span class="planning-legend__dot" style="width: 16px; height: 16px; border-radius: 4px; background: ${t.defaultColor};"></span>
                                <span style="flex: 1; font-size: 12px; color: #374151;">${t.name}</span>
                                <span style="font-size: 10px; color: #9ca3af;">${t.code}</span>
                            </div>
                        `;
                    });
                }

                legendItems.innerHTML = html;
            } catch (e) {
                console.log('Could not load planning legend:', e);
            }
        }

        // ==================== SOIL MAP LAYER ====================
        let soilLayerGroup = null;
        let soilZonesData = [];
        let isSoilLayerVisible = false;

        // Load soil zones from database
        async function loadSoilZones() {
            try {
                const bounds = map.getBounds();
                const response = await fetch(`${API_BASE}/planning-zones/bounds?minLat=${bounds.getSouth()}&maxLat=${bounds.getNorth()}&minLng=${bounds.getWest()}&maxLng=${bounds.getEast()}&mapType=soil`);

                if (response.ok) {
                    soilZonesData = await response.json();
                    if (isSoilLayerVisible) {
                        renderSoilZones();
                    }
                }
            } catch (error) {
                console.log('Soil zones not available:', error);
                // Fallback: load all soil zones
                try {
                    const response = await fetch(`${API_BASE}/planning-zones?mapType=soil`);
                    if (response.ok) {
                        soilZonesData = await response.json();
                        if (isSoilLayerVisible) {
                            renderSoilZones();
                        }
                    }
                } catch (e) {
                    console.log('Could not load soil zones');
                }
            }
        }

        // Render soil zones on map
        function renderSoilZones() {
            if (!soilLayerGroup) {
                soilLayerGroup = L.layerGroup().addTo(map);
            }

            // Clear existing
            soilLayerGroup.clearLayers();

            soilZonesData.forEach(zone => {
                try {
                    let layer;

                    // Try GeoJSON first
                    if (zone.geojson) {
                        try {
                            const geojson = typeof zone.geojson === 'string' ? JSON.parse(zone.geojson) : zone.geojson;
                            layer = L.geoJSON(geojson, {
                                style: {
                                    color: zone.strokeColor || '#78350f',
                                    weight: 2,
                                    opacity: 0.8,
                                    fillColor: zone.fillColor || '#d97706',
                                    fillOpacity: parseFloat(zone.fillOpacity) || 0.5
                                }
                            });
                        } catch (geoErr) {
                            console.warn('GeoJSON parse error for soil zone', geoErr);
                        }
                    }

                    // Fallback to boundaryCoordinates
                    if (!layer && zone.boundaryCoordinates) {
                        const coords = typeof zone.boundaryCoordinates === 'string'
                            ? JSON.parse(zone.boundaryCoordinates)
                            : zone.boundaryCoordinates;
                        layer = L.polygon(coords, {
                            color: zone.strokeColor || '#78350f',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: zone.fillColor || '#d97706',
                            fillOpacity: parseFloat(zone.fillOpacity) || 0.5,
                            className: 'soil-zone-polygon'
                        });
                    }

                    if (!layer) return;

                    // Create popup content for soil zone
                    const popupContent = `
                        <div class="soil-zone-popup" style="min-width: 220px;">
                            <h4 style="margin: 0 0 8px 0; color: #92400e;">
                                <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">landscape</span>
                                ${zone.name || 'Vùng thổ nhưỡng'}
                            </h4>
                            <div style="font-size: 12px; color: #4b5563; line-height: 1.6;">
                                <p><strong>Loại đất:</strong> ${zone.zoneType || 'Chưa phân loại'}</p>
                                ${zone.zoneCode ? `<p><strong>Mã:</strong> ${zone.zoneCode}</p>` : ''}
                                ${zone.landUsePurpose ? `<p><strong>Đặc điểm:</strong> ${zone.landUsePurpose}</p>` : ''}
                                ${zone.district || zone.commune ? `<p><strong>Vị trí:</strong> ${zone.commune || ''} ${zone.district || ''} ${zone.province || ''}</p>` : ''}
                                ${zone.notes ? `<p style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 11px;"><strong>Gợi ý cây trồng:</strong> ${zone.notes}</p>` : ''}
                                ${zone.source ? `<p style="font-size: 11px; color: #9ca3af;"><em>Nguồn: ${zone.source}</em></p>` : ''}
                            </div>
                        </div>
                    `;

                    layer.bindPopup(popupContent);
                    layer.bindTooltip(zone.name || 'Vùng thổ nhưỡng', {
                        permanent: false,
                        direction: 'center',
                        className: 'soil-zone-tooltip'
                    });

                    soilLayerGroup.addLayer(layer);
                } catch (e) {
                    console.error('Error rendering soil zone:', zone.name, e);
                }
            });
        }

        // Toggle soil layer visibility
        function toggleSoilLayer() {
            // If planning is active, turn it off first (exclusive toggle)
            if (isPlanningLayerVisible) {
                togglePlanningLayer();
            }

            isSoilLayerVisible = !isSoilLayerVisible;

            const soilBtn = document.querySelector('.map-layer-btn[data-layer="soil"]');
            const soilLegend = document.getElementById('soil-legend');

            if (isSoilLayerVisible) {
                soilBtn?.classList.add('active');
                if (soilLegend) soilLegend.style.display = 'block';

                // Load and render soil zones
                loadSoilZones();

                showToast('Bản đồ Thổ nhưỡng', 'Đang hiển thị các vùng thổ nhưỡng', 'success');
            } else {
                soilBtn?.classList.remove('active');
                if (soilLegend) soilLegend.style.display = 'none';

                // Clear layer
                if (soilLayerGroup) {
                    soilLayerGroup.clearLayers();
                }
            }
        }

        // Filter soil zones by district
        async function filterSoilByDistrict(district) {
            try {
                let url = `${API_BASE}/planning-zones?mapType=soil`;
                if (district) {
                    url = `${API_BASE}/planning-zones/by-district?district=${encodeURIComponent(district)}&mapType=soil`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch');

                soilZonesData = await response.json();
                renderSoilZones();

                showToast(
                    'Lọc Thổ nhưỡng',
                    district ? `Đang hiển thị ${soilZonesData.length} vùng tại ${district}` : `Đang hiển thị tất cả ${soilZonesData.length} vùng`,
                    'success'
                );
            } catch (e) {
                console.error('Filter error:', e);
                showToast('Lỗi', 'Không thể lọc dữ liệu thổ nhưỡng', 'error');
            }
        }

        // Search soil zone by coordinate
        async function searchSoilByCoordinate() {
            const input = document.getElementById('soil-coord-search')?.value?.trim();
            if (!input) {
                showToast('Tìm kiếm', 'Vui lòng nhập tọa độ (VD: 10.0306, 105.7701)', 'warning');
                return;
            }

            // Parse coordinates - same logic as planning
            const parts = input.split(/[,\s]+/).map(p => parseFloat(p.trim()));
            if (parts.length < 2 || isNaN(parts[0]) || isNaN(parts[1])) {
                showToast('Lỗi', 'Định dạng tọa độ không hợp lệ', 'error');
                return;
            }

            const lat = parts[0];
            const lng = parts[1];

            // Pan to location
            map.setView([lat, lng], 16);

            // Search for soil zones near this point
            try {
                const response = await fetch(`${API_BASE}/planning-zones/near?lat=${lat}&lng=${lng}&radius=0.01&mapType=soil`);
                if (response.ok) {
                    const zones = await response.json();
                    if (zones.length > 0) {
                        soilZonesData = zones;
                        renderSoilZones();
                        showToast('Tìm thấy', `${zones.length} vùng thổ nhưỡng gần tọa độ này`, 'success');
                    } else {
                        showToast('Không tìm thấy', 'Không có vùng thổ nhưỡng nào gần tọa độ này', 'warning');
                    }
                }
            } catch (e) {
                console.error('Search error:', e);
            }
        }

        // Update togglePlanningLayer to be exclusive with soil
        const originalTogglePlanningLayer = togglePlanningLayer;
        togglePlanningLayer = function() {
            // If soil is active, turn it off first
            if (isSoilLayerVisible) {
                isSoilLayerVisible = false;
                const soilBtn = document.querySelector('.map-layer-btn[data-layer="soil"]');
                const soilLegend = document.getElementById('soil-legend');
                soilBtn?.classList.remove('active');
                if (soilLegend) soilLegend.style.display = 'none';
                if (soilLayerGroup) soilLayerGroup.clearLayers();
            }

            isPlanningLayerVisible = !isPlanningLayerVisible;

            const planningBtn = document.querySelector('.map-layer-btn[data-layer="planning"]');
            const planningLegend = document.getElementById('planning-legend');

            if (isPlanningLayerVisible) {
                planningBtn?.classList.add('active');
                if (planningLegend) planningLegend.style.display = 'block';
                loadPlanningZones();
                loadPlanningLegend();
                showToast('Bản đồ Quy hoạch', 'Đang hiển thị các vùng quy hoạch đã lưu', 'success');
            } else {
                planningBtn?.classList.remove('active');
                if (planningLegend) planningLegend.style.display = 'none';
                if (planningLayerGroup) planningLayerGroup.clearLayers();
            }
        };

        // ==================== PHASE 3: FILTER, SEARCH & EXPORT ====================

        let currentDistrictFilter = '';

        // Load district options for filter dropdown
        async function loadDistrictFilter() {
            try {
                const response = await fetch(`${API_BASE}/planning-zones/districts`);
                if (!response.ok) return;

                const data = await response.json();
                const select = document.getElementById('planning-district-filter');
                if (!select) return;

                // Clear existing options except first
                select.innerHTML = '<option value="">🏛️ Tất cả Quận/Huyện</option>';

                // Add options with counts
                data.withCounts?.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.name;
                    option.textContent = `${d.name} (${d.count})`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.log('Could not load districts:', e);
            }
        }

        // Filter planning zones by district
        async function filterPlanningByDistrict(district) {
            currentDistrictFilter = district;

            try {
                let url = `${API_BASE}/planning-zones`;
                if (district) {
                    url = `${API_BASE}/planning-zones/by-district?district=${encodeURIComponent(district)}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch');

                planningZonesData = await response.json();
                renderPlanningZones();

                showToast(
                    'Lọc Quy hoạch',
                    district ? `Đang hiển thị ${planningZonesData.length} vùng tại ${district}` : `Đang hiển thị tất cả ${planningZonesData.length} vùng`,
                    'success'
                );
            } catch (e) {
                console.error('Filter error:', e);
                showToast('Lỗi', 'Không thể lọc dữ liệu quy hoạch', 'error');
            }
        }

        // Search planning zone by coordinate
        async function searchPlanningByCoordinate() {
            const input = document.getElementById('planning-coord-search')?.value?.trim();
            if (!input) {
                showToast('Tìm kiếm', 'Vui lòng nhập tọa độ (VD: 10.0306, 105.7701)', 'warning');
                return;
            }

            // Parse coordinates
            const parts = input.split(',').map(s => parseFloat(s.trim()));
            if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) {
                showToast('Lỗi', 'Tọa độ không hợp lệ. Định dạng: lat, lng', 'error');
                return;
            }

            const [lat, lng] = parts;

            try {
                // Fly to location
                map.flyTo([lat, lng], 16);

                // Search for zones at this point
                const response = await fetch(`${API_BASE}/planning-zones/at-point?lat=${lat}&lng=${lng}`);
                const zones = await response.json();

                if (zones.length > 0) {
                    // Add marker at search point
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: '<span class="material-symbols-outlined" style="color:#ef4444;font-size:32px;text-shadow:0 2px 4px rgba(0,0,0,0.3);">location_on</span>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map);

                    // Open first zone popup
                    const zone = zones[0];
                    const popup = L.popup()
                        .setLatLng([lat, lng])
                        .setContent(`
                            <div class="planning-zone-popup">
                                <h4 style="margin: 0 0 8px 0; color: ${zone.fillColor || '#f59e0b'};">
                                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">map</span>
                                    ${zone.name || 'Vùng quy hoạch'}
                                </h4>
                                <div style="font-size: 12px; color: #4b5563;">
                                    <p><strong>Loại:</strong> ${zone.zoneType || 'Chưa phân loại'}</p>
                                    <p><strong>Mã:</strong> ${zone.zoneCode || '-'}</p>
                                    <p><strong>Địa điểm:</strong> ${zone.district || '-'}</p>
                                </div>
                            </div>
                        `)
                        .openOn(map);

                    // Remove marker after 5 seconds
                    setTimeout(() => map.removeLayer(marker), 5000);

                    showToast('Kết quả', `Tìm thấy ${zones.length} vùng quy hoạch tại tọa độ này`, 'success');
                } else {
                    showToast('Không tìm thấy', 'Không có vùng quy hoạch tại tọa độ này', 'info');
                }
            } catch (e) {
                console.error('Search error:', e);
                showToast('Lỗi', 'Không thể tìm kiếm vùng quy hoạch', 'error');
            }
        }

        // Export planning zones as GeoJSON
        async function exportPlanningGeoJson() {
            try {
                let url = `${API_BASE}/planning-zones/export/geojson`;
                if (currentDistrictFilter) {
                    url += `?district=${encodeURIComponent(currentDistrictFilter)}`;
                }

                const response = await fetch(url);
                const geojson = await response.json();

                // Create downloadable file
                const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                const downloadUrl = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `planning_zones_${currentDistrictFilter || 'all'}_${new Date().toISOString().split('T')[0]}.geojson`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                showToast('Export', `Đã xuất ${geojson.features?.length || 0} vùng quy hoạch`, 'success');
            } catch (e) {
                console.error('Export error:', e);
                showToast('Lỗi', 'Không thể xuất dữ liệu GeoJSON', 'error');
            }
        }

        // Update togglePlanningLayer to load district filter
        const originalTogglePlanningLayer = togglePlanningLayer;
        togglePlanningLayer = function () {
            originalTogglePlanningLayer();
            if (isPlanningLayerVisible) {
                loadDistrictFilter();
            }
        };


        // Start drawing a new planning zone
        let drawingPlanningZone = false;
        let planningDrawControl = null;

        function startDrawingPlanningZone() {
            if (drawingPlanningZone) return;
            drawingPlanningZone = true;

            document.getElementById('drawing-indicator').classList.add('active');
            document.getElementById('drawing-indicator').querySelector('span:last-child').textContent =
                'Click để vẽ vùng quy hoạch. Nhấn Enter để hoàn thành.';

            planningDrawControl = new L.Draw.Polygon(map, {
                shapeOptions: {
                    color: '#f59e0b',
                    weight: 3,
                    fillOpacity: 0.3,
                    dashArray: '5, 10'
                }
            });
            planningDrawControl.enable();

            map.once(L.Draw.Event.CREATED, onPlanningZoneDrawComplete);
        }

        function onPlanningZoneDrawComplete(e) {
            drawingPlanningZone = false;
            document.getElementById('drawing-indicator').classList.remove('active');

            const layer = e.layer;
            const latlngs = layer.getLatLngs()[0];
            const area = L.GeometryUtil.geodesicArea(latlngs);

            // Calculate center
            const bounds = layer.getBounds();
            const center = bounds.getCenter();

            // Show modal to save planning zone
            showPlanningZoneModal(latlngs, area, center);

            if (planningDrawControl) planningDrawControl.disable();
        }

        // Show modal to create planning zone
        async function showPlanningZoneModal(coordinates, areaSqm, center) {
            // Load zone types
            let zoneTypes = [];
            try {
                const response = await fetch(`${API_BASE}/planning-zones/types`);
                if (response.ok) {
                    zoneTypes = await response.json();
                }
            } catch (e) {
                console.log('Could not load zone types');
            }

            // Group by category
            const categories = {};
            zoneTypes.forEach(t => {
                if (!categories[t.category]) categories[t.category] = [];
                categories[t.category].push(t);
            });

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'planning-zone-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                        <div>
                            <h3 style="margin: 0;">
                                <span class="material-symbols-outlined" style="vertical-align: middle;">add_location</span>
                                Thêm vùng Quy hoạch mới
                            </h3>
                            <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Diện tích: ${(areaSqm / 10000).toFixed(2)} ha</p>
                        </div>
                        <span class="close-modal" onclick="closeModalById('planning-zone-modal')" style="color: white; cursor: pointer;">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Tên vùng quy hoạch *</label>
                            <input type="text" id="pz-name" placeholder="VD: Khu đất trồng lúa xã Nhơn Ái" 
                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Loại đất *</label>
                                <select id="pz-zone-code" style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;" onchange="updateZoneTypeFromCode()">
                                    <option value="">-- Chọn loại đất --</option>
                                    ${Object.entries(categories).map(([cat, types]) => `
                                        <optgroup label="${cat}">
                                            ${types.map(t => `<option value="${t.code}" data-color="${t.defaultColor}" data-name="${t.name}">${t.code} - ${t.name}</option>`).join('')}
                                        </optgroup>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Kỳ quy hoạch</label>
                                <select id="pz-period" style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;">
                                    <option value="2021-2030">2021 - 2030</option>
                                    <option value="2026-2030">KH 2026 - 2030</option>
                                    <option value="2030-2040">2030 - 2040</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Mục đích sử dụng</label>
                            <input type="text" id="pz-purpose" placeholder="VD: Đất chuyên trồng lúa nước 2 vụ" 
                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px;">Tỉnh/TP</label>
                                <input type="text" id="pz-province" placeholder="VD: Cần Thơ" 
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px;">Quận/Huyện</label>
                                <input type="text" id="pz-district" placeholder="VD: Phong Điền" 
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px;">Xã/Phường</label>
                                <input type="text" id="pz-commune" placeholder="VD: Nhơn Ái" 
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Nguồn thông tin</label>
                                <select id="pz-source" style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;">
                                    <option value="Guland.vn">Guland.vn</option>
                                    <option value="Thư viện Quy hoạch">Thư viện Quy hoạch</option>
                                    <option value="Sở TN&MT">Sở TN&MT địa phương</option>
                                    <option value="UBND">UBND xã/phường</option>
                                    <option value="Khác">Nguồn khác</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Màu hiển thị</label>
                                <input type="color" id="pz-color" value="#22c55e" 
                                    style="width: 100%; height: 42px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Ghi chú</label>
                            <textarea id="pz-notes" rows="2" placeholder="Thông tin bổ sung..." 
                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
                            <p style="margin: 0; font-size: 12px; color: #92400e;">
                                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">info</span>
                                <strong>Lưu ý:</strong> Thông tin quy hoạch này được lưu để tham khảo. Vui lòng xác minh với cơ quan có thẩm quyền trước khi sử dụng đất.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeModalById('planning-zone-modal')" class="btn btn--secondary">Hủy</button>
                        <button onclick="savePlanningZone()" class="btn btn--primary" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <span class="material-symbols-outlined">save</span> Lưu vùng quy hoạch
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Store coordinates for saving
            window.pendingPlanningZone = {
                coordinates: coordinates.map(ll => [ll.lat, ll.lng]),
                areaSqm: areaSqm,
                centerLat: center.lat,
                centerLng: center.lng
            };
        }

        // Update color when zone type changes
        function updateZoneTypeFromCode() {
            const select = document.getElementById('pz-zone-code');
            const option = select.options[select.selectedIndex];
            if (option && option.dataset.color) {
                document.getElementById('pz-color').value = option.dataset.color;
            }
        }

        // Save planning zone to database
        async function savePlanningZone() {
            const name = document.getElementById('pz-name').value.trim();
            const zoneCode = document.getElementById('pz-zone-code').value;

            if (!name) {
                alert('Vui lòng nhập tên vùng quy hoạch');
                return;
            }
            if (!zoneCode) {
                alert('Vui lòng chọn loại đất');
                return;
            }

            const select = document.getElementById('pz-zone-code');
            const option = select.options[select.selectedIndex];
            const zoneType = option.parentElement.label; // Get category as zoneType

            const data = {
                name: name,
                boundaryCoordinates: JSON.stringify(window.pendingPlanningZone.coordinates),
                areaSqm: window.pendingPlanningZone.areaSqm,
                centerLat: window.pendingPlanningZone.centerLat,
                centerLng: window.pendingPlanningZone.centerLng,
                zoneType: zoneType,
                zoneCode: zoneCode,
                landUsePurpose: document.getElementById('pz-purpose').value,
                planningPeriod: document.getElementById('pz-period').value,
                province: document.getElementById('pz-province').value,
                district: document.getElementById('pz-district').value,
                commune: document.getElementById('pz-commune').value,
                source: document.getElementById('pz-source').value,
                fillColor: document.getElementById('pz-color').value,
                strokeColor: adjustColor(document.getElementById('pz-color').value, -30),
                fillOpacity: 0.4,
                notes: document.getElementById('pz-notes').value
            };

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/planning-zones`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModalById('planning-zone-modal');
                    showToast('Thành công', 'Đã lưu vùng quy hoạch', 'success');

                    // Reload planning zones
                    await loadPlanningZones();
                    renderPlanningZones();
                } else {
                    const err = await response.json();
                    showToast('Lỗi', err.error || 'Không thể lưu', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Lỗi', 'Lỗi kết nối', 'error');
            }
        }

        // Darken/lighten color helper
        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // ==================== MAP INITIALIZATION ====================
        let fieldsLayerGroup;

        // ==================== MAP INITIALIZATION ====================
        async function initMap() {
            // Load saved position from database
            let initialCenter = [currentLocation.lat, currentLocation.lng];
            let initialZoom = CONFIG.MAP_DEFAULT_ZOOM;

            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                try {
                    const response = await fetch(`${API_BASE}/user/map-position?email=${encodeURIComponent(userEmail)}`);
                    if (response.ok) {
                        const pos = await response.json();
                        initialCenter = [pos.lat, pos.lng];
                        initialZoom = pos.zoom || CONFIG.MAP_DEFAULT_ZOOM;
                        currentLocation.lat = pos.lat;
                        currentLocation.lng = pos.lng;
                    }
                } catch (e) {
                    console.log('Could not load saved position, using default');
                }
            }

            map = L.map('leaflet-map', { center: initialCenter, zoom: initialZoom, zoomControl: false });
            tileLayers.satellite.addTo(map);

            // Create dedicated layer group for fields
            fieldsLayerGroup = L.layerGroup().addTo(map);

            // Save position when map moves (debounced to avoid too many API calls)
            let saveTimeout;
            map.on('moveend', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveMapPosition, 1000);
            });
            map.on('zoomend', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveMapPosition, 1000);
            });

            // Initialize draw control
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Load fields from API
            await loadFieldsFromAPI();
            await loadCrops();
            await loadUserInventory(); // Load inventory for activity checks

            checkDailyTasks();

            setupControls();
        }

        // ==================== FINANCIAL HEATMAP ====================
        let isFinancialMode = false;
        let financialDataCache = null;

        async function toggleFinancialMode() {
            const btn = document.getElementById('btn-financial-mode');
            const icon = btn.querySelector('.material-symbols-outlined');
            isFinancialMode = !isFinancialMode;

            if (isFinancialMode) {
                // Add active styling (assuming .map-control-btn.active or custom style)
                btn.style.backgroundColor = '#f59e0b'; // Amber
                btn.style.color = 'white';
                icon.textContent = 'payments';

                // Show legend
                showFinancialLegend(true);

                // Fetch data if not cached
                if (!currentFarmId) {
                    await loadCurrentFarm();
                }
                if (currentFarmId) {
                    try {
                        const response = await fetch(`${API_BASE}/analytics/fields/financial-summary?farmId=${currentFarmId}`);
                        if (response.ok) {
                            financialDataCache = await response.json();
                            applyFinancialHeatmap();
                        }
                    } catch (e) { console.error(e); }
                }

            } else {
                // Reset styling
                btn.style.backgroundColor = 'white';
                btn.style.color = '#374151'; // Default gray
                icon.textContent = 'monetization_on';

                showFinancialLegend(false);
                renderFieldsOnMap();
            }
        }



        function showFinancialLegend(show) {
            let legend = document.getElementById('financial-legend');
            if (!legend && show) {
                legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.id = 'financial-legend';
                    div.style.background = 'white';
                    div.style.padding = '10px';
                    div.style.borderRadius = '5px';
                    div.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';
                    div.innerHTML = `
                        <h4 style="margin:0 0 5px;font-size:12px;">Lợi nhuận dự kiến</h4>
                        <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px;"><span style="width:12px;height:12px;background:#15803d;display:inline-block;"></span> Lãi cao (>30%)</div>
                        <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px;"><span style="width:12px;height:12px;background:#facc15;display:inline-block;"></span> Ổn định/Thấp</div>
                        <div style="display:flex;align-items:center;gap:5px;"><span style="width:12px;height:12px;background:#ef4444;display:inline-block;"></span> Đang lỗ</div>
                    `;
                    return div;
                };
                legend.addTo(map);
            } else if (legend && !show) {
                document.getElementById('financial-legend').remove();
            }
        }

        function applyFinancialHeatmap() {
            if (!fieldsLayerGroup || !financialDataCache) return;

            fieldsLayerGroup.eachLayer(layer => {
                const fieldId = layer.feature?.properties?.id; // Assuming we attached feature info
                // Workaround: We didn't attach feature to layer in renderFieldsOnMap properly for all fields
                // Let's re-render specifically for heatmap
            });

            // Re-render with heatmap logic
            fieldsLayerGroup.clearLayers();

            fieldsData.forEach(field => {
                if (!field.boundaryCoordinates) return;
                let coords;
                try { coords = JSON.parse(field.boundaryCoordinates); } catch (e) { return; }

                const finance = financialDataCache.find(f => f.fieldId === field.id);
                let color = '#9ca3af'; // Grey default
                let popupContent = '';

                if (finance) {
                    switch (finance.status) {
                        case 'PROFIT_HIGH': color = '#15803d'; break; // Green
                        case 'PROFIT_LOW': color = '#facc15'; break; // Yellow
                        case 'NEUTRAL': color = '#facc15'; break;
                        case 'LOSS': color = '#ef4444'; break; // Red
                    }

                    const roi = finance.totalCost > 0 ? ((finance.projectedProfit / finance.totalCost) * 100).toFixed(1) + '%' : 'N/A';

                    popupContent = `
                        <div style="text-align:center; min-width:180px;">
                            <h4 style="margin:0 0 8px 0; color:#b45309;">${field.name}</h4>
                            <div style="background:#f3f4f6; padding:8px; border-radius:8px; text-align:left;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                    <span style="color:#6b7280;font-size:12px;">Đã chi:</span>
                                    <span style="font-weight:600;">${formatMoney(finance.totalCost)}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                    <span style="color:#6b7280;font-size:12px;">Dự thu:</span>
                                    <span style="font-weight:600;">${formatMoney(finance.estimatedRevenue)}</span>
                                </div>
                                <div style="margin-top:6px; pt-1; border-top:1px dashed #d1d5db; display:flex;justify-content:space-between; align-items:center;">
                                    <span style="font-weight:bold; font-size:13px;">Lãi dự kiến:</span>
                                    <span style="font-weight:bold; color:${finance.projectedProfit >= 0 ? '#16a34a' : '#dc2626'}">
                                        ${formatMoney(finance.projectedProfit)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const polygon = L.polygon(coords, { color: color, weight: 2, opacity: 1, fillOpacity: 0.6 }).addTo(fieldsLayerGroup);
                polygon.feature = { properties: field }; // Re-attach for future usage
                if (popupContent) polygon.bindPopup(popupContent);
                polygon.bindTooltip(`💰 ${formatMoney(finance?.projectedProfit || 0)}`, { direction: 'center', className: 'field-tooltip' });
            });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(amount);
        }

        // Toggle Notification Dropdown
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                checkDailyTasks(); // Refresh when opening
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('notification-dropdown');
            const button = document.querySelector('.header__notification');
            if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Check daily tasks based on field data
        function checkDailyTasks() {
            // Logic to loop fields and generate tasks
            const tasks = [];
            const now = new Date();

            if (!fieldsData || fieldsData.length === 0) {
                renderDailyTasks([]);
                return;
            }

            fieldsData.forEach(field => {
                // 1. Harvest Check
                if (field.expectedHarvestDate) {
                    const harvestDate = new Date(field.expectedHarvestDate);
                    // Check if harvest date is today or passed, AND field is not already harvested
                    // Simple check: crop must be active (currentCropId exists)
                    if (now >= harvestDate && field.currentCropId) {
                        tasks.push({
                            type: 'harvest',
                            fieldId: field.id,
                            fieldName: field.name,
                            title: 'Đến ngày thu hoạch',
                            desc: 'Cần thu hoạch ngay hôm nay',
                            icon: 'agriculture',
                            color: '#fef3c7', // amber bg
                            iconColor: '#d97706'
                        });
                    }
                }

                // 2. Watering Check
                // Rule: If last watered > 24 hours ago
                if (field.lastWateredAt) {
                    const lastWatered = new Date(field.lastWateredAt);
                    const diffHours = (now - lastWatered) / (1000 * 60 * 60);
                    if (diffHours > 24) {
                        tasks.push({
                            type: 'water',
                            fieldId: field.id,
                            fieldName: field.name,
                            title: 'Cần tưới nước',
                            desc: `Đã ${Math.floor(diffHours)} giờ chưa tưới`,
                            icon: 'water_drop',
                            color: '#dbeafe', // blue bg
                            iconColor: '#2563eb'
                        });
                    }
                } else {
                    // If never watered but planted, maybe remind?
                    // For now keeping it simple as per user request for "fresh data"
                }
            });

            renderDailyTasks(tasks);
        }

        function renderDailyTasks(tasks) {
            const container = document.getElementById('notification-list-items');
            const badge = document.querySelector('.header__notification-badge');

            // Update Badge
            if (tasks.length > 0) {
                badge.style.display = 'block';
                badge.innerText = tasks.length;
            } else {
                badge.style.display = 'none';
            }

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="notification-empty">
                        <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: 8px;">task_alt</span>
                        <p>Tuyệt vời! Không có việc cần làm.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="notification-item">
                    <div class="notification-icon" style="background: ${task.color}; color: ${task.iconColor}">
                        <span class="material-symbols-outlined">${task.icon}</span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${task.fieldName}</div>
                        <div class="notification-desc">${task.title} - ${task.desc}</div>
                        <div style="text-align: right;">
                             <button class="notification-action notification-action--primary" onclick="handleTaskAction('${task.type}', ${task.fieldId})">
                                Hoàn thành
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            // 1. Save to Backend (Async)
            saveNotificationToBackend(title, message, type);

            // 2. Show Visual Toast
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerHTML = `
                <div class="toast-icon">
                    <span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : 'info'}</span>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-desc">${message}</div>
                    <div class="toast-time">${timeString}</div>
                </div>
            `;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('closing');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // ==================== LOCAL NOTIFICATION HISTORY ====================
        // ==================== DATABASE NOTIFICATION LOGIC ====================

        async function saveNotificationToBackend(title, message, type) {
            try {
                let backendType = 'INFO';
                if (type === 'success') backendType = 'SUCCESS_ACTION';
                else if (type === 'error') backendType = 'ERROR_ACTION';
                else if (type === 'info') backendType = 'INFO_ACTION';

                await fetch(`${API_BASE}/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 1,
                        title: title,
                        message: message,
                        type: backendType,
                        fieldId: typeof selectedField !== 'undefined' && selectedField ? selectedField.id : null
                    })
                });

                // Refresh list if panel is open
                const panel = document.getElementById('notification-panel');
                if (panel && panel.classList.contains('open')) {
                    renderNotifications();
                }
            } catch (e) {
                console.error('Error saving notification to DB:', e);
            }
        }

        // Override renderNotifications (from features.js) to include local history
        // We redefine it here so it takes precedence
        // Override renderNotifications (from features.js) to use Backend + Grouping
        async function renderNotifications() {
            const container = document.getElementById('notification-list');
            if (!container) return;

            container.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;">Đang tải...</div>';

            try {
                // Fetch all history from backend
                const response = await fetch(`${API_BASE}/notifications/user/1`);
                if (!response.ok) throw new Error('Failed to fetch');
                const notifications = await response.json();

                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="display:flex;flex-direction:column;align-items:center;padding:40px 20px;color:#94a3b8;text-align:center;">
                            <span class="material-symbols-outlined" style="font-size:48px;margin-bottom:12px;opacity:0.5;">notifications_off</span>
                            <p>Không có thông báo nào</p>
                        </div>`;
                    return;
                }

                // Group by Date
                const groups = groupNotificationsByDate(notifications);

                container.innerHTML = '';

                Object.keys(groups).forEach(dateLabel => {
                    // Header
                    const header = document.createElement('div');
                    header.className = 'notification-date-header';
                    header.style.cssText = 'padding: 8px 12px; background: #f1f5f9; color: #475569; font-size: 12px; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; margin-top: 0px; position:sticky; top:0; z-index:10;';
                    header.textContent = dateLabel;
                    container.appendChild(header);

                    // Items
                    const itemsHtml = groups[dateLabel].map(n => renderNotificationItem(n)).join('');
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = itemsHtml;
                    container.appendChild(groupDiv);
                });

            } catch (e) {
                console.error('Error rendering notifications:', e);
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Lỗi tải dữ liệu. Hãy đảm bảo Backend đang chạy.</div>';
            }
        }

        function groupNotificationsByDate(notifications) {
            const groups = {};
            const today = new Date().toLocaleDateString('vi-VN');
            const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('vi-VN');

            notifications.forEach(n => {
                const date = new Date(n.createdAt);
                const dateStr = date.toLocaleDateString('vi-VN');

                let label = dateStr;
                if (dateStr === today) label = 'Hôm nay';
                else if (dateStr === yesterday) label = 'Hôm qua';

                if (!groups[label]) groups[label] = [];
                groups[label].push(n);
            });
            return groups;
        }

        function renderNotificationItem(n) {
            // Determine icon and color based on type
            let icon = 'notifications';
            let iconClass = 'icon--blue';

            // Mapping backend types to icons
            if (n.type && (n.type.includes('SUCCESS') || n.title.includes('thành công'))) { icon = 'check_circle'; iconClass = 'icon--green'; }
            else if (n.type && n.type.includes('ERROR')) { icon = 'error'; iconClass = 'icon--red'; }
            else if (n.type && n.type.includes('HARVEST')) { icon = 'agriculture'; iconClass = 'icon--amber'; }
            else if (n.type && n.type.includes('WATER')) { icon = 'water_drop'; iconClass = 'icon--blue'; }
            else if (n.type && n.type.includes('PEST')) { icon = 'bug_report'; iconClass = 'icon--red'; }
            else if (n.type && n.type.includes('FERTILIZE')) { icon = 'eco'; iconClass = 'icon--green'; }

            const time = new Date(n.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="notification-item ${n.isRead ? 'read' : 'unread'}" style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 12px; align-items: flex-start; background: white;">
                    <div class="notification-icon ${iconClass}" style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f1f5f9;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">${icon}</span>
                    </div>
                    <div class="notification-content" style="flex: 1;">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 2px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">${n.title}</h4>
                            <span style="font-size: 11px; color: #94a3b8;">${time}</span>
                        </div>
                        <p style="font-size: 13px; color: #64748b; margin: 0; line-height: 1.4;">${n.message || ''}</p>
                    </div>
                </div>
            `;
        }

        async function handleTaskAction(type, fieldId) {
            if (type === 'water') {
                // Call API water
                try {
                    const res = await fetch(`${API_BASE}/fields/${fieldId}/water`, { method: 'POST' });
                    if (res.ok) {
                        showToast('Tưới nước', 'Đã tưới nước thành công', 'success');
                        // Refresh data
                        await loadFieldsFromAPI();
                        checkDailyTasks(); // Update list
                    }
                } catch (e) { console.error(e); }
            } else if (type === 'harvest') {
                const dropdown = document.getElementById('notification-dropdown');
                if (dropdown) dropdown.classList.remove('active');

                openHarvestModal(fieldId); // Open existing modal
            }
        }

        async function saveMapPosition() {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) return;

            const center = map.getCenter();
            const zoom = map.getZoom();

            try {
                await fetch(`${API_BASE}/user/map-position`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        lat: center.lat,
                        lng: center.lng,
                        zoom: zoom
                    })
                });
            } catch (e) {
                console.error('Could not save map position:', e);
            }
        }

        // ==================== API FUNCTIONS ====================

        /**
         * Load current user's farm from the backend
         */
        async function loadCurrentFarm() {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                const response = await fetch(`${API_BASE}/farms/my-farms`, { headers });
                if (response.ok) {
                    const farms = await response.json();
                    console.log('Loaded farms for cultivation page:', farms.length);
                    if (farms.length > 0) {
                        currentFarmId = farms[0].id;
                        console.log('Using farmId:', currentFarmId);
                        return true;
                    } else {
                        console.warn('No farms found for current user');
                        return false;
                    }
                }
            } catch (error) {
                console.error('Error loading farm:', error);
            }
            return false;
        }

        async function loadFieldsFromAPI() {
            // First load the current user's farm if not yet loaded
            if (!currentFarmId) {
                const hasFarm = await loadCurrentFarm();
                if (!hasFarm) {
                    console.log('No farm found, skipping field load');
                    fieldsData = [];
                    renderFieldsOnMap();
                    return;
                }
            }

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                const response = await fetch(`${API_BASE}/fields?farmId=${currentFarmId}`, { headers });
                if (response.ok) {
                    fieldsData = await response.json();
                    renderFieldsOnMap();

                    if (selectedField) {
                        const selectedId = selectedField && selectedField.id != null ? selectedField.id : selectedField;
                        const fresh = fieldsData.find(f => f.id == selectedId);
                        if (fresh) selectFieldFromAPI(fresh);
                    }
                }
            } catch (e) {
                console.error('Error loading fields:', e);
                // If API fails, show empty map (no hardcoded data)
            }
        }


        async function loadCrops() {
            try {
                const response = await fetch(`${API_BASE}/crops`);
                if (response.ok) {
                    allCrops = await response.json();
                }
            } catch (e) {
                console.error('Error loading crops:', e);
            }
        }

        function renderFieldsOnMap() {
            // Clear existing layers to prevent duplicates (fix for delete issue)
            if (fieldsLayerGroup) {
                fieldsLayerGroup.clearLayers();
            }

            fieldsData.forEach(field => {
                if (!field.boundaryCoordinates) return;

                let coords;
                try {
                    coords = JSON.parse(field.boundaryCoordinates);
                } catch (e) { return; }

                const color = field.currentCropId ? '#22c55e' : '#94a3b8';
                const cropName = field.currentCrop ? field.currentCrop.name : 'Chưa trồng';
                const areaHa = field.areaSqm ? (field.areaSqm / 10000).toFixed(2) : 0;

                // Add to fieldsLayerGroup instead of map directly
                const polygon = L.polygon(coords, { color, weight: 3, opacity: 0.8, fillColor: color, fillOpacity: 0.4 }).addTo(fieldsLayerGroup);
                let pestButton = '';
                // Only show pest analysis if crop is planted and seeded (Pesticide stage)
                if (field.currentCropId && field.seedingDate) {
                    pestButton = `
                        <button onclick="openPestAnalysisModal(${field.id})" 
                                style="background:#10b981; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px; margin:0 auto;">
                            <span class="material-symbols-outlined" style="font-size:16px;">bug_report</span> 
                            Phân tích sâu bệnh
                        </button>
                    `;
                }

                polygon.bindPopup(`
                    <div style="text-align:center;">
                        <h4 style="margin:0 0 8px 0;">${field.name}</h4>
                        <div style="margin-bottom:8px;">${cropName} - ${areaHa} ha</div>
                        ${pestButton}
                    </div>
                `);
                polygon.on('click', () => selectFieldFromAPI(field));
                polygon.bindTooltip(field.name, { permanent: true, direction: 'center', className: 'field-tooltip' });
            });
        }

        // ==================== FIELD SELECTION ====================
        function selectFieldFromAPI(field) {
            if (field == null) return;

            // Support being called with a numeric id or stub object {id: ...}
            if ((typeof field === 'number' || typeof field === 'string') && Array.isArray(fieldsData)) {
                const id = Number(field);
                const found = fieldsData.find(f => f.id == id);
                if (!found) return;
                field = found;
            } else if (typeof field === 'object' && field.id != null && !field.name && Array.isArray(fieldsData)) {
                const found = fieldsData.find(f => f.id == field.id);
                if (!found) return;
                field = found;
            }

            selectedField = field;
            const cropName = field.currentCrop ? field.currentCrop.name : 'Chưa chọn cây';
            const areaHa = field.areaSqm ? (field.areaSqm / 10000).toFixed(2) : 0;
            const plantedDays = field.plantingDate ? Math.floor((new Date() - new Date(field.plantingDate)) / (1000 * 60 * 60 * 24)) : 0;
            const harvestDate = field.expectedHarvestDate ? new Date(field.expectedHarvestDate).toLocaleDateString('vi-VN') : 'Chưa xác định';
            const growthDays = field.currentCrop?.growthDurationDays || 0;
            const fieldCondition = String(field.condition || 'GOOD').toUpperCase();

            // Determine workflow stage and status
            const stage = getWorkflowStage(field);
            const statusInfo = getFieldStatusInfo(field);

            const fieldInfo = document.getElementById('selected-field-info');
            fieldInfo.innerHTML = `
                <div class="field-info-card__content">
                    <div class="field-info-card__icon" style="background-color: ${statusInfo.iconBg}; color: ${statusInfo.iconColor};">
                        <span class="material-symbols-outlined">${statusInfo.icon}</span>
                    </div>
                    <div style="flex: 1;">
                        <p class="field-info-card__name">${field.name}</p>
                        <p class="field-info-card__meta">${areaHa} ha • ${cropName}</p>
                        ${field.expectedHarvestDate ? `<p class="field-info-card__meta" style="color:#f59e0b;">📅 Dự kiến thu hoạch: ${harvestDate}</p>` : ''}
                        ${field.plantingDate ? `<p class="field-info-card__meta">🌱 Đã trồng ${plantedDays}/${growthDays} ngày</p>` : ''}
                        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
                            <span style="font-size:11px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;">Tình trạng</span>
                            <select id="field-condition-select" onchange="handleFieldConditionChange(this.value)" style="padding:6px 10px;border-radius:10px;border:1px solid #e2e8f0;background:white;font-size:12px;">
                                <option value="GOOD" ${fieldCondition === 'GOOD' ? 'selected' : ''}>Tốt</option>
                                <option value="FAIR" ${fieldCondition === 'FAIR' ? 'selected' : ''}>Trung bình</option>
                                <option value="POOR" ${fieldCondition === 'POOR' ? 'selected' : ''}>Kém</option>
                            </select>
                        </div>
                        <div class="field-status-indicators" style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
                            ${renderStatusBadge('Cây trồng', !!field.currentCrop, field.currentCrop?.name)}
                            ${renderStatusBadge('Bón phân', !!field.lastFertilizedAt, field.lastFertilizedAt ? formatDateShort(field.lastFertilizedAt) : null, field.seedingDate ? getTimingInfo(field).fertilizer : null)}
                            ${renderStatusBadge('Gieo hạt', !!field.seedingDate, field.seedingDate ? `nảy mầm ${getTimingInfo(field).germDays} ngày` : null, getTimingInfo(field).seedWait)}
                            ${renderStatusBadge('Phun thuốc', !!field.lastPesticideAt, field.lastPesticideAt ? formatDateShort(field.lastPesticideAt) : null, getTimingInfo(field).pesticide)}
                            ${(() => {
                    // Custom Harvest Logic
                    if (!field.currentCrop || !field.expectedHarvestDate) return '';
                    const daysToHarvest = Math.ceil((new Date(field.expectedHarvestDate) - new Date()) / (1000 * 60 * 60 * 24));
                    return renderStatusBadge('Thu hoạch', false, null, daysToHarvest);
                })()}
                        </div>
                    </div>
                </div>`;

            // Enable farm management buttons based on workflow
            updateFarmManagementButtons(field);

            if (typeof gsap !== 'undefined') gsap.fromTo(fieldInfo, { opacity: 0, x: 20 }, { opacity: 1, x: 0, duration: 0.3 });
        }

        async function handleFieldConditionChange(condition) {
            if (!selectedField) return;

            const selectEl = document.getElementById('field-condition-select');
            const fieldId = selectedField.id;
            const prevCondition = String(selectedField.condition || 'GOOD').toUpperCase();

            if (selectEl) selectEl.disabled = true;

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(`${API_BASE}/fields/${fieldId}/condition`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ condition })
                });

                if (response.ok) {
                    const updatedField = await response.json();

                    const idx = fieldsData.findIndex(f => f.id === fieldId);
                    if (idx !== -1) fieldsData[idx].condition = updatedField.condition;

                    if (selectedField && selectedField.id === fieldId) {
                        selectedField.condition = updatedField.condition;
                    }

                    showToast('Thành công', 'Đã cập nhật tình trạng ruộng', 'success');
                } else {
                    let err = {};
                    try { err = await response.json(); } catch (e) { }
                    showToast('Lỗi', err.error || 'Không thể cập nhật tình trạng ruộng', 'error');
                    if (selectEl) selectEl.value = prevCondition;
                }
            } catch (e) {
                console.error('Error updating field condition:', e);
                showToast('Lỗi', 'Không thể cập nhật tình trạng ruộng', 'error');
                if (selectEl) selectEl.value = prevCondition;
            } finally {
                if (selectEl) selectEl.disabled = false;
            }
        }

        function renderStatusBadge(label, isDone, detail, timeRemaining = null) {
            // timeRemaining: null = no countdown, object or number for countdown
            // If number (legacy): days remaining
            // If object: { days, hours, isHours } for precise display

            let displayText = '';
            let remainingValue = 0;

            if (typeof timeRemaining === 'object' && timeRemaining !== null) {
                remainingValue = timeRemaining.totalHours || (timeRemaining.days * 24);
                if (timeRemaining.isHours) {
                    displayText = `còn ${timeRemaining.hours} giờ`;
                } else {
                    displayText = `còn ${timeRemaining.days} ngày`;
                }
            } else if (typeof timeRemaining === 'number') {
                remainingValue = timeRemaining * 24;
                displayText = `còn ${timeRemaining} ngày`;
            }

            if (timeRemaining !== null && remainingValue > 0) {
                // Waiting - show countdown
                return `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:11px;background:#fef3c7;color:#b45309;">
                    <span class="material-symbols-outlined" style="font-size:14px;">schedule</span>
                    ${label}: ${displayText}
                </span>`;
            } else if (timeRemaining !== null && remainingValue <= 0 && !isDone) {
                // Due now - needs action
                return `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:11px;background:#fee2e2;color:#b91c1c;">
                    <span class="material-symbols-outlined" style="font-size:14px;">warning</span>
                    ${label}: cần thực hiện ngay
                </span>`;
            } else if (isDone) {
                // Done
                return `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:11px;background:#dcfce7;color:#166534;">
                    <span class="material-symbols-outlined" style="font-size:14px;">check_circle</span>
                    ${label}${detail ? ': ' + detail : ''}
                </span>`;
            } else {
                // Not done yet, no countdown
                return `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:11px;background:#f1f5f9;color:#94a3b8;">
                    <span class="material-symbols-outlined" style="font-size:14px;">radio_button_unchecked</span>
                    ${label}
                </span>`;
            }
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        }

        function calculateDaysRemaining(lastActionDate, intervalDays) {
            if (!lastActionDate || !intervalDays) return null;
            const lastDate = new Date(lastActionDate);
            const nextDueDate = new Date(lastDate.getTime() + intervalDays * 24 * 60 * 60 * 1000);
            const today = new Date();
            const diffTime = nextDueDate.getTime() - today.getTime();
            const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // If less than 24 hours remaining, show in hours
            if (diffHours > 0 && diffHours < 24) {
                return { days: 0, hours: diffHours, totalHours: diffHours, isHours: true };
            }
            // Otherwise show in days
            return { days: diffDays, hours: 0, totalHours: diffDays * 24, isHours: false };
        }

        function getTimingInfo(field) {
            const crop = field.currentCrop;
            if (!crop) return { fertilizer: null, germination: null, watering: null, pesticide: null, seedWait: null };

            // Get intervals from crop (handle 0 correctly)
            const fertInterval = (crop.fertilizerIntervalDays !== undefined && crop.fertilizerIntervalDays !== null) ? crop.fertilizerIntervalDays : 30;
            const germDays = (crop.germinationDays !== undefined && crop.germinationDays !== null) ? crop.germinationDays : 7;
            const waterInterval = (crop.wateringIntervalDays !== undefined && crop.wateringIntervalDays !== null) ? crop.wateringIntervalDays : 3;
            const pestInterval = (crop.pesticideIntervalDays !== undefined && crop.pesticideIntervalDays !== null) ? crop.pesticideIntervalDays : 14;

            // Wait time after fertilizing before seeding (default 1 day, 0 for test crops)
            const isTestCrop = crop.growthDurationDays === 0 || (crop.name && crop.name.includes("Test"));
            const seedWaitDays = isTestCrop ? 0 : 1;

            // Calculate days remaining for each action
            const fertRemaining = field.lastFertilizedAt
                ? calculateDaysRemaining(field.lastFertilizedAt, fertInterval)
                : (field.currentCrop ? 0 : null); // Due immediately if crop selected but never fertilized

            // Wait time for seeding after fertilizer
            const seedWaitRemaining = (field.lastFertilizedAt && !field.seedingDate)
                ? calculateDaysRemaining(field.lastFertilizedAt, seedWaitDays)
                : null;

            const germRemaining = field.seedingDate
                ? calculateDaysRemaining(field.seedingDate, germDays)
                : null;

            const waterRemaining = field.lastWateredAt
                ? calculateDaysRemaining(field.lastWateredAt, waterInterval)
                : (field.seedingDate ? 0 : null); // Due immediately if seeded but never watered

            const pestRemaining = field.lastPesticideAt
                ? calculateDaysRemaining(field.lastPesticideAt, pestInterval)
                : (field.seedingDate ? 0 : null); // Due immediately if seeded but never sprayed

            return {
                fertilizer: fertRemaining,
                germination: germRemaining,
                watering: waterRemaining,
                pesticide: pestRemaining,
                seedWait: seedWaitRemaining,
                fertInterval,
                germDays,
                waterInterval,
                pestInterval,
                seedWaitDays
            };
        }

        function getWorkflowStage(field) {
            // Workflow stages:
            // 1. EMPTY - no crop selected
            // 2. CROP_SELECTED - crop selected, need to fertilize
            // 3. FERTILIZED - fertilized, need to seed
            // 4. SEEDED - seeded, can water/spray, wait for harvest
            // 5. READY_HARVEST - ready to harvest

            if (!field.currentCrop) return 'EMPTY';
            if (!field.lastFertilizedAt) return 'CROP_SELECTED';
            if (!field.seedingDate) return 'FERTILIZED';

            // Check if ready to harvest
            if (field.expectedHarvestDate) {
                const harvestDate = new Date(field.expectedHarvestDate);
                if (harvestDate <= new Date()) return 'READY_HARVEST';
            }

            return 'SEEDED';
        }

        function getFieldStatusInfo(field) {
            const stage = getWorkflowStage(field);
            switch (stage) {
                case 'EMPTY':
                    return { icon: 'landscape', iconBg: '#fef3c720', iconColor: '#f59e0b' };
                case 'CROP_SELECTED':
                    return { icon: 'eco', iconBg: '#dbeafe20', iconColor: '#3b82f6' };
                case 'FERTILIZED':
                    return { icon: 'compost', iconBg: '#fef3c720', iconColor: '#eab308' };
                case 'SEEDED':
                    return { icon: 'grass', iconBg: '#dcfce720', iconColor: '#22c55e' };
                case 'READY_HARVEST':
                    return { icon: 'agriculture', iconBg: '#fef3c720', iconColor: '#f97316' };
                default:
                    return { icon: 'grass', iconBg: '#10b98120', iconColor: '#10b981' };
            }
        }

        // ==================== ZONING LOGIC ====================
        let currentZones = [];

        function switchFieldTab(tabName) {
            // Update Buttons
            const btnGeneral = document.getElementById('tab-btn-general');
            const btnZoning = document.getElementById('tab-btn-zoning');

            if (tabName === 'general') {
                btnGeneral.classList.add('active');
                btnGeneral.style.fontWeight = '600'; btnGeneral.style.color = '#0f172a';
                btnZoning.classList.remove('active');
                btnZoning.style.fontWeight = '400'; btnZoning.style.color = '#64748b';

                // Show General Elements
                document.querySelectorAll('.sensor-card, .farm-management-section').forEach(el => el.style.display = 'block');
                document.getElementById('field-timers').style.display = selectedField ? 'flex' : 'none';

                // Hide Zoning
                document.getElementById('zoning-ui').style.display = 'none';

            } else {
                btnGeneral.classList.remove('active');
                btnGeneral.style.fontWeight = '400'; btnGeneral.style.color = '#64748b';
                btnZoning.classList.add('active');
                btnZoning.style.fontWeight = '600'; btnZoning.style.color = '#0f172a';

                // Hide General Elements
                document.querySelectorAll('.sensor-card, .farm-management-section').forEach(el => el.style.display = 'none');
                document.getElementById('field-timers').style.display = 'none';

                // Show Zoning
                document.getElementById('zoning-ui').style.display = 'block';

                if (selectedField) loadFieldZones(selectedField.id);
            }
        }

        async function loadFieldZones(fieldId) {
            try {
                const response = await fetch(`${API_BASE}/field-zones/field/${fieldId}`);
                if (response.ok) {
                    currentZones = await response.json();
                    renderZones(currentZones);
                } else {
                    currentZones = [];
                    renderZones([]);
                }
            } catch (e) {
                console.error('Error loading zones:', e);
                renderZones([]);
            }
        }

        function renderZones(zones) {
            const list = document.getElementById('zoning-list');
            const totalAreaEl = document.getElementById('zone-total-area');
            const assignedAreaEl = document.getElementById('zone-assigned-area');

            if (selectedField) totalAreaEl.textContent = (selectedField.areaSqm || '--') + ' m²';

            // Calc assigned area
            let assigned = 0;
            zones.forEach(z => assigned += (z.areaSqm || 0));

            // Calculate percentage
            let total = selectedField ? (selectedField.areaSqm || 1000) : 1000;
            let percent = Math.round((assigned / total) * 100);

            assignedAreaEl.textContent = percent + '%';
            assignedAreaEl.style.color = percent > 100 ? '#ef4444' : '#10b981';

            if (!zones || zones.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">Chưa có vùng trồng nào</div>`;
                return;
            }

            list.innerHTML = zones.map(z => `
                <div class="zone-item" style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:600; color:#0f172a; font-size:13px;">${z.name}</div>
                        <div style="font-size:11px; color:#64748b;">${z.crop ? z.crop.name : 'Chưa trồng'} • ${z.areaSqm} m²</div>
                    </div>
                    <button onclick="deleteFieldZone(${z.id})" style="color:#ef4444; background:none; border:none; cursor:pointer;">
                        <span class="material-symbols-outlined" style="font-size:18px;">delete</span>
                    </button>
                </div>
            `).join('');
        }

        function openAddZoneModal() {
            // Simple prompt for now
            const name = prompt("Tên khu vực (VD: Khu A):");
            if (!name) return;
            const area = prompt("Diện tích (m²):");
            if (!area) return;

            createFieldZone(name, area);
        }

        async function createFieldZone(name, area) {
            if (!selectedField) return;
            try {
                const res = await fetch(`${API_BASE}/field-zones`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fieldId: selectedField.id,
                        name: name,
                        areaSqm: parseFloat(area),
                        boundaryCoordinates: null // Future: Polygon
                    })
                });

                if (res.ok) {
                    loadFieldZones(selectedField.id);
                } else {
                    alert('Lỗi khi tạo vùng trồng: ' + res.statusText);
                }
            } catch (e) { console.error(e); }
        }

        async function deleteFieldZone(id) {
            if (!confirm('Bạn có chắc muốn xóa vùng này?')) return;
            try {
                await fetch(`${API_BASE}/field-zones/${id}`, { method: 'DELETE' });
                loadFieldZones(selectedField.id);
            } catch (e) { console.error(e); }
        }

        function updateFarmManagementButtons(field) {
            const stage = getWorkflowStage(field);
            const timing = getTimingInfo(field);

            // All buttons disabled by default
            const allButtons = ['btn-select-crop', 'btn-watering', 'btn-fertilize', 'btn-seed', 'btn-pesticide', 'btn-harvest', 'btn-delete-field'];
            allButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('field-action-btn--disabled');
                }
            });

            // Delete button is always enabled when field is selected
            enableButton('btn-delete-field');

            // Enable Analysis button when field is selected
            enableButton('btn-pest-analysis');

            // Enable buttons based on workflow stage AND timing
            switch (stage) {
                case 'EMPTY':
                    // Only can select crop or delete
                    enableButton('btn-select-crop');
                    break;

                case 'CROP_SELECTED':
                    // Need to fertilize first - check if timing allows (fertilize is due when remaining <= 0)
                    if (timing.fertilizer === null || timing.fertilizer <= 0) {
                        enableButton('btn-fertilize');
                    }
                    break;

                case 'FERTILIZED':
                    // Need to seed - check wait time (soil rest) after fertilizer
                    if (timing.seedWait === null || timing.seedWait <= 0) {
                        enableButton('btn-seed');
                    }
                    break;

                case 'SEEDED':
                    // Can water and spray ONLY when timing is due
                    if (timing.watering === null || timing.watering <= 0) {
                        enableButton('btn-watering');
                    }
                    if (timing.pesticide === null || timing.pesticide <= 0) {
                        enableButton('btn-pesticide');
                    }
                    break;

                case 'READY_HARVEST':
                    // Can water, spray (if due), or harvest
                    if (timing.watering === null || timing.watering <= 0) {
                        enableButton('btn-watering');
                    }
                    if (timing.pesticide === null || timing.pesticide <= 0) {
                        enableButton('btn-pesticide');
                    }
                    enableButton('btn-harvest');
                    break;

                case 'HARVESTING':
                    // Currently harvesting - disable all actions except maybe "Claim"
                    // Claim/Complete logic is handled by the timer finish or user checking
                    const btn = document.getElementById('btn-harvest');
                    if (btn) {
                        if (status.isHarvestReady) {
                            btn.disabled = false;
                            btn.classList.remove('field-action-btn--disabled');
                            btn.innerHTML = '<span class="material-symbols-outlined">payments</span> <span>Nhận thu hoạch</span>';
                            // Override click to claim
                            btn.onclick = () => claimHarvest(status);
                        } else {
                            btn.disabled = true;
                            btn.classList.add('field-action-btn--disabled');
                            btn.innerHTML = `
                                <div style="display: flex; flex-direction: column; align-items: center; line-height: 1.2;">
                                    <span style="font-size: 11px;">Đang thu hoạch</span>
                                    <span style="font-weight: 700; color: #f59e0b;" id="harvest-timer-btn">${status.remainingMinutes}p</span>
                                </div>`;
                            // Start countdown
                            startHarvestTimer(status.remainingMinutes);
                        }
                    }
                    break;
            }

            // Hide hint if field is selected
            const hint = document.querySelector('#farm-management p');
            if (hint) hint.style.display = 'none';
        }

        function enableButton(id) {
            const btn = document.getElementById(id);
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('field-action-btn--disabled');
            }
        }

        function enableFarmManagement(enable) {
            // Legacy function - now uses updateFarmManagementButtons
            if (!enable) {
                const allButtons = ['btn-select-crop', 'btn-watering', 'btn-fertilize', 'btn-seed', 'btn-pesticide', 'btn-harvest', 'btn-delete-field'];
                allButtons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('field-action-btn--disabled');
                    }
                });
                const hint = document.querySelector('#farm-management p');
                if (hint) hint.style.display = 'block';
            }
        }

        // ==================== DRAWING FIELD ====================
        function startDrawingField() {
            if (isDrawing) return;
            isDrawing = true;

            document.getElementById('drawing-indicator').classList.add('active');

            // Create draw control
            drawControl = new L.Draw.Polygon(map, {
                shapeOptions: {
                    color: '#3b82f6',
                    weight: 3,
                    fillOpacity: 0.3
                }
            });
            drawControl.enable();

            map.on(L.Draw.Event.CREATED, onDrawComplete);
        }

        function onDrawComplete(e) {
            isDrawing = false;
            document.getElementById('drawing-indicator').classList.remove('active');

            drawnLayer = e.layer;
            drawnItems.addLayer(drawnLayer);

            // Calculate area
            const latlngs = drawnLayer.getLatLngs()[0];
            const area = L.GeometryUtil.geodesicArea(latlngs);
            const areaHa = (area / 10000).toFixed(2);

            // Show confirmation modal with certificate upload
            showFieldConfirmationModal(latlngs, area, areaHa);

            if (drawControl) drawControl.disable();
            map.off(L.Draw.Event.CREATED, onDrawComplete);
        }

        function showFieldConfirmationModal(coordinates, areaSqm, areaHa) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'field-confirm-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>Xác nhận mảnh ruộng</h3>
                        <p>Diện tích: <strong>${areaHa} ha</strong> (${Math.round(areaSqm).toLocaleString()} m²)</p>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="field-name-input" style="display: block; margin-bottom: 6px; font-weight: 500;">Tên mảnh ruộng</label>
                            <input type="text" id="field-name-input" placeholder="VD: Khu A, Ruộng Bắc..." 
                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label for="certificate-input" style="display: block; margin-bottom: 6px; font-weight: 500;">Giấy chứng nhận quyền sử dụng đất</label>
                            <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Upload ảnh giấy tờ để xác minh quyền sở hữu</p>
                            <input type="file" id="certificate-input" accept="image/*" style="display: none;">
                            <div id="certificate-preview" style="width: 100%; height: 120px; border: 2px dashed #d1d5db; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f9fafb;"
                                onclick="document.getElementById('certificate-input').click()">
                                <div style="text-align: center; color: #9ca3af;">
                                    <span class="material-symbols-outlined" style="font-size: 32px;">upload_file</span>
                                    <p style="margin: 4px 0 0; font-size: 12px;">Click để chọn ảnh</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="cancelFieldDrawing()" class="btn btn--secondary">Hủy</button>
                        <button onclick="confirmFieldCreation()" class="btn btn--primary">Xác nhận</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            // Setup certificate preview with filename validation
            document.getElementById('certificate-input').onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name.toLowerCase();
                    // Check if filename contains "quyền sử dụng đất" (simplified check)
                    const isValidCertificateName = fileName.includes('quyền') ||
                        fileName.includes('quyen') ||
                        fileName.includes('sử dụng đất') ||
                        fileName.includes('su dung dat') ||
                        fileName.includes('giấy chứng nhận') ||
                        fileName.includes('giay chung nhan') ||
                        fileName.includes('sổ đỏ') ||
                        fileName.includes('so do');

                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        const preview = document.getElementById('certificate-preview');
                        preview.innerHTML = '';
                        preview.style.backgroundImage = `url('${ev.target.result}')`;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                        preview.dataset.base64 = ev.target.result;
                        preview.dataset.verified = isValidCertificateName ? 'true' : 'false';

                        // Show verification badge
                        const badge = document.createElement('div');
                        badge.style.cssText = `
                            position: absolute; top: 8px; right: 8px; padding: 4px 10px;
                            border-radius: 12px; font-size: 11px; font-weight: 500;
                            ${isValidCertificateName ? 'background: #d1fae5; color: #065f46;' : 'background: #fef3c7; color: #92400e;'}
                        `;
                        badge.innerHTML = isValidCertificateName ?
                            '<span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">verified</span> Đã xác minh' :
                            '<span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">info</span> Chờ xác minh';
                        preview.style.position = 'relative';
                        preview.appendChild(badge);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function cancelFieldDrawing() {
            if (drawnLayer) {
                drawnItems.removeLayer(drawnLayer);
                drawnLayer = null;
            }
            closeModalById('field-confirm-modal');
        }

        async function confirmFieldCreation() {
            const name = document.getElementById('field-name-input').value.trim();
            if (!name) {
                alert('Vui lòng nhập tên mảnh ruộng');
                return;
            }

            // Ensure we have a farm ID
            if (!currentFarmId) {
                const hasFarm = await loadCurrentFarm();
                if (!hasFarm) {
                    showToast('Lỗi', 'Không tìm thấy nông trại. Vui lòng tạo nông trại trước.', 'error');
                    return;
                }
            }

            const latlngs = drawnLayer.getLatLngs()[0];
            const coordinates = latlngs.map(ll => [ll.lat, ll.lng]);
            const area = L.GeometryUtil.geodesicArea(latlngs);
            const certificateBase64 = document.getElementById('certificate-preview').dataset?.base64;

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                };

                // Create field
                const response = await fetch(`${API_BASE}/fields`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        farmId: currentFarmId,
                        name: name,
                        boundaryCoordinates: JSON.stringify(coordinates),
                        areaSqm: area
                    })
                });

                if (response.ok) {
                    const newField = await response.json();

                    // Upload certificate if provided
                    if (certificateBase64) {
                        await fetch(`${API_BASE}/fields/${newField.id}/certificate`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ image: certificateBase64 })
                        });
                    }

                    // Refresh map
                    closeModalById('field-confirm-modal');
                    drawnItems.clearLayers();
                    drawnLayer = null;

                    // Reload fields
                    await loadFieldsFromAPI();
                    showToast('Thành công', `Đã thêm mảnh ruộng "${name}"`, 'success');
                } else {
                    const err = await response.json();
                    showToast('Lỗi', err.error || 'Không thể tạo mảnh ruộng', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Lỗi', 'Lỗi kết nối', 'error');
            }
        }

        async function confirmDeleteField() {
            if (!selectedField) return;

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                const response = await fetch(`${API_BASE}/fields/${selectedField.id}`, {
                    method: 'DELETE',
                    headers: headers
                });

                if (response.ok) {
                    closeModalById('delete-confirm-modal');
                    // Clear from map
                    await loadFieldsFromAPI();

                    // Clear info panel
                    document.getElementById('selected-field-info').innerHTML =
                        '<p style="color: #9ca3af; text-align: center; margin-top: 20px;">Chọn một mảnh ruộng để xem chi tiết</p>';

                    selectedField = null;
                    enableFarmManagement(false);

                    showToast('Thành công', 'Đã xóa mảnh ruộng', 'success');
                } else {
                    const err = await response.json();
                    showToast('Lỗi', err.error || 'Không thể xóa', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Lỗi', 'Lỗi kết nối', 'error');
            }
        }

        // ==================== CROP SELECTION ====================


        function openDeleteFieldModal() {
            console.log('openDeleteFieldModal called', selectedField);
            if (!selectedField) {
                console.warn('No selected field');
                return;
            }

            const warningEl = document.getElementById('delete-warning');
            const messageEl = document.getElementById('delete-message');

            // Check if field has active crops
            if (selectedField.currentCrop) {
                warningEl.style.display = 'block';
                messageEl.textContent = `Mảnh ruộng "${selectedField.name}" đang trồng ${selectedField.currentCrop.name}. Bạn có chắc chắn muốn xóa không?`;
            } else {
                warningEl.style.display = 'none';
                messageEl.textContent = `Bạn có chắc chắn muốn xóa mảnh ruộng "${selectedField.name}" không?`;
            }

            document.getElementById('delete-confirm-modal').classList.add('open');
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        async function openCropSelectionModal() {
            if (!selectedField) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'crop-selection-modal';

            // Categorize crops based on weather
            const recommendedCrops = [];
            const avoidCrops = [];
            const normalCrops = [];

            allCrops.forEach(crop => {
                const isGoodTemp = currentTemp && crop.minTemp <= currentTemp && crop.maxTemp >= currentTemp;
                if (isGoodTemp) {
                    recommendedCrops.push(crop);
                } else if (currentTemp && (currentTemp < crop.minTemp - 5 || currentTemp > crop.maxTemp + 5)) {
                    avoidCrops.push(crop);
                } else {
                    normalCrops.push(crop);
                }
            });

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 750px;">
                    <div class="modal-header">
                        <h3>Chọn cây trồng cho ${selectedField.name}</h3>
                        <p>Diện tích: ${(selectedField.areaSqm / 10000).toFixed(2)} ha • Nhiệt độ hiện tại: ${currentTemp || '--'}°C</p>
                        <span class="close-modal" onclick="closeModalById('crop-selection-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="modal-hint">
                            <span class="material-symbols-outlined">touch_app</span>
                            <span><strong>1 click</strong> = Chọn cây • <strong>2 click</strong> = Xem chi tiết đầy đủ</span>
                        </div>
                        <div class="item-grid">
                            ${recommendedCrops.map(c => renderCropCard(c, 'recommend')).join('')}
                            ${normalCrops.map(c => renderCropCard(c, 'normal')).join('')}
                            ${avoidCrops.map(c => renderCropCard(c, 'avoid')).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeModalById('crop-selection-modal')" class="btn btn--secondary">Đóng</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function renderCropCard(crop, status) {
            const badge = status === 'recommend' ? '<span class="item-card__badge item-card__badge--recommend">Khuyến nghị</span>' :
                status === 'avoid' ? '<span class="item-card__badge item-card__badge--avoid">Không phù hợp</span>' : '';
            const extraClass = status === 'avoid' ? 'item-card--avoid' : '';

            return `
                <div class="item-card ${extraClass}" 
                     onclick="selectCropCard(this, ${crop.id}, '${crop.name}')"
                     ondblclick="showCropDetails(${crop.id})">
                    <div class="item-card__image">
                        <img src="${crop.imageUrl || 'https://cdn-icons-png.flaticon.com/512/2910/2910807.png'}" alt="${crop.name}">
                    </div>
                    <div class="item-card__content">
                        <div class="item-card__title">${crop.name}</div>
                        <div class="item-card__subtitle">${crop.category || 'Loại khác'}</div>
                        <div class="item-card__meta">
                            <span>${crop.growthDurationDays || 0} ngày</span>
                            ${badge}
                        </div>
                    </div>
                </div>`;
        }

        // Selected crop tracking
        let selectedCropData = null;

        function selectCropCard(el, cropId, cropName) {
            document.querySelectorAll('#crop-selection-modal .item-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedCropData = { id: cropId, name: cropName };

            // Show confirm bar
            let confirmBar = document.getElementById('crop-confirm-bar');
            if (!confirmBar) {
                confirmBar = document.createElement('div');
                confirmBar.id = 'crop-confirm-bar';
                confirmBar.style.cssText = 'display:flex;gap:12px;justify-content:flex-end;padding-top:16px;border-top:1px solid #e2e8f0;margin-top:16px;';
                confirmBar.innerHTML = `
                    <button class="btn btn--secondary" onclick="cancelCropSelection()">Hủy</button>
                    <button class="btn btn--primary" onclick="confirmCropSelection()">Xác nhận chọn ${cropName}</button>`;
                document.querySelector('#crop-selection-modal .modal-body').appendChild(confirmBar);
            } else {
                confirmBar.innerHTML = `
                    <button class="btn btn--secondary" onclick="cancelCropSelection()">Hủy</button>
                    <button class="btn btn--primary" onclick="confirmCropSelection()">Xác nhận chọn ${cropName}</button>`;
                confirmBar.style.display = 'flex';
            }
        }

        function cancelCropSelection() {
            document.querySelectorAll('#crop-selection-modal .item-card').forEach(c => c.classList.remove('selected'));
            const confirmBar = document.getElementById('crop-confirm-bar');
            if (confirmBar) confirmBar.style.display = 'none';
            selectedCropData = null;
        }

        function confirmCropSelection() {
            if (!selectedCropData) return;
            selectCrop(selectedCropData.id);
        }

        // CROP DETAIL MODAL
        function showCropDetails(cropId) {
            const crop = allCrops.find(c => c.id === cropId);
            if (!crop) return;

            // Parse JSON fields safely
            let pests = [];
            try { pests = JSON.parse(crop.commonPests || '[]'); } catch (e) { }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay detail-modal';
            modal.id = 'crop-detail-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Chi tiết cây trồng</h3>
                        <span class="close-modal" onclick="closeModalById('crop-detail-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${crop.imageUrl || 'https://cdn-icons-png.flaticon.com/512/2910/2910807.png'}" alt="${crop.name}">
                            </div>
                            <div class="detail-info">
                                <h2 class="detail-title">${crop.name}</h2>
                                <div class="detail-tags">
                                    <span class="detail-tag--info">${crop.category || 'Khác'}</span>
                                    <span class="detail-tag">${crop.growthDurationDays || 0} ngày sinh trưởng</span>
                                    <span class="detail-tag--warning">${crop.waterNeeds || 'MEDIUM'} nước</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <label>Mô tả</label>
                            <p>${crop.description || 'Chưa có mô tả.'}</p>
                        </div>
                        <div class="detail-section">
                            <label>Nhiệt độ lý tưởng</label>
                            <p>${crop.minTemp || 15}°C - ${crop.maxTemp || 35}°C</p>
                        </div>
                        <div class="detail-section">
                            <label>Loại đất phù hợp</label>
                            <p>${crop.soilTypePreferred || 'Đất phù sa'}</p>
                        </div>
                        <div class="detail-section">
                            <label>Chi phí ước tính</label>
                            <p>Hạt giống: ${(crop.seedCostPerKg || 50000).toLocaleString()} VNĐ/kg • Chăm sóc: ${(crop.careCostPerSqm || 2000).toLocaleString()} VNĐ/m²</p>
                        </div>
                        ${pests.length ? `
                        <div class="detail-section">
                            <label>Sâu bệnh thường gặp</label>
                            <div class="detail-tags">
                                ${pests.map(p => `<span class="detail-tag--warning">${p.name || p}</span>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn--secondary" onclick="closeModalById('crop-detail-modal')">Đóng</button>
                        <button class="btn btn--primary" onclick="closeModalById('crop-detail-modal'); selectCrop(${crop.id});">Chọn cây này</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function selectCrop(cropId) {
            if (!selectedField) return;

            try {
                const response = await fetch(`${API_BASE}/fields/${selectedField.id}/plant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cropId })
                });

                if (response.ok) {
                    closeModalById('crop-selection-modal');
                    await loadFieldsFromAPI();
                    showToast('Thành công', 'Đã chọn cây trồng', 'success');
                    selectedField = null;
                    enableFarmManagement(false);
                }
            } catch (e) {
                console.error(e);
                showToast('Lỗi', 'Không thể chọn cây trồng', 'error');
            }
        }

        function showAvoidWarning(cropId, cropName) {
            if (confirm(`Cây ${cropName} không phù hợp với thời tiết hiện tại. Bạn vẫn muốn tiếp tục?`)) {
                selectCrop(cropId);
            }
        }

        // ==================== FARM ACTIVITIES ====================

        // --- FERTILIZER ---
        let allFertilizers = [];
        let selectedFertilizerData = null;

        async function openFertilizerModal() {
            if (!selectedField) return;
            const modal = document.getElementById('fertilizer-modal');
            modal.classList.add('open');
            modal.style.display = 'flex';

            const list = document.getElementById('fertilizer-list');
            list.innerHTML = '<div class="loading-spinner">Đang tải phân bón...</div>';
            list.className = 'item-grid';

            try {
                const response = await fetch(`${API_BASE}/fertilizers`);
                if (response.ok) {
                    allFertilizers = await response.json();
                } else {
                    // Fallback mock data
                    allFertilizers = [
                        { id: 1, name: "Phân NPK 16-16-8", description: "Phân bón cân bằng", costPerKg: 12000, imageUrl: "https://cdn-icons-png.flaticon.com/512/10003/10003757.png", ingredients: "N-P-K 16-16-8", usageInstructions: "Bón thúc" },
                        { id: 2, name: "Phân Urê", description: "Đạm cao", costPerKg: 11000, imageUrl: "https://cdn-icons-png.flaticon.com/512/10432/10432857.png", ingredients: "Nitrogen 46%", usageInstructions: "Bón thúc lá" },
                        { id: 3, name: "Phân Hữu Cơ", description: "Cải tạo đất", costPerKg: 8000, imageUrl: "https://cdn-icons-png.flaticon.com/512/3596/3596160.png", ingredients: "Hữu cơ 15%, Vi sinh", usageInstructions: "Bón lót" }
                    ];
                }

                list.innerHTML = `
                    <div class="modal-hint" style="grid-column: 1/-1;">
                        <span class="material-symbols-outlined">touch_app</span>
                        <span><strong>1 click</strong> = Chọn phân bón • <strong>2 click</strong> = Xem chi tiết</span>
                    </div>
                    ${allFertilizers.map(f => renderFertilizerCard(f)).join('')}
                `;
                document.getElementById('fertilizer-cost').textContent = '0 VNĐ';
                selectedFertilizerData = null;
            } catch (e) {
                console.error('Fertilizer load error:', e);
                list.innerHTML = '<div style="color:red;text-align:center;padding:20px;grid-column:1/-1;">Lỗi tải dữ liệu. Vui lòng thử lại.</div>';
            }
        }

        function renderFertilizerCard(f) {
            const price = f.costPerKg || f.price || 10000;
            return `
                <div class="item-card" 
                     onclick="selectFertilizerCard(this, ${f.id}, ${price}, '${f.name}')"
                     ondblclick="showFertilizerDetails(${f.id})">
                    <div class="item-card__image">
                        <img src="${f.imageUrl || 'https://cdn-icons-png.flaticon.com/512/10003/10003757.png'}" alt="${f.name}">
                    </div>
                    <div class="item-card__content">
                        <div class="item-card__title">${f.name}</div>
                        <div class="item-card__subtitle">${f.description || 'Phân bón nông nghiệp'}</div>
                        <div class="item-card__meta">
                            <span class="item-card__price">${price.toLocaleString()}đ/kg</span>
                            <span class="item-card__badge item-card__badge--info">${f.type || 'inorganic'}</span>
                        </div>
                    </div>
                </div>`;
        }

        function selectFertilizerCard(el, id, price, name) {
            document.querySelectorAll('#fertilizer-list .item-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedFertilizerData = { id, price, name };

            // Calculate cost based on area
            const quantity = Math.ceil(selectedField.areaSqm / 100); // 1kg per 100m²
            const cost = quantity * price;
            document.getElementById('fertilizer-cost').textContent = cost.toLocaleString() + ' VNĐ';
        }

        function showFertilizerDetails(id) {
            const f = allFertilizers.find(x => x.id === id);
            if (!f) return;

            let suitableCrops = [];
            try { suitableCrops = JSON.parse(f.suitableCrops || '[]'); } catch (e) { }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay detail-modal';
            modal.id = 'fertilizer-detail-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Chi tiết phân bón</h3>
                        <span class="close-modal" onclick="closeModalById('fertilizer-detail-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${f.imageUrl || 'https://cdn-icons-png.flaticon.com/512/10003/10003757.png'}" alt="${f.name}">
                            </div>
                            <div class="detail-info">
                                <h2 class="detail-title">${f.name}</h2>
                                <div class="detail-price">${(f.costPerKg || 10000).toLocaleString()} VNĐ/kg</div>
                                <span class="item-card__badge item-card__badge--info">${f.type || 'inorganic'}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <label>Mô tả</label>
                            <p>${f.description || 'Phân bón chất lượng cao.'}</p>
                        </div>
                        <div class="detail-section">
                            <label>Thành phần</label>
                            <p>${f.ingredients || 'N-P-K và khoáng chất'}</p>
                        </div>
                        <div class="detail-section">
                            <label>Hướng dẫn sử dụng</label>
                            <p>${f.usageInstructions || 'Bón lót hoặc bón thúc theo nhu cầu cây trồng.'}</p>
                        </div>
                        ${suitableCrops.length ? `
                        <div class="detail-section">
                            <label>Cây trồng phù hợp</label>
                            <div class="detail-tags">
                                ${suitableCrops.map(c => `<span class="detail-tag">${c}</span>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn--secondary" onclick="closeModalById('fertilizer-detail-modal')">Đóng</button>
                        <button class="btn btn--primary" onclick="closeModalById('fertilizer-detail-modal'); selectFertilizerCard(null, ${f.id}, ${f.costPerKg || 10000}, '${f.name}'); confirmFertilizer();">Chọn phân bón này</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function confirmFertilizer() {
            if (!selectedFertilizerData) {
                alert('Vui lòng chọn loại phân bón');
                return;
            }

            const quantity = Math.ceil(selectedField.areaSqm / 100);
            const cost = quantity * selectedFertilizerData.price;

            // Check inventory first
            await loadUserInventory(); // Refresh inventory
            const invCheck = checkInventory('PHAN_BON', selectedFertilizerData.name, quantity);

            if (!invCheck.hasEnough) {
                closeModalById('fertilizer-modal');
                showInsufficientInventoryDialog(
                    selectedFertilizerData.name,
                    invCheck.available,
                    quantity,
                    'PHAN_BON',
                    selectedFertilizerData.name
                );
                return;
            }

            fetch(`${API_BASE}/fields/${selectedField.id}/fertilize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fertilizerId: selectedFertilizerData.id,
                    cost: cost
                })
            })
                .then(res => {
                    if (res.ok) {
                        closeModalById('fertilizer-modal');
                        loadFieldsFromAPI();
                        loadUserInventory(); // Refresh inventory after use
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                        showToast('Thành công', `Đã bón ${selectedFertilizerData.name}`, 'success');
                        selectedFertilizerData = null;
                    } else {
                        return res.json().then(err => { throw new Error(err.error || 'Lỗi bón phân'); });
                    }
                })
                .catch(e => {
                    console.error(e);
                    showToast('Lỗi', e.message, 'error');
                });
        }

        // --- SEED ---
        function openSeedModal() {
            if (!selectedField) return;
            const modal = document.getElementById('seed-modal');
            modal.classList.add('open');
            modal.style.display = 'flex';

            // Set default values based on crop
            const crop = selectedField.currentCrop;
            const seedPrice = crop?.seedCostPerKg || 50000;
            document.getElementById('seed-price').textContent = seedPrice.toLocaleString() + ' VNĐ/kg';
            document.getElementById('seed-quantity').value = (selectedField.areaSqm / 1000 * 5).toFixed(1); // Mock 5kg/1000m2
            calculateSeedCost();
        }

        function calculateSeedCost() {
            const quantity = parseFloat(document.getElementById('seed-quantity').value) || 0;
            const price = parseInt(document.getElementById('seed-price').textContent.replace(/\D/g, '')) || 0;
            document.getElementById('seed-total-cost').textContent = (quantity * price).toLocaleString() + ' VNĐ';
        }

        async function confirmSeed() {
            const quantity = parseFloat(document.getElementById('seed-quantity').value);
            const costString = document.getElementById('seed-total-cost').textContent;
            const cost = parseInt(costString.replace(/\D/g, ''));

            // Get crop name for inventory check
            const cropName = selectedField?.currentCrop?.name || 'hạt giống';

            // Check inventory first
            await loadUserInventory();
            const invCheck = checkInventory('HAT_GIONG', cropName, Math.ceil(quantity));

            if (!invCheck.hasEnough) {
                closeModalById('seed-modal');
                showInsufficientInventoryDialog(
                    `Hạt giống ${cropName}`,
                    invCheck.available,
                    Math.ceil(quantity),
                    'HAT_GIONG',
                    cropName
                );
                return;
            }

            fetch(`${API_BASE}/fields/${selectedField.id}/seed`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quantity: quantity,
                    cost: cost
                })
            })
                .then(res => {
                    if (res.ok) {
                        closeModalById('seed-modal');
                        loadFieldsFromAPI(); // Reload to update status to ACTIVE
                        loadUserInventory(); // Refresh inventory
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                        showToast('Thành công', 'Đã gieo hạt, vụ mùa bắt đầu!', 'success');
                    } else {
                        return res.json().then(err => { throw new Error(err.error || 'Lỗi gieo hạt'); });
                    }
                })
                .catch(e => {
                    console.error(e);
                    showToast('Lỗi', e.message, 'error');
                });
        }

        // --- PESTICIDE ---
        let allPests = [];
        let selectedPestData = null;

        async function openPesticideModal() {
            if (!selectedField) return;

            // Use dynamically created modal for better UI
            let modal = document.getElementById('pesticide-enhanced-modal');
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'pesticide-enhanced-modal';

            try {
                const response = await fetch(`${API_BASE}/pests/definitions`);
                if (response.ok) {
                    allPests = await response.json();
                } else {
                    // Fallback mock data
                    allPests = [
                        { id: 1, name: "Rầy nâu", description: "Gây cháy lúa, lây virus", treatment: "Phun Chess 50WG", severity: "HIGH", imageUrl: "https://cdn-icons-png.flaticon.com/512/3069/3069172.png" },
                        { id: 2, name: "Sâu đục thân", description: "Đục vào thân, gây bạch bông", treatment: "Phun Virtako 40WG", severity: "HIGH", imageUrl: "https://cdn-icons-png.flaticon.com/512/3069/3069186.png" },
                        { id: 3, name: "Bệnh đạo ôn", description: "Nấm gây cháy lá, cổ bông", treatment: "Phun Beam 75WP", severity: "CRITICAL", imageUrl: "https://cdn-icons-png.flaticon.com/512/3069/3069195.png" }
                    ];
                }

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 750px;">
                        <div class="modal-header">
                            <h3>Phun thuốc bảo vệ thực vật</h3>
                            <p>Chọn loại sâu bệnh cần phòng trừ</p>
                            <span class="close-modal" onclick="closeModalById('pesticide-enhanced-modal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="modal-hint">
                                <span class="material-symbols-outlined">touch_app</span>
                                <span><strong>1 click</strong> = Chọn phương pháp • <strong>2 click</strong> = Xem chi tiết sâu bệnh</span>
                            </div>
                            <div class="item-grid">
                                ${allPests.map(p => renderPestCard(p)).join('')}
                            </div>
                            <div style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px;">
                                <div id="selected-pest-info" style="margin-bottom:12px;color:#64748b;">Chưa chọn sâu bệnh</div>
                                <div class="form-group" style="margin-bottom:12px;">
                                    <label>Chi phí thuốc (VNĐ)</label>
                                    <input type="number" id="pesticide-cost-input" class="form-input" value="100000" min="0" step="10000">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn--secondary" onclick="closeModalById('pesticide-enhanced-modal')">Hủy</button>
                            <button class="btn btn--primary" onclick="confirmPesticideEnhanced()">Xác nhận phun thuốc</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                selectedPestData = null;
            } catch (e) {
                console.error('Pest load error:', e);
                alert('Lỗi tải danh sách sâu bệnh');
            }
        }

        function renderPestCard(p) {
            const severityClass = {
                'LOW': 'item-card__badge--info',
                'MEDIUM': 'item-card__badge--warning',
                'HIGH': 'item-card__badge--warning',
                'CRITICAL': 'item-card__badge--critical'
            }[p.severity] || 'item-card__badge--info';

            return `
                <div class="item-card" 
                     onclick="selectPestCard(this, ${p.id}, '${p.name}', '${p.treatment || ''}')"
                     ondblclick="showPestDetails(${p.id})">
                    <div class="item-card__image">
                        <img src="${p.imageUrl || 'https://cdn-icons-png.flaticon.com/512/3069/3069172.png'}" alt="${p.name}">
                    </div>
                    <div class="item-card__content">
                        <div class="item-card__title">${p.name}</div>
                        <div class="item-card__subtitle">${(p.description || '').substring(0, 50)}...</div>
                        <div class="item-card__meta">
                            <span class="item-card__badge ${severityClass}">${p.severity || 'MEDIUM'}</span>
                        </div>
                    </div>
                </div>`;
        }

        function selectPestCard(el, id, name, treatment) {
            document.querySelectorAll('#pesticide-enhanced-modal .item-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedPestData = { id, name, treatment };

            const infoEl = document.getElementById('selected-pest-info');
            if (infoEl) {
                infoEl.innerHTML = `<strong>Đã chọn:</strong> ${name} → <span style="color:#10b981;">${treatment || 'Xem chi tiết để biết thêm'}</span>`;
                infoEl.style.color = '#0f172a';
            }
        }

        function showPestDetails(id) {
            const p = allPests.find(x => x.id === id);
            if (!p) return;

            const severityLabel = { 'LOW': 'Nhẹ', 'MEDIUM': 'Trung bình', 'HIGH': 'Nặng', 'CRITICAL': 'Nghiêm trọng' }[p.severity] || 'Trung bình';
            const severityClass = { 'LOW': 'severity-badge--low', 'MEDIUM': 'severity-badge--medium', 'HIGH': 'severity-badge--high', 'CRITICAL': 'severity-badge--critical' }[p.severity] || 'severity-badge--medium';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay detail-modal';
            modal.id = 'pest-detail-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Chi tiết sâu bệnh</h3>
                        <span class="close-modal" onclick="closeModalById('pest-detail-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${p.imageUrl || 'https://cdn-icons-png.flaticon.com/512/3069/3069172.png'}" alt="${p.name}">
                            </div>
                            <div class="detail-info">
                                <h2 class="detail-title">${p.name}</h2>
                                ${p.scientificName ? `<p style="font-style:italic;color:#64748b;margin-bottom:12px;">${p.scientificName}</p>` : ''}
                                <span class="severity-badge ${severityClass}">${severityLabel}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <label>Mô tả</label>
                            <p>${p.description || 'Loại sâu bệnh hại cây trồng.'}</p>
                        </div>
                        <div class="detail-section">
                            <label>Cách điều trị</label>
                            <p style="background:#dcfce7;color:#166534;">${p.treatment || 'Tham khảo ý kiến chuyên gia.'}</p>
                        </div>
                        ${p.prevention ? `
                        <div class="detail-section">
                            <label>Phòng ngừa</label>
                            <p>${p.prevention}</p>
                        </div>` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn--secondary" onclick="closeModalById('pest-detail-modal')">Đóng</button>
                        <button class="btn btn--primary" onclick="closeModalById('pest-detail-modal'); selectPestCard(null, ${p.id}, '${p.name}', '${p.treatment || ''}'); confirmPesticideEnhanced();">Áp dụng điều trị này</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function confirmPesticideEnhanced() {
            if (!selectedPestData) {
                alert('Vui lòng chọn loại sâu bệnh');
                return;
            }

            const cost = parseInt(document.getElementById('pesticide-cost-input')?.value) || 100000;
            const treatmentName = selectedPestData.treatment || selectedPestData.name;

            fetch(`${API_BASE}/fields/${selectedField.id}/pesticide`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pesticideName: treatmentName,
                    cost: cost
                })
            })
                .then(res => {
                    if (res.ok) {
                        closeModalById('pesticide-enhanced-modal');
                        showToast('Thành công', `Đã phun thuốc trị ${selectedPestData.name}`, 'success');
                        loadFieldsFromAPI();
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                        selectedPestData = null;
                    } else {
                        return res.json().then(err => { throw new Error(err.error || 'Lỗi'); });
                    }
                })
                .catch(e => {
                    showToast('Lỗi', e.message, 'error');
                });
        }

        // Keep old function for backward compatibility
        function confirmPesticide() {
            const name = document.getElementById('pesticide-name')?.value;
            const cost = parseInt(document.getElementById('pesticide-cost')?.value) || 0;

            if (!name) {
                alert('Vui lòng nhập tên thuốc');
                return;
            }

            fetch(`${API_BASE}/fields/${selectedField.id}/pesticide`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pesticideName: name,
                    cost: cost
                })
            })
                .then(res => {
                    if (res.ok) {
                        closeModalById('pesticide-modal');
                        showToast('Thành công', `Đã phun ${name}`, 'success');
                        loadFieldsFromAPI();
                    } else {
                        return res.json().then(err => { throw new Error(err.error || 'Lỗi'); });
                    }
                })
                .catch(e => {
                    showToast('Lỗi', e.message, 'error');
                });
        }

        // --- HARVEST ---
        function openHarvestModal() {
            if (!selectedField) return;
            const modal = document.getElementById('harvest-modal');
            modal.classList.add('open');
            modal.style.display = 'flex';

            const list = document.getElementById('machinery-list');
            // machineryId: 1 = Máy gặt Kubota, 5 = Thu hoạch thủ công (based on DataInitializer)
            list.innerHTML = `
                <div class="harvest-option-card" onclick="selectHarvestMethod(this, 1, 500000)" 
                    style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <span class="material-symbols-outlined" style="font-size: 28px; color: white;">agriculture</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; color: #1f2937;">Máy gặt liên hợp</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">Nhanh chóng, hiệu quả cao, tiết kiệm nhân công</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: 700; color: #10b981;">500,000</div>
                        <div style="font-size: 12px; color: #6b7280;">VNĐ/ha</div>
                    </div>
                </div>
                <div class="harvest-option-card" onclick="selectHarvestMethod(this, 5, 2000000)"
                    style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <span class="material-symbols-outlined" style="font-size: 28px; color: white;">front_hand</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; color: #1f2937;">Thu hoạch thủ công</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">Chi phí nhân công cao, phù hợp diện tích nhỏ</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">2,000,000</div>
                        <div style="font-size: 12px; color: #6b7280;">VNĐ/ha</div>
                    </div>
                </div>`;
            document.getElementById('harvest-cost').textContent = '0 VNĐ';
            selectedActivityOption = null;
        }

        function selectHarvestMethod(element, machineryId, pricePerHa) {
            // Remove selection from all cards
            document.querySelectorAll('.harvest-option-card').forEach(card => {
                card.style.borderColor = '#e5e7eb';
                card.style.background = 'white';
                card.style.boxShadow = 'none';
            });
            // Select this card
            element.style.borderColor = '#f59e0b';
            element.style.background = '#fffbeb';
            element.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.2)';

            // Calculate cost based on field area
            const areaHa = selectedField.areaSqm / 10000;
            const totalCost = Math.round(pricePerHa * areaHa);
            document.getElementById('harvest-cost').textContent = totalCost.toLocaleString('vi-VN') + ' VNĐ';

            selectedActivityOption = { machineryId: machineryId, pricePerHa: pricePerHa };
        }

        function confirmHarvest() {
            if (!selectedActivityOption) {
                alert('Vui lòng chọn phương thức thu hoạch');
                return;
            }

            const machineryId = selectedActivityOption.machineryId;
            const cost = selectedActivityOption.pricePerHa * (selectedField.areaSqm / 10000);

            // Call start-harvest endpoint
            fetch(`${API_BASE}/fields/${selectedField.id}/start-harvest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    machineryId: machineryId,
                    machineCost: cost
                })
            })
                .then(res => res.json())
                .then(data => {
                    closeModalById('harvest-modal');

                    if (data.status === 'HARVESTING') {
                        // Timed harvest - show progress notification
                        showToast('Đang thu hoạch', `Thu hoạch sẽ hoàn tất sau ${data.durationMinutes} phút`, 'success');
                        loadFieldsFromAPI();
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                    } else if (data.cropName) {
                        // Instant harvest (Test crop) - show result immediately
                        showHarvestResult(data);
                        loadFieldsFromAPI();
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                    } else if (data.error) {
                        showToast('Lỗi', data.error, 'error');
                    }
                })
                .catch(e => {
                    console.error(e);
                    showToast('Lỗi', 'Không thể thu hoạch', 'error');
                });
        }

        // Harvest Timer
        let harvestTimerInterval;

        function startHarvestTimer(minutes) {
            if (harvestTimerInterval) clearInterval(harvestTimerInterval);

            let seconds = minutes * 60;
            const timerBtn = document.getElementById('harvest-timer-btn');

            harvestTimerInterval = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(harvestTimerInterval);
                    if (timerBtn) {
                        timerBtn.parentElement.parentElement.innerHTML =
                            '<span class="material-symbols-outlined">payments</span> <span>Nhận thu hoạch</span>';
                        const btn = document.getElementById('btn-harvest');
                        btn.disabled = false;
                        btn.classList.remove('field-action-btn--disabled');
                        btn.onclick = () => {
                            // Reload to get latest status and trigger claim
                            selectFieldFromAPI(selectedField.id);
                        };
                    }
                    // Refresh field status to show updated state
                    loadFieldsFromAPI();
                    if (selectedField) selectFieldFromAPI(selectedField.id);
                } else {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    if (timerBtn) timerBtn.textContent = `${m}p ${s}s`;
                }
            }, 1000);
        }

        function claimHarvest(status) {
            fetch(`${API_BASE}/fields/${selectedField.id}/harvest-complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    // Send 0/null as we want to use stored values from start-harvest
                    machineryId: 0,
                    machineCost: 0
                })
            })
                .then(res => res.json())
                .then(data => {
                    closeModalById('harvest-modal');
                    showHarvestResult(data);
                    loadFieldsFromAPI();
                    // Force refresh fields on map
                    if (layers && layers.fields) {
                        layers.fields.clearLayers();
                        createFieldsLayer(fields || []); // Will use updated fields from loadFieldsFromAPI if sync
                    }
                    if (selectedField) selectFieldFromAPI(selectedField.id);
                })
                .catch(e => {
                    console.error(e);
                    showToast('Lỗi', 'Không thể hoàn tất thu hoạch: ' + e.message, 'error');
                });
        }

        async function showHarvestResult(data) {
            const modal = document.getElementById('harvest-result-modal');
            document.getElementById('result-crop-name').textContent = data.cropName;
            document.getElementById('result-revenue').textContent = data.revenue.toLocaleString() + ' VNĐ';
            document.getElementById('result-yield').textContent = data.yieldKg.toLocaleString() + ' kg';
            document.getElementById('result-profit').textContent = data.profit.toLocaleString() + ' VNĐ';

            // Fetch and display new balance
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                try {
                    const balanceRes = await fetch(`http://localhost:8080/api/assets/balance?email=${encodeURIComponent(userEmail)}`);
                    if (balanceRes.ok) {
                        const balanceData = await balanceRes.json();
                        const newBalance = balanceData.balance || 0;
                        // Check if balance element exists, if not create it
                        let balanceEl = document.getElementById('result-new-balance');
                        if (!balanceEl) {
                            // Find the profit row and add balance row after it
                            const profitRow = document.querySelector('#harvest-result-modal .result-profit-row') ||
                                document.getElementById('result-profit')?.closest('.harvest-result__item');
                            if (profitRow && profitRow.parentNode) {
                                const balanceRow = document.createElement('div');
                                balanceRow.className = 'harvest-result__item';
                                balanceRow.style.cssText = 'display: flex; justify-content: space-between; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; margin-top: 16px;';
                                balanceRow.innerHTML = `
                                    <span style="display: flex; align-items: center; gap: 8px;">
                                        <span class="material-symbols-outlined">account_balance_wallet</span>
                                        Số dư tài khoản
                                    </span>
                                    <span id="result-new-balance" style="font-weight: 700;">${newBalance.toLocaleString()} VNĐ</span>
                                `;
                                profitRow.parentNode.appendChild(balanceRow);
                            }
                        } else {
                            balanceEl.textContent = newBalance.toLocaleString() + ' VNĐ';
                        }
                    }
                } catch (e) {
                    console.error('Error fetching balance:', e);
                }
            }

            modal.classList.add('open');
            modal.style.display = 'flex';
        }

        function waterField() {
            if (!selectedField) return;
            fetch(`${API_BASE}/fields/${selectedField.id}/water`, { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        showToast('Thành công', 'Đã tưới nước', 'success');
                        loadFieldsFromAPI();
                        if (selectedField) selectFieldFromAPI(selectedField.id);
                    } else {
                        return res.json().then(err => { throw new Error(err.error || 'Lỗi tưới nước'); });
                    }
                })
                .catch(e => showToast('Lỗi', e.message, 'error'));
        }

        function openHarvestHistoryModal() {
            showToast('Thông báo', 'Tính năng đang phát triển', 'info');
        }

        function openAnalyticsModal() {
            showToast('Thông báo', 'Tính năng đang phát triển', 'info');
        }

        async function logActivity(activityType) {
            if (!selectedField) return;

            const activityNames = {
                'WATERING': 'Tưới nước',
                'FERTILIZING': 'Bón phân',
                'PESTICIDE': 'Phun thuốc',
                'MACHINERY': 'Sử dụng máy móc'
            };

            try {
                const response = await fetch(`${API_BASE}/fields/${selectedField.id}/activities`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activityType,
                        description: `${activityNames[activityType]} cho ${selectedField.name}`
                    })
                });

                if (response.ok) {
                    showNotification('success', 'Ghi nhận', `Đã ghi nhận hoạt động: ${activityNames[activityType]}`);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function harvestField() {
            if (!selectedField) return;

            if (!confirm(`Xác nhận thu hoạch ${selectedField.name}?`)) return;

            try {
                const response = await fetch(`${API_BASE}/fields/${selectedField.id}/harvest`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await loadFieldsFromAPI();
                    showNotification('success', 'Thành công', 'Đã thu hoạch thành công!');
                    selectedField = null;
                    enableFarmManagement(false);
                }
            } catch (e) {
                console.error(e);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function closeModalById(id) {
            const modal = document.getElementById(id);
            if (!modal) return;

            // Check if it is a dynamic modal (usually overlay class without base 'modal' class in standard html, or check ID)
            // But strict check: Dynamic ones (crop-selection, field-confirm) use class 'modal-overlay'. 
            // Static ones use class 'modal'.
            if (modal.classList.contains('modal-overlay')) {
                modal.remove();
            } else {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }

            // Also clean up any lingering activity options selection
            selectedActivityOption = null;
        }

        function closeModal(id) {
            closeModalById(id);
        }

        function showNotification(type, title, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${type === 'success' ? '#10b981' : '#ef4444'}; color: white;
                padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex; align-items: center; gap: 12px; max-width: 350px;
            `;
            notification.innerHTML = `
                <span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : 'error'}</span>
                <div><strong>${title}</strong><p style="margin: 2px 0 0; font-size: 13px;">${message}</p></div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function setupControls() {
            document.getElementById('zoom-in').onclick = () => map.zoomIn();
            document.getElementById('zoom-out').onclick = () => map.zoomOut();
            document.getElementById('my-location').onclick = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        updateLocation(pos.coords.latitude, pos.coords.longitude, 'Vị trí của bạn');
                    });
                }
            };

            document.querySelectorAll('.map-layer-btn[data-layer]').forEach(btn => {
                btn.onclick = () => {
                    const layerType = btn.dataset.layer;

                    // Xử lý riêng cho nút Quy hoạch - toggle layer quy hoạch
                    if (layerType === 'planning') {
                        togglePlanningLayer();
                        return;
                    }

                    // Xử lý riêng cho nút Thổ nhưỡng - toggle layer thổ nhưỡng
                    if (layerType === 'soil') {
                        toggleSoilLayer();
                        return;
                    }

                    document.querySelectorAll('.map-layer-btn[data-layer]').forEach(b => {
                        if (b.dataset.layer !== 'planning' && b.dataset.layer !== 'soil') b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    Object.values(tileLayers).forEach(l => map.removeLayer(l));
                    tileLayers[layerType].addTo(map);
                };
            });

            document.getElementById('search-location').onclick = searchLocation;
            document.getElementById('location-input').onkeypress = (e) => { if (e.key === 'Enter') searchLocation(); };

            // Forecast modal
            document.getElementById('open-forecast').onclick = openForecastModal;
            document.getElementById('close-forecast').onclick = closeForecastModal;
            document.getElementById('forecast-modal').onclick = (e) => { if (e.target.id === 'forecast-modal') closeForecastModal(); };

            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.forecast-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    fetchForecast(parseInt(tab.dataset.days));
                };
            });
        }

        // Update location and refresh weather
        function updateLocation(lat, lng, name) {
            currentLocation = { lat, lng, name };
            map.setView([lat, lng], 14);

            // Save position to localStorage
            saveMapPosition();

            // Fetch weather for new location
            fetchWeather();
            fetchForecast(5);
        }

        async function searchLocation() {
            const query = document.getElementById('location-input').value.trim();
            if (!query) return;

            try {
                // Search globally - allows city names or specific addresses
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();

                if (data.length > 0) {
                    const name = data[0].display_name.split(',')[0];
                    updateLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), name);
                } else {
                    alert('Không tìm thấy địa điểm. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Lỗi tìm kiếm. Vui lòng thử lại.');
            }
        }

        function selectField(field) {
            const fieldInfo = document.getElementById('selected-field-info');
            fieldInfo.innerHTML = `<div class="field-info-card__content"><div class="field-info-card__icon" style="background-color: ${field.color}20; color: ${field.color};"><span class="material-symbols-outlined">grass</span></div><div><p class="field-info-card__name">${field.name} - ${field.crop}</p><p class="field-info-card__meta">${field.area} • ${field.status}</p></div></div>`;
            if (typeof gsap !== 'undefined') gsap.fromTo(fieldInfo, { opacity: 0, x: 20 }, { opacity: 1, x: 0, duration: 0.3 });
        }

        async function fetchWeather() {
            console.log('fetchWeather called', currentLocation);
            const widget = document.getElementById('weather-widget');
            widget.innerHTML = '<div class="weather-loading"><span class="material-symbols-outlined spinning">sync</span></div>';

            try {
                // Hardcode using coordinates to avoid name mismatch 404s
                let url = `https://api.openweathermap.org/data/2.5/weather?lat=${currentLocation.lat}&lon=${currentLocation.lng}&appid=${CONFIG.OPENWEATHER_API_KEY}&units=metric&lang=vi`;

                const response = await fetch(url);
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                currentTemp = Math.round(data.main.temp); // Store for crop recommendations
                renderWeather(data);
                updateSensors(data);
            } catch (error) {
                console.error('Weather error:', error);
                widget.innerHTML = `<div class="weather-loading"><span class="material-symbols-outlined" style="color:#ef4444;">error</span><p style="font-size:11px;">Lỗi</p></div>`;
            }
        }

        async function fetchForecast(days) {
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${currentLocation.lat}&lon=${currentLocation.lng}&appid=${CONFIG.OPENWEATHER_API_KEY}&units=metric&lang=vi`);
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                forecastData = processForecast(data.list, days);
                renderForecast(forecastData);
            } catch (error) {
                console.error('Forecast error:', error);
                document.getElementById('forecast-list').innerHTML = '<p style="text-align:center;color:var(--color-text-muted);">Không thể tải dự báo</p>';
            }
        }

        function processForecast(list, days) {
            const daily = {};
            list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!daily[date]) daily[date] = { temps: [], icons: [], descs: [] };
                daily[date].temps.push(item.main.temp);
                daily[date].icons.push(item.weather[0].icon);
                daily[date].descs.push(item.weather[0].description);
            });

            return Object.entries(daily).slice(0, days).map(([date, d]) => ({
                date: new Date(date).toLocaleDateString('vi-VN', { weekday: 'short', day: 'numeric', month: 'numeric' }),
                temp: Math.round(d.temps.reduce((a, b) => a + b) / d.temps.length),
                icon: d.icons[Math.floor(d.icons.length / 2)],
                desc: d.descs[Math.floor(d.descs.length / 2)]
            }));
        }

        function renderWeather(data) {
            const widget = document.getElementById('weather-widget');
            const locationName = data.name || currentLocation.name;
            widget.innerHTML = `
                <div class="weather-widget__header">
                    <div class="weather-widget__location"><span class="material-symbols-outlined">location_on</span>${locationName}</div>
                </div>
                <div class="weather-widget__body">
                    <div class="weather-widget__current">
                        <img class="weather-widget__icon" src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" alt="">
                        <div><div class="weather-widget__temp">${Math.round(data.main.temp)}°C</div><div class="weather-widget__desc">${data.weather[0].description}</div></div>
                    </div>
                    <div class="weather-widget__details">
                        <div class="weather-detail"><div class="weather-detail__label">Ẩm</div><div class="weather-detail__value">${data.main.humidity}%</div></div>
                        <div class="weather-detail"><div class="weather-detail__label">Gió</div><div class="weather-detail__value">${data.wind.speed}m/s</div></div>
                    </div>
                </div>
            `;
            if (typeof gsap !== 'undefined') gsap.fromTo(widget, { opacity: 0, y: -10 }, { opacity: 1, y: 0, duration: 0.3 });
        }

        function renderForecast(forecast) {
            const list = document.getElementById('forecast-list');
            document.getElementById('forecast-title').textContent = `Dự báo thời tiết - ${currentLocation.name}`;
            list.innerHTML = forecast.map(day => `
                <div class="forecast-item">
                    <span class="forecast-item__date">${day.date}</span>
                    <img class="forecast-item__icon" src="https://openweathermap.org/img/wn/${day.icon}@2x.png" alt="">
                    <span class="forecast-item__temp">${day.temp}°C</span>
                    <span class="forecast-item__desc">${day.desc}</span>
                </div>
            `).join('');
            if (typeof gsap !== 'undefined') gsap.fromTo('.forecast-item', { opacity: 0, x: -10 }, { opacity: 1, x: 0, duration: 0.2, stagger: 0.05 });
        }

        function updateSensors(data) {
            document.getElementById('temperature').textContent = `${Math.round(data.main.temp)}°C`;
            document.getElementById('temp-source').textContent = 'OpenWeather';
            document.getElementById('humidity').textContent = `${data.main.humidity}%`;
            document.getElementById('humidity-source').textContent = 'OpenWeather';
        }

        function openForecastModal() {
            document.getElementById('forecast-modal').classList.add('open');
            fetchForecast(5);
            if (typeof gsap !== 'undefined') gsap.fromTo('.forecast-modal__content', { opacity: 0, scale: 0.9, y: 20 }, { opacity: 1, scale: 1, y: 0, duration: 0.3 });
        }

        function closeForecastModal() {
            document.getElementById('forecast-modal').classList.remove('open');
        }

        // --- WATERING SCHEDULE LOGIC ---
        function openWateringScheduleModal() {
            const modal = document.getElementById('watering-schedule-modal');
            modal.style.display = 'flex'; // Use flex directly for feature-modal logic

            // Render Timeline
            renderWateringTimeline();

            // Setup realtime clock
            updateTimelineClock();
            setInterval(updateTimelineClock, 60000);
        }

        function updateTimelineClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const display = document.getElementById('timeline-current-time');
            if (display) display.textContent = timeStr;

            // Move red line
            const totalMinutes = now.getHours() * 60 + now.getMinutes();
            const percentage = (totalMinutes / 1440) * 100;
            const line = document.getElementById('current-time-line');
            if (line) line.style.left = `${percentage}%`;
        }

        async function renderWateringTimeline() {
            const list = document.getElementById('watering-schedule-list');
            list.innerHTML = '<div class="loading">Đang tải lịch trình...</div>';

            // Ensure crop data is loaded
            if (allCrops.length === 0) await loadCrops();

            // We use global fieldsData which is updated by map
            const fields = fieldsData.filter(f => f.currentCropId);

            if (fields.length === 0) {
                list.innerHTML = '<div class="empty-state">Chưa có cây trồng nào cần tưới hôm nay</div>';
                return;
            }

            let html = '';
            const now = new Date();
            const currentHour = now.getHours();

            fields.forEach(field => {
                // Determine Interval
                // If crop details missing in field, try to find in allCrops
                const cropDef = field.currentCrop || allCrops.find(c => c.id === field.currentCropId);
                const interval = cropDef ? (cropDef.wateringIntervalDays || 1) : 1;

                // Calculate Next Watering
                const lastWatered = field.lastWateredDate ? new Date(field.lastWateredDate) : new Date(field.plantingDate);
                // Reset time to start of day for accurate day diff
                lastWatered.setHours(0, 0, 0, 0);

                const nextWatering = new Date(lastWatered);
                nextWatering.setDate(lastWatered.getDate() + interval);

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Show on timeline if:
                // 1. Due today
                // 2. Overdue (Due before today but not done today)
                // 3. Already done today (lastWatered == today)

                const isDoneToday = field.lastWateredDate && new Date(field.lastWateredDate).setHours(0, 0, 0, 0) === today.getTime();
                const isDueToday = nextWatering.getTime() <= today.getTime();

                if (!isDueToday && !isDoneToday) return; // Skip if future

                // Mock Time Logic
                // Generate consistent hour based on Field ID (Start time)
                const startHour = (field.id * 7) % 13 + 6; // 6h to 18h
                const duration = 2; // 2 hours window
                const endHour = startHour + duration;

                const startPercent = (startHour / 24) * 100;
                const widthPercent = (duration / 24) * 100;

                let statusClass = 'schedule-block--upcoming';
                // Text is now just the time range
                let statusText = `${startHour}h - ${endHour}h`;

                if (isDoneToday) {
                    statusClass = 'schedule-block--done';
                    // statusText += ' (Đã xong)'; // Optional, user said just color is enough, but keeping time is useful
                } else if (currentHour >= endHour) {
                    statusClass = 'schedule-block--missed';
                } else if (currentHour >= startHour && currentHour < endHour) {
                    statusClass = 'schedule-block--upcoming'; // Or Active color if we had one
                    // statusText = 'Đang tưới...';
                }

                html += `
                    <div class="schedule-row">
                        <div class="schedule-label">
                            <div class="field-name">${field.name}</div>
                            <div class="crop-name">
                                <span class="material-symbols-outlined icon-sm">grass</span>
                                ${cropDef?.name || 'Cây trồng'}
                            </div>
                        </div>
                        <div class="schedule-track">
                            <div class="schedule-block ${statusClass}" 
                                 style="left: ${startPercent}%; width: ${widthPercent}%;"
                                 onclick="selectFieldFromAPI({id: ${field.id}})"
                                 data-tooltip="Lịch tưới: ${startHour}h - ${endHour}h">
                                <span class="material-symbols-outlined icon-sm">water_drop</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html || '<div class="empty-state">Không có lịch tưới hôm nay</div>';
        }

        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            fetchWeather();
            fetchForecast(5);
            document.getElementById('refresh-sensors').onclick = () => { fetchWeather(); fetchForecast(5); };
        });
    </script>

    <!-- Harvest History Modal -->
    <div class="feature-modal" id="harvest-history-modal">
        <div class="feature-modal__content">
            <div class="feature-modal__header">
                <h3>Lich su thu hoach</h3>
                <button onclick="closeHarvestHistoryModal()" class="close-btn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="feature-modal__body" id="harvest-history-list"></div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="feature-modal" id="analytics-modal">
        <div class="feature-modal__content feature-modal__content--large">
            <div class="feature-modal__header">
                <h3>Phan tich chi phi & doanh thu</h3>
                <button onclick="closeAnalyticsModal()" class="close-btn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="feature-modal__body" id="analytics-content"></div>
        </div>
    </div>

    <!-- Watering Schedule Modal -->
    <div class="feature-modal" id="watering-schedule-modal" style="display: none;">
        <div class="feature-modal__content feature-modal__content--large" style="width: 90%; max-width: 1000px;">
            <div class="feature-modal__header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-symbols-outlined" style="font-size: 32px; color: #3b82f6;">water_drop</span>
                    <div>
                        <h3 style="margin: 0;">Lịch tưới nước</h3>
                        <p style="margin: 0; font-size: 13px; color: #6b7280; font-weight: normal;">Theo dõi lịch tưới
                            cho toàn bộ trang trại</p>
                    </div>
                </div>
                <button onclick="closeModalById('watering-schedule-modal')" class="close-btn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="feature-modal__body" style="padding: 24px;">
                <!-- Timeline Container -->
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="current-time-display" id="timeline-current-time">12:00</div>
                        <div class="timeline-legend">
                            <div class="legend-item"><span class="legend-dot legend-dot--green"></span>Đã tưới</div>
                            <div class="legend-item"><span class="legend-dot legend-dot--red"></span>Quá giờ</div>
                            <div class="legend-item"><span class="legend-dot legend-dot--blue"></span>Sắp tới</div>
                        </div>
                    </div>

                    <div class="timeline-scroll-area">
                        <!-- Time Axis -->
                        <div class="time-axis">
                            <div class="time-marker" style="left: 0%;">0h</div>
                            <div class="time-marker" style="left: 16.6%;">4h</div>
                            <div class="time-marker" style="left: 33.3%;">8h</div>
                            <div class="time-marker" style="left: 50%;">12h</div>
                            <div class="time-marker" style="left: 66.6%;">16h</div>
                            <div class="time-marker" style="left: 83.3%;">20h</div>
                            <div class="time-marker" style="left: 100%;">24h</div>
                        </div>

                        <!-- Current Time Indicator (Moved out of axis to span full height) -->
                        <div class="current-time-line" id="current-time-line"></div>

                        <!-- Grid Background -->
                        <div class="schedule-grid-bg"></div>

                        <!-- Field Schedules -->
                        <div id="watering-schedule-list">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .timeline-container {
            border: 1px solid #f1f5f9;
            border-radius: 16px;
            padding: 32px;
            background: #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .current-time-display {
            font-size: 32px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .timeline-legend {
            display: flex;
            gap: 24px;
            background: #f8fafc;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 1), 0 0 0 3px currentColor;
        }

        .legend-dot--green {
            color: #22c55e;
            background: currentColor;
        }

        .legend-dot--red {
            color: #ef4444;
            background: currentColor;
        }

        .legend-dot--blue {
            color: #3b82f6;
            background: currentColor;
        }

        .timeline-scroll-area {
            position: relative;
            padding-top: 10px;
        }

        .time-axis {
            position: relative;
            height: 40px;
            margin-bottom: 20px;
            margin-left: 180px;
            /* Increased label space */
            border-bottom: 1px solid #e2e8f0;
            /* Grid Lines on Axis */
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px);
            background-size: 4.166% 100%;
            /* 100% / 24h */
            background-position: left bottom;
        }

        /* Grid lines extending down */
        .schedule-grid-bg {
            position: absolute;
            top: 40px;
            /* below axis */
            left: 180px;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background-image: linear-gradient(to right, #f1f5f9 1px, transparent 1px);
            background-size: 4.166% 100%;
            z-index: 0;
        }

        .time-marker {
            position: absolute;
            bottom: -28px;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
        }

        .current-time-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #000;
            z-index: 20;
            pointer-events: none;
        }

        .current-time-line::before {
            content: 'Hiện tại';
            position: absolute;
            top: -26px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
        }

        .current-time-line::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #000;
        }

        .schedule-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            height: 56px;
            z-index: 1;
        }

        .schedule-label {
            width: 180px;
            padding-right: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .schedule-label .field-name {
            font-weight: 700;
            font-size: 14px;
            color: #334155;
            margin-bottom: 2px;
        }

        .schedule-label .crop-name {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .schedule-track {
            flex: 1;
            height: 100%;
            position: relative;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 12px;
        }

        .schedule-block {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 40px;
            border-radius: 8px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .schedule-block:hover {
            transform: translateY(-50%) scale(1.05);
            z-index: 10;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .schedule-block--done {
            background: linear-gradient(135deg, #22c55e, #15803d);
        }

        .schedule-block--missed {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            animation: pulse-red 2s infinite;
        }

        .schedule-block--upcoming {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        /* Tooltip Style */
        .schedule-block[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 50;
            pointer-events: none;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }

        /* Tooltip Arrow */
        .schedule-block[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.9);
            margin-bottom: -4px;
            z-index: 50;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>


</body>

position: absolute;
top: 0;
bottom: 0;
width: 2px;
background: #000;
z-index: 20;
pointer-events: none;
}

.current-time-line::before {
content: 'Hiện tại';
position: absolute;
top: -26px;
left: 50%;
transform: translateX(-50%);
background: #000;
color: white;
font-size: 10px;
font-weight: 800;
padding: 4px 8px;
border-radius: 6px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
white-space: nowrap;
}

.current-time-line::after {
content: '';
position: absolute;
top: -6px;
left: 50%;
transform: translateX(-50%);
border-left: 6px solid transparent;
border-right: 6px solid transparent;
border-top: 6px solid #000;
}

.schedule-row {
display: flex;
align-items: center;
margin-bottom: 20px;
position: relative;
height: 56px;
z-index: 1;
}

.schedule-label {
width: 180px;
padding-right: 24px;
display: flex;
flex-direction: column;
justify-content: center;
}

.schedule-label .field-name {
font-weight: 700;
font-size: 14px;
color: #334155;
margin-bottom: 2px;
}

.schedule-label .crop-name {
font-size: 12px;
color: #64748b;
display: flex;
align-items: center;
gap: 4px;
}

.schedule-track {
flex: 1;
height: 100%;
position: relative;
background: rgba(248, 250, 252, 0.5);
border-radius: 12px;
}

.schedule-block {
position: absolute;
top: 50%;
transform: translateY(-50%);
height: 40px;
border-radius: 8px;
padding: 0 16px;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 12px;
font-weight: 600;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
cursor: pointer;
border: 1px solid rgba(255, 255, 255, 0.1);
white-space: nowrap;
}

.schedule-block:hover {
transform: translateY(-50%) scale(1.05);
z-index: 10;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.schedule-block--done {
background: linear-gradient(135deg, #22c55e, #15803d);
}

.schedule-block--missed {
background: linear-gradient(135deg, #ef4444, #b91c1c);
animation: pulse-red 2s infinite;
}

.schedule-block--upcoming {
background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

@keyframes pulse-red {
0% {
box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
}

70% {
box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
}

100% {
box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
}
}

position: absolute;
top: 0;
bottom: 0;
/* Fit container strictly */
width: 2px;
background: #000;
/* Black */
z-index: 20;
pointer-events: none;
/* box-shadow: 0 0 10px rgba(0,0,0, 0.3); */
}

.current-time-line::before {
content: 'Hiện tại';
/* Vietnamese */
position: absolute;
top: -26px;
left: 50%;
transform: translateX(-50%);
background: #000;
color: white;
font-size: 10px;
font-weight: 800;
padding: 4px 8px;
border-radius: 6px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
white-space: nowrap;
}

/* Triangle indicator */
.current-time-line::after {
content: '';
position: absolute;
top: -6px;
left: 50%;
transform: translateX(-50%);
border-left: 6px solid transparent;
border-right: 6px solid transparent;
border-top: 6px solid #ef4444;
}

.schedule-row {
display: flex;
align-items: center;
margin-bottom: 20px;
position: relative;
height: 56px;
z-index: 1;
/* Above grid */
}

.schedule-label {
width: 180px;
padding-right: 24px;
display: flex;
flex-direction: column;
justify-content: center;
}

.schedule-label .field-name {
font-weight: 700;
font-size: 14px;
color: #334155;
margin-bottom: 2px;
}

.schedule-label .crop-name {
font-size: 12px;
color: #64748b;
display: flex;
align-items: center;
gap: 4px;
}

.schedule-track {
flex: 1;
height: 100%;
position: relative;
background: rgba(248, 250, 252, 0.5);
border-radius: 12px;
}

.schedule-block {
position: absolute;
top: 50%;
transform: translateY(-50%);
height: 40px;
border-radius: 8px;
padding: 0 16px;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 12px;
font-weight: 600;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
cursor: pointer;
border: 1px solid rgba(255, 255, 255, 0.1);
white-space: nowrap;
}

.schedule-block:hover {
transform: translateY(-50%) scale(1.05);
z-index: 10;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.schedule-block--done {
background: linear-gradient(135deg, #22c55e, #15803d);
}

.schedule-block--missed {
background: linear-gradient(135deg, #ef4444, #b91c1c);
animation: pulse-red 2s infinite;
}

.schedule-block--upcoming {
background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

@keyframes pulse-red {
0% {
box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
}

70% {
box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
}

100% {
box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
}
}
</style>


<!-- Financial Analysis Modal (New) -->
<div class="modal financial-modal" id="financial-analysis-modal" style="z-index: 10001;">
    <div class="modal-content expanded">
        <div class="modal-header">
            <h3>Mô phỏng Tài chính & Lợi nhuận</h3>
            <p>Dự báo dòng tiền và ROI theo thời gian thực</p>
            <span class="close-modal" onclick="closeFinancialModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 24px;">
                <select id="financial-field-select" class="form-select" onchange="analyzeFieldFinancials(this.value)"
                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;">
                    <option value="">Đang tải danh sách ruộng...</option>
                </select>
            </div>

            <div class="financial-dashboard">
                <div class="financial-kpi-card">
                    <div class="kpi-icon" style="background: #fee2e2; color: #ef4444;">
                        <span class="material-symbols-outlined">trending_down</span>
                    </div>
                    <div class="kpi-label">Chi phí hiện tại</div>
                    <div class="kpi-value" id="kpi-cost">0 ₫</div>
                    <div class="kpi-subtext">Đã đầu tư</div>
                </div>
                <div class="financial-kpi-card">
                    <div class="kpi-icon" style="background: #dcfce7; color: #10b981;">
                        <span class="material-symbols-outlined">trending_up</span>
                    </div>
                    <div class="kpi-label">Doanh thu dự kiến</div>
                    <div class="kpi-value" id="kpi-revenue">0 ₫</div>
                    <div class="kpi-subtext">Theo giá thị trường</div>
                </div>
                <div class="financial-kpi-card">
                    <div class="kpi-icon" style="background: #e0f2fe; color: #0284c7;">
                        <span class="material-symbols-outlined">account_balance_wallet</span>
                    </div>
                    <div class="kpi-label">Lợi nhuận ước tính</div>
                    <div class="kpi-value" id="kpi-profit">0 ₫</div>
                    <div class="kpi-subtext">Net Profit</div>
                </div>
            </div>

            <div class="chart-container-financial">
                <canvas id="financialRoiChart"></canvas>
            </div>

            <div class="simulation-panel">
                <div class="simulation-header">
                    <span class="material-symbols-outlined">tune</span>
                    <h4 style="margin:0;">Giả lập Kịch bản (What-if)</h4>
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>Giá bán dự kiến</span>
                        <span id="price-value-display" style="font-weight: 700; color: #10b981;">7,000 ₫/kg</span>
                    </div>
                    <input type="range" min="1000" max="20000" step="100" value="7000" class="financial-slider"
                        id="price-slider" oninput="onPriceSliderChange(event)">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 4px;">
                        <span>1k</span>
                        <span>20k</span>
                    </div>
                </div>

                <div class="profit-projection">
                    <div>
                        <span style="display: block; font-size: 12px; color: #64748b; font-weight: 500;">DỰ BÁO LỢI
                            NHUẬN MỚI</span>
                        <span style="font-size: 10px; color: #94a3b8;">Dựa trên điều chỉnh của bạn</span>
                    </div>
                    <span class="profit-value-highlight" id="projected-profit-display">0 ₫</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn--secondary" onclick="closeFinancialModal()">Đóng</button>
            <button class="btn btn--primary" onclick="alert('Đã lưu kịch bản tài chính!')">Lưu báo cáo</button>
        </div>
    </div>
</div>

<!-- Traceability QR Modal -->
<div class="modal" id="traceability-modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h3>Truy xuất Nguồn gốc</h3>
            <span class="close-modal" onclick="closeTraceabilityModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="color: #64748b; margin-bottom: 24px;">Quét mã này để xem nhật ký canh tác công khai.</p>

            <div id="qr-code-display"
                style="margin: 0 auto; width: 200px; height: 200px; background: #f8fafc; display: flex; align-items: center; justify-content: center; border: 2px dashed #cbd5e1; border-radius: 12px;">
                <!-- Placeholder for QRCode Library output -->
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://agriplanner.com/traceability"
                    alt="QR Code" id="real-qr-img" style="width: 100%; height: 100%; border-radius: 10px;">
            </div>

            <div style="margin-top: 24px;">
                <a href="#" id="traceability-link" target="_blank" class="btn btn--secondary"
                    style="width: 100%; justify-content: center;">
                    <span class="material-symbols-outlined">open_in_new</span>
                    Mở trang Timeline
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Traceability Logic (Simple inline for now or move to features.js) -->
<script>
    function openTraceabilityModal() {
        // Assume selectedFieldId from main.js or features.js
        // If undefined, fallback or alert
        const fieldId = 1; // Default for demo

        const modal = document.getElementById('traceability-modal');
        const qrImg = document.getElementById('real-qr-img');
        const linkBtn = document.getElementById('traceability-link');

        // Generate link to local file or deployed URL
        // NOTE: In local dev, we link to the relative page
        const viewUrl = `${window.location.origin}/pages/traceability-view.html?fieldId=${fieldId}`;

        // Update QR (Using public API for demo)
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(viewUrl)}`;

        // Update Link
        linkBtn.href = viewUrl;

        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeTraceabilityModal() {
        const modal = document.getElementById('traceability-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }
</script>

<!-- Financial Analysis Logic -->
<script src="../js/financial-analysis.js"></script>

<!-- Pest Analysis Modal -->
<div class="modal" id="pest-analysis-modal" style="z-index: 10002;">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div class="modal-header">
            <h3>Bác sĩ Nông học AI</h3>
            <span class="close-modal" onclick="closeModalById('pest-analysis-modal')">&times;</span>
        </div>
        <div class="modal-body" style="padding: 0;">

            <!-- Scanner View -->
            <div id="scan-container" class="scan-container">
                <div class="scan-area" onclick="document.getElementById('pest-file-input').click()">
                    <input type="file" id="pest-file-input" accept="image/*" hidden
                        onchange="handlePestImageUpload(this)">

                    <div id="scan-placeholder">
                        <span class="material-symbols-outlined"
                            style="font-size: 48px; color: #94a3b8;">add_a_photo</span>
                        <p>Nhấp để tải ảnh lá cây lên</p>
                        <span style="font-size: 12px; color: #cbd5e1;">Hỗ trợ JPG, PNG</span>
                    </div>

                    <img id="scan-preview"
                        style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">

                    <div id="scan-overlay" class="scan-overlay">
                        <div class="scan-line"></div>
                    </div>
                </div>

                <div id="analyzing-status" class="analyzing-status">
                    <div class="spinner"></div>
                    <span>Đang phân tích hình ảnh...</span>
                </div>

                <div id="analysis-error" style="display: none; color: #ef4444; margin-top: 10px; text-align: center;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">warning</span>
                    Không tìm thấy sâu bệnh hoặc lỗi hệ thống.
                </div>
            </div>

            <!-- Result View (Hidden initially) -->
            <div id="pest-result-view" style="display: none; padding: 24px; opacity: 0; transition: opacity 0.3s;">
                <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <img id="modal-pest-img" src=""
                            style="width: 100%; border-radius: 12px; box-shadow: var(--shadow-md);">

                        <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 12px;">
                            <h4 style="margin: 0 0 8px 0; color: #475569;">Độ nghiêm trọng</h4>
                            <div id="modal-pest-severity" class="pest-severity-badge">
                                <span id="modal-severity-text">HIGH</span>
                            </div>
                        </div>
                    </div>

                    <div style="flex: 1.5; min-width: 300px;">
                        <h2 id="modal-pest-name" style="color: #0f172a; margin-top: 0; font-size: 24px;">Rầy nâu</h2>
                        <p id="modal-pest-scientific" style="font-style: italic; color: #64748b; margin-top: -8px;">
                            Nilaparvata lugens</p>

                        <div class="detail-section">
                            <label style="font-weight: bold; color: #334155;">Triệu chứng:</label>
                            <p id="modal-pest-description" style="color: #475569; line-height: 1.5;">Lá vàng, khô héo...
                            </p>
                        </div>

                        <div class="detail-section"
                            style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0;">
                            <label
                                style="font-weight: bold; color: #166534; display: flex; align-items: center; gap: 8px;">
                                <span class="material-symbols-outlined">medical_services</span> Giải pháp điều trị:
                            </label>
                            <p id="modal-pest-treatment" style="color: #15803d; font-weight: 500; margin: 8px 0;">Phun
                                thuốc Bassa 50EC</p>
                            <button onclick="applyTreatment()" class="btn btn--primary btn--sm"
                                style="margin-top: 8px;">
                                <span class="material-symbols-outlined" style="font-size: 16px;">healing</span>
                                Tạo lịch phun ngay
                            </button>
                        </div>

                        <div class="detail-section" style="margin-top: 16px;">
                            <label style="font-weight: bold; color: #334155;">Phòng ngừa:</label>
                            <p id="modal-pest-prevention" style="color: #475569;">Vệ sinh đồng ruộng...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer" id="modal-footer-action">
            <button class="btn btn--secondary" onclick="closeModalById('pest-analysis-modal')">Đóng</button>
            <button id="reset-scan-btn" class="btn btn--secondary" onclick="resetPestAnalysis()"
                style="display: none;">Quét lại</button>
            <button id="start-scan-btn" class="btn btn--primary" onclick="startPestAnalysis()" disabled>
                <span class="material-symbols-outlined">search</span> Phân tích
            </button>
        </div>
    </div>
</div>

<!-- AI Agronomist Logic -->
<script src="../js/ai-agronomist.js"></script>

<!-- Inverse Inventory Modal -->
<div class="modal" id="inventory-modal">
    <div class="modal-content inventory-modal-content">
        <div class="modal-header">
            <h3>Quản lý kho vật tư</h3>
            <span class="close-modal" onclick="closeInventoryModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Tabs or Actions -->
            <div class="inventory-actions" style="margin-bottom: 20px; display: flex; justify-content: space-between;">
                <div class="search-box" style="flex: 1; margin-right: 16px;">
                    <input type="text" id="inventory-search" placeholder="Tìm kiếm vật tư..." class="form-input">
                </div>
                <button class="btn btn--primary" onclick="showAddInventoryForm()">
                    <span class="material-symbols-outlined">add</span> Nhập kho
                </button>
            </div>

            <!-- Inventory List -->
            <div class="inventory-list-container">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Tên vật tư</th>
                            <th>Loại</th>
                            <th>Tồn kho</th>
                            <th>Đơn giá (VNĐ)</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <!-- Items Injected Here -->
                    </tbody>
                </table>
            </div>

            <!-- Add/Edit Form (Hidden by default) -->
            <div id="inventory-form-overlay" class="inventory-overlay" style="display: none;">
                <div class="inventory-form-card">
                    <h4 id="inv-form-title">Nhập kho vật tư mới</h4>

                    <!-- Tab Selection: Catalog vs Custom -->
                    <div class="inv-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button type="button" id="tab-catalog" class="inv-tab active"
                            onclick="switchInventoryTab('catalog')">
                            <span class="material-symbols-outlined">storefront</span>
                            Chọn từ Catalog
                        </button>
                        <button type="button" id="tab-custom" class="inv-tab" onclick="switchInventoryTab('custom')">
                            <span class="material-symbols-outlined">edit_note</span>
                            Tự nhập
                        </button>
                    </div>

                    <form id="inventory-form" onsubmit="handleInventorySubmit(event)">
                        <input type="hidden" id="inv-id">

                        <!-- Catalog Mode -->
                        <div id="catalog-mode">
                            <div class="form-group">
                                <label>Loại vật tư</label>
                                <select id="inv-catalog-type" class="form-select" onchange="loadCatalogItems()">
                                    <option value="FERTILIZER">🌱 Phân bón</option>
                                    <option value="PESTICIDE">🦟 Thuốc BVTV</option>
                                    <option value="SEED">🌾 Hạt giống</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Chọn sản phẩm</label>
                                <select id="inv-catalog-product" class="form-select" onchange="fillProductInfo()">
                                    <option value="">-- Đang tải --</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Số lượng nhập</label>
                                    <input type="number" id="inv-catalog-quantity" required class="form-input" min="1"
                                        step="0.1" value="1">
                                </div>
                                <div class="form-group">
                                    <label>Đơn giá (VNĐ)</label>
                                    <input type="number" id="inv-catalog-cost" required class="form-input" min="0"
                                        readonly>
                                </div>
                            </div>
                            <div class="inv-product-preview" id="inv-product-preview" style="display: none;">
                                <div class="preview-name" id="preview-name"></div>
                                <div class="preview-desc" id="preview-desc"></div>
                            </div>
                        </div>

                        <!-- Custom Mode (Hidden by default) -->
                        <div id="custom-mode" style="display: none;">
                            <div class="form-group">
                                <label>Tên vật tư</label>
                                <input type="text" id="inv-name" class="form-input" placeholder="VD: Phân NPK 20-20-15">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Loại</label>
                                    <select id="inv-type" class="form-select">
                                        <option value="FERTILIZER">Phân bón</option>
                                        <option value="PESTICIDE">Thuốc BVTV</option>
                                        <option value="SEED">Hạt giống</option>
                                        <option value="OTHER">Khác</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Đơn vị tính</label>
                                    <input type="text" id="inv-unit" class="form-input" placeholder="kg, chai, bao">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Số lượng</label>
                                    <input type="number" id="inv-quantity" class="form-input" min="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Đơn giá/đơn vị</label>
                                    <input type="number" id="inv-cost" class="form-input" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ngưỡng cảnh báo (Min)</label>
                            <input type="number" id="inv-threshold" class="form-input" value="10">
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn--secondary"
                                onclick="hideAddInventoryForm()">Hủy</button>
                            <button type="submit" class="btn btn--primary">
                                <span class="material-symbols-outlined">add_shopping_cart</span>
                                Nhập kho
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Logic -->
<script src="../js/inventory.js"></script>

<!-- Weather Logs Modal -->
<div class="modal" id="weather-modal">
    <div class="modal-content weather-modal-content">
        <div class="modal-header">
            <h3>Thời tiết Nông vụ</h3>
            <span class="close-modal" onclick="closeWeatherModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Spray Advice Section -->
            <div id="spray-advice-container">
                <div class="loading">Đang phân tích điều kiện phun thuốc...</div>
            </div>

            <div class="weather-divider"></div>

            <!-- Weather History Section -->
            <div id="weather-history-container">
                <div class="loading">Đang tải lịch sử thời tiết...</div>
            </div>
        </div>
    </div>
</div>

<!-- Weather Logs Logic -->
<script src="../js/weather-logs.js"></script>

<!-- Planning Map Modal -->
<div class="modal" id="planning-map-modal">
    <div class="modal-content" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
            <div>
                <h3 style="margin: 0;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">map</span>
                    Bản đồ Quy hoạch Đất đai Việt Nam
                </h3>
                <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Tra cứu thông tin quy hoạch từ nguồn chính
                    thức</p>
            </div>
            <span class="close-modal" onclick="closePlanningMapModal()" style="color: white;">&times;</span>
        </div>
        <div class="modal-body" style="flex: 1; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
            <!-- Hướng dẫn -->
            <div style="padding: 16px; background: #fffbeb; border-bottom: 1px solid #fcd34d;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <span class="material-symbols-outlined" style="color: #d97706; font-size: 24px;">info</span>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: #92400e;">Hướng dẫn tra cứu quy hoạch</h4>
                        <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">
                            <li>Chọn nguồn bản đồ quy hoạch bên dưới</li>
                            <li>Tìm kiếm vị trí đất của bạn trên bản đồ quy hoạch</li>
                            <li>Xác minh loại đất (đất nông nghiệp, đất ở, v.v.) và mục đích sử dụng</li>
                            <li>Chụp màn hình kết quả quy hoạch nếu cần</li>
                            <li>Quay lại AgriPlanner để vẽ ruộng với thông tin đã tra cứu</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Danh sách nguồn quy hoạch -->
            <div style="padding: 16px; overflow-y: auto; flex: 1;">
                <h4 style="margin: 0 0 12px 0; color: #374151;">
                    <span class="material-symbols-outlined"
                        style="vertical-align: middle; font-size: 18px;">language</span>
                    Nguồn bản đồ quy hoạch chính thức
                </h4>

                <div class="planning-sources-grid">
                    <!-- GIS Cần Thơ Chính thức - Nguồn số 1 -->
                    <div class="planning-source-card planning-source-card--featured"
                        onclick="openPlanningSource('https://gisportal.cantho.gov.vn/maps/web/kg/e574cba1-8f4b-4b4a-b654-5593045ba85b/0/home', 'GIS Cần Thơ - Quy hoạch 2021-2030')">
                        <div class="planning-source-icon"
                            style="background: linear-gradient(135deg, #059669, #047857);">
                            <span class="material-symbols-outlined">verified</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>🏛️ GIS Cần Thơ - Quy hoạch 2021-2030</h5>
                            <p>Nguồn chính thức từ UBND TP. Cần Thơ - Quy hoạch sử dụng đất, phân vùng chức năng</p>
                            <span class="planning-source-tag planning-source-tag--green">✓ CHÍNH THỨC - ƯU TIÊN</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #059669;">open_in_new</span>
                    </div>

                    <!-- GIS Cần Thơ - Sở Nông nghiệp -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://gisportal.cantho.gov.vn/maps/web/kg/75b3f8ba-e8d2-4a3b-aa5b-9a4bc8d84dd2/0/csdl', 'GIS Cần Thơ - Sở Nông nghiệp')">
                        <div class="planning-source-icon" style="background: #16a34a;">
                            <span class="material-symbols-outlined">agriculture</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Sở Nông nghiệp & Môi trường Cần Thơ</h5>
                            <p>Dữ liệu nông nghiệp, môi trường từ Sở NN&MT</p>
                            <span class="planning-source-tag planning-source-tag--green">Chính thức</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Guland.vn -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://guland.vn/soi-quy-hoach', 'Guland.vn')">
                        <div class="planning-source-icon" style="background: #ec4899;">
                            <span class="material-symbols-outlined">public</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Guland.vn</h5>
                            <p>Tra cứu quy hoạch toàn quốc - QH 2030, KH 2026</p>
                            <span class="planning-source-tag">Tham khảo</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Thư viện Quy hoạch -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://thuvienquyhoach.vn/', 'Thư viện Quy hoạch')">
                        <div class="planning-source-icon" style="background: #3b82f6;">
                            <span class="material-symbols-outlined">library_books</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Thư viện Quy hoạch</h5>
                            <p>Kho dữ liệu quy hoạch 63 tỉnh thành</p>
                            <span class="planning-source-tag planning-source-tag--blue">Tham khảo</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Cổng TTĐT BTNMT -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://gis.monre.gov.vn/', 'Bộ TN&MT')">
                        <div class="planning-source-icon" style="background: #10b981;">
                            <span class="material-symbols-outlined">account_balance</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>GIS Bộ Tài nguyên & Môi trường</h5>
                            <p>Hệ thống GIS chính thức của Bộ TN&MT</p>
                            <span class="planning-source-tag planning-source-tag--green">Chính thức</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Quy hoạch Hà Nội -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://quyhoach.hanoi.vn/', 'Quy hoạch Hà Nội')">
                        <div class="planning-source-icon" style="background: #8b5cf6;">
                            <span class="material-symbols-outlined">location_city</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Quy hoạch Hà Nội</h5>
                            <p>Tra cứu quy hoạch thủ đô Hà Nội</p>
                            <span class="planning-source-tag planning-source-tag--purple">Hà Nội</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Quy hoạch TP.HCM -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://thongtinquyhoach.hochiminhcity.gov.vn/', 'Quy hoạch TP.HCM')">
                        <div class="planning-source-icon" style="background: #f97316;">
                            <span class="material-symbols-outlined">apartment</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Quy hoạch TP.HCM</h5>
                            <p>Cổng thông tin quy hoạch TP. Hồ Chí Minh</p>
                            <span class="planning-source-tag planning-source-tag--orange">TP.HCM</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>

                    <!-- Sở TN&MT Cần Thơ -->
                    <div class="planning-source-card"
                        onclick="openPlanningSource('https://sonnmt.cantho.gov.vn/', 'Sở TN&MT Cần Thơ')">
                        <div class="planning-source-icon" style="background: #06b6d4;">
                            <span class="material-symbols-outlined">water</span>
                        </div>
                        <div class="planning-source-info">
                            <h5>Sở TN&MT Cần Thơ</h5>
                            <p>Sở Tài nguyên & Môi trường TP. Cần Thơ</p>
                            <span class="planning-source-tag planning-source-tag--cyan">Cần Thơ</span>
                        </div>
                        <span class="material-symbols-outlined" style="color: #9ca3af;">open_in_new</span>
                    </div>
                </div>

                <!-- Lưu ý pháp lý -->
                <div
                    style="margin-top: 20px; padding: 16px; background: #f1f5f9; border-radius: 12px; border-left: 4px solid #64748b;">
                    <div style="display: flex; gap: 10px;">
                        <span class="material-symbols-outlined" style="color: #64748b;">gavel</span>
                        <div>
                            <h5 style="margin: 0 0 6px 0; color: #334155;">Lưu ý pháp lý</h5>
                            <p style="margin: 0; font-size: 12px; color: #64748b; line-height: 1.6;">
                                Thông tin quy hoạch trên các trang web chỉ mang tính chất tham khảo.
                                Để xác minh chính xác, vui lòng liên hệ UBND xã/phường hoặc Phòng Tài nguyên & Môi
                                trường địa phương.
                                Đất nông nghiệp phải có Giấy chứng nhận quyền sử dụng đất hợp lệ để canh tác.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e5e7eb;">
            <button class="btn btn--secondary" onclick="closePlanningMapModal()">Đóng</button>
            <button class="btn btn--primary" onclick="closePlanningMapModal(); startDrawingField();">
                <span class="material-symbols-outlined">draw</span> Vẽ ruộng mới
            </button>
        </div>
    </div>
</div>

<style>
    .planning-sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
    }

    .planning-source-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .planning-source-card:hover {
        border-color: #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
        transform: translateY(-2px);
    }

    .planning-source-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .planning-source-icon .material-symbols-outlined {
        color: white;
        font-size: 22px;
    }

    .planning-source-info {
        flex: 1;
        min-width: 0;
    }

    .planning-source-info h5 {
        margin: 0 0 4px 0;
        font-size: 14px;
        color: #1f2937;
        font-weight: 600;
    }

    .planning-source-info p {
        margin: 0;
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
    }

    .planning-source-tag {
        display: inline-block;
        margin-top: 6px;
        padding: 2px 8px;
        background: #fef3c7;
        color: #92400e;
        font-size: 10px;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .planning-source-tag--blue {
        background: #dbeafe;
        color: #1e40af;
    }

    .planning-source-tag--green {
        background: #d1fae5;
        color: #065f46;
    }

    .planning-source-tag--purple {
        background: #ede9fe;
        color: #5b21b6;
    }

    .planning-source-tag--orange {
        background: #ffedd5;
        color: #c2410c;
    }

    .planning-source-tag--cyan {
        background: #cffafe;
        color: #0e7490;
    }
</style>

<script>
    // Planning Map Modal Functions
    function openPlanningMapModal() {
        document.getElementById('planning-map-modal').classList.add('open');
    }

    function closePlanningMapModal() {
        document.getElementById('planning-map-modal').classList.remove('open');
    }

    function openPlanningSource(url, name) {
        // Log for analytics
        console.log(`Mở bản đồ quy hoạch: ${name}`);

        // Show notification
        showToast('Đang mở', `Chuyển đến ${name}...`, 'success');

        // Open in new tab
        window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Show Add Field Options Modal
    function showAddFieldOptions() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'add-field-options-modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 520px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                    <div>
                        <h3 style="margin: 0;">
                            <span class="material-symbols-outlined" style="vertical-align: middle;">add_location_alt</span>
                            Thêm mảnh ruộng mới
                        </h3>
                        <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Chọn phương thức thêm ruộng</p>
                    </div>
                    <span class="close-modal" onclick="closeModalById('add-field-options-modal')" style="color: white; cursor: pointer;">&times;</span>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div class="add-field-options">
                        <!-- Option 1: View Planning Layer (NEW - RECOMMENDED) -->
                        <div class="add-field-option add-field-option--recommended" onclick="closeModalById('add-field-options-modal'); if(!isPlanningLayerVisible) togglePlanningLayer();">
                            <div class="add-field-option__icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <span class="material-symbols-outlined">layers</span>
                            </div>
                            <div class="add-field-option__content">
                                <div class="add-field-option__badge" style="background: #f59e0b;">Khuyến nghị</div>
                                <h4>Xem lớp Quy hoạch trên bản đồ</h4>
                                <p>Bật hiển thị các vùng quy hoạch đã lưu trực tiếp trên bản đồ</p>
                            </div>
                            <span class="material-symbols-outlined" style="color: #d97706;">arrow_forward</span>
                        </div>
                        
                        <!-- Option 2: Compare with Guland -->
                        <div class="add-field-option" onclick="closeModalById('add-field-options-modal'); openPlanningMapSynced();">
                            <div class="add-field-option__icon" style="background: linear-gradient(135deg, #059669, #047857);">
                                <span class="material-symbols-outlined">sync_alt</span>
                            </div>
                            <div class="add-field-option__content">
                                <h4>So sánh với Guland.vn</h4>
                                <p>Mở Guland.vn song song để tra cứu và so sánh quy hoạch</p>
                            </div>
                            <span class="material-symbols-outlined" style="color: #059669;">arrow_forward</span>
                        </div>
                        
                        <!-- Option 3: Click to Add Land Point -->
                        <div class="add-field-option" onclick="closeModalById('add-field-options-modal'); startClickToAddLand();">
                            <div class="add-field-option__icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <span class="material-symbols-outlined">pin_drop</span>
                            </div>
                            <div class="add-field-option__content">
                                <h4>Click vào điểm trên bản đồ</h4>
                                <p>Chọn 1 điểm trên bản đồ để xem thông tin quy hoạch & thổ nhưỡng</p>
                            </div>
                            <span class="material-symbols-outlined" style="color: #8b5cf6;">arrow_forward</span>
                        </div>

                        <!-- Option 4: Draw Directly -->
                        <div class="add-field-option" onclick="closeModalById('add-field-options-modal'); startDrawingField();">
                            <div class="add-field-option__icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <span class="material-symbols-outlined">draw</span>
                            </div>
                            <div class="add-field-option__content">
                                <h4>Vẽ ruộng trực tiếp</h4>
                                <p>Bỏ qua tra cứu quy hoạch, vẽ ranh giới ruộng ngay trên bản đồ</p>
                            </div>
                            <span class="material-symbols-outlined" style="color: #3b82f6;">arrow_forward</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
                        <p style="margin: 0; font-size: 12px; color: #92400e; line-height: 1.5;">
                            <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">lightbulb</span>
                            <strong>Mẹo:</strong> Bật "Lớp Quy hoạch" để xem các vùng đất đã được ghi nhận. 
                            Bạn cũng có thể vẽ thêm vùng quy hoạch mới từ thông tin tra cứu trên Guland.vn.
                        </p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // ==================== CLICK TO ADD LAND FEATURE ====================
    let isClickToAddLandMode = false;
    let clickToAddLandMarker = null;

    function startClickToAddLand() {
        isClickToAddLandMode = true;
        
        // Show instruction banner
        const banner = document.createElement('div');
        banner.id = 'click-to-add-banner';
        banner.className = 'click-to-add-banner';
        banner.innerHTML = `
            <div class="click-to-add-banner__content">
                <span class="material-symbols-outlined">pin_drop</span>
                <span>Click vào một điểm trên bản đồ để xem thông tin quy hoạch & thổ nhưỡng</span>
            </div>
            <button class="click-to-add-banner__cancel" onclick="cancelClickToAddLand()">
                <span class="material-symbols-outlined">close</span> Hủy
            </button>
        `;
        document.querySelector('.map-container').appendChild(banner);

        // Change cursor
        document.getElementById('map').style.cursor = 'crosshair';

        // Enable both layers if not visible
        if (!isPlanningLayerVisible && !isSoilLayerVisible) {
            togglePlanningLayer();
        }

        showToast('Click để thêm đất', 'Click vào vị trí bạn muốn kiểm tra', 'info');

        // Setup click handler
        map.once('click', handleClickToAddLand);
    }

    function cancelClickToAddLand() {
        isClickToAddLandMode = false;
        document.getElementById('map').style.cursor = '';
        const banner = document.getElementById('click-to-add-banner');
        if (banner) banner.remove();
        map.off('click', handleClickToAddLand);
        if (clickToAddLandMarker) {
            map.removeLayer(clickToAddLandMarker);
            clickToAddLandMarker = null;
        }
    }

    async function handleClickToAddLand(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Remove old marker
        if (clickToAddLandMarker) {
            map.removeLayer(clickToAddLandMarker);
        }

        // Add marker at clicked point
        clickToAddLandMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'click-marker',
                html: `<div style="background: #8b5cf6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }).addTo(map);

        // Fetch zone info at this point
        showToast('Đang tìm kiếm', 'Đang tra cứu thông tin quy hoạch và thổ nhưỡng...', 'info');

        try {
            // Search for planning zones AND soil zones near this point
            const [planningRes, soilRes] = await Promise.all([
                fetch(`${API_BASE}/planning-zones/near?lat=${lat}&lng=${lng}&radius=0.005&mapType=planning`),
                fetch(`${API_BASE}/planning-zones/near?lat=${lat}&lng=${lng}&radius=0.005&mapType=soil`)
            ]);

            const planningZones = planningRes.ok ? await planningRes.json() : [];
            const soilZones = soilRes.ok ? await soilRes.json() : [];

            // Show combined info modal
            showCombinedLandInfoModal(lat, lng, planningZones, soilZones);

        } catch (error) {
            console.error('Error fetching land info:', error);
            showToast('Lỗi', 'Không thể tra cứu thông tin', 'error');
        }

        // Reset mode
        cancelClickToAddLand();
    }

    function showCombinedLandInfoModal(lat, lng, planningZones, soilZones) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'combined-land-info-modal';

        const planningInfo = planningZones.length > 0 
            ? planningZones.map(z => `
                <div style="padding: 12px; background: #fff7ed; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-weight: 600; color: #92400e;">${z.name || 'Vùng quy hoạch'}</div>
                    <div style="font-size: 12px; color: #78350f; margin-top: 4px;">
                        Loại: ${z.zoneType || 'Chưa xác định'} ${z.zoneCode ? `(${z.zoneCode})` : ''}
                    </div>
                    ${z.landUsePurpose ? `<div style="font-size: 12px; color: #78350f;">Mục đích: ${z.landUsePurpose}</div>` : ''}
                </div>
            `).join('')
            : '<p style="color: #9ca3af; text-align: center; padding: 12px;">Không có dữ liệu quy hoạch tại điểm này</p>';

        const soilInfo = soilZones.length > 0 
            ? soilZones.map(z => `
                <div style="padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #d97706;">
                    <div style="font-weight: 600; color: #78350f;">${z.name || 'Vùng thổ nhưỡng'}</div>
                    <div style="font-size: 12px; color: #92400e; margin-top: 4px;">
                        Loại đất: ${z.zoneType || 'Chưa xác định'} ${z.zoneCode ? `(${z.zoneCode})` : ''}
                    </div>
                    ${z.notes ? `<div style="font-size: 12px; color: #92400e; margin-top: 4px;">Gợi ý: ${z.notes}</div>` : ''}
                </div>
            `).join('')
            : '<p style="color: #9ca3af; text-align: center; padding: 12px;">Không có dữ liệu thổ nhưỡng tại điểm này</p>';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                    <div>
                        <h3 style="margin: 0;">
                            <span class="material-symbols-outlined" style="vertical-align: middle;">location_on</span>
                            Thông tin điểm đất
                        </h3>
                        <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                    </div>
                    <span class="close-modal" onclick="closeModalById('combined-land-info-modal')" style="color: white; cursor: pointer;">&times;</span>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <!-- Planning Section -->
                    <div style="margin-bottom: 16px;">
                        <h4 style="margin: 0 0 8px; display: flex; align-items: center; gap: 8px; color: #f59e0b;">
                            <span class="material-symbols-outlined">map</span>
                            Quy hoạch sử dụng đất
                        </h4>
                        ${planningInfo}
                    </div>

                    <!-- Soil Section -->
                    <div style="margin-bottom: 16px;">
                        <h4 style="margin: 0 0 8px; display: flex; align-items: center; gap: 8px; color: #92400e;">
                            <span class="material-symbols-outlined">landscape</span>
                            Thổ nhưỡng
                        </h4>
                        ${soilInfo}
                    </div>

                    <!-- Action: Add Land Form -->
                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 12px; color: #059669;">
                            <span class="material-symbols-outlined" style="vertical-align: middle;">add_location_alt</span>
                            Đăng ký mảnh đất tại đây
                        </h4>
                        <form id="add-land-form" onsubmit="submitAddLandForm(event, ${lat}, ${lng})">
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 4px;">Tên mảnh đất *</label>
                                <input type="text" name="landName" required style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px;" placeholder="VD: Ruộng lúa Bờ Đông">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 4px;">Diện tích (m²)</label>
                                <input type="number" name="area" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px;" placeholder="VD: 5000">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 4px;">Ảnh xác nhận quyền sử dụng đất</label>
                                <input type="file" name="landDocument" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb;">
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">check_circle</span>
                                Gửi đăng ký
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function submitAddLandForm(event, lat, lng) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const landName = formData.get('landName');
        const area = formData.get('area');
        const documentFile = formData.get('landDocument');

        showToast('Đang xử lý', 'Đang đăng ký mảnh đất...', 'info');

        // For now, just show success - in real implementation, call API
        // TODO: Implement actual API call to register land
        setTimeout(() => {
            closeModalById('combined-land-info-modal');
            showToast('Thành công', `Đã ghi nhận yêu cầu đăng ký mảnh đất "${landName}"`, 'success');
            
            // Optionally start drawing the field boundary
            // startDrawingField();
        }, 1500);
    }
</script>

<style>
    .click-to-add-banner {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        z-index: 1000;
    }

    .click-to-add-banner__content {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .click-to-add-banner__cancel {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
    }

    .click-to-add-banner__cancel:hover {
        background: rgba(255,255,255,0.3);
    }
</style>
</script>

<style>
    .add-field-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .add-field-option {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 16px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .add-field-option:hover {
        border-color: #10b981;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        transform: translateY(-2px);
    }

    .add-field-option--recommended {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
    }

    .add-field-option--recommended:hover {
        border-color: #d97706;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }

    .add-field-option__icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .add-field-option__icon .material-symbols-outlined {
        color: white;
        font-size: 24px;
    }

    .add-field-option__content {
        flex: 1;
    }

    .add-field-option__badge {
        display: inline-block;
        padding: 2px 8px;
        background: #f59e0b;
        color: white;
        font-size: 10px;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .add-field-option__content h4 {
        margin: 0 0 4px 0;
        font-size: 15px;
        color: #1f2937;
        font-weight: 600;
    }

    .add-field-option__content p {
        margin: 0;
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
    }
</style>

</body>

</html>