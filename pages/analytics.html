<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPlanner - T√†i s·∫£n</title>
    <meta name="description" content="Qu·∫£n l√Ω t√†i s·∫£n v√† t√†i ch√≠nh n√¥ng tr·∫°i">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/analytics.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <link rel="stylesheet" href="../css/smart-advisor.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .balance-hero {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            border-radius: 20px;
            padding: 32px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        .balance-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
        }

        .balance-hero__label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .balance-hero__amount {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 16px;
        }

        .balance-hero__stats {
            display: flex;
            gap: 32px;
        }

        .balance-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .balance-stat__label {
            font-size: 12px;
            opacity: 0.8;
        }

        .balance-stat__value {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .balance-stat__value--up {
            color: #a7f3d0;
        }

        .balance-stat__value--down {
            color: #fca5a5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
        }

        .stat-card__icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .stat-card__icon--income {
            background: #d1fae5;
            color: #059669;
        }

        .stat-card__icon--expense {
            background: #fee2e2;
            color: #dc2626;
        }

        .stat-card__icon--profit {
            background: #dbeafe;
            color: #2563eb;
        }

        .stat-card__icon--transactions {
            background: #fef3c7;
            color: #d97706;
        }

        .stat-card__label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .stat-card__value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .stat-card__change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-card__change--up {
            color: #059669;
        }

        .stat-card__change--down {
            color: #dc2626;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
        }

        .chart-card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-card__title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .chart-card__subtitle {
            font-size: 13px;
            color: #6b7280;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .transactions-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
        }

        .transactions-card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .transaction-row {
            display: grid;
            grid-template-columns: 120px 1fr 100px 140px;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .transaction-row:hover {
            background: #f9fafb;
            margin: 0 -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .transaction-row:last-child {
            border-bottom: none;
        }

        .transaction__time {
            font-size: 13px;
            color: #6b7280;
        }

        .transaction__desc {
            font-size: 14px;
            color: #111827;
            font-weight: 500;
        }

        .transaction__type {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .transaction__type--income {
            background: #d1fae5;
            color: #059669;
        }

        .transaction__type--expense {
            background: #fee2e2;
            color: #dc2626;
        }

        .transaction__amount {
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        .transaction__amount--income {
            color: #059669;
        }

        .transaction__amount--expense {
            color: #dc2626;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
        }

        .btn--topup {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
        }

        .btn--topup:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .balance-hero__amount {
                font-size: 36px;
            }

            .balance-hero__stats {
                flex-direction: column;
                gap: 16px;
            }
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
</head>

<body data-page="analytics">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo-icon" style="background: none; padding: 0;">
                    <img src="../images/logo.png" alt="AgriPlanner Logo"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <h1 class="sidebar__logo-text">AgriPlanner</h1>
            </div>
            <nav class="sidebar__nav">
                <a href="../index.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">home</span><span>Trang ch·ªß</span></a>
                <a href="cultivation.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">potted_plant</span><span>Tr·ªìng tr·ªçt</span></a>
                <a href="livestock.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">egg</span><span>ChƒÉn nu√¥i</span></a>
                <a href="labor.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">engineering</span><span>Nh√¢n c√¥ng</span></a>
                <a href="shop.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">store</span><span>C·ª≠a h√†ng</span></a>
                <a href="cooperative.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">groups</span><span>H·ª£p t√°c x√£</span></a>
                <a href="community.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">forum</span><span>C·ªông ƒë·ªìng</span></a>
                <a href="analytics.html" class="sidebar__nav-link active"><span
                        class="material-symbols-outlined">account_balance_wallet</span><span>T√†i s·∫£n</span></a>
                <a href="settings.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">settings</span><span>C√†i ƒë·∫∑t</span></a>
                <div class="sidebar__spacer"></div>
                <a href="help.html" class="sidebar__nav-link"><span
                        class="material-symbols-outlined">help</span><span>Tr·ª£ gi√∫p</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="sidebar__user">
                    <div class="sidebar__user-avatar" id="sidebar-avatar"></div>
                    <div class="sidebar__user-info">
                        <p class="sidebar__user-name" id="sidebar-name">ƒêang t·∫£i...</p>
                        <p class="sidebar__user-email" id="sidebar-email"></p>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="header">
                <div class="header__search"><span
                        class="material-symbols-outlined header__search-icon">search</span><input type="text"
                        class="header__search-input" placeholder="T√¨m ki·∫øm giao d·ªãch..."></div>
                <div class="header__actions">
                    <button class="header__notification"><span
                            class="material-symbols-outlined">notifications</span><span
                            class="header__notification-badge"></span></button>
                    <div class="header__user">
                        <div class="header__user-info">
                            <p class="header__user-name" id="header-name">ƒêang t·∫£i...</p>
                            <p class="header__user-role">Ch·ªß trang tr·∫°i</p>
                        </div>
                        <div class="header__user-avatar" id="header-avatar"></div>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="main-content__container">
                    <div class="assets-header">
                        <div>
                            <h2 class="page-header__title">Qu·∫£n l√Ω T√†i s·∫£n</h2>
                            <p class="page-header__subtitle">Theo d√µi d√≤ng ti·ªÅn v√† ph√¢n t√≠ch t√†i ch√≠nh</p>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn--topup" onclick="openTopUpModal()">
                                <span class="material-symbols-outlined icon-sm">add</span>N·∫°p ti·ªÅn
                            </button>
                            <button class="btn btn--secondary" onclick="exportReport()">
                                <span class="material-symbols-outlined icon-sm">download</span>Xu·∫•t b√°o c√°o
                            </button>
                        </div>
                    </div>

                    <!-- Balance Hero -->
                    <div class="balance-hero fade-in">
                        <div class="balance-hero__label">
                            <span class="material-symbols-outlined">account_balance_wallet</span>
                            T·ªïng s·ªë d∆∞ hi·ªán t·∫°i
                        </div>
                        <div class="balance-hero__amount" id="total-balance">0 VNƒê</div>
                        <div class="balance-hero__stats">
                            <div class="balance-stat">
                                <span class="balance-stat__label">Thu nh·∫≠p th√°ng n√†y</span>
                                <span class="balance-stat__value balance-stat__value--up" id="month-income">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                                    0 VNƒê
                                </span>
                            </div>
                            <div class="balance-stat">
                                <span class="balance-stat__label">Chi ti√™u th√°ng n√†y</span>
                                <span class="balance-stat__value balance-stat__value--down" id="month-expense">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 16px;">trending_down</span>
                                    0 VNƒê
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid" style="margin-top: 24px;">
                        <div class="stat-card fade-in">
                            <div class="stat-card__icon stat-card__icon--income">
                                <span class="material-symbols-outlined">arrow_upward</span>
                            </div>
                            <div class="stat-card__label">T·ªïng thu nh·∫≠p</div>
                            <div class="stat-card__value" id="stat-total-income">0 VNƒê</div>
                            <div class="stat-card__change stat-card__change--up" id="stat-income-change">
                                <span class="material-symbols-outlined" style="font-size: 14px;">trending_up</span>
                                +0% so v·ªõi th√°ng tr∆∞·ªõc
                            </div>
                        </div>
                        <div class="stat-card fade-in">
                            <div class="stat-card__icon stat-card__icon--expense">
                                <span class="material-symbols-outlined">arrow_downward</span>
                            </div>
                            <div class="stat-card__label">T·ªïng chi ti√™u</div>
                            <div class="stat-card__value" id="stat-total-expense">0 VNƒê</div>
                            <div class="stat-card__change stat-card__change--down" id="stat-expense-change">
                                <span class="material-symbols-outlined" style="font-size: 14px;">trending_down</span>
                                +0% so v·ªõi th√°ng tr∆∞·ªõc
                            </div>
                        </div>
                        <div class="stat-card fade-in">
                            <div class="stat-card__icon stat-card__icon--profit">
                                <span class="material-symbols-outlined">savings</span>
                            </div>
                            <div class="stat-card__label">L·ª£i nhu·∫≠n r√≤ng</div>
                            <div class="stat-card__value" id="stat-net-profit">0 VNƒê</div>
                            <div class="stat-card__change" id="stat-profit-change">
                                <span class="material-symbols-outlined" style="font-size: 14px;">trending_flat</span>
                                T√≠nh theo th√°ng n√†y
                            </div>
                        </div>
                        <div class="stat-card fade-in">
                            <div class="stat-card__icon stat-card__icon--transactions">
                                <span class="material-symbols-outlined">receipt_long</span>
                            </div>
                            <div class="stat-card__label">S·ªë giao d·ªãch</div>
                            <div class="stat-card__value" id="stat-tx-count">0</div>
                            <div class="stat-card__change" id="stat-tx-change">
                                Trong 30 ng√†y qua
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-card fade-in">
                            <div class="chart-card__header">
                                <div>
                                    <div class="chart-card__title">Thu nh·∫≠p & Chi ti√™u</div>
                                    <div class="chart-card__subtitle">30 ng√†y g·∫ßn nh·∫•t</div>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px;">
                                    <span style="display: flex; align-items: center; gap: 6px;">
                                        <span
                                            style="width: 12px; height: 12px; background: #10b981; border-radius: 3px;"></span>
                                        Thu nh·∫≠p
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 6px;">
                                        <span
                                            style="width: 12px; height: 12px; background: #ef4444; border-radius: 3px;"></span>
                                        Chi ti√™u
                                    </span>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="incomeExpenseChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card fade-in">
                            <div class="chart-card__header">
                                <div>
                                    <div class="chart-card__title">Ph√¢n b·ªï chi ti√™u</div>
                                    <div class="chart-card__subtitle">Theo danh m·ª•c</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="expenseBreakdownChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions -->
                    <div class="transactions-card fade-in">
                        <div class="transactions-card__header">
                            <div>
                                <div class="chart-card__title">L·ªãch s·ª≠ giao d·ªãch</div>
                                <div class="chart-card__subtitle">C√°c giao d·ªãch g·∫ßn ƒë√¢y</div>
                            </div>
                            <button class="btn btn--secondary btn--sm" onclick="loadMoreTransactions()">
                                Xem t·∫•t c·∫£
                            </button>
                        </div>
                        <div id="transactions-list">
                            <div style="text-align: center; padding: 40px; color: #9ca3af;">
                                <span class="material-symbols-outlined"
                                    style="font-size: 48px; display: block; margin-bottom: 8px;">hourglass_empty</span>
                                ƒêang t·∫£i giao d·ªãch...
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/animations.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/smart-advisor.js"></script>
    <script src="../js/main.js"></script>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let incomeExpenseChart, expenseBreakdownChart;
        let allTransactions = [];

        document.addEventListener('DOMContentLoaded', async () => {
            initCharts();  // Initialize charts FIRST
            await loadAssetData();  // Then load data and update charts
        });

        async function loadAssetData() {
            try {
                // Get user email by decoding JWT token
                let userEmail = null;
                const token = localStorage.getItem('token');

                if (token) {
                    try {
                        // Decode JWT payload (middle part)
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        userEmail = payload.sub || payload.email; // JWT usually has email in 'sub' claim
                        if (userEmail) {
                            localStorage.setItem('userEmail', userEmail);
                        }
                    } catch (e) {
                        console.log('Could not decode JWT, using localStorage');
                    }
                }

                // Fallback to localStorage
                if (!userEmail) {
                    userEmail = localStorage.getItem('userEmail');
                }

                if (!userEmail) {
                    console.warn('No user email found');
                    document.getElementById('transactions-list').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #9ca3af;">
                            <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 8px;">login</span>
                            Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem t√†i s·∫£n
                        </div>
                    `;
                    return;
                }

                // Load balance
                const balanceRes = await fetch(`${API_BASE}/assets/balance?email=${encodeURIComponent(userEmail)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (balanceRes.ok) {
                    const data = await balanceRes.json();
                    document.getElementById('total-balance').textContent = formatCurrency(data.balance || 0);
                }

                // Load transactions
                const txRes = await fetch(`${API_BASE}/assets/transactions?email=${encodeURIComponent(userEmail)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (txRes.ok) {
                    allTransactions = await txRes.json();
                    processTransactions(allTransactions);
                    renderTransactions(allTransactions.slice(0, 10));
                }
            } catch (e) {
                console.error('Error loading assets:', e);
            }
        }

        function processTransactions(transactions) {
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            let totalIncome = 0, totalExpense = 0;
            let monthIncome = 0, monthExpense = 0;
            const categoryTotals = {};
            const dailyData = {};

            transactions.forEach(tx => {
                const txDate = new Date(tx.createdAt);
                const amount = Math.abs(tx.amount);
                const dateKey = txDate.toISOString().split('T')[0];
                const isIncome = tx.transactionType === 'INCOME';

                if (isIncome) {
                    totalIncome += amount;
                    if (txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear) {
                        monthIncome += amount;
                    }
                    if (!dailyData[dateKey]) dailyData[dateKey] = { income: 0, expense: 0 };
                    dailyData[dateKey].income += amount;
                } else {
                    totalExpense += amount;
                    if (txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear) {
                        monthExpense += amount;
                    }
                    if (!dailyData[dateKey]) dailyData[dateKey] = { income: 0, expense: 0 };
                    dailyData[dateKey].expense += amount;

                    // Category breakdown
                    const cat = tx.category || 'Kh√°c';
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + amount;
                }
            });

            // Update stats
            document.getElementById('month-income').innerHTML = `
                <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                +${formatCurrency(monthIncome)}
            `;
            document.getElementById('month-expense').innerHTML = `
                <span class="material-symbols-outlined" style="font-size: 16px;">trending_down</span>
                -${formatCurrency(monthExpense)}
            `;
            document.getElementById('stat-total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('stat-total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('stat-net-profit').textContent = formatCurrency(monthIncome - monthExpense);
            document.getElementById('stat-tx-count').textContent = transactions.length;

            // Update charts
            updateCharts(dailyData, categoryTotals);
        }

        function initCharts() {
            // Income/Expense Line Chart
            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            incomeExpenseChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Thu nh·∫≠p',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Chi ti√™u',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxTicksLimit: 7 }
                        },
                        y: {
                            grid: { color: '#f3f4f6' },
                            ticks: {
                                callback: v => formatCompact(v)
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Expense Breakdown Pie Chart
            const ctx2 = document.getElementById('expenseBreakdownChart').getContext('2d');
            expenseBreakdownChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 16,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    }
                }
            });
        }

        function updateCharts(dailyData, categoryTotals) {
            // Get last 30 days
            const labels = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                incomeData.push(dailyData[key]?.income || 0);
                expenseData.push(dailyData[key]?.expense || 0);
            }

            incomeExpenseChart.data.labels = labels;
            incomeExpenseChart.data.datasets[0].data = incomeData;
            incomeExpenseChart.data.datasets[1].data = expenseData;
            incomeExpenseChart.update();

            // Category breakdown
            const catLabels = Object.keys(categoryTotals);
            const catData = Object.values(categoryTotals);

            // Map category names to Vietnamese
            const catNameMap = {
                'HARVEST': 'Thu ho·∫°ch',
                'SEEDING': 'Gieo h·∫°t',
                'FERTILIZER': 'Ph√¢n b√≥n',
                'PESTICIDE': 'Thu·ªëc tr·ª´ s√¢u',
                'MACHINERY': 'M√°y m√≥c',
                'TOPUP': 'N·∫°p ti·ªÅn',
                'WATERING': 'T∆∞·ªõi n∆∞·ªõc'
            };

            expenseBreakdownChart.data.labels = catLabels.map(c => catNameMap[c] || c);
            expenseBreakdownChart.data.datasets[0].data = catData;
            expenseBreakdownChart.update();
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 8px;">receipt_long</span>
                        Ch∆∞a c√≥ giao d·ªãch n√†o
                    </div>
                `;
                return;
            }

            const categoryIcons = {
                'HARVEST': 'agriculture',
                'SEEDING': 'grass',
                'FERTILIZER': 'compost',
                'PESTICIDE': 'bug_report',
                'MACHINERY': 'precision_manufacturing',
                'TOPUP': 'add_card',
                'WATERING': 'water_drop'
            };

            container.innerHTML = transactions.map(tx => {
                const isIncome = tx.transactionType === 'INCOME';
                const date = new Date(tx.createdAt);
                const icon = categoryIcons[tx.category] || 'receipt';

                return `
                    <div class="transaction-row">
                        <div class="transaction__time">${date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
                        <div class="transaction__desc">
                            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 8px; color: ${isIncome ? '#059669' : '#dc2626'};">${icon}</span>
                            ${tx.description || tx.category}
                        </div>
                        <div>
                            <span class="transaction__type transaction__type--${isIncome ? 'income' : 'expense'}">
                                ${isIncome ? '‚Üë Thu nh·∫≠p' : '‚Üì Chi ti√™u'}
                            </span>
                        </div>
                        <div class="transaction__amount transaction__amount--${isIncome ? 'income' : 'expense'}">
                            ${isIncome ? '+' : '-'}${formatCurrency(tx.amount)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        function formatCompact(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num;
        }

        function loadMoreTransactions() {
            renderTransactions(allTransactions);
        }

        // Top-up Modal (reuse from settings)
        function openTopUpModal() {
            const modal = document.createElement('div');
            modal.id = 'topup-modal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 32px; border-radius: 16px; width: 440px; max-width: 90%; animation: slideUp 0.3s;">
                    <div class="modal-header">
                        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</h3>
                        <p style="font-size: 14px; color: #6b7280; margin: 8px 0 0 0;">T·∫£i l√™n h√¨nh ·∫£nh v·ªõi t√™n l√† s·ªë ti·ªÅn (VNƒê)</p>
                    </div>
                    <div class="modal-body" style="margin-top: 20px;">
                        <div style="background: #f0fdf4; border: 2px dashed #10b981; border-radius: 12px; padding: 32px; text-align: center; cursor: pointer;" onclick="document.getElementById('topup-file-input').click()">
                            <span class="material-symbols-outlined" style="font-size: 48px; color: #10b981; margin-bottom: 8px;">cloud_upload</span>
                            <p style="color: #065f46; font-weight: 500; margin: 0;">Click ƒë·ªÉ ch·ªçn h√¨nh ·∫£nh</p>
                        </div>
                        <input type="file" id="topup-file-input" accept="image/*" style="display: none;" onchange="handleTopUpFile(event)">
                        <div id="topup-preview" style="margin-top: 16px; display: none;"></div>
                        <div id="topup-error" style="margin-top: 12px; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; display: none;"></div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                        <button class="btn btn--secondary" onclick="closeTopUpModal()">H·ªßy</button>
                        <button id="confirm-topup-btn" class="btn btn--primary" onclick="confirmTopUp()" disabled>X√°c nh·∫≠n n·∫°p ti·ªÅn</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let topUpAmount = 0;
        let topUpImageBase64 = null;

        function handleTopUpFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.replace(/\.[^/.]+$/, '');
            const amount = parseInt(fileName.replace(/[^0-9]/g, ''));

            if (!amount || amount <= 0) {
                document.getElementById('topup-error').textContent = 'T√™n file kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒë·∫∑t t√™n file l√† s·ªë ti·ªÅn (v√≠ d·ª•: 1000000.png)';
                document.getElementById('topup-error').style.display = 'block';
                document.getElementById('topup-preview').style.display = 'none';
                document.getElementById('confirm-topup-btn').disabled = true;
                return;
            }

            topUpAmount = amount;
            document.getElementById('topup-error').style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                topUpImageBase64 = e.target.result;
                document.getElementById('topup-preview').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                        <img src="${e.target.result}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #059669;">${formatCurrency(amount)}</div>
                            <div style="font-size: 12px; color: #6b7280;">S·∫µn s√†ng n·∫°p</div>
                        </div>
                    </div>
                `;
                document.getElementById('topup-preview').style.display = 'block';
                document.getElementById('confirm-topup-btn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function confirmTopUp() {
            if (!topUpAmount || !topUpImageBase64) return;

            try {
                const res = await fetch(`${API_BASE}/assets/topup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        amount: topUpAmount,
                        imageBase64: topUpImageBase64
                    })
                });

                if (res.ok) {
                    closeTopUpModal();
                    showNotification('success', 'Th√†nh c√¥ng', `ƒê√£ n·∫°p ${formatCurrency(topUpAmount)} th√†nh c√¥ng!`);
                    await loadAssetData();
                } else {
                    const err = await res.json();
                    document.getElementById('topup-error').textContent = err.error || 'C√≥ l·ªói x·∫£y ra';
                    document.getElementById('topup-error').style.display = 'block';
                }
            } catch (e) {
                document.getElementById('topup-error').textContent = 'L·ªói k·∫øt n·ªëi server';
                document.getElementById('topup-error').style.display = 'block';
            }
        }

        function closeTopUpModal() {
            const modal = document.getElementById('topup-modal');
            if (modal) modal.remove();
            topUpAmount = 0;
            topUpImageBase64 = null;
        }

        function showNotification(type, title, message) {
            // Simple notification
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${type === 'success' ? '#10b981' : '#ef4444'}; color: white;
                padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                animation: slideUp 0.3s;
            `;
            notif.innerHTML = `<strong>${title}</strong><br>${message}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        // Export Report to PDF using html2canvas for Vietnamese font support
        async function exportReport() {
            const { jsPDF } = window.jspdf;

            // Show loading
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal-overlay';
            loadingModal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                    <h3 style="margin: 0 0 8px 0;">ƒêang t·∫°o b√°o c√°o PDF...</h3>
                    <p style="color: #6b7280; margin: 0;">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
                </div>
            `;
            document.body.appendChild(loadingModal);

            try {
                // Get data
                const now = new Date();
                const balance = document.getElementById('total-balance').textContent;
                const totalIncome = document.getElementById('stat-total-income').textContent;
                const totalExpense = document.getElementById('stat-total-expense').textContent;
                const netProfit = document.getElementById('stat-net-profit').textContent;
                const txCount = document.getElementById('stat-tx-count').textContent;

                // Get chart images
                const lineChartCanvas = document.getElementById('incomeExpenseChart');
                const pieChartCanvas = document.getElementById('expenseBreakdownChart');
                const lineChartImg = lineChartCanvas.toDataURL('image/png', 1.0);
                const pieChartImg = pieChartCanvas.toDataURL('image/png', 1.0);

                // Build transaction rows HTML
                let txRows = '';
                const transactions = allTransactions.slice(0, 10);
                transactions.forEach((tx, i) => {
                    const isIncome = tx.transactionType === 'INCOME';
                    const date = new Date(tx.createdAt);
                    const bgColor = i % 2 === 0 ? '#f9fafb' : 'white';
                    const typeColor = isIncome ? '#059669' : '#dc2626';
                    const typeBg = isIncome ? '#d1fae5' : '#fee2e2';
                    txRows += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 8px 12px; font-size: 12px; color: #6b7280;">${date.toLocaleDateString('vi-VN')}</td>
                            <td style="padding: 8px 12px; font-size: 12px; color: #111827;">${(tx.description || tx.category).substring(0, 40)}</td>
                            <td style="padding: 8px 12px;"><span style="background: ${typeBg}; color: ${typeColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${isIncome ? 'Thu nh·∫≠p' : 'Chi ti√™u'}</span></td>
                            <td style="padding: 8px 12px; font-size: 12px; font-weight: 600; color: ${typeColor}; text-align: right;">${isIncome ? '+' : '-'}${formatCurrency(tx.amount)}</td>
                        </tr>
                    `;
                });

                // Create hidden report element
                const reportEl = document.createElement('div');
                reportEl.id = 'pdf-report';
                reportEl.style.cssText = 'position: fixed; top: -9999px; left: 0; width: 794px; background: white; font-family: "Manrope", Arial, sans-serif;';
                reportEl.innerHTML = `
                    <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 30px; text-align: center; color: white;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: 700;">B√°o C√°o T√†i Ch√≠nh</h1>
                        <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">AgriPlanner - H·ªá th·ªëng qu·∫£n l√Ω n√¥ng tr·∫°i</p>
                        <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.8;">Ng√†y xu·∫•t: ${now.toLocaleDateString('vi-VN')} - ${now.toLocaleTimeString('vi-VN')}</p>
                    </div>
                    
                    <div style="padding: 24px;">
                        <h2 style="font-size: 18px; color: #111827; margin: 0 0 16px 0; font-weight: 600;">T√≥m T·∫Øt T√†i Ch√≠nh</h2>
                        
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <p style="margin: 0 0 4px 0; font-size: 13px; color: #059669;">S·ªë d∆∞ hi·ªán t·∫°i</p>
                            <p style="margin: 0; font-size: 28px; font-weight: 700; color: #059669;">${balance}</p>
                        </div>
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                            <div style="flex: 1; background: #f9fafb; padding: 16px; border-radius: 8px;">
                                <p style="margin: 0 0 4px 0; font-size: 12px; color: #6b7280;">T·ªïng thu nh·∫≠p</p>
                                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #059669;">${totalIncome}</p>
                            </div>
                            <div style="flex: 1; background: #f9fafb; padding: 16px; border-radius: 8px;">
                                <p style="margin: 0 0 4px 0; font-size: 12px; color: #6b7280;">T·ªïng chi ti√™u</p>
                                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #dc2626;">${totalExpense}</p>
                            </div>
                            <div style="flex: 1; background: #f9fafb; padding: 16px; border-radius: 8px;">
                                <p style="margin: 0 0 4px 0; font-size: 12px; color: #6b7280;">L·ª£i nhu·∫≠n r√≤ng</p>
                                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #2563eb;">${netProfit}</p>
                            </div>
                            <div style="flex: 1; background: #f9fafb; padding: 16px; border-radius: 8px;">
                                <p style="margin: 0 0 4px 0; font-size: 12px; color: #6b7280;">S·ªë giao d·ªãch</p>
                                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #d97706;">${txCount} giao d·ªãch</p>
                            </div>
                        </div>
                        
                        <h2 style="font-size: 18px; color: #111827; margin: 0 0 16px 0; font-weight: 600;">Bi·ªÉu ƒê·ªì Ph√¢n T√≠ch</h2>
                        <div style="display: flex; gap: 20px; margin-bottom: 24px;">
                            <div style="flex: 2;">
                                <p style="font-size: 13px; color: #6b7280; margin: 0 0 8px 0;">Thu nh·∫≠p & Chi ti√™u (30 ng√†y)</p>
                                <img src="${lineChartImg}" style="width: 100%; border-radius: 8px; border: 1px solid #e5e7eb;">
                            </div>
                            <div style="flex: 1;">
                                <p style="font-size: 13px; color: #6b7280; margin: 0 0 8px 0;">Ph√¢n b·ªï chi ti√™u</p>
                                <img src="${pieChartImg}" style="width: 100%; border-radius: 8px; border: 1px solid #e5e7eb;">
                            </div>
                        </div>
                        
                        <h2 style="font-size: 18px; color: #111827; margin: 0 0 16px 0; font-weight: 600;">L·ªãch S·ª≠ Giao D·ªãch G·∫ßn ƒê√¢y</h2>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 600; color: #4b5563;">Th·ªùi gian</th>
                                    <th style="padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 600; color: #4b5563;">M√¥ t·∫£</th>
                                    <th style="padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 600; color: #4b5563;">Lo·∫°i</th>
                                    <th style="padding: 10px 12px; text-align: right; font-size: 12px; font-weight: 600; color: #4b5563;">S·ªë ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${txRows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: center; font-size: 11px; color: #9ca3af; margin: 24px 0 0 0;">¬© 2024 AgriPlanner - B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</p>
                    </div>
                `;
                document.body.appendChild(reportEl);

                // Wait for images to load
                await new Promise(r => setTimeout(r, 300));

                // Capture with html2canvas
                const canvas = await html2canvas(reportEl, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Remove hidden element
                reportEl.remove();

                // Create PDF
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add more pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Save PDF
                const fileName = `BaoCaoTaiChinh_${now.toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                loadingModal.remove();
                showNotification('success', 'Th√†nh c√¥ng', 'ƒê√£ xu·∫•t b√°o c√°o PDF th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                loadingModal.remove();
                showNotification('error', 'L·ªói', 'Kh√¥ng th·ªÉ t·∫°o b√°o c√°o PDF. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
    </script>
</body>

</html>